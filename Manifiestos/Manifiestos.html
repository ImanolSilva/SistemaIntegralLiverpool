<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manifestar Mercancía - Sistema Liverpool</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"> <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <style>
        :root {
            --rosa-principal: #E6007E;
            --negro-fondo: #1a1a1a;
            --blanco: #ffffff;
            --gris-claro: #f8f9fa;
            --gris-medio: #dee2e6;
            --gris-oscuro: #6c757d;
            --texto-principal: #343a40;
            --verde-exito: #43A047;
            --rojo-peligro: #e53935;
            --ios-border-radius: 12px; /* Mantenido para compatibilidad con el contenido */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #E6007E 0%, var(--negro-fondo) 100%);
            color: var(--texto-principal);
        }

        /* --- Estructura Principal y Menú (Estilo del Panel de Admin) --- */
        .app-header{display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,.2);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);padding:1rem 1.5rem;position:sticky;top:0;z-index:1030;border-bottom:1px solid rgba(255,255,255,.1)}
        .header-title{color:var(--blanco);font-weight:700;margin:0; font-size: 1.5rem;}
        .btn-menu,#logout-btn{background:transparent;border:2px solid var(--blanco);color:var(--blanco);border-radius:50px;width:45px;height:45px;display:inline-flex;justify-content:center;align-items:center;font-size:1.2rem;transition:all .3s ease}.btn-menu:hover,#logout-btn:hover{background:var(--blanco);color:var(--rosa-principal);transform:scale(1.1) rotate(10deg)}
        .offcanvas{background-color:var(--rosa-principal)}
        .offcanvas .nav-link{color:var(--blanco);font-size:1.1rem;font-weight:600;padding:1rem 1.5rem;transition:background-color .3s ease,padding-left .3s ease;border-radius:0 50px 50px 0; display: flex; align-items: center;}
        .offcanvas .nav-link.active,.offcanvas .nav-link:hover{background-color:var(--blanco);color:var(--rosa-principal);padding-left:2rem}
        .offcanvas-header{border-bottom:1px solid rgba(255,255,255,.2)}
        .main-container{max-width:1400px;margin:2rem auto;padding:clamp(1.5rem, 5vw, 2.5rem);background:var(--blanco);border-radius:20px;box-shadow:0 15px 40px rgba(0,0,0,.2);animation:fadeIn .8s ease-out}
        @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        
        /* --- Estilos de Componentes (Adaptados y Mantenidos) --- */
        .main-container h2 { font-weight: 700; color: var(--rosa-principal); display: flex; align-items: center; gap: 0.75rem; }
        .card { border-radius: var(--ios-border-radius); border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .form-control:focus, .form-select:focus { border-color: var(--rosa-principal); box-shadow: 0 0 0 3px rgba(230,0,126,0.2); }

        /* Estilos específicos para la página de manifiestos */
        #dropzone {
            border: 2px dashed var(--rosa-principal);
            border-radius: var(--ios-border-radius);
            background-color: #fafafa;
            padding: 2rem;
            text-align: center;
            color: var(--rosa-principal);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #dropzone:hover { transform: scale(1.02); background-color: #f5f5f5; }
        .progress { height: 30px; border-radius: 30px; }
        
        .table-responsive thead th { background-color: var(--texto-principal); color: var(--blanco); white-space: nowrap; }
        .table td, .table th { vertical-align: middle; }
        /* Estilo para cada elemento de la lista de archivos */
.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e0e0e0;
    border-left: 5px solid #0d6efd; /* Un color azul primario */
    background-color: #ffffff;
    padding: 1rem;
    margin-bottom: 0.75rem;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    transition: all 0.3s ease; /* Transición suave para todas las propiedades */
}

/* Efecto al pasar el mouse sobre un elemento de la lista */
.file-item:hover {
    transform: translateY(-3px); /* Se levanta ligeramente */
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-left-color: #E6007E; /* Cambia al color rosa principal */
}

/* Contenedor del ícono principal para darle un fondo */
.file-item-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f0f3ff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    margin-right: 15px;
}

.file-item-icon .material-icons {
    color: #0d6efd;
    font-size: 20px;
}

/* Estilo para la información del archivo (nombre, tienda, fecha) */
.file-info .file-name {
    font-weight: 600;
    color: #333;
    font-size: 1rem;
}

.file-info .file-meta {
    font-size: 0.8rem;
    color: #6c757d;
    display: flex;
    align-items: center;
    gap: 12px; /* Espacio entre los íconos de tienda y fecha */
    margin-top: 4px;
}

.file-meta .material-icons {
    font-size: 1rem; /* Alinea el tamaño de los íconos con el texto */
}

/* Clase base para los botones de acción con animación */
.action-btn {
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease-in-out;
    border: none;
}

.action-btn:hover {
    transform: scale(1.1); /* Agranda el botón al pasar el mouse */
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
}

/* Estilo para los botones de ordenar la lista */
.sort-btn {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
}

/* Estilo para el botón de ordenamiento activo */
.sort-btn.active {
    background-color: #e7f1ff;
    color: #0d6efd;
    font-weight: 600;
}
/* Contenedor principal del dashboard */
.dashboard-container {
    background-color: #f8f9fa; /* Un fondo gris muy claro */
    border-radius: 12px;
    padding: 24px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Mensaje de estado (Progreso o Completo) */
.status-message {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    margin-bottom: 20px;
    border-radius: 8px;
    font-weight: 600;
}
.status-message.is-warning {
    background-color: #fff3cd;
    color: #664d03;
}
.status-message.is-success {
    background-color: #d1e7dd;
    color: #0f5132;
}
.status-message .material-icons {
    vertical-align: middle;
}

/* Contenedor para las tarjetas de estadísticas */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

/* Estilo para cada tarjeta de estadística */
.stat-card {
    background-color: #ffffff;
    padding: 16px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border-left: 4px solid;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
}
.stat-card .stat-title {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 8px;
}
.stat-card .stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: #212529;
}
/* Colores específicos para el borde de cada tarjeta */
.stat-card.total { border-color: #0d6efd; }
.stat-card.expected { border-color: #6f42c1; }
.stat-card.scanned { border-color: #198754; }
.stat-card.missing { border-color: #dc3545; }
.stat-card.excess { border-color: #ffc107; }


/* Barra de progreso */
.progress-container {
    background-color: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    height: 24px;
    margin-bottom: 24px;
}
.progress-fill {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    transition: width 0.5s ease-in-out;
}

/* Contenedor del gráfico */
.chart-container {
    background-color: #ffffff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    margin-bottom: 20px;
}

/* Detalles de faltantes */
.faltantes-section .toggle-btn {
    width: 100%;
    margin-bottom: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
}
.faltantes-details {
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 16px;
    font-size: 0.9rem;
}
.faltantes-details strong {
    color: #dc3545; /* Rojo para resaltar */
}
.faltantes-details ul {
    list-style: none;
    padding-left: 0;
    margin-top: 8px;
}
.faltantes-details li {
    padding: 8px 0;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 1px solid #f1f1f1;
}
.faltantes-details li:last-child {
    border-bottom: none;
}
.faltantes-details .material-icons {
    color: #6c757d;
}
/* Contenedor principal para el modal de cambio de contenedor */
.change-container-modal {
    padding: 0; /* Quitamos el padding para tener control total */
    text-align: left;
}

/* Encabezado del modal que cambia de color según el estado */
.modal-header-status {
    padding: 16px 24px;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    color: white;
    display: flex;
    align-items: center;
    gap: 12px;
}
.modal-header-status .material-icons {
    font-size: 2.5rem;
}
.modal-header-status h3 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
}

/* Colores de estado para el encabezado */
.modal-header-status.status-neutral { background-color: #2196F3; } /* Azul Info */
.modal-header-status.status-incompleto { background-color: #f44336; } /* Rojo */
.modal-header-status.status-excedente { background-color: #FF9800; } /* Naranja */
.modal-header-status.status-completo { background-color: #4CAF50; } /* Verde */

/* Cuerpo del modal */
.modal-body-content {
    padding: 24px;
}

/* Tarjeta para el resumen del contenedor actual */
.container-summary-card {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 16px;
    margin-top: 16px;
}
.container-summary-card h4 {
    color: #343a40;
    margin-top: 0;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.container-summary-card .summary-content {
    font-size: 0.95rem;
    color: #495057;
}

/* Texto de la pregunta de confirmación */
.confirmation-prompt {
    margin-top: 24px;
    font-size: 1.1rem;
    font-weight: 500;
    text-align: center;
    color: #212529;
}
.confirmation-prompt .material-icons {
    vertical-align: bottom;
    color: #E6007E;
}

/* Estilos personalizados para los botones de SweetAlert */
.swal2-actions {
    gap: 12px; /* Espacio entre botones */
}
.swal2-confirm.btn-confirm-custom,
.swal2-cancel.btn-cancel-custom {
    border-radius: 8px !important;
    padding: 12px 24px !important;
    font-size: 1rem !important;
    font-weight: 600 !important;
    display: inline-flex !important;
    align-items: center;
    gap: 8px;
    transition: transform 0.2s ease;
}
.swal2-confirm.btn-confirm-custom:hover,
.swal2-cancel.btn-cancel-custom:hover {
    transform: scale(1.05);
}

.btn-confirm-custom { background-color: #28a745 !important; }
.btn-cancel-custom { background-color: #6c757d !important; }

/* Alerta simple para cuando no hay contenedor */
.no-container-alert {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}
.no-container-alert .material-icons {
    font-size: 3rem;
    color: #17a2b8;
}
/* Contenedor para el campo de búsqueda principal */
.search-input-container {
    position: relative;
    margin-bottom: 20px;
}
.search-input-container .material-icons {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #999;
    font-size: 24px;
}
#inputBusqueda {
    padding: 15px 20px 15px 50px; /* Espacio para el ícono */
    font-size: 1.2rem;
    border: 2px solid #ddd;
    border-radius: 10px;
    transition: all 0.3s ease;
    width: 100%;
}
#inputBusqueda:focus {
    border-color: #E6007E;
    box-shadow: 0 0 10px rgba(230, 0, 126, 0.2);
}

/* Contenedor de la lista de resultados en el modal */
.results-list-container {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 10px;
    margin-top: 16px;
}

/* Tarjeta individual para cada resultado de búsqueda */
.result-item-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
}
.result-item-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-left: 4px solid #E6007E;
    padding-left: 13px;
}
.result-item-card .item-info .item-title {
    font-weight: 600;
    font-size: 1.1rem;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}
.result-item-card .item-info .item-meta {
    font-size: 0.85rem;
    color: #6c757d;
}

/* Badge para el estado del contenedor */
.status-badge {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 700;
    vertical-align: middle;
}
.status-badge.is-closed {
    background-color: #dc3545;
    color: white;
}

/* Botón de 'Elegir' en la tarjeta */
.result-item-card .btn-choose {
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 600;
}

/* Contenedor para el mensaje de 'No encontrado' */
.not-found-container {
    text-align: center;
    padding: 20px;
}
.not-found-container .material-icons {
    font-size: 4rem;
    color: #6c757d;
    margin-bottom: 10px;
}
.not-found-container h4 {
    color: #333;
    font-weight: 600;
}
.not-found-container p {
    color: #6c757d;
}
/* Contenedor para la nueva alerta de carga personalizada */
.custom-loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

/* El ícono de la lupa que se animará */
.swal-icon-searching {
    font-size: 5rem; /* Hacemos el ícono más grande */
    color: #0d6efd; /* Un color azul primario */
    /* Aplicamos la animación */
    animation: search-animation 1.5s ease-in-out infinite;
}

/* El título principal de la alerta */
.swal-loading-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #333;
    margin-top: 20px;
    margin-bottom: 10px;
}

/* El párrafo donde aparecerán las frases motivacionales */
.swal-loading-phrase {
    font-size: 1rem;
    color: #6c757d;
    height: 30px; /* Altura fija para evitar que la alerta "salte" al cambiar el texto */
    display: flex;
    align-items: center;
}
/* Estilo base para el contenido de nuestros modales de confirmación */
.confirmation-modal-content {
    text-align: left;
    padding: 24px;
}

/* Encabezado que cambia de color según la acción */
/* (Reutilizamos el estilo que ya teníamos) */
.modal-header-status {
    padding: 16px 24px;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    color: white;
    display: flex;
    align-items: center;
    gap: 12px;
}
.modal-header-status .material-icons { font-size: 2.5rem; }
.modal-header-status h3 { margin: 0; font-size: 1.5rem; }

/* Colores de estado para el encabezado */
.modal-header-status.status-close { background-color: #f44336; } /* Rojo */
.modal-header-status.status-reopen { background-color: #4CAF50; } /* Verde */

/* Tarjeta para mostrar el resumen del contenedor */
.summary-card {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 16px;
    margin-top: 16px;
    margin-bottom: 20px;
}

/* Mensaje principal del modal */
.confirmation-modal-content p.main-text {
    font-size: 1.1rem;
    color: #333;
    margin-top: 16px;
}
.confirmation-modal-content .closed-by-user {
    color: var(--rosa-principal); /* Usamos tu variable de color rosa */
    font-weight: 600;
}
/* Estilo para el toast de éxito de escaneo */
.scan-success-toast {
    background-color: #28a745 !important; /* Verde éxito */
    color: white !important;
}
.scan-success-toast .swal2-icon-content {
    color: white !important;
}

/* Estilo para el toast de error o advertencia */
.scan-error-toast {
    background-color: #dc3545 !important; /* Rojo error */
    color: white !important;
}
.scan-error-toast .swal2-icon-content {
    color: white !important;
}
/* Contenedor para hacer la tabla responsiva en móviles */
.table-responsive-wrapper {
    overflow-x: auto;
    border-radius: var(--ios-border-radius, 10px);
    border: 1px solid #dee2e6;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
}

/* Estilo mejorado para la tabla */
.details-table {
    border-collapse: separate; /* Permite bordes redondeados */
    border-spacing: 0;
}

.details-table thead th {
    background-color: #f8f9fa;
    position: sticky; /* Encabezados fijos al hacer scroll vertical */
    top: 0;
    z-index: 10;
    white-space: nowrap; /* Evita que el texto del encabezado se parta */
}

.details-table tbody td {
    vertical-align: middle;
}

/* Clases de estado para la columna 'Diferencia' */
.diff-status {
    padding: 0.5rem;
    font-weight: 600;
    text-align: center;
    border-radius: 6px;
    color: white;
}
.diff-status.is-ok { background-color: #28a745; } /* Verde */
.diff-status.is-missing { background-color: #dc3545; } /* Rojo */
.diff-status.is-excess { background-color: #ffc107; color: #333; } /* Amarillo */

/* Animación para resaltar una fila cuando se actualiza */
@keyframes flash-update {
    0% { background-color: rgba(255, 193, 7, 0.5); }
    100% { background-color: transparent; }
}

.row-updated {
    animation: flash-update 1s ease-out;
}
/* ======================================================== */
/* ESTILOS MEJORADOS PARA BOTONES                           */
/* ======================================================== */

/* --- Estilo Base para TODOS los botones --- */
.btn {
    /* 1. Alineación perfecta de ícono y texto */
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem; /* Espacio entre el ícono y el texto */

    /* 2. Un toque visual más moderno */
    border-radius: 8px;
    font-weight: 600;
    padding: 0.5rem 1rem; /* Ajuste de padding */
    border-width: 2px;
    
    /* 3. Animación para el efecto hover */
    transition: all 0.2s ease-in-out;
}

/* 4. Efecto al pasar el mouse */
.btn:hover {
    transform: translateY(-2px); /* Eleva ligeramente el botón */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); /* Añade una sombra sutil */
}

/* 5. Aseguramos el tamaño y alineación del ícono SIN style en línea */
.btn .material-icons {
    font-size: 1.25rem; /* Tamaño consistente para los íconos */
    /* No se necesita 'vertical-align' gracias a flexbox */
}

/* --- Ajustes para botones pequeños --- */
.btn-sm {
    padding: 0.35rem 0.8rem;
    gap: 0.4rem;
}

.btn-sm .material-icons {
    font-size: 1.1rem;
}

/* --- Pequeños retoques a los colores primarios y secundarios --- */
.btn-primary {
    /* Un azul un poco más vibrante */
    background-color: #0d6efd; 
    border-color: #0d6efd;
}

.btn-secondary {
    /* Un gris un poco más oscuro para mejor contraste */
    background-color: #6c757d;
    border-color: #6c757d;
}

/* (Reutilizamos los estilos de los botones que ya creamos) */
/* .swal2-confirm.btn-confirm-custom, .swal2-cancel.btn-cancel-custom */
/* Definición de la animación de la lupa */
@keyframes search-animation {
    0% {
        transform: rotate(-15deg) scale(1);
    }
    50% {
        transform: rotate(15deg) scale(1.1);
    }
    100% {
        transform: rotate(-15deg) scale(1);
    }
    
}

    </style>
</head>
<body>
    <header class="app-header">
        <button class="btn-menu" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuLateral"><i class="bi bi-list"></i></button>
        <h1 class="header-title">Manifestar Mercancía</h1>
        <button id="logout-btn" class="btn-menu"><i class="bi bi-power"></i></button>
    </header>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="menuLateral">
        <div class="offcanvas-header"><h5 class="offcanvas-title text-white fw-bold"><i class="bi bi-box-seam-fill me-2"></i> Menú</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button></div>
        <div class="offcanvas-body p-0">
            <nav class="nav flex-column">
                <a class="nav-link" href="../index.html"><i class="bi bi-house-door-fill me-3"></i>Inicio</a>
                <a class="nav-link" href="../ChecarPrecios/index.html"><i class="bi bi-tags-fill me-3"></i>Checar Precios</a>
                <a class="nav-link" href="../Rechazos/reportes.html"><i class="bi bi-x-octagon-fill me-3"></i>Rechazos</a>
                <a class="nav-link" href="../Inventarios/Inventarios.html"><i class="bi bi-archive-fill me-3"></i>Inventarios</a>
                <a class="nav-link" href="../Configuraciones/Configuracion.html"><i class="bi bi-sliders me-3"></i>Configuración</a>
                <a class="nav-link active" href="../Manifiestos/Manifiestos.html"><i class="bi bi-file-earmark-check-fill me-3"></i>Manifiestos</a>
                <li class="nav-item" id="admin-nav-link" style="display: none;"><a class="nav-link" href="../Admin/admin.html"><i class="bi bi-gear-fill me-3"></i>Administrar</a></li>
            </nav>
        </div>
    </div>
    
<main class="container main-container">
    <div id="userInfo"></div>

    <section id="employeeSection" class="container mb-4">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center bg-white border-0">
                <h2 class="h4 mb-0"><i class="material-icons" style="font-size:1.5rem; vertical-align:middle;">badge</i> Ingrese Número de Empleado (8 dígitos)</h2>
                <button id="btnCambiarEmpleado" class="btn btn-outline-primary btn-sm"><i class="material-icons">edit</i> Cambiar</button>
            </div>
            <div class="card-body">
                <input type="text" id="employeeNumberInput" class="form-control" placeholder="Ej: 12345678" maxlength="8">
                <small class="text-muted">Sin este dato el sistema permanecerá bloqueado.</small>
            </div>
        </div>
    </section>
    
    <div id="restoInterfaz" style="display:none;">
        <div id="adminUploadSection" data-aos="zoom-in" style="display:none;">
            <div class="card mb-4 shadow">
                <div class="card-header text-center bg-white border-0">
                    <h2 class="h4 mb-0"><i class="material-icons" style="font-size:2rem; vertical-align:middle;">upload_file</i> Subir Archivo Manifiesto</h2>
                </div>
                <div class="card-body text-center">
                    <div id="dropzone" class="mb-3">
                        <div class="d-flex flex-column align-items-center justify-content-center p-3">
                            <i class="material-icons animate__animated animate__fadeIn" style="font-size:3.5rem;">cloud_upload</i>
                            <p class="mt-2 mb-0 fw-bold" style="color:#555;">Arrastra y suelta o haz clic para seleccionar un archivo Excel</p>
                        </div>
                        <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;">
                    </div>
                    <p id="selectedFileName" class="text-muted mt-2 mb-0" style="font-size: 0.95rem;"></p>
                    <div class="d-flex justify-content-center gap-3 mt-3 flex-wrap">
                        <button id="uploadFileBtn" class="btn btn-primary" disabled><i class="material-icons">file_upload</i> Subir</button>
                        <button id="btnVerArchivos" class="btn btn-secondary"><i class="material-icons">folder_open</i> Ver Archivos</button>
                    </div>
                    <div id="uploadProgressContainer" class="mt-4" style="display: none;">
                        <div class="progress"><div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success text-white fw-bold" role="progressbar" style="width: 0%;">0%</div></div>
                        <div class="d-flex justify-content-between mt-2 px-2 small text-muted"><span id="uploadSpeed">Velocidad: 0 KB/s</span><span id="uploadEta">Tiempo restante: --</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="searchContainerSection" class="mb-4">
            <div class="card shadow-sm">
                <div class="card-header text-center bg-white border-0"><h2 class="h4 mb-0"><i class="material-icons" style="vertical-align:middle;">search</i> Buscar Contenedor / SKU</h2></div>
                <div class="card-body">
                    <input type="text" id="inputBusqueda" class="form-control" placeholder="Ingrese código (mínimo 5 dígitos)">
                    <small class="text-muted d-block mt-1">La búsqueda se enviará automáticamente al detenerse 500ms o al pegar.</small>
                </div>
            </div>
        </div>

        <div id="containerResultsSection" style="display:none;" class="mb-4">
            <div class="card shadow-sm">
                <div class="card-header text-center bg-white border-0">
                    <h2 class="h4" id="containerHeader"><i class="material-icons" style="vertical-align:middle;">inventory_2</i> Detalles del Contenedor</h2>
                    <p id="selectedFileToWork" class="fw-bold mb-0"></p>
                    <p id="lastUserUpdate" class="text-muted" style="font-size:0.9rem;"></p>
                    <div class="d-flex justify-content-center flex-wrap gap-2 mt-2">
                        <button id="btnAnalisisGlobal" class="btn btn-info btn-sm"><i class="material-icons">analytics</i> Análisis Global</button>
                        <button id="btnCerrarContenedor" class="btn btn-danger btn-sm"><i class="material-icons">lock</i> Cerrar Contenedor</button>
                        <button id="btnCambiarContenedor" class="btn btn-secondary btn-sm"><i class="material-icons">switch_account</i> Cambiar de Contenedor</button>
                    </div>
                </div>
                <div id="containerDetails" class="card-body table-responsive"></div>
                <div id="downloadSection" class="p-3 text-center" style="display:none;">
                    <button id="btnDescargarArchivo" class="btn btn-success btn-sm"><i class="material-icons">download</i> Descargar Archivo Actual</button>
                </div>
            </div>
        </div>

        <div id="scanEntrySection" style="display:none;" class="mb-4">
            <div class="card shadow-sm">
                <div class="card-header text-center bg-white border-0"><h2 class="h4 mb-0"><i class="material-icons" style="vertical-align:middle;">qr_code_scanner</i> Registro de Piezas</h2></div>
                <div class="card-body">
                    <input type="text" id="inputScanCode" class="form-control" placeholder="Escanee o ingrese manualmente el código" disabled>
                    <small class="text-muted d-block mt-1">Se procesará automáticamente al detectar entre 5 y 10 dígitos o, para código europeo, 12 o más.</small>
                </div>
                <div class="card-footer text-end bg-white">
                    <button id="btnRegistrarManual" class="btn btn-primary btn-sm"><i class="material-icons">edit_note</i> Registrar Manual</button>
                </div>
            </div>
        </div>
    </div>
</main>

    <div class="modal fade" id="modalDanios" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content" style="border-radius: var(--ios-border-radius);"><div class="modal-header border-bottom-0"><h5 class="modal-title" style="color: var(--rosa-principal); font-weight:700;"><i class="material-icons" style="vertical-align:middle;">warning</i> Registrar Condiciones de la Mcia</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label for="danioCantidad" class="form-label fw-bold">¿Cuántas piezas presentan condiciones (daños)?</label><input type="number" class="form-control" id="danioCantidad" min="1" step="1" value="1"></div><div class="mb-3"><label for="danioFoto" class="form-label fw-bold">Foto de la condición</label><input type="file" class="form-control" id="danioFoto" accept="image/*"><small class="text-muted">Suba una foto clara del artículo.</small></div></div><div class="modal-footer border-top-0"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="material-icons">cancel</i> Cancelar</button><button type="button" class="btn btn-primary" id="btnGuardarDanio"><i class="material-icons">check_circle</i> Guardar</button></div></div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script> <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    </body>

  <script>
    (function(){
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelector('.main-container').removeAttribute('aria-hidden');
        AOS.init();

        /***************************************************
         * CONFIGURACIÓN DE FIREBASE
         ***************************************************/
        const firebaseConfig = {
          apiKey: "AIzaSyA_4H46I7TCVLnFjet8fQPZ006latm-mRE",
          authDomain: "loginliverpool.firebaseapp.com",
          projectId: "loginliverpool",
          storageBucket: "loginliverpool.appspot.com",
          messagingSenderId: "704223815941",
          appId: "1:704223815941:web:c871525230fb61caf96f6c",
          measurementId: "G-QFEPQ4TSPY"
        };
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.app().storage("gs://loginliverpool.firebasestorage.app");

        /***************************************************
         * VARIABLES GLOBALES
         ***************************************************/
        const ADMIN_UID = "OaieQ6cGi7TnW0nbxvlk2oyLaER2";
        let currentUser = null;
        let currentUserStore = null;
        let currentUserRole = null;
        let currentContenedor = null;
        let currentContainerRecords = [];
        let excelDataGlobal = {};
        let currentFileName = "";
        let currentEmployeeNumber = "";
        let debounceTimerBusqueda = null;
        let debounceTimerScan = null;
        let allFilesList = null;
        let globalContainerMap = {};
        let currentDanioSKU = null;

        /***************************************************
         * REFERENCIAS DEL DOM
         ***************************************************/
        const logoutBtn = document.getElementById("logout-btn");
        const userInfoEl = document.getElementById("userInfo");
        const employeeNumberInput = document.getElementById("employeeNumberInput");
        const restoInterfaz = document.getElementById("restoInterfaz");
        const adminUploadSection = document.getElementById("adminUploadSection");
        const dropzone = document.getElementById("dropzone");
        const fileInput = document.getElementById("fileInput");
        const selectedFileNameEl = document.getElementById("selectedFileName");
        const uploadFileBtn = document.getElementById("uploadFileBtn");
        const uploadProgressContainer = document.getElementById("uploadProgressContainer");
        const uploadProgressBar = document.getElementById("uploadProgressBar");
        const btnVerArchivos = document.getElementById("btnVerArchivos");
        const inputBusqueda = document.getElementById("inputBusqueda");
        const containerResultsSection = document.getElementById("containerResultsSection");
        const containerDetailsEl = document.getElementById("containerDetails");
        const selectedFileToWorkEl = document.getElementById("selectedFileToWork");
        const lastUserUpdateEl = document.getElementById("lastUserUpdate");
        const btnAnalisisGlobal = document.getElementById("btnAnalisisGlobal");
        const downloadSection = document.getElementById("downloadSection");
        const scanEntrySection = document.getElementById("scanEntrySection");
        const inputScanCode = document.getElementById("inputScanCode");
        const btnCerrarContenedor = document.getElementById("btnCerrarContenedor");
        const btnRegistrarManual = document.getElementById("btnRegistrarManual");
        const btnCambiarEmpleado = document.getElementById("btnCambiarEmpleado");
        const btnCambiarContenedor = document.getElementById("btnCambiarContenedor");
        const searchContainerSection = document.getElementById("searchContainerSection");
        const modalDanios = new bootstrap.Modal(document.getElementById("modalDanios"));
        const danioCantidadInput = document.getElementById("danioCantidad");
        const danioFotoInput = document.getElementById("danioFoto");
        const btnGuardarDanio = document.getElementById("btnGuardarDanio");

        /***************************************************
         * AUTH / LOGOUT
         ***************************************************/
         auth.onAuthStateChanged(async (user) => {
  if (!user) {
    Swal.fire({
      icon: "warning",
      title: "No Autenticado",
      html: `<i class="material-icons" style="color:#FFC107;">warning</i> Debes iniciar sesión.`
    }).then(() => window.location.href = "../Login/login.html");
    return;
  }

  currentUser = user;
  // Admin global
  if (user.uid === ADMIN_UID) {
    currentUserStore = "ALL";
    currentUserRole  = "admin";
    adminUploadSection.style.display = "block";
    userInfoEl.textContent = "Usuario: Admin (ALL - admin)";
  } else {
    // Leer datos de Firestore
    const docSnap = await db.collection("usuarios").doc(user.uid).get();
    if (!docSnap.exists) {
      Swal.fire({
        icon: "warning",
        title: "Sin datos",
        html: `<i class="material-icons" style="color:#2196F3;">info</i> No se encontró tu registro en "usuarios".`
      }).then(() => window.location.href = "../Login/login.html");
      return;
    }
    const data = docSnap.data();
    // Si no está aprobado
    if ((data.status || "pendiente") !== "aprobado") {
      Swal.fire({
        icon: "info",
        title: "Pendiente",
        html: `<i class="material-icons" style="color:#2196F3;">info</i> Tu cuenta no está aprobada.`
      }).then(() => window.location.href = "../Login/login.html");
      return;
    }
    currentUserStore = data.store || "";
    currentUserRole  = data.role  || "vendedor";

    // *** Aquí el control *** 
    // Solo 'auxiliar' y 'jefe' ven la sección de subir archivos
    if (currentUserRole === "auxiliar" || currentUserRole === "jefe") {
      adminUploadSection.style.display = "block";
    } else {
      adminUploadSection.style.display = "none";
    }

    userInfoEl.textContent = `Usuario: ${data.name} (Tienda: ${currentUserStore}, Rol: ${currentUserRole})`;
  }
});

        logoutBtn.addEventListener("click", () => {
          auth.signOut().then(() => window.location.href = "../Login/login.html")
            .catch(e => console.error(e));
        });

        /***************************************************
         * SECCIÓN: SUBIR ARCHIVO MANIFIESTO + BARRA DE PROGRESO
         ***************************************************/
        // Al hacer clic en la zona de dropzone, abrir selector de archivo
        dropzone.addEventListener('click', () => fileInput.click());

        // Mostrar nombre de archivo seleccionado y habilitar botón
        fileInput.addEventListener('change', () => {
          const file = fileInput.files[0];
          if (!file) return;
          selectedFileNameEl.textContent = file.name;
          uploadFileBtn.disabled = false;
        });

        // Manejar subida con progreso
        uploadFileBtn.addEventListener('click', () => {
          const file = fileInput.files[0];
          if (!file) return;
          uploadFileBtn.disabled = true;
          uploadProgressContainer.style.display = 'block';

          const folder = (currentUserStore === "ALL") ? "ALL" : currentUserStore;
          const storageRef = storage.ref(`Manifiestos/${folder}/${file.name}`);
          const uploadTask = storageRef.put(file);

          uploadTask.on('state_changed',
            snapshot => {
              const percent = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
              uploadProgressBar.style.width = percent + '%';
              uploadProgressBar.textContent = percent + '%';
            },
            error => {
              console.error(error);
              Swal.fire({ icon:'error', title:'Error', text:'Error al subir el archivo.' });
              uploadProgressContainer.style.display = 'none';
              uploadFileBtn.disabled = false;
            },
            async () => {
              // Al finalizar, obtener URL y guardar metadatos
// Al subir por primera vez:
await db.collection('manifiestos')
  .doc(file.name)
  .set(
    {
      fileName: file.name,
      store: folder,
      lastUser: currentUser.email || currentUser.uid,
      lastUserStore: (currentUserStore !== undefined) ? currentUserStore : null,
      lastUserRole:  (currentUserRole   !== undefined) ? currentUserRole   : null,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    },
    { merge: true }
  );



              Swal.fire({ icon:'success', title:'Archivo subido', text: file.name });
              // Resetar barra y campos
              uploadProgressContainer.style.display = 'none';
              uploadProgressBar.style.width = '0%';
              uploadProgressBar.textContent = '0%';
              selectedFileNameEl.textContent = '';
            }
          );
        });

        /***************************************************
         * DETECCIÓN DE EMPLEADO (8 dígitos)
         ***************************************************/
/**
 * Función "debounce" para evitar que el código se ejecute en cada pulsación de tecla.
 * Espera a que el usuario deje de escribir para ejecutar la validación.
 * @param {Function} func - La función a ejecutar después del retardo.
 * @param {number} delay - El tiempo de espera en milisegundos.
 * @returns {Function}
 */
const debounce = (func, delay = 400) => {
    let timeoutId;
    return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            func.apply(this, args);
        }, delay);
    };
};

// 1. MEJORA: Usamos 'debounce' en el evento 'input' para una experiencia fluida.
//    La validación solo se ejecuta cuando el usuario deja de escribir.
employeeNumberInput.addEventListener("input", debounce(() => {
    let val = employeeNumberInput.value.trim();

    // Validamos que sean exactamente 8 dígitos numéricos para más robustez.
    if (/^\d{8}$/.test(val)) {
        currentEmployeeNumber = val;
        
        // MEJORA DE DISEÑO: Usamos un "toast" no intrusivo para notificar el éxito.
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'success',
            title: 'Número de empleado válido',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.onmouseenter = Swal.stopTimer;
                toast.onmouseleave = Swal.resumeTimer;
            }
        });

        restoInterfaz.style.display = "block";
        inputScanCode.disabled = false;
        inputScanCode.focus(); // Guía al usuario al siguiente paso.
    } else {
        restoInterfaz.style.display = "none";
        inputScanCode.disabled = true;
    }
}));

// 2. MEJORA: Se rediseña el popup para cambiar el número, haciéndolo más atractivo.
btnCambiarEmpleado.addEventListener("click", () => {
    Swal.fire({
        title: "Cambiar Empleado",
        input: "text",
        inputLabel: "Ingrese el nuevo número de empleado",
        inputPlaceholder: "Debe contener 8 dígitos...",
        inputAttributes: {
            maxlength: 8,
            autocapitalize: "off",
            autocorrect: "off"
        },
        showCancelButton: true,
        confirmButtonText: 'Confirmar',
        cancelButtonText: 'Cancelar',
        // MEJORA DE DISEÑO: Colores y estilo consistentes con la app.
        confirmButtonColor: '#43A047', // Verde éxito
        cancelButtonColor: '#6c757d',  // Gris oscuro
        customClass: {
            popup: 'animated animate__fadeInDown' // Animación de entrada
        },
        // MEJORA: Validación más robusta y mensaje de error claro.
        preConfirm: (value) => {
            if (!/^\d{8}$/.test(value)) {
                Swal.showValidationMessage("El número debe contener exactamente 8 dígitos numéricos");
                return false; // Evita que se cierre la alerta
            }
            return value;
        }
    }).then(result => {
        if (result.isConfirmed) {
            currentEmployeeNumber = result.value.trim();
            // MEJORA DE DISEÑO: Notificación de éxito con un toast.
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Número actualizado con éxito',
                html: `Ahora se usará: <strong>${currentEmployeeNumber}</strong>`,
                showConfirmButton: false,
                timer: 2500
            });
            // Aseguramos que la interfaz esté visible después del cambio.
            restoInterfaz.style.display = "block";
            inputScanCode.disabled = false;
            inputScanCode.focus();
        }
    });
});
   /***************************************************
   * LISTAR / DESCARGAR / ELIMINAR MANIFIESTOS
   ***************************************************/
   const SUPER_ADMINS = [
    "OaieQ6cGi7TnW0nbxvlk2oyLaER2",
    "doxhVo1D3aYQqqkqgRgfJ4qcKcU2"
  ];

  btnVerArchivos.addEventListener("click", listarArchivos);

async function listarArchivos() {
  try {
    const entries = [];
    // Obtener lista de archivos según rol
    if (SUPER_ADMINS.includes(currentUser.uid)) {
      const root = await storage.ref("Manifiestos").listAll();
      for (const prefix of root.prefixes) {
        const lst = await prefix.listAll();
        lst.items.forEach(i => entries.push({ folder: prefix.name, name: i.name }));
      }
    } else {
      const lst = await storage.ref(`Manifiestos/${currentUserStore}`).listAll();
      lst.items.forEach(i => entries.push({ folder: currentUserStore, name: i.name }));
    }

    if (!entries.length) {
      return Swal.fire({
        icon: "info",
        title: "Sin manifiestos",
        text: "No se encontraron archivos para tu tienda.",
        toast: true,
        position: "center",
        timer: 2000
      });
    }

    // Obtener fechas de actualización
    const detailed = await Promise.all(
      entries.map(async e => {
        const doc = await db.collection("manifiestos").doc(e.name).get();
        const updated = doc.exists && doc.data().updatedAt ? doc.data().updatedAt.toDate() : null;
        return { ...e, date: updated, dateStr: updated ? formatFecha(updated) : "–" };
      })
    );

    let currentList = detailed.slice();
    // Ordenar por defecto: recientes primero
    currentList.sort((a, b) => (b.date || 0) - (a.date || 0));

    // --- ¡MEJORA! ---
    // Función para generar la lista de items con el nuevo estilo.
    function renderItems(list) {
      return list.map(f => `
        <div class="file-item">
          <div class="d-flex align-items-center">
            <div class="file-item-icon">
              <i class="material-icons">description</i>
            </div>
            <div class="file-info">
              <div class="file-name">${f.name}</div>
              <div class="file-meta">
                <span><i class="material-icons align-middle">store</i> ${f.folder}</span>
                <span><i class="material-icons align-middle">date_range</i> ${f.dateStr}</span>
              </div>
            </div>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-info action-btn" onclick="verDashboardArchivo('${f.folder}','${f.name}')" title="Ver Dashboard">
              <i class="material-icons">insights</i>
            </button>
            <button class="btn btn-success action-btn" onclick="downloadFile('${f.folder}','${f.name}')" title="Descargar">
              <i class="material-icons">download</i>
            </button>
            ${SUPER_ADMINS.includes(currentUser.uid) ?
              `<button class="btn btn-danger action-btn" onclick="eliminarArchivo('${f.folder}','${f.name}')" title="Eliminar">
                 <i class="material-icons">delete_sweep</i>
               </button>` : ''
            }
          </div>
        </div>
      `).join('');
    }

    // --- ¡MEJORA! ---
    // Construir contenido del modal con los nuevos botones de ordenamiento.
    const htmlHeader = `
      <div class="d-flex justify-content-end align-items-center mb-3 gap-2">
        <span class="text-muted small me-2">Ordenar por:</span>
        <button id="sortRecent" class="btn btn-sm btn-outline-primary sort-btn active">
          <i class="material-icons">new_releases</i> Más recientes
        </button>
        <button id="sortOld" class="btn btn-sm btn-outline-secondary sort-btn">
          <i class="material-icons">history</i> Más antiguos
        </button>
      </div>
      <div id="filesList" style="max-height: 420px; overflow-y: auto; padding-right: 10px;">
        ${renderItems(currentList)}
      </div>
    `;

    Swal.fire({
      title: `<span style="display: flex; align-items: center; gap: 8px;">
                <i class="material-icons" style="color:#E6007E;">folder_open</i> Manifiestos
              </span>`,
      html: htmlHeader,
      width: "700px", // Un poco más ancho para que respire el diseño
      showCloseButton: true,
      confirmButtonText: "Cerrar",
      customClass: { popup: "swal2-file-list-modal" },
      didOpen: () => {
        const btnRecent = document.getElementById('sortRecent');
        const btnOld = document.getElementById('sortOld');
        const listContainer = document.getElementById('filesList');

        // --- ¡MEJORA! ---
        // Lógica para cambiar la clase 'active' en los botones de ordenamiento.
        btnRecent.addEventListener('click', () => {
          btnRecent.classList.add('active');
          btnOld.classList.remove('active');
          currentList.sort((a, b) => (b.date || 0) - (a.date || 0));
          listContainer.innerHTML = renderItems(currentList);
        });

        btnOld.addEventListener('click', () => {
          btnOld.classList.add('active');
          btnRecent.classList.remove('active');
          currentList.sort((a, b) => (a.date || 0) - (b.date || 0));
          listContainer.innerHTML = renderItems(currentList);
        });
      }
    });

  } catch (err) {
    console.error("Error al listar archivos:", err);
    Swal.fire({
      icon: "error",
      title: "Error Inesperado",
      text: "No se pudo listar los archivos. Por favor, intenta de nuevo."
    });
  }
}
window.verDashboardArchivo = async (folder, fileName) => {
  try {
    // La lógica para cargar y procesar datos se mantiene igual
    if (!excelDataGlobal[fileName]) {
      const url = await storage.ref(`Manifiestos/${folder}/${fileName}`).getDownloadURL();
      const buf = await (await fetch(url)).arrayBuffer();
      const wb = XLSX.read(buf, { type: "array" });
      const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
      excelDataGlobal[fileName] = { data };
    }

    const datos = excelDataGlobal[fileName].data;
    const {
      totalSAP,
      totalSCAN,
      faltantes,
      excedentes,
      avance,
      contenedoresFaltantes,
      seccionFaltantes,
      totalSKUs
    } = (() => {
      let tSAP = 0, tSCAN = 0, falt = 0, exc = 0;
      const contF = {}, secF = {};
      datos.forEach(r => {
        const sap = Number(r.SAP) || 0;
        const sc = Number(r.SCANNER) || 0;
        const cont = (r.CONTENEDOR || 'SIN NOMBRE').toUpperCase().trim();
        const sec = (r.SECCION || 'Sin sección').toString().trim();
        tSAP += sap;
        tSCAN += sc;
        if (sc < sap) {
          const diff = sap - sc;
          falt += diff;
          contF[cont] = (contF[cont] || 0) + diff;
          secF[sec] = (secF[sec] || 0) + diff;
        } else if (sc > sap) {
          exc += sc - sap;
        }
      });
      const av = tSAP ? Math.round((tSCAN / tSAP) * 100) : 0;
      return { totalSAP: tSAP, totalSCAN: tSCAN, faltantes: falt, excedentes: exc, avance: av, contenedoresFaltantes: contF, seccionFaltantes: secF, totalSKUs: datos.length };
    })();

    // --- ¡MEJORA! ---
    // Mensaje y clase según el avance
    let statusClass = 'is-warning';
    let msgHTML = `<i class="material-icons">warning</i> Aún falta un ${100 - avance}% por completar. ¡Ánimo!`;
    if (avance >= 100) {
      statusClass = 'is-success';
      msgHTML = `<i class="material-icons">celebration</i> ¡Manifiesto completo! Excelente trabajo 🎉`;
    }

    // --- ¡MEJORA! ---
    // Panel de faltantes con un diseño más limpio
    const contKeys = Object.keys(contenedoresFaltantes);
    let faltHTML = '';
    if (contKeys.length > 0) {
      faltHTML = `
        <div class="faltantes-section">
          <button id="toggleFaltantesBtn" class="btn btn-outline-secondary toggle-btn">
            Mostrar detalles de faltantes <i class="material-icons">expand_more</i>
          </button>
          <div id="faltantesContainer" style="display:none;" class="faltantes-details">
            <div class="row">
              <div class="col-md-6">
                <strong>Contenedores con faltantes:</strong>
                <ul>${contKeys.map(c => `<li><i class="material-icons">inventory_2</i> <strong>${c}:</strong> ${contenedoresFaltantes[c]} pz.</li>`).join('')}</ul>
              </div>
              <div class="col-md-6">
                <strong>Secciones con faltantes:</strong>
                <ul>${Object.keys(seccionFaltantes).map(s => `<li><i class="material-icons">folder_open</i> <strong>${s}:</strong> ${seccionFaltantes[s]} pz.</li>`).join('')}</ul>
              </div>
            </div>
          </div>
        </div>`;
    }

    // --- ¡MEJORA! ---
    // Construir HTML del dashboard usando las nuevas clases de CSS
    const canvasId = `grafico_${fileName.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const dashboardHTML = `
      <div class="dashboard-container">
        <div class="status-message ${statusClass}">${msgHTML}</div>
        
        <div class="stats-grid">
          <div class="stat-card total"><div class="stat-title">SKUs Totales</div><div class="stat-value">${totalSKUs}</div></div>
          <div class="stat-card expected"><div class="stat-title">Piezas Esperadas</div><div class="stat-value">${totalSAP.toLocaleString('es-MX')}</div></div>
          <div class="stat-card scanned"><div class="stat-title">Piezas Escaneadas</div><div class="stat-value">${totalSCAN.toLocaleString('es-MX')}</div></div>
          <div class="stat-card missing"><div class="stat-title">Piezas Faltantes</div><div class="stat-value">${faltantes.toLocaleString('es-MX')}</div></div>
          <div class="stat-card excess"><div class="stat-title">Piezas Excedentes</div><div class="stat-value">${excedentes.toLocaleString('es-MX')}</div></div>
        </div>

        <div class="progress-container">
          <div class="progress-fill ${avance < 100 ? 'bg-primary' : 'bg-success'}" style="width:${avance}%;">${avance}% Completado</div>
        </div>
        
        <div class="chart-container">
          <canvas id="${canvasId}"></canvas>
        </div>

        ${faltHTML}
      </div>`;

    await Swal.fire({
      title: `<span style="display: flex; align-items: center; gap: 8px;">
                <i class="material-icons text-primary">dashboard</i> Dashboard: ${fileName}
              </span>`,
      html: dashboardHTML,
      width: '800px',
      padding: '0', // Quitamos el padding de Swal para que nuestro contenedor ocupe todo
      showCloseButton: true,
      showConfirmButton: false, // El botón de cerrar es suficiente
      didOpen: () => {
        const ctx = document.getElementById(canvasId).getContext('2d');
        // --- ¡MEJORA! ---
        // Gráfico con colores más vibrantes y mejor tooltip
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Correcto', 'Faltante', 'Excedente'],
            datasets: [{
              data: [totalSCAN - excedentes, faltantes, excedentes], // Se ajusta el dato 'correcto' para mayor precisión
              backgroundColor: ['#198754', '#dc3545', '#ffc107'],
              borderColor: '#f8f9fa',
              borderWidth: 4,
              hoverOffset: 10
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
              legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true, pointStyle: 'rectRounded' } },
              tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.raw.toLocaleString('es-MX')} piezas` } }
            }
          }
        });

        // --- ¡MEJORA! ---
        // Lógica para mostrar/ocultar detalles con cambio de ícono
        const btn = document.getElementById('toggleFaltantesBtn');
        if (btn) {
          btn.addEventListener('click', () => {
            const panel = document.getElementById('faltantesContainer');
            const icon = btn.querySelector('.material-icons');
            const isHidden = panel.style.display === 'none';
            
            panel.style.display = isHidden ? 'block' : 'none';
            btn.innerHTML = isHidden ? 'Ocultar detalles <i class="material-icons">expand_less</i>' : 'Mostrar detalles <i class="material-icons">expand_more</i>';
          });
        }
      }
    });
  } catch (e) {
    console.error("Error al generar dashboard:", e);
    Swal.fire({ icon: 'error', title: 'Error Inesperado', text: 'No se pudo generar el dashboard del archivo.' });
  }
};

  // Descargar un manifiesto (con columna DIFERENCIA)
  window.downloadFile = async (folder, name) => {
    try {
      // 1) Cargar o reutilizar datos en memoria
      if (!excelDataGlobal[name]) {
        const url = await storage.ref(`Manifiestos/${folder}/${name}`).getDownloadURL();
        const buf = await (await fetch(url)).arrayBuffer();
        const wb = XLSX.read(buf, { type: "array", cellDates: true });
        const js = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        excelDataGlobal[name] = { data: js };
      }
      const data = excelDataGlobal[name].data;

      // 2) Preparar exportación
      const exportData = data.map(r => {
        const sap = Number(r.SAP) || 0;
        const sc = Number(r.SCANNER) || 0;
        let diff = "";
        if (sc === sap) diff = "OK";
        else if (sc < sap) diff = `FALTAN ${sap - sc} piezas`;
        else diff = `+${sc - sap} piezas`;

        return {
          FECHA: formatFecha(new Date(r.FECHA)),
          SECCION: r.SECCION || "",
          MANIFIESTO: r.MANIFIESTO || "",
          CONTENEDOR: r.CONTENEDOR || "",
          SKU: r.SKU || "",
          EUROPEO: r.EUROPEO || "",
          DESCRIPCION: r.DESCRIPCION || "",
          SAP: sap,
          SCANNER: sc,
          LAST_SCANNED_BY: r.LAST_SCANNED_BY || "",
          ENTREGADO_A: r.ENTREGADO_A || "",
          DIFERENCIA: diff,
          FechaEscaneo: formatFecha(new Date(r.FECHA_ESCANEO)),
          CONDICIONES_MCIA: r.DANIO_CANTIDAD || 0,
          FOTO_CONDICIONES: r.DANIO_FOTO_URL || ""
        };
      });

      // 3) Generar y descargar XLSX
      const ws = XLSX.utils.json_to_sheet(exportData, {
        header: [
          "FECHA","SECCION","MANIFIESTO","CONTENEDOR","SKU","EUROPEO",
          "DESCRIPCION","SAP","SCANNER","LAST_SCANNED_BY","ENTREGADO_A",
          "DIFERENCIA","FechaEscaneo","CONDICIONES_MCIA","FOTO_CONDICIONES"
        ]
      });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
      const out = XLSX.write(wb, { bookType: "xlsx", type: "array" });
      const blob = new Blob([out], { type: "application/octet-stream" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);

      Swal.fire({
        icon: "success",
        title: "Descargado",
        toast: true,
        position: "center",
        timer: 1200
      });

    } catch (e) {
      console.error(e);
      Swal.fire({ icon: "error", title: "Error", text: "No se pudo descargar." });
    }
  };

  // Eliminar un manifiesto
  window.eliminarArchivo = async (folder, name) => {
    const { isConfirmed } = await Swal.fire({
      title: "Eliminar manifiesto",
      html: `¿Eliminar <strong>${name}</strong>?`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Sí, eliminar",
      cancelButtonText: "Cancelar"
    });
    if (!isConfirmed) return;

    try {
      await storage.ref(`Manifiestos/${folder}/${name}`).delete();
      await db.collection("manifiestos").doc(name).delete().catch(()=>{});
      delete excelDataGlobal[name];
      Swal.fire({
        icon: "success",
        title: "Eliminado",
        toast: true,
        position: "center",
        timer: 1200
      });
      listarArchivos();
    } catch {
      Swal.fire({ icon: "error", title: "Error", text: "No se pudo eliminar." });
    }
  };

  // Helper: formatea Date a dd/mm/yyyy
  function formatFecha(d) {
    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }
btnCambiarContenedor.addEventListener("click", () => {
    // --- ¡MEJORA! ---
    // Alerta mejorada para cuando no hay un contenedor activo.
    if (!currentContenedor) {
        Swal.fire({
            title: "No hay Contenedor Activo",
            html: `<div class="no-container-alert">
                     <i class="material-icons">info_outline</i>
                     <div>Para cambiar de contenedor, primero debes abrir uno.</div>
                   </div>`,
            icon: 'info',
            confirmButtonText: "Entendido"
        });
        return;
    }

    const summaryHTML = getContainerSummaryDetailed(currentContainerRecords);
    const containerStatus = getContainerStateFromRecords(currentContainerRecords);

    // --- ¡MEJORA! ---
    // Mapeamos el estado a una clase de CSS y un título para el modal.
    let statusInfo = { className: 'status-neutral', title: 'Cambio de Contenedor' };
    if (containerStatus === "INCOMPLETO") {
        statusInfo = { className: 'status-incompleto', title: 'Contenedor Incompleto' };
    } else if (containerStatus === "COMPLETO CON MERCANCÍA DE MÁS") {
        statusInfo = { className: 'status-excedente', title: 'Contenedor con Excedente' };
    } else if (containerStatus === "COMPLETO") {
        statusInfo = { className: 'status-completo', title: 'Contenedor Completo' };
    }

    // --- ¡MEJORA! ---
    // Modal de confirmación completamente rediseñado con clases CSS.
    Swal.fire({
        html: `
            <div class="change-container-modal">
                <div class="modal-header-status ${statusInfo.className}">
                    <i class="material-icons">switch_account</i>
                    <h3>${statusInfo.title}</h3>
                </div>
                <div class="modal-body-content">
                    <div class="container-summary-card">
                        <h4>
                            <i class="material-icons">inventory_2</i>
                            Resumen de: <strong>${currentContenedor}</strong>
                        </h4>
                        <div class="summary-content">
                            ${summaryHTML}
                        </div>
                    </div>
                    <p class="confirmation-prompt">
                        <i class="material-icons">help_outline</i>
                        ¿Estás seguro de que deseas cerrar y cambiar de contenedor?
                    </p>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Sí, cambiar',
        cancelButtonText: 'Cancelar',
        width: "600px",
        padding: 0, // Importante para que nuestro diseño se ajuste bien
        showLoaderOnConfirm: true,
        customClass: {
            confirmButton: 'btn-confirm-custom',
            cancelButton: 'btn-cancel-custom'
        }
    }).then(async (result) => {
        if (!result.isConfirmed) return;

        // La lógica de guardado y reseteo se mantiene igual. ¡Ya estaba perfecta!
        try {
            await reuploadFileWithScannerChanges(currentFileName);
        } catch (e) {
            console.error("Error al guardar cambios antes de cambiar contenedor:", e);
            // Podríamos mostrar un error aquí si falla el guardado
        }

        currentContenedor = null;
        currentContainerRecords = [];
        selectedFileToWorkEl.textContent = "";

        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'success',
            title: '¡Listo! Contenedor cerrado.',
            timer: 1500,
            showConfirmButton: false
        }).then(() => {
            searchContainerSection.style.display = "block";
            inputBusqueda.focus();
        });
    });
});

/****************************************************************************
 * INICIO DE LA SECCIÓN DE BÚSQUEDA MEJORADA
 ****************************************************************************/

// =========================================================================
// PASO 1: Declarar variables en un ámbito superior
// =========================================================================
let containersMapGlobal = {};
let skuContainerMapGlobal = {}; // Esta la usaremos después

// --- ¡NUEVO! ---
// Array con las frases que irán cambiando
const motivationalPhrases = [
    "Analizando los datos...",
    "Buscando coincidencias...",
    "La eficiencia es clave. ¡Ya casi!",
    "Revisando cada rincón digital...",
    "El éxito es la suma de pequeños esfuerzos.",
    "Un momento, estamos en ello...",
    "Preparando la información para ti...",
    "Tu próxima gran jugada está a un segundo."
];
// Variable para guardar el ID del intervalo y poder limpiarlo después
let loadingIntervalId = null;
// =========================================================================
// PASO 2: Definir funciones de ayuda
// =========================================================================

// Función para mostrar una alerta de "No encontrado" más visual.
function showNotFoundAlert(type) {
    Swal.fire({
        html: `<div class="not-found-container">
                 <i class="material-icons">search_off</i>
                 <h4>No se encontraron resultados</h4>
                 <p>No pudimos encontrar el ${type} que buscas. Por favor, verifica el código y vuelve a intentarlo.</p>
               </div>`,
        showConfirmButton: false,
        timer: 3000
    });
}

// Función que crea el HTML para cada tarjeta de resultado.
function createContainerResultCard(containerName, file, isClosed, onclickAction) {
    return `
    <div class="result-item-card">
        <div class="item-info">
            <div class="item-title">
                <i class="material-icons text-primary">inventory_2</i>
                ${containerName}
                ${isClosed ? `<span class="status-badge is-closed">CERRADO</span>` : ''}
            </div>
            <div class="item-meta">
                <strong>Archivo:</strong> ${file}
            </div>
        </div>
        <button class="btn btn-primary btn-sm btn-choose" onclick="${onclickAction}">
            <i class="material-icons">touch_app</i> Elegir
        </button>
    </div>`;
}

// =========================================================================
// PASO 3: Reemplazar la función original `buscarContenedor`
// =========================================================================
async function buscarContenedor(ref) {
    // Las funciones `checkFileForReference` y `openContainerDirect` se asume que existen en tu código
    let candidates = await checkFileForReference(null, ref, true);
    if (!candidates) {
        return showNotFoundAlert("contenedor");
    }

    // Limpiamos y llenamos el mapa global con los resultados
    containersMapGlobal = {}; 
    candidates.forEach(cand => {
        cand.matchedRecords.forEach(rec => {
            const cont = String(rec.CONTENEDOR || "").trim().toUpperCase();
            if (!containersMapGlobal[cont]) {
                containersMapGlobal[cont] = {
                    fileName: cand.fileName,
                    records: [],
                    isClosed: Boolean(excelDataGlobal[cand.fileName].closedContainers?.[cont])
                };
            }
            containersMapGlobal[cont].records.push(rec);
        });
    });

    const keys = Object.keys(containersMapGlobal);
    // Si solo hay un resultado, lo abrimos directamente
    if (keys.length === 1) {
        Swal.close();
        const { fileName, records } = containersMapGlobal[keys[0]];
        return openContainerDirect({ fileName, matchedRecords: records }, 0);
    }
    
    // Si hay múltiples resultados, creamos el HTML con las nuevas tarjetas
    let html = keys.map(cont => {
        const { fileName, isClosed } = containersMapGlobal[cont];
        return createContainerResultCard(cont, fileName, isClosed, `selectContainerV2('${cont}')`);
    }).join('');

    // Mostramos el modal de SweetAlert con los resultados
    Swal.fire({
        title: "Múltiples Coincidencias",
        html: `<p>Se encontró la referencia en <strong>${keys.length}</strong> contenedores. Por favor, elige uno:</p>
               <div class="results-list-container">${html}</div>`,
        showConfirmButton: false,
        width: "650px",
        customClass: { title: 'text-primary' }
    });
}

// =========================================================================
// PASO 4: Función llamada por los nuevos botones 'Elegir'
// =========================================================================
// Esta función reemplaza a tu antiguo `selectContainer`
window.selectContainerV2 = function(cont) {
    const info = window.containersMapGlobal[cont];
    if (info) {
        Swal.close();
        openContainerDirect({
            fileName: info.fileName,
            matchedRecords: info.records
        }, 0);
    }
};

// =========================================================================
// PASO 5: Reemplazar los `addEventListener` con el manejador unificado
// =========================================================================
const handleSearch = (value) => {
    let val = value.trim().toUpperCase();
    if (val.length < 5) return;

    // --- ¡MEJORA! ---
    // Esta es la nueva alerta de carga con la lupa animada y frases cambiantes.
    Swal.fire({
        // Usamos el parámetro `html` para construir nuestra alerta personalizada
        html: `
            <div class="custom-loading-container">
                <i class="material-icons swal-icon-searching">search</i>
                <h3 class="swal-loading-title">Buscando</h3>
                <p id="motivational-phrase" class="swal-loading-phrase"></p>
            </div>
        `,
        showConfirmButton: false, // Ocultamos el botón de OK
        allowOutsideClick: false, // Evitamos que se cierre al hacer clic afuera
        
        // --- Aquí comienza la magia ---
        didOpen: () => {
            const phraseElement = document.getElementById('motivational-phrase');
            let phraseIndex = 0;
            
            // Mostramos la primera frase inmediatamente
            phraseElement.innerText = motivationalPhrases[phraseIndex];

            // Creamos un intervalo que cambiará la frase cada 2 segundos
            loadingIntervalId = setInterval(() => {
                phraseIndex = (phraseIndex + 1) % motivationalPhrases.length;
                phraseElement.innerText = motivationalPhrases[phraseIndex];
            }, 2000);
        },
        // Se ejecuta justo antes de que la alerta se cierre
        willClose: () => {
            // Es MUY IMPORTANTE limpiar el intervalo para evitar que se siga ejecutando en segundo plano
            clearInterval(loadingIntervalId);
        }
    });

    if (/^[A-Z]/.test(val)) {
        buscarContenedor(val);
    } else {
        buscarSKUenArchivos(val);
    }
    inputBusqueda.value = "";
};

// Asignamos los listeners que inician todo el proceso
inputBusqueda.addEventListener("keyup", (event) => {
    if (event.key === 'Enter') {
        clearTimeout(debounceTimerBusqueda);
        handleSearch(inputBusqueda.value);
    } else {
        clearTimeout(debounceTimerBusqueda);
        debounceTimerBusqueda = setTimeout(() => {
            handleSearch(inputBusqueda.value);
        }, 600);
    }
});

inputBusqueda.addEventListener("paste", (event) => {
    const pastedText = (event.clipboardData || window.clipboardData).getData('text');
    setTimeout(() => {
        handleSearch(pastedText);
    }, 10);
});

// Se llama al pulsar “Elegir”
window.selectContainer = function(cont) {
  Swal.close();
  const info = containersMap[cont];
  openContainerDirect({
    fileName: info[0].fileName,
    matchedRecords: info.map(i => i.record)
  }, 0);
};


async function buscarSKUenArchivos(sku) {
  try {
    // La lógica de `checkFileForReference` se mantiene, es correcta.
    let candidates = await checkFileForReference(null, sku, false);

    // --- ¡MEJORA! ---
    // Usamos nuestra nueva alerta estandarizada para el caso "No encontrado".
    if (!candidates || !Array.isArray(candidates) || candidates.length === 0) {
        return showNotFoundAlert("SKU");
    }

    // La lógica para agrupar por contenedor es correcta, la mantenemos.
    const contMap = {};
    candidates.forEach(cand => {
        cand.matchedRecords.forEach(record => {
            const cont = (record.CONTENEDOR || "").trim().toUpperCase();
            if (!cont) return;
            if (!contMap[cont]) {
                contMap[cont] = {
                    fileName: cand.fileName,
                    records: [],
                    isClosed: Boolean(excelDataGlobal[cand.fileName].closedContainers?.[cont]) // Verificamos si está cerrado
                };
            }
            contMap[cont].records.push(record);
        });
    });

    const contKeys = Object.keys(contMap);
    if (contKeys.length === 0) {
        return showNotFoundAlert("SKU en algún contenedor");
    }

    // El comportamiento para un solo resultado es correcto, lo mantenemos.
    if (contKeys.length === 1) {
        Swal.close(); // Cerramos la alerta de "Buscando..."
        const { fileName, records } = contMap[contKeys[0]];
        return openContainerDirect({ fileName, matchedRecords: records }, 0);
    }

    // --- ¡MEJORA PRINCIPAL! ---
    // Guardamos los resultados en una variable global para el callback
    window.skuContainerMapGlobal = contMap;

    // Construimos el HTML usando las nuevas tarjetas, pero con la información específica del SKU.
    let html = contKeys.map(cont => {
        const { fileName, records, isClosed } = contMap[cont];
        
        // La lógica para calcular la fecha y el SAP se mantiene.
        const fechas = records.map(r => new Date(r.FECHA));
        const fechaMax = fechas.length ? new Date(Math.max(...fechas)) : null;
        const fechaStr = fechaMax ? formatFecha(fechaMax) : "–"; // Asumo que tienes una función formatFecha
        const cantidadSAP = Number(records[0].SAP) || 0;

        // Creamos una tarjeta personalizada para el resultado de SKU
        return `
        <div class="result-item-card">
            <div class="item-info">
                <div class="item-title">
                    <i class="material-icons text-primary">inventory_2</i>
                    ${cont}
                    ${isClosed ? `<span class="status-badge is-closed">CERRADO</span>` : ''}
                </div>
                <div class="item-meta">
                    <span><strong>Archivo:</strong> ${fileName}</span> | 
                    <span><strong>SAP:</strong> ${cantidadSAP} pz</span> | 
                    <span><strong>Fecha:</strong> ${fechaStr}</span>
                </div>
            </div>
            <button class="btn btn-primary btn-sm btn-choose" onclick="selectSKUContainerV2('${cont}')">
                <i class="material-icons">touch_app</i> Elegir
            </button>
        </div>`;
    }).join('');

    // Mostramos el modal de SweetAlert con los resultados mejorados.
    Swal.fire({
        title: "SKU en Múltiples Contenedores",
        html: `<p>Se encontró el SKU <strong>${sku}</strong> en ${contKeys.length} contenedores diferentes:</p>
               <div class="results-list-container">${html}</div>`,
        showConfirmButton: false,
        width: "650px",
        customClass: { title: 'text-primary' }
    });

  } catch (err) {
    console.error("Error en buscarSKUenArchivos:", err);
    Swal.fire({ icon: "error", title: "Error Inesperado", text: "Ocurrió un problema al buscar el SKU." });
  }
}

// =========================================================================
// Función llamada por los botones 'Elegir' de la búsqueda de SKU
// =========================================================================
window.selectSKUContainerV2 = function(cont) {
    // Lee la información desde la variable global que llenamos antes
    const info = window.skuContainerMapGlobal[cont];
    if (info) {
        Swal.close();
        // Llama a la misma función que ya tienes para abrir el contenedor
        openContainerDirect({
            fileName: info.fileName,
            matchedRecords: info.records
        }, 0);
    }
};
// ========================================================
// INICIA EL BLOQUE PARA REEMPLAZAR
// ========================================================

// FUNCIÓN AUXILIAR PARA PROCESAR UN SOLO ARCHIVO (CON LA CORRECCIÓN)
async function processSingleFile(fileInfo) {
    const fileName = fileInfo.ref.name;
    // Si el archivo ya está en caché, no hacemos nada y lo devolvemos.
    if (excelDataGlobal[fileName]) {
        return; 
    }

    try {
        const url = await storage.ref(`Manifiestos/${fileInfo.folderName}/${fileName}`).getDownloadURL();
        const arrBuff = await (await fetch(url)).arrayBuffer();
        const wb = XLSX.read(arrBuff, { type: "array", cellDates: true });
        const sheet = wb.SheetNames[0];
        const dataJson = XLSX.utils.sheet_to_json(wb.Sheets[sheet]);
        
        // Obtenemos metadatos de Firestore
        const docSnap = await db.collection("manifiestos").doc(fileName).get();
        
        // --- ¡LA CORRECCIÓN DEFINITIVA ESTÁ AQUÍ! ---
        // Usamos 'docSnap.exists' (sin paréntesis) para que sea compatible con tu versión de Firebase.
        let docData = docSnap.exists ? docSnap.data() : {};

        // Guardamos todo en nuestra caché global
        excelDataGlobal[fileName] = {
            data: dataJson,
            lastUser: docData.lastUser || "",
            lastUserStore: docData.lastUserStore || "",
            lastUserRole: docData.lastUserRole || "",
            closedContainers: docData.closedContainers || {},
            uploadedAt: docData.updatedAt ? docData.updatedAt.toDate() : null
        };
    } catch (error) {
        // Mostramos un error más detallado en la consola para futura depuración
        console.error(`Error procesando el archivo ${fileName}:`, error);
    }
}


// VERSIÓN OPTIMIZADA DE checkFileForReference
async function checkFileForReference(folderName, code) {
    // Lógica para obtener la lista de archivos (mejorada)
    if (!allFilesList || allFilesList.length === 0) {
        allFilesList = [];
        const storeFolder = currentUserStore === "ALL" ? "" : currentUserStore;
        
        if (storeFolder) { // Si es una tienda específica
            const storeFiles = await storage.ref(`Manifiestos/${storeFolder}`).listAll();
            storeFiles.items.forEach(itemRef => allFilesList.push({ folderName: storeFolder, ref: itemRef }));
        } else { // Si es Super Admin (ALL)
            const root = await storage.ref("Manifiestos").listAll();
            for (const folderRef of root.prefixes) {
                const storeFiles = await folderRef.listAll();
                storeFiles.items.forEach(itemRef => allFilesList.push({ folderName: folderRef.name, ref: itemRef }));
            }
        }
    }
    const filesToProcess = allFilesList.filter(f => !excelDataGlobal[f.ref.name]);

    // Procesamos todos los archivos necesarios en paralelo.
    if (filesToProcess.length > 0) {
        const phraseElement = document.getElementById('motivational-phrase');
        if (phraseElement) {
             phraseElement.innerText = `Cargando ${filesToProcess.length} archivo(s) nuevos...`;
        }
        await Promise.all(filesToProcess.map(fileInfo => processSingleFile(fileInfo)));
    }
    
    // Lógica de filtrado (la misma que antes, pero ahora sobre datos ya cargados)
    const foundCandidates = [];
    const searchCode = code.toUpperCase();

    for (const f of allFilesList) {
        const fileName = f.ref.name;
        if (!excelDataGlobal[fileName]) continue; // Si falló la carga, lo saltamos

        const records = excelDataGlobal[fileName].data;
        const matched = records.filter(r => {
            const cont = String(r.CONTENEDOR || "").trim().toUpperCase();
            const sku = String(r.SKU || "").trim().toUpperCase();
            return cont.includes(searchCode) || sku.includes(searchCode);
        });

        if (matched.length > 0) {
            foundCandidates.push({
                folderName: f.folderName,
                fileName,
                matchedRecords: matched
            });
        }
    }

    return foundCandidates.length > 0 ? foundCandidates : null;
}

// ========================================================
// FIN DEL BLOQUE PARA REEMPLAZAR
// ========================================================
        function openContainerDirect(candidate, recordIndex = 0) {
          currentFileName = candidate.fileName;
          let cont = String(candidate.matchedRecords[recordIndex]?.CONTENEDOR || "").trim().toUpperCase();
          realOpenFileManifiesto(currentFileName, cont);
        }

        function realOpenFileManifiesto(fileName, cont) {
          if (!excelDataGlobal[fileName]) {
            Swal.fire({
              icon: "error",
              title: "Error",
              html: `<i class="material-icons" style="color:#F44336;">error</i> No se encontró el archivo ${fileName}`
            });
            return;
          }
          adminUploadSection.style.display = "none";
          searchContainerSection.style.display = "none";
          currentContenedor = cont;
          let dataObj = excelDataGlobal[fileName];
          let arr = dataObj.data;
          let matched = arr.filter(r => String(r.CONTENEDOR || "").trim().toUpperCase() === cont);
          if (matched.length === 0) {
            Swal.fire({
              icon: "info",
              title: "Sin registros",
              html: `<i class="material-icons" style="color:#2196F3;">info</i> No se encontraron registros para el contenedor ${cont}`
            });
            return;
          }
          currentContainerRecords = matched;
          if (selectedFileToWorkEl) selectedFileToWorkEl.textContent = fileName;
          currentFileName = fileName;
          let closedBy = dataObj.closedContainers && dataObj.closedContainers[cont] ? dataObj.closedContainers[cont] : "";
          if (closedBy) {
            lastUserUpdateEl.textContent = `Contenedor ${cont} cerrado por: ${closedBy}`;
            inputScanCode.disabled = true;
            btnCerrarContenedor.innerHTML = `<i class="material-icons" style="vertical-align:middle;">lock_open</i> Abrir Contenedor`;
          } else {
            let lastU = dataObj.lastUser || "Desconocido";
            let store = dataObj.lastUserStore || "?";
            let role = dataObj.lastUserRole || "?";
            lastUserUpdateEl.textContent = `Último cambio por: ${lastU} (Tienda: ${store}, Rol: ${role})`;
            inputScanCode.disabled = (currentEmployeeNumber === "");
            btnCerrarContenedor.innerHTML = `<i class="material-icons" style="vertical-align:middle;">lock</i> Cerrar Contenedor`;
          }
          containerResultsSection.style.display = "block";
          scanEntrySection.style.display = "block";

          // Mostrar sección de descarga también a vendedores
          if (
            currentUser &&
            (
              currentUser.uid === ADMIN_UID ||
              ["admin", "jefe", "auxiliar", "vendedor"].includes(currentUserRole)
            )
          ) {
            downloadSection.style.display = "block";
          } else {
            downloadSection.style.display = "none";
          }

          document.getElementById("containerHeader").innerHTML = `<i class="material-icons" style="vertical-align:middle;">inventory_2</i> Detalles del Contenedor (${cont})`;
          mostrarDetallesContenedor(currentContainerRecords);
          inputScanCode.focus();
        }
// =========================================================================
// SECCIÓN: CERRAR / REABRIR CONTENEDOR (MEJORADA)
// =========================================================================

// --- PASO 1: Funciones de ayuda para crear los modales ---

/** Muestra el modal de confirmación para REABRIR un contenedor. */
function showReopenConfirmationModal(containerName, closedBy) {
    return Swal.fire({
        html: `
            <div class="modal-header-status status-reopen">
                <i class="material-icons">lock_open</i>
                <h3>Reabrir Contenedor</h3>
            </div>
            <div class="confirmation-modal-content">
                <p class="main-text">
                    El contenedor <strong>${containerName}</strong> fue cerrado por <strong class="closed-by-user">${closedBy}</strong>.
                </p>
                <p class="text-muted small">Al reabrirlo, podrás registrar mercancía faltante. Se volverá a cerrar automáticamente si cambias de contenedor.</p>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Sí, Reabrir',
        cancelButtonText: 'Cancelar',
        width: "550px",
        padding: 0,
        customClass: {
            confirmButton: 'btn-confirm-custom', // Reutilizamos clases de botones
            cancelButton: 'btn-cancel-custom'
        }
    });
}

/** Muestra el modal de confirmación para CERRAR un contenedor. */
function showCloseConfirmationModal(containerName, summaryHTML) {
    return Swal.fire({
        html: `
            <div class="modal-header-status status-close">
                <i class="material-icons">lock</i>
                <h3>Cerrar Contenedor</h3>
            </div>
            <div class="confirmation-modal-content">
                <p class="main-text">¿Estás seguro de que deseas cerrar el contenedor <strong>${containerName}</strong>?</p>
                <div class="summary-card">${summaryHTML}</div>
                <p class="text-muted small">Una vez cerrado, no podrás escanear más productos en él a menos que lo reabras.</p>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Sí, Cerrar',
        cancelButtonText: 'Cancelar',
        width: "600px",
        padding: 0,
        customClass: {
            confirmButton: 'btn-confirm-custom',
            cancelButton: 'btn-cancel-custom'
        }
    });
}

/** Muestra el resumen final DESPUÉS de cerrar un contenedor. */
function showFinalSummaryModal(containerName, summaryHTML, closedBy) {
    Swal.fire({
        html: `
            <div class="modal-header-status status-close">
                <i class="material-icons">check_circle</i>
                <h3>Contenedor Cerrado</h3>
            </div>
            <div class="confirmation-modal-content">
                <p class="main-text">
                    El contenedor <strong>${containerName}</strong> ha sido cerrado con éxito por <strong class="closed-by-user">${closedBy}</strong>.
                </p>
                <p>Este es el resumen final:</p>
                <div class="summary-card">${summaryHTML}</div>
            </div>
        `,
        confirmButtonText: "Entendido",
        width: "600px",
        padding: 0
    });
}


// --- PASO 2: El Event Listener principal, ahora mucho más limpio ---

btnCerrarContenedor.addEventListener("click", async () => {
    const fn = selectedFileToWorkEl.textContent;
    // Validaciones iniciales (mejoradas con nuestras alertas estándar)
    if (!fn || !excelDataGlobal[fn] || !currentContenedor) {
        return showNotFoundAlert("contenedor abierto para realizar esta acción");
    }

    const dataObj = excelDataGlobal[fn];
    const isClosed = dataObj.closedContainers && dataObj.closedContainers[currentContenedor];

    if (isClosed) {
        // --- Flujo para REABRIR ---
        const closedBy = dataObj.closedContainers[currentContenedor];
        const { isConfirmed } = await showReopenConfirmationModal(currentContenedor, closedBy);

        if (isConfirmed) {
            delete dataObj.closedContainers[currentContenedor];
            excelDataGlobal[fn] = dataObj;
            await reuploadFileWithScannerChanges(fn);
            
            Swal.fire({ icon: "success", title: "¡Reabierto!", text: `El contenedor ${currentContenedor} está listo para escanear de nuevo.`, timer: 2000, showConfirmButton: false });

            inputScanCode.disabled = false;
            btnCerrarContenedor.innerHTML = `<i class="material-icons">lock</i> Cerrar Contenedor`;
        }
    } else {
        // --- Flujo para CERRAR ---
        const summary = getContainerSummaryDetailed(currentContainerRecords);
        const { isConfirmed } = await showCloseConfirmationModal(currentContenedor, summary);

        if (isConfirmed) {
            if (!dataObj.closedContainers) dataObj.closedContainers = {};
            const userIdentifier = currentUser.email || currentUser.uid;
            dataObj.closedContainers[currentContenedor] = userIdentifier;
            excelDataGlobal[fn] = dataObj;
            
            await reuploadFileWithScannerChanges(fn);

            inputScanCode.disabled = true;
            btnCerrarContenedor.innerHTML = `<i class="material-icons">lock_open</i> Reabrir Contenedor`;
            
            // --- ¡Alerta única y mejorada! ---
            // Mostramos el resumen final en lugar de dos alertas separadas.
            showFinalSummaryModal(currentContenedor, summary, userIdentifier);
        }
    }
});
// =========================================================================
// SECCIÓN: REGISTRO DE PIEZAS (SCAN) - MEJORADA
// =========================================================================

// --- PASO 1: Funciones de ayuda para la interfaz de usuario ---

/** Muestra un toast de éxito rápido tras un escaneo correcto. */
function showScanSuccessToast(sku, newCount) {
    Swal.fire({
        toast: true,
        position: 'top-end',
        icon: 'success',
        title: `+1 ${sku} (Total: ${newCount})`,
        showConfirmButton: false,
        timer: 1500, // Desaparece en 1.5 segundos
        customClass: { popup: 'scan-success-toast' }
    });
}

/** Muestra un toast de error no bloqueante. */
function showScanErrorToast(title, text) {
    Swal.fire({
        toast: true,
        position: 'top-end',
        icon: 'error',
        title: title,
        text: text,
        showConfirmButton: false,
        timer: 2500,
        customClass: { popup: 'scan-error-toast' }
    });
}

/** Muestra el modal para confirmar si se añade un nuevo artículo. */
function showAddItemConfirmation(code) {
    return Swal.fire({
        html: `
            <div class="modal-header-status status-reopen" style="background-color: #9C27B0;">
                <i class="material-icons">add_shopping_cart</i>
                <h3>Artículo No Encontrado</h3>
            </div>
            <div class="confirmation-modal-content">
                <p class="main-text">El artículo <strong>${code}</strong> no existe en este contenedor.</p>
                <p>¿Deseas añadirlo como un nuevo registro con Cantidad SAP = 0?</p>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Sí, Añadir',
        cancelButtonText: 'Cancelar',
        width: "550px",
        padding: 0,
        customClass: {
            confirmButton: 'btn-confirm-custom',
            cancelButton: 'btn-cancel-custom'
        }
    });
}

/** Muestra el modal para elegir entre múltiples coincidencias. */
function showMultipleMatchesModal(code, matchingRows) {
    // Reutilizamos nuestras tarjetas de resultados
    const html = matchingRows.map((row, idx) => `
        <div class="result-item-card">
            <div class="item-info">
                <div class="item-title">
                    <i class="material-icons text-primary">sell</i>
                    ${row.SKU || 'SKU no definido'}
                </div>
                <div class="item-meta">
                    <strong>Descripción:</strong> ${row.DESCRIPCION || '(sin descripción)'}
                </div>
            </div>
            <button class="btn btn-primary btn-sm btn-choose" onclick="window.chooseRow(${idx})">
                <i class="material-icons">touch_app</i> Seleccionar
            </button>
        </div>
    `).join('');

    Swal.fire({
        title: "Múltiples Coincidencias",
        html: `<p>Se encontraron varios registros para el código <strong>${code}</strong>. Por favor, selecciona el correcto:</p>
               <div class="results-list-container">${html}</div>`,
        showConfirmButton: false,
        width: "650px"
    });
}


// --- PASO 2: La lógica principal de manejo de escaneo ---

/** Incrementa el contador de un artículo y notifica al usuario. */
async function incrementRowAndNotify(row, code) {
    // Tu lógica original para incrementar la fila (se mantiene)
    row.SCANNER = (Number(row.SCANNER) || 0) + 1;
    row.FECHA_ESCANEO = new Date();
    row.LAST_SCANNED_BY = currentUser.email || currentUser.uid;
    // ... cualquier otra lógica que tuvieras en incrementRow ...

    // Mostramos el toast de éxito
    showScanSuccessToast(row.SKU || code, row.SCANNER);

    // Actualizamos la vista de detalles del contenedor
    mostrarDetallesContenedor(currentContainerRecords);
    
    // Guardamos los cambios en el archivo
    await reuploadFileWithScannerChanges(selectedFileToWorkEl.textContent);
}

/** El manejador central que decide qué hacer con un código escaneado. */
async function handleScanCode(code) {
    // --- Validaciones (Guard Clauses) ---
    if (!currentEmployeeNumber || employeeNumberInput.value.trim().length !== 8) {
        return showScanErrorToast('Falta # de Empleado', 'Debes ingresar 8 dígitos.');
    }
    if (!currentContenedor || !currentContainerRecords.length) {
        return showScanErrorToast('Sin Contenedor', 'No hay un contenedor abierto.');
    }
    const fn = selectedFileToWorkEl.textContent;
    if (!fn || !excelDataGlobal[fn]) {
        return showScanErrorToast('Sin Archivo', 'No hay un manifiesto abierto.');
    }
    const dataObj = excelDataGlobal[fn];
    if (dataObj.closedContainers?.[currentContenedor]) {
        return showScanErrorToast('Contenedor Cerrado', 'No se puede editar.');
    }

    // --- Lógica de Búsqueda y Acción ---
    const matchingRows = currentContainerRecords.filter(r => 
        String(r.SKU || "").trim().toUpperCase() === code || 
        String(r.EUROPEO || "").trim().toUpperCase() === code
    );

    if (matchingRows.length === 0) {
        // Caso 1: No se encuentra el artículo
        const { isConfirmed } = await showAddItemConfirmation(code);
        if (isConfirmed) {
            const newRow = { /* ... tu objeto newRow se mantiene igual ... */ };
            dataObj.data.push(newRow);
            dataObj.lastUser = currentUser.email || currentUser.uid;
            excelDataGlobal[fn] = dataObj;
            currentContainerRecords.push(newRow);
            await reuploadFileWithScannerChanges(fn);
            mostrarDetallesContenedor(currentContainerRecords);
            Swal.fire({ icon: "success", title: "¡Añadido!", text: `Se añadió ${code} al contenedor.` });
        }
    } else if (matchingRows.length === 1) {
        // Caso 2: Se encuentra un único artículo (el más común)
        await incrementRowAndNotify(matchingRows[0], code);
    } else {
        // Caso 3: Múltiples coincidencias para el mismo código
        showMultipleMatchesModal(code, matchingRows);
        window.chooseRow = (index) => {
            Swal.close();
            incrementRowAndNotify(matchingRows[index], code);
        };
    }
}


// --- PASO 3: Los nuevos event listeners, unificados y eficientes ---

function scanInputHandler() {
    let val = inputScanCode.value.trim().toUpperCase();
    // Validamos la longitud del código escaneado
    if (val && ((val.length >= 5 && val.length <= 10) || (val.length >= 12))) {
        handleScanCode(val);
        inputScanCode.value = "";
    }
}

// Un scanner de códigos de barras normalmente simula un 'Enter' al final.
// Por eso, este es nuestro listener principal.
inputScanCode.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
        e.preventDefault(); // Evita que el 'Enter' envíe un formulario si lo hubiera
        clearTimeout(debounceTimerScan); // Limpiamos cualquier timer pendiente
        scanInputHandler();
    }
});

// El listener de 'paste' es útil si se copia y pega el código manualmente.
inputScanCode.addEventListener("paste", (e) => {
    e.preventDefault();
    const pastedText = (e.clipboardData || window.clipboardData).getData('text');
    inputScanCode.value = pastedText;
    scanInputHandler();
});

// Mantenemos un debounce para el 'keyup' como un respaldo, pero con menos tiempo.
inputScanCode.addEventListener("keyup", (e) => {
    if (e.key !== 'Enter') {
        clearTimeout(debounceTimerScan);
        debounceTimerScan = setTimeout(() => {
            scanInputHandler();
        }, 800); // 800ms es un tiempo más razonable para una pausa al teclear.
    }
});

        // **MODIFICACIÓN**: En vez de reescribir el XLSX en cada escaneo,
        // solo actualizamos la interfaz y dejamos el reupload para el cierre.
/***********************************************************
 * incrementRow (ahora asigna FECHA_ESCANEO correctamente)
 ***********************************************************/
 function incrementRow(rowObj, code) {
  const now = new Date();

  // Incrementar contador y asignar metadatos
  rowObj.SCANNER         = (rowObj.SCANNER || 0) + 1;
  rowObj.LAST_SCANNED_BY = currentUser.email || currentUser.uid;
  rowObj.FECHA_ESCANEO   = now;                     // ← asignación de fecha de escaneo

  if (!rowObj.ENTREGADO_A) {
    rowObj.ENTREGADO_A = currentEmployeeNumber;
  }

  // Actualizar último usuario en memoria
  const dataObj = excelDataGlobal[currentFileName];
  dataObj.lastUser = rowObj.LAST_SCANNED_BY;
  excelDataGlobal[currentFileName] = dataObj;

  // Refrescar UI
  currentContainerRecords = dataObj.data.filter(x =>
    String(x.CONTENEDOR || "").trim().toUpperCase() === currentContenedor
  );
  mostrarDetallesContenedor(currentContainerRecords);

  // Toast de confirmación
  Swal.fire({
    toast: true,
    position: "top-end",
    icon: "success",
    title: `+1 para ${code}`,
    showConfirmButton: false,
    timer: 1500,
    timerProgressBar: true
  });
}
// =========================================================================
// SECCIÓN: MOSTRAR DETALLES EN TABLA (OPTIMIZADA)
// =========================================================================

function mostrarDetallesContenedor(registros) {
    // Si no hay registros, limpiamos y salimos.
    if (!registros || registros.length === 0) {
        containerDetailsEl.innerHTML = "";
        return;
    }

    // --- ¡MEJORA DE RENDIMIENTO! ---
    // Construimos toda la tabla como una cadena de texto HTML. Es mucho más rápido.
    const headers = [
        "Fecha", "Sección", "Manifiesto", "Contenedor", "SKU", "Europeo",
        "Descripción", "SAP", "SCANNER", "Diferencia", "Fecha Escaneo",
        "Condiciones", "Foto", "Acciones"
    ];

    const tableHTML = `
        <div class="table-responsive-wrapper">
            <table class="table table-bordered table-striped table-hover details-table">
                <thead>
                    <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                </thead>
                <tbody>
                    ${registros.map(r => {
                        const sku = String(r.SKU || "").toUpperCase();
                        const SAP = r.SAP || 0;
                        const SCANNER = r.SCANNER || 0;
                        
                        // Lógica para determinar la clase y texto de la diferencia
                        let diffClass = '';
                        let diffText = '';
                        if (SCANNER === SAP) {
                            diffClass = 'is-ok';
                            diffText = 'OK';
                        } else if (SCANNER < SAP) {
                            diffClass = 'is-missing';
                            diffText = `FALTAN ${SAP - SCANNER}`;
                        } else {
                            diffClass = 'is-excess';
                            diffText = `EXCESO: ${SCANNER - SAP}`;
                        }

                        // --- ¡CLAVE! --- Asignamos IDs únicos a las filas y celdas que actualizaremos.
                        return `
                            <tr id="row-${sku}">
                                <td>${r.FECHA ? formatFecha(r.FECHA) : ""}</td>
                                <td>${r.SECCION || ""}</td>
                                <td>${r.MANIFIESTO || ""}</td>
                                <td>${r.CONTENEDOR || ""}</td>
                                <td>${sku}</td>
                                <td>${String(r.EUROPEO || "").toUpperCase()}</td>
                                <td>${r.DESCRIPCION || ""}</td>
                                <td>${SAP}</td>
                                <td id="scanner-cell-${sku}">${SCANNER}</td>
                                <td id="diff-cell-${sku}"><div class="diff-status ${diffClass}">${diffText}</div></td>
                                <td>${r.FECHA_ESCANEO ? formatFecha(r.FECHA_ESCANEO) : ""}</td>
                                <td>
                                    <button class="btn ${r.DANIO_CANTIDAD > 0 ? 'btn-warning' : 'btn-outline-warning'} btn-circle btn-anim btnDanio" data-sku="${sku}" title="Reportar daño">
                                        <i class="material-icons">warning</i>
                                        ${r.DANIO_CANTIDAD > 0 ? `<span class="badge bg-white text-dark">${r.DANIO_CANTIDAD}</span>` : ''}
                                    </button>
                                </td>
                                <td>
                                    ${r.DANIO_FOTO_URL ? `
                                        <button class="btn btn-info btn-circle btn-anim btnFoto" data-url="${r.DANIO_FOTO_URL}" title="Ver foto">
                                            <i class="material-icons">image</i>
                                        </button>` : `<span class="text-muted">-</span>`}
                                </td>
                                <td>
                                    <button class="btn btn-danger btn-circle btn-anim removeOneBtn" data-sku="${sku}" title="Restar 1 pieza">
                                        <i class="material-icons">remove</i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;

    // Dibujamos la tabla en el DOM una sola vez.
    containerDetailsEl.innerHTML = tableHTML;

    // --- Mantenemos la delegación de eventos, que es una buena práctica ---
    
    // Evento para abrir modal de daños
    containerDetailsEl.querySelectorAll(".btnDanio").forEach(btn => {
        btn.addEventListener("click", () => {
            currentDanioSKU = btn.dataset.sku || "";
            danioCantidadInput.value = "1";
            danioFotoInput.value = "";
            modalDanios.show();
        });
    });

    // Evento para abrir foto de daño
    containerDetailsEl.querySelectorAll(".btnFoto").forEach(btn => {
        btn.addEventListener("click", () => window.open(btn.dataset.url, "_blank"));
    });

    // --- ¡MEJORA DE ACTUALIZACIÓN INTELIGENTE! ---
    // Evento para restar una pieza
    containerDetailsEl.querySelectorAll(".removeOneBtn").forEach(btn => {
        btn.addEventListener("click", () => {
            const sku = btn.dataset.sku;
            const fn = selectedFileToWorkEl.textContent;
            const dataObj = excelDataGlobal[fn];
            const rowObj = dataObj.data.find(x => String(x.SKU || "").trim().toUpperCase() === sku && String(x.CONTENEDOR || "").trim().toUpperCase() === currentContenedor);
            
            if (!rowObj || (rowObj.SCANNER || 0) === 0) return;

            // 1. Actualizar datos en memoria
            rowObj.SCANNER -= 1;
            // ... (el resto de tu lógica de actualización de datos se mantiene)

            // 2. Persistir en segundo plano (igual que antes)
            reuploadFileWithScannerChanges(fn).catch(e => console.error(e));

            // 3. ¡Actualizar solo la UI necesaria, sin redibujar todo!
            const scannerCell = document.getElementById(`scanner-cell-${sku}`);
            const diffCell = document.getElementById(`diff-cell-${sku}`);
            const rowElement = document.getElementById(`row-${sku}`);

            if (scannerCell && diffCell && rowElement) {
                scannerCell.textContent = rowObj.SCANNER;

                // Re-calculamos la diferencia y actualizamos su celda
                const SAP = rowObj.SAP || 0;
                let diffClass = '', diffText = '';
                if (rowObj.SCANNER === SAP) { diffClass = 'is-ok'; diffText = 'OK'; }
                else if (rowObj.SCANNER < SAP) { diffClass = 'is-missing'; diffText = `FALTAN ${SAP - rowObj.SCANNER}`; }
                else { diffClass = 'is-excess'; diffText = `EXCESO: ${rowObj.SCANNER - SAP}`; }
                diffCell.innerHTML = `<div class="diff-status ${diffClass}">${diffText}</div>`;
                
                // Animación para feedback visual
                rowElement.classList.add('row-updated');
                setTimeout(() => rowElement.classList.remove('row-updated'), 1000);
            }

            // 4. Toast rápido (igual que antes)
            Swal.fire({
                toast: true, position: 'top-end', icon: 'info',
                title: `-1 ${sku}`, showConfirmButton: false, timer: 1200
            });
        });
    });
}
        /***********************************************************
         * MODAL DE CONDICIONES DE LA MCIA
         ***********************************************************/
        btnGuardarDanio.addEventListener("click", async () => {
          let cant = parseInt(danioCantidadInput.value) || 0;
          if (!cant || cant < 1) {
            return Swal.fire({
              icon: "info",
              title: "Cantidad inválida",
              html: `<i class="material-icons" style="color:#2196F3;">info</i> Ingrese una cantidad válida.`
            });
          }
          if (!currentDanioSKU) {
            return Swal.fire({
              icon: "info",
              title: "Error interno",
              html: `<i class="material-icons" style="color:#2196F3;">info</i> No se puede guardar condiciones sin SKU.`
            });
          }
          let fn = selectedFileToWorkEl.textContent;
          let dataObj = excelDataGlobal[fn];
          let arr = dataObj.data;
          let rowObj = arr.find(r => {
            let s = String(r.SKU || "").trim().toUpperCase();
            return s === currentDanioSKU && String(r.CONTENEDOR || "").toUpperCase() === currentContenedor;
          });
          if (!rowObj) {
            return Swal.fire({
              icon: "info",
              title: "No encontrado",
              html: `<i class="material-icons" style="color:#2196F3;">info</i> No se encontró el SKU en el contenedor.`
            });
          }
          rowObj.DANIO_CANTIDAD = cant;
          let file = danioFotoInput.files[0];
          if (file) {
            Swal.fire({ title: "Subiendo foto...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            let safeSKU = currentDanioSKU.replace(/[^a-zA-Z0-9]/g, '_');
            let ts = Date.now();
            let filePath = `Evidencias/${fn}/${currentContenedor}/${safeSKU}_${ts}.jpg`;
            let ref = storage.ref(filePath);
            let snap = await ref.put(file);
            rowObj.DANIO_FOTO_URL = await snap.ref.getDownloadURL();
          }
          rowObj.LAST_SCANNED_BY = currentUser.email || currentUser.uid;
          dataObj.lastUser = rowObj.LAST_SCANNED_BY;
          excelDataGlobal[fn] = dataObj;
          try {
            await reuploadFileWithScannerChanges(fn);
            currentContainerRecords = arr.filter(z =>
              String(z.CONTENEDOR || "").toUpperCase() === currentContenedor
            );
            mostrarDetallesContenedor(currentContainerRecords);
            Swal.fire({
              icon: "success",
              title: "Condiciones registradas",
              html: `<i class="material-icons" style="color:#4CAF50;">check_circle</i> Se guardó la información.`
            });
            modalDanios.hide();
          } catch (e) {
            console.error(e);
            Swal.fire({
              icon: "error",
              title: "Error",
              html: `<i class="material-icons" style="color:#F44336;">error</i> No se pudo subir la info de condiciones.`
            });
          }
        });

        /***********************************************************
         * DESCARGAR ARCHIVO
         ***********************************************************/
        document.getElementById("btnDescargarArchivo").addEventListener("click", () => {
          let fn = selectedFileToWorkEl.textContent;
          if (!fn || !excelDataGlobal[fn]) {
            return Swal.fire({
              icon: "error",
              title: "Error",
              html: `<i class="material-icons" style="color:#F44336;">error</i> No hay archivo para descargar.`
            });
          }
          descargarArchivoTotal(fn);
        });
        function descargarArchivoTotal(fileName) {
          let dataObj = excelDataGlobal[fileName];
          if (!dataObj || !dataObj.data) {
            return Swal.fire({
              icon: "error",
              title: "Error",
              html: `<i class="material-icons" style="color:#F44336;">error</i> No hay datos para descargar.`
            });
          }
          let arr = dataObj.data.slice();
          arr.sort((a, b) => {
            let ca = String(a.CONTENEDOR || "").trim().toUpperCase();
            let cb = String(b.CONTENEDOR || "").trim().toUpperCase();
            if (ca < cb) return -1;
            if (ca > cb) return 1;
            return String(a.SKU||"").localeCompare(String(b.SKU||""));
          });
          arr = arr.map(r => {
            if (r.SCANNER > 0) r.ENTREGADO_A = r.ENTREGADO_A || currentEmployeeNumber;
            return r;
          });
          let exportData = arr.map(r => {
            let SAP = r.SAP || 0;
            let SCANNER = r.SCANNER || 0;
            let diff = (SCANNER === SAP) ? "OK"
                     : (SCANNER < SAP) ? `FALTAN ${SAP - SCANNER} piezas`
                     : `MERCANCIA DE MAS: ${SCANNER - SAP} piezas`;
            return {
              FECHA: formatFecha(r.FECHA),
              SECCION: r.SECCION || "",
              MANIFIESTO: r.MANIFIESTO || "",
              CONTENEDOR: r.CONTENEDOR || "",
              SKU: r.SKU || "",
              EUROPEO: r.EUROPEO || "",
              DESCRIPCION: r.DESCRIPCION || "",
              SAP,
              SCANNER,
              LAST_SCANNED_BY: r.LAST_SCANNED_BY || "",
              ENTREGADO_A: r.ENTREGADO_A || "",
              DIFERENCIA: diff,
              "Fecha de Escaneo": r.FECHA_ESCANEO ? formatFecha(r.FECHA_ESCANEO) : "",
              "CONDICIONES_MCIA": r.DANIO_CANTIDAD || 0,
              "FOTO_CONDICIONES": r.DANIO_FOTO_URL || ""
            };
          });
          let ws = XLSX.utils.json_to_sheet(exportData, {
            header: [
              "FECHA","SECCION","MANIFIESTO","CONTENEDOR","SKU","EUROPEO",
              "DESCRIPCION","SAP","SCANNER","LAST_SCANNED_BY","ENTREGADO_A",
              "DIFERENCIA","Fecha de Escaneo","CONDICIONES_MCIA","FOTO_CONDICIONES"
            ]
          });
          let wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
          let wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
          let blob = new Blob([wbout], { type: "application/octet-stream" });
          let url = URL.createObjectURL(blob);
          let a = document.createElement("a");
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          Swal.fire({
            icon: "success",
            title: "Descargado",
            html: `<i class="material-icons" style="color:#4CAF50;">check_circle</i> Archivo descargado.`
          });
        }

        /***********************************************************
         * ANÁLISIS GLOBAL
         ***********************************************************/
        btnAnalisisGlobal.addEventListener("click", () => {
          let fn = selectedFileToWorkEl.textContent;
          if (!fn || !excelDataGlobal[fn]) {
            return Swal.fire({
              icon: "error",
              title: "Error",
              html: `<i class="material-icons" style="color:#F44336;">error</i> No hay registros para analizar.`
            });
          }
          let data = excelDataGlobal[fn].data;
          let closed = excelDataGlobal[fn].closedContainers || {};
          let secciones = Array.from(new Set(data.map(r => String(r.SECCION || "").trim().toUpperCase()))).filter(s => s);
          let selectHTML = '<label class="form-label"><strong>Filtrar por Sección:</strong></label><select class="form-select" id="selectSeccion"><option value="">(Todas)</option>';
          secciones.forEach(sec => {
            selectHTML += `<option value="${sec}">${sec}</option>`;
          });
          selectHTML += '</select>';
          let inputContHTML = '<input type="text" id="analysisSearchContInput" class="form-control mt-2" placeholder="Buscar Contenedor...">';
          let containerHTML = `<div class="global-analysis-content" id="analysisContainer">${getContainerAnalysis(data, closed)}</div>`;
          Swal.fire({
            title: `<i class="material-icons" style="vertical-align:middle;">analytics</i> Análisis Global`,
            html: `<div>${selectHTML}${inputContHTML}</div>${containerHTML}`,
            icon: "info",
            confirmButtonText: "Cerrar",
            width: "600px",
            customClass: { popup: "swal2-popup global-analysis" }
          });
          setTimeout(() => {
            let sel = document.getElementById("selectSeccion");
            let cont = document.getElementById("analysisContainer");
            let inputCont = document.getElementById("analysisSearchContInput");
            sel.addEventListener("change", () => {
              let val = sel.value.trim().toUpperCase();
              let filtered = (val === "" ? data : data.filter(r => String(r.SECCION || "").trim().toUpperCase() === val));
              cont.innerHTML = getContainerAnalysis(filtered, closed);
            });
            inputCont.addEventListener("input", () => {
              let text = inputCont.value.trim().toUpperCase();
              let groups = {};
              data.forEach(r => {
                let c = String(r.CONTENEDOR || "").trim().toUpperCase() || "SIN CONTENEDOR";
                if (!groups[c]) groups[c] = [];
                groups[c].push(r);
              });
              let html = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px;">`;
              for (let c in groups) {
                if (c.includes(text) || text === "") {
                  let closedFlag = closed && closed[c] ? true : false;
                  html += `<div class="analysis-box" style="padding:10px;border-radius:8px;${closedFlag ? "border:2px solid red;background:rgba(255,0,0,0.1);" : "border:1px solid rgba(255,255,255,0.5);background:rgba(0,0,0,0.1);"}">
                              <h5 style="margin-bottom:8px;">
                                <i class="material-icons" style="vertical-align:middle; font-size:1.3rem; ${closedFlag ? "color:red;" : ""}">inventory_2</i>
                                Contenedor: ${c} ${closedFlag ? '<span style="color:red;font-weight:bold;">(CERRADO)</span>' : ''}
                              </h5>
                              ${getContainerSummaryDetailed(groups[c])}
                            </div>`;
                }
              }
              html += `</div>`;
              cont.innerHTML = html;
            });
          }, 100);
        });
        function getContainerAnalysis(records, closedContainers) {
          let groups = {};
          records.forEach(r => {
            let c = String(r.CONTENEDOR || "").trim().toUpperCase() || "SIN CONTENEDOR";
            if (!groups[c]) groups[c] = [];
            groups[c].push(r);
          });
          let html = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px;">`;
          for (let c in groups) {
            let closed = closedContainers && closedContainers[c] ? true : false;
            html += `<div class="analysis-box" style="padding:10px;border-radius:8px;${closed ? "border:2px solid red;background:rgba(255,0,0,0.1);" : "border:1px solid rgba(255,255,255,0.5);background:rgba(0,0,0,0.1);"}">
                        <h5 style="margin-bottom:8px;">
                          <i class="material-icons" style="vertical-align:middle; font-size:1.3rem; ${closed ? "color:red;" : ""}">inventory_2</i>
                          Contenedor: ${c} ${closed ? '<span style="color:red;font-weight:bold;">(CERRADO)</span>' : ''}
                        </h5>
                        ${getContainerSummaryDetailed(groups[c])}
                      </div>`;
          }
          html += "</div>";
          return html;
        }
        function getContainerSummaryDetailed(recs) {
          let totalRecords = recs.length;
          let assignedUsers = new Set();
          let workers = new Set();
          let dates = [];
          let sapSum = 0, scannerSum = 0;
          let completeCount = 0, totalMissing = 0, totalExtra = 0;
          recs.forEach(r => {
            let sap = Number(r.SAP) || 0;
            let sc = Number(r.SCANNER) || 0;
            sapSum += sap;
            scannerSum += sc;
            if (r.ENTREGADO_A) assignedUsers.add(r.ENTREGADO_A);
            if (r.LAST_SCANNED_BY) workers.add(r.LAST_SCANNED_BY);
            if (r.FECHA_ESCANEO) {
              let d = new Date(r.FECHA_ESCANEO);
              if (!isNaN(d.getTime())) dates.push(d);
            }
            if (sc >= sap) {
              completeCount++;
              if (sc > sap) totalExtra += (sc - sap);
            } else {
              totalMissing += (sap - sc);
            }
          });
          let status = "INCOMPLETO";
          if (totalMissing === 0 && totalExtra > 0) {
            status = "COMPLETO CON MERCANCÍA DE MÁS";
          } else if (completeCount === totalRecords && totalExtra === 0) {
            status = "COMPLETO";
          }
          let dateInfo = "N/A";
          if (dates.length > 0) {
            let minDate = new Date(Math.min(...dates));
            let maxDate = new Date(Math.max(...dates));
            dateInfo = `${formatFecha(minDate)} - ${formatFecha(maxDate)}`;
          }
          let completionInfo = "N/A";
          if (status === "INCOMPLETO" || status === "COMPLETO CON MERCANCÍA DE MÁS") {
            let lastDate = (dates.length > 0) ? new Date(Math.max(...dates)) : new Date();
            let lastWorker = Array.from(workers).pop() || "N/A";
            completionInfo = `${lastWorker} el ${formatFecha(lastDate)}`;
          } else {
            completionInfo = (workers.size === 1) ? Array.from(workers)[0] : `Varios (${Array.from(workers).join(", ")})`;
          }
          return `
            <div style="font-size:0.95rem; display:flex; flex-direction:column; gap:4px;">
              <div class="analysis-item">
                <i class="material-icons" style="color:#666;">apps</i>
                <strong>SKUs en contenedor:</strong> ${totalRecords}
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:#8E44AD;">receipt_long</i>
                <strong>Piezas Totales (SAP):</strong> ${sapSum}
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:#27AE60;">fact_check</i>
                <strong>Piezas Escaneadas:</strong> ${scannerSum}
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:#2980B9;">check_box</i>
                <strong>SKUs Completos:</strong> ${completeCount} ${totalExtra > 0 ? `(con ${totalExtra} piezas de más)` : ""} 
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:${totalMissing > 0 ? "#E74C3C" : "#95A5A6"};">remove_circle</i>
                <strong>Faltan piezas:</strong> ${totalMissing}
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:${totalExtra > 0 ? "#F1C40F" : "#95A5A6"};">add_circle</i>
                <strong>Excedentes:</strong> ${totalExtra} ${totalExtra > 0 ? "<em style='font-size:0.85rem;color:#555;'>(piezas agregadas de más)</em>" : ""} 
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:#16A085;">person</i>
                <strong>Asignados a:</strong> ${Array.from(assignedUsers).join(", ") || "N/A"}
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:#34495E;">engineering</i>
                <strong>Trabajado por:</strong> ${Array.from(workers).join(", ") || "N/A"}
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:#CD6155;">date_range</i>
                <strong>Fechas de escaneo:</strong> ${dateInfo || "N/A"}
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:${status === "COMPLETO" ? "#2ECC71" : "#E74C3C"};">info</i>
                <strong>Estado:</strong> ${status}
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:${status === "COMPLETO" ? "#2ECC71" : "#E74C3C"};">person</i>
                <strong>${status === "COMPLETO" ? "Completado por:" : "Última actualización:"}</strong> ${completionInfo}
              </div>
            </div>
          `;
        }
        function getContainerStateFromRecords(records) {
          let totalMissing = 0, totalExtra = 0, completeCount = 0;
          let totalRecords = records.length;
          records.forEach(r => {
            let sap = Number(r.SAP) || 0;
            let sc = Number(r.SCANNER) || 0;
            if (sc >= sap) {
              completeCount++;
              if (sc > sap) totalExtra += (sc - sap);
            } else {
              totalMissing += (sap - sc);
            }
          });
          if (totalMissing === 0 && totalExtra > 0) {
            return "COMPLETO CON MERCANCÍA DE MÁS";
          } else if (completeCount === totalRecords && totalExtra === 0) {
            return "COMPLETO";
          }
          return "INCOMPLETO";
        }
        function formatFecha(fecha) {
  // Si es instancia de Date, usamos el día local sin correction de zona
  if (fecha instanceof Date && !isNaN(fecha.getTime())) {
    const dia  = fecha.getDate().toString().padStart(2, "0");
    const mes  = (fecha.getMonth() + 1).toString().padStart(2, "0");
    const anio = fecha.getFullYear();
    return `${dia}/${mes}/${anio}`;
  }
          if (typeof fecha === "string") {
            let d = new Date(fecha);
            if (!isNaN(d.getTime())) {
              let c = new Date(d.getTime() + d.getTimezoneOffset() * 60000);
              let dd = c.getDate().toString().padStart(2, "0");
              let mm = (c.getMonth() + 1).toString().padStart(2, "0");
              let yy = c.getFullYear();
              return `${dd}/${mm}/${yy}`;
            }
            return fecha;
          }
          if (typeof fecha === "number") {
            let d = new Date(Math.round((fecha - 25569) * 86400 * 1000));
            let c = new Date(d.getTime() + d.getTimezoneOffset() * 60000);
            let dd = c.getDate().toString().padStart(2, "0");
            let mm = (c.getMonth() + 1).toString().padStart(2, "0");
            let yy = c.getFullYear();
            return `${dd}/${mm}/${yy}`;
          }
          return "";
        }
        async function reuploadFileWithScannerChanges(fileName) {
          let dataObj = excelDataGlobal[fileName];
          let arr = dataObj.data;
          let ws = XLSX.utils.json_to_sheet(arr);
          let wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
          let wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
          let blob = new Blob([wbout], { type: "application/octet-stream" });
          let storeFolder = (currentUserStore === "ALL") ? "ALL" : currentUserStore;
          let storageRef = storage.ref(`Manifiestos/${storeFolder}/${fileName}`);
          await storageRef.put(blob);
          await db.collection('manifiestos')
  .doc(fileName)
  .set(
    {
      fileName,
      store: storeFolder,
      lastUser: dataObj.lastUser,
      lastUserStore: (dataObj.lastUserStore !== undefined) ? dataObj.lastUserStore : null,
      lastUserRole:  (dataObj.lastUserRole   !== undefined) ? dataObj.lastUserRole   : null,
      closedContainers: dataObj.closedContainers || {},
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    },
    { merge: true }
  );

        }
      });
    })();
  </script>
</body>
</html>