<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manifestar Mercancía - Sistema Liverpool</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <style>
        :root {
            --rosa-principal: #E6007E;
            --negro-fondo: #1a1a1a;
            --blanco: #ffffff;
            --gris-claro: #f8f9fa;
            --gris-medio: #dee2e6;
            --gris-oscuro: #6c757d;
            --texto-principal: #343a40;
            --verde-exito: #43A047;
            --rojo-peligro: #e53935;
            --ios-border-radius: 12px;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: radial-gradient(ellipse at top, #ec208d, var(--negro-fondo));
            color: var(--texto-principal);
            min-height: 100vh;
            background-attachment: fixed;
        }

        /* --- Estructura Principal y Menú --- */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, .2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 1030;
            border-bottom: 1px solid rgba(255, 255, 255, .1);
        }
        .header-title {
            color: var(--blanco);
            font-weight: 700;
            margin: 0;
            font-size: 1.5rem;
        }
        .btn-menu, #logout-btn {
            background: transparent;
            border: 2px solid var(--blanco);
            color: var(--blanco);
            border-radius: 50px;
            width: 45px;
            height: 45px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            transition: all .3s ease;
        }
        .btn-menu:hover, #logout-btn:hover {
            background: var(--blanco);
            color: var(--rosa-principal);
            transform: scale(1.1) rotate(10deg);
        }
        .offcanvas {
            background-color: var(--rosa-principal);
        }
        .offcanvas .nav-link {
            color: var(--blanco);
            font-size: 1.1rem;
            font-weight: 600;
            padding: 1rem 1.5rem;
            transition: background-color .3s ease, padding-left .3s ease;
            border-radius: 0 50px 50px 0;
            display: flex;
            align-items: center;
        }
        .offcanvas .nav-link.active, .offcanvas .nav-link:hover {
            background-color: var(--blanco);
            color: var(--rosa-principal);
            padding-left: 2rem;
        }
        .offcanvas-header {
            border-bottom: 1px solid rgba(255, 255, 255, .2);
        }
        .main-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: clamp(1.5rem, 5vw, 2.5rem);
            background: var(--blanco);
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, .2);
            animation: fadeIn .8s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* --- Estilos de Componentes --- */
        .main-container h2 {
            font-weight: 700;
            color: var(--rosa-principal);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .card {
            border-radius: var(--ios-border-radius);
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--rosa-principal);
            box-shadow: 0 0 0 3px rgba(230, 0, 126, 0.2);
        }

        /* Estilos específicos para la página de manifiestos */
        #dropzone {
            border: 2px dashed var(--rosa-principal);
            border-radius: var(--ios-border-radius);
            background-color: #fafafa;
            padding: 2rem;
            text-align: center;
            color: var(--rosa-principal);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #dropzone:hover {
            transform: scale(1.02);
            background-color: #f5f5f5;
        }
        .progress {
            height: 30px;
            border-radius: 30px;
        }
        
        .table-responsive thead th {
            background-color: var(--texto-principal);
            color: var(--blanco);
            white-space: nowrap;
        }
        .table td, .table th {
            vertical-align: middle;
        }

        /* Estilo para cada elemento de la lista de archivos */
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
            border-left: 5px solid #0d6efd;
            background-color: #ffffff;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .file-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-left-color: #E6007E;
        }
        .file-item-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f3ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 15px;
        }
        .file-item-icon .material-icons {
            color: #0d6efd;
            font-size: 20px;
        }
        .file-info .file-name {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }
        .file-info .file-meta {
            font-size: 0.8rem;
            color: #6c757d;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 4px;
        }
        .file-meta .material-icons {
            font-size: 1rem;
        }
        .action-btn {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-in-out;
            border: none;
        }
        .action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }
        .sort-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        .sort-btn.active {
            background-color: #e7f1ff;
            color: #0d6efd;
            font-weight: 600;
        }

        /* Dashboard PRO */
        .dashboard-container {
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .status-message {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 600;
        }
        .status-message.is-warning { background-color: #fff3cd; color: #664d03; }
        .status-message.is-success { background-color: #d1e7dd; color: #0f5132; }
        .status-message .material-icons { vertical-align: middle; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background-color: #ffffff;
            padding: 16px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
        .stat-card .stat-title { font-size: 0.85rem; color: #6c757d; margin-bottom: 8px; }
        .stat-card .stat-value { font-size: 1.75rem; font-weight: 700; color: #212529; }
        .stat-card.total { border-color: #0d6efd; }
        .stat-card.expected { border-color: #6f42c1; }
        .stat-card.scanned { border-color: #198754; }
        .stat-card.missing { border-color: #dc3545; }
        .stat-card.excess { border-color: #ffc107; }
        .progress-container {
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            height: 24px;
            margin-bottom: 24px;
        }
        .progress-fill {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            transition: width 0.5s ease-in-out;
        }
        .chart-container {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        .faltantes-section .toggle-btn {
            width: 100%;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .faltantes-details {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            font-size: 0.9rem;
        }
        .faltantes-details strong { color: #dc3545; }
        .faltantes-details ul { list-style: none; padding-left: 0; margin-top: 8px; }
        .faltantes-details li {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #f1f1f1;
        }
        .faltantes-details li:last-child { border-bottom: none; }
        .faltantes-details .material-icons { color: #6c757d; }

        /* Modales */
        .change-container-modal { padding: 0; text-align: left; }
        .modal-header-status {
            padding: 16px 24px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .modal-header-status .material-icons { font-size: 2.5rem; }
        .modal-header-status h3 { margin: 0; font-size: 1.5rem; font-weight: 600; }
        .modal-header-status.status-neutral { background-color: #2196F3; }
        .modal-header-status.status-incompleto { background-color: #f44336; }
        .modal-header-status.status-excedente { background-color: #FF9800; }
        .modal-header-status.status-completo { background-color: #4CAF50; }
        .modal-body-content { padding: 24px; }
        .container-summary-card {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }
        .container-summary-card h4 {
            color: #343a40;
            margin-top: 0;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .container-summary-card .summary-content { font-size: 0.95rem; color: #495057; }
        .confirmation-prompt {
            margin-top: 24px;
            font-size: 1.1rem;
            font-weight: 500;
            text-align: center;
            color: #212529;
        }
        .confirmation-prompt .material-icons { vertical-align: bottom; color: #E6007E; }
        .swal2-actions { gap: 12px; }
        .swal2-confirm.btn-confirm-custom,
        .swal2-cancel.btn-cancel-custom {
            border-radius: 8px !important;
            padding: 12px 24px !important;
            font-size: 1rem !important;
            font-weight: 600 !important;
            display: inline-flex !important;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s ease;
        }
        .swal2-confirm.btn-confirm-custom:hover,
        .swal2-cancel.btn-cancel-custom:hover { transform: scale(1.05); }
        .btn-confirm-custom { background-color: #28a745 !important; }
        .btn-cancel-custom { background-color: #6c757d !important; }
        .no-container-alert { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .no-container-alert .material-icons { font-size: 3rem; color: #17a2b8; }
        .search-input-container { position: relative; margin-bottom: 20px; }
        .search-input-container .material-icons {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 24px;
        }
        #inputBusqueda {
            padding: 15px 20px 15px 50px;
            font-size: 1.2rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            transition: all 0.3s ease;
            width: 100%;
        }
        #inputBusqueda:focus {
            border-color: #E6007E;
            box-shadow: 0 0 0 3px rgba(230, 0, 126, 0.2);
        }
        .results-list-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
            margin-top: 16px;
        }
        .result-item-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .result-item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #E6007E;
            padding-left: 13px;
        }
        .result-item-card .item-info .item-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        .result-item-card .item-info .item-meta { font-size: 0.85rem; color: #6c757d; }
        .status-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 700;
            vertical-align: middle;
        }
        .status-badge.is-closed { background-color: #dc3545; color: white; }
        .result-item-card .btn-choose { display: flex; align-items: center; gap: 6px; font-weight: 600; }
        .not-found-container { text-align: center; padding: 20px; }
        .not-found-container .material-icons { font-size: 4rem; color: #6c757d; margin-bottom: 10px; }
        .not-found-container h4 { color: #333; font-weight: 600; }
        .not-found-container p { color: #6c757d; }
        .custom-loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .swal-icon-searching {
            font-size: 5rem;
            color: #0d6efd;
            animation: search-animation 1.5s ease-in-out infinite;
        }
        @keyframes search-animation {
            0% { transform: rotate(-15deg) scale(1); }
            50% { transform: rotate(15deg) scale(1.1); }
            100% { transform: rotate(-15deg) scale(1); }
        }
        .swal-loading-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .swal-loading-phrase {
            font-size: 1rem;
            color: #6c757d;
            height: 30px;
            display: flex;
            align-items: center;
        }
        .confirmation-modal-content { text-align: left; padding: 24px; }
        .modal-header-status {
            padding: 16px 24px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .modal-header-status .material-icons { font-size: 2.5rem; }
        .modal-header-status h3 { margin: 0; font-size: 1.5rem; }
        .modal-header-status.status-close { background-color: #f44336; }
        .modal-header-status.status-reopen { background-color: #4CAF50; }
        .summary-card {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            margin-bottom: 20px;
        }
        .confirmation-modal-content p.main-text { font-size: 1.1rem; color: #333; margin-top: 16px; }
        .confirmation-modal-content .closed-by-user { color: var(--rosa-principal); font-weight: 600; }
        .scan-success-toast { background-color: #28a745 !important; color: white !important; }
        .scan-success-toast .swal2-icon-content { color: white !important; }
        .scan-error-toast { background-color: #dc3545 !important; color: white !important; }
        .scan-error-toast .swal2-icon-content { color: white !important; }
        .table-responsive-wrapper {
            overflow-x: auto;
            border-radius: var(--ios-border-radius, 10px);
            border: 1px solid #dee2e6;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        /* Contenedor principal de la lista de tarjetas */
        .details-list-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .item-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
            border-left: 6px solid;
            padding: 1rem 1.5rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .item-card:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12); }
        .item-card.status-ok { border-color: #20c997; }
        .item-card.status-missing { border-color: #e53935; }
        .item-card.status-excess { border-color: #ffb22d; }
        .item-card.is-new { border-color: var(--rosa-principal); }
        .item-card-main { flex-grow: 1; min-width: 250px; padding-right: 1rem; }
        .item-card-main .sku { font-size: 1.25rem; font-weight: 700; color: var(--texto-principal); }
        .item-card-main .descripcion { font-size: 0.9rem; color: #6c757d; }
        .item-card-stats { display: flex; gap: 1.5rem; margin: 0.5rem 2rem 0.5rem 0; }
        .stat-item { text-align: center; }
        .stat-item .label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
        }
        .stat-item .value { font-size: 1.5rem; font-weight: 700; color: var(--texto-principal); }
        .diff-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            color: white;
        }
        .diff-badge.is-ok { background-color: #20c997; }
        .diff-badge.is-missing { background-color: #e53935; }
        .diff-badge.is-excess { background-color: #ffb22d; color: #212529; }
        .item-card-actions { display: flex; gap: 0.75rem; margin-left: auto; }
        .details-list-container .btn-action {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
            transition: all 0.2s ease;
        }
        .details-list-container .btn-action:hover {
            transform: scale(1.15);
            filter: brightness(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .details-list-container .btn-action.btn-danio { background-color: #ffc107; }
        .details-list-container .btn-action.btn-foto { background-color: #0dcaf0; }
        .details-list-container .btn-action.btn-restar { background-color: #6c757d; }
        .details-list-container .btn-action.btn-eliminar { background-color: #dc3545; }
        .item-card.is-new { border-left: 5px solid var(--rosa-principal); }
        
        /* Estilos de Botones */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border-radius: 8px;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-width: 2px;
            transition: all 0.2s ease-in-out;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        .btn .material-icons { font-size: 1.25rem; }
        .btn-sm { padding: 0.35rem 0.8rem; gap: 0.4rem; }
        .btn-sm .material-icons { font-size: 1.1rem; }
        .btn-primary { background-color: #0d6efd; border-color: #0d6efd; }
        .btn-secondary { background-color: #6c757d; border-color: #6c757d; }
        
        /* Panel de Resultados y Botones Modernos */
        .results-header {
            background-color: #f8f9fa;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .header-info .header-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--texto-principal);
            margin: 0 0 0.25rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .header-info .header-subtitle { font-weight: 600; color: var(--rosa-principal); margin: 0; }
        .header-info .header-meta { font-size: 0.85rem; color: #6c757d; margin: 0.25rem 0 0 0; }
        .header-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .btn-custom {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.25s ease;
            color: white;
        }
        .btn-custom:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); }
        .btn-custom.btn-analisis { background: linear-gradient(45deg, #2193b0, #6dd5ed); }
        .btn-custom.btn-descargar { background: linear-gradient(45deg, #1d976c, #93f9b9); }
        .btn-custom.btn-cambiar { background-color: #6c757d; }
        .btn-custom.btn-cerrar { background: linear-gradient(45deg, #c31432, #240b36); }
        
        /* Detalles extra en tarjetas */
        .item-card-details {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            flex-basis: 100%;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #f1f1f1;
            font-size: 0.8rem;
            color: #6c757d;
        }
        .detail-item { display: flex; align-items: center; gap: 0.4rem; }
        .detail-item .material-icons { font-size: 1.1rem; }
        
        /* Formularios y Zona de Carga */
        .form-card {
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }
        .form-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
        }
        .form-card-header h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--texto-principal);
        }
        .form-card-body { padding: 1.5rem; }
        .form-card-body .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--texto-secundario);
        }
        .form-card-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }
        
        /* Separador de columnas adaptable */
        .border-end-md { border-right: 1px solid var(--gris-borde); }
        @media (max-width: 767px) {
            .border-end-md {
                border-right: none;
                border-bottom: 1px solid var(--gris-borde);
                padding-bottom: 1.5rem;
                margin-bottom: 1.5rem;
            }
        }
        
        /* Inputs y Botones Modernos */
        .form-control-modern {
            width: 100%;
            padding: 0.8rem 1rem;
            font-size: 1rem;
            border-radius: 8px;
            border: 1px solid #ced4da;
            background-color: #f8f9fa;
            transition: all 0.2s ease;
        }
        .form-control-modern:focus {
            background-color: #fff;
            border-color: var(--rosa-principal);
            box-shadow: 0 0 0 3px rgba(230, 0, 126, 0.2);
            outline: none;
        }
        .btn-main {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
        .btn-primary-main { background-color: var(--rosa-principal); color: white; }
        .btn-secondary-main { background-color: #495057; color: white; }
        
        /* Zona de Carga de Archivos Rediseñada */
        #dropzone {
            background-color: #f8f9fa;
            border: 2px dashed #ced4da;
            border-radius: 12px;
            padding: 2rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #dropzone:hover { border-color: var(--rosa-principal); background-color: #fff; }
        #dropzone .material-icons {
            font-size: 3rem;
            color: var(--rosa-principal);
            transition: transform 0.3s ease;
        }
        #dropzone:hover .material-icons { transform: scale(1.1); }
        #dropzone p { margin: 0.5rem 0 0 0; }
        #uploadProgressBar { background-color: var(--rosa-principal); }
        
        /* SweetAlert2 Modificaciones */
        .swal2-popup.dashboard-modal { width: 95% !important; max-width: 1500px !important; }
        .swal2-html-container { padding: 0 !important; }
        .dashboard-pro-container { padding: 1.5rem; font-family: 'Poppins', sans-serif; text-align: left; }
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
        }
        .dashboard-header .title {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .search-filter-controls { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
        #dashboardSearchInput { width: 250px; }
        #statusFilter { width: 180px; }
        .manifest-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            padding-top: 1.5rem;
            max-height: 65vh;
            overflow-y: auto;
            padding-right: 10px;
        }
        .manifest-card-pro {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        .manifest-card-pro .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #f1f1f1;
            background-color: #fafafa;
        }
        .manifest-card-pro .file-name { font-weight: 600; word-break: break-all; }
        .manifest-card-pro .file-store { font-size: 0.85rem; color: #6c757d; }
        .manifest-card-pro .card-body { padding: 1.25rem; }
        .progress-preview { margin-bottom: 1.25rem; }
        .progress-preview .progress-title {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 50px;
            height: 12px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            border-radius: 50px;
            background: linear-gradient(90deg, #1fddff, #0d6efd);
            transition: width 0.5s ease;
        }
        .card-stats {
            display: flex;
            justify-content: space-around;
            text-align: center;
            padding: 1rem 0;
            border-top: 1px solid #f1f1f1;
            margin-top: 1rem;
        }
        .card-stats .stat-value { font-size: 1.25rem; font-weight: 700; }
        .card-stats .stat-label { font-size: 0.7rem; color: #6c757d; text-transform: uppercase; }
        .card-stats .is-missing { color: #dc3545; }
        .card-stats .is-excess { color: #ffc107; }
        .card-footer {
            padding: 0.75rem 1.25rem;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: auto;
        }
        .status-tag {
            font-size: 0.75rem;
            font-weight: 700;
            padding: 0.2rem 0.7rem;
            border-radius: 20px;
            color: #fff;
        }
        .status-tag.sin-iniciar { background-color: #6c757d; }
        .status-tag.en-progreso { background-color: #0d6efd; }
        .status-tag.avanzado { background-color: #fd7e14; }
        .status-tag.completo { background-color: #198754; }
        .status-tag.con-sobrantes { background-color: #6f42c1; }
        .badge-destacado {
            position: absolute;
            top: -10px;
            right: 15px;
            background: linear-gradient(45deg, #ffc107, #f7971e);
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            font-weight: 700;
            font-size: 0.8rem;
            transform: rotate(10deg);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .archivable-notice {
            padding: 0.5rem;
            background-color: #dc3545;
            color: white;
            text-align: center;
            font-weight: 600;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <button class="btn-menu" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuLateral" aria-label="Abrir menú de navegación"><i class="bi bi-list"></i></button>
        <h1 class="header-title">Manifestar Mercancía</h1>
        <button id="logout-btn" class="btn-menu" aria-label="Cerrar sesión" title="Cerrar Sesión"><i class="bi bi-power"></i></button>
    </header>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="menuLateral" aria-labelledby="menuLateralLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title text-white fw-bold" id="menuLateralLabel"><i class="bi bi-box-seam-fill me-2"></i> Menú</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Cerrar menú"></button>
        </div>
        <div class="offcanvas-body p-0">
            <nav class="nav flex-column">
                <a class="nav-link" href="../index.html"><i class="bi bi-house-door-fill me-3"></i>Inicio</a>
                <a class="nav-link" href="../ChecarPrecios/index.html"><i class="bi bi-tags-fill me-3"></i>Checar Precios</a>
                <a class="nav-link" href="../Rechazos/reportes.html"><i class="bi bi-x-octagon-fill me-3"></i>Rechazos</a>
                <a class="nav-link" href="../Inventarios/Inventarios.html"><i class="bi bi-archive-fill me-3"></i>Inventarios</a>
                <a class="nav-link" href="../Configuraciones/Configuracion.html"><i class="bi bi-sliders me-3"></i>Configuración</a>
                <a class="nav-link active" href="../Manifiestos/Manifiestos.html"><i class="bi bi-file-earmark-check-fill me-3"></i>Manifiestos</a>
                <li class="nav-item" id="admin-nav-link" style="display: none;"><a class="nav-link" href="../Admin/admin.html"><i class="bi bi-gear-fill me-3"></i>Administrar</a></li>
            </nav>
        </div>
    </div>
    <main class="container main-container">
        <div id="userInfo"></div>

        <section id="employeeSection" data-aos="fade-up" class="mb-4">
            <div class="form-card" style="background: #fff; border-radius: 24px; box-shadow: 0 16px 48px rgba(0, 0, 0, 0.1); overflow: hidden; border: 1px solid #e9ecef;">
            <div class="form-card-body p-lg-5 p-4 text-center">
                
                <div class="employee-icon-container mb-4" style="width: 80px; height: 80px; margin: 0 auto 1.5rem auto; background: linear-gradient(145deg, rgba(230, 0, 126, 0.1), rgba(230, 0, 126, 0)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-person-vcard" style="font-size: 3.5rem; color: var(--rosa-principal); transition: transform 0.3s ease;"></i>
                </div>

                <h2 class="h3 fw-bold mb-2" style="color: var(--texto-principal);">Verificación de Empleado</h2>
                <p id="typewriter-text" class="text-muted mb-4" style="height: 24px; font-weight: 500;"></p>

                <div class="employee-input-group mx-auto mb-4" style="max-width: 420px; position: relative;">
                <input type="text" id="employeeNumberInput" class="form-control-modern text-center" placeholder="________" maxlength="8" inputmode="numeric" pattern="[0-9]*" aria-label="Número de empleado de 8 dígitos" style="font-size: 2rem; letter-spacing: 8px; font-weight: 700; padding: 1rem 2rem; height: auto; background-color: #f8f9fa; border-width: 2px;">
                </div>
                
                <div id="employeeInfoDisplay" class="mt-4" style="display: none; animation: fadeIn 0.5s ease;">
                <p class="text-success fw-bold mb-2 d-flex align-items-center justify-content-center gap-2 fs-5">
                    <i class="material-icons">check_circle</i> 
                    Empleado Verificado: <span id="displayedEmployeeNumber" style="color: var(--rosa-principal);"></span>
                </p>
                <button id="btnCambiarEmpleado" class="btn btn-sm btn-outline-secondary">
                    <i class="material-icons">edit</i>
                    <span>Cambiar</span>
                </button>
                </div>
            </div>
            </div>
        </section>

        <div id="restoInterfaz" style="display: none;">

            <section id="uploadAndSearchSection" data-aos="fade-up" class="form-card mb-4">
                <div class="form-card-header">
                    <i class="material-icons">manage_search</i>
                    <h2>2. Cargar o Buscar Manifiesto</h2>
                </div>
                <div class="form-card-body">
                    <div class="row gx-lg-5 align-items-center">
                        <div class="col-lg-5" id="upload-column">
                            <div class="p-3 text-center">
                                <p class="form-label mb-3">Cargar un nuevo archivo</p>
                                <div id="dropzone" role="button" tabindex="0" aria-label="Arrastra o haz clic para subir un archivo Excel de manifiesto">
                                    <i class="material-icons" style="font-size: 3rem;">cloud_upload</i>
                                    <p class="fw-bold mt-2">Arrastra un archivo Excel aquí</p>
                                    <p class="text-muted small">o haz clic para seleccionarlo.</p>
                                    <input type="file" id="fileInput" accept=".xlsx, .xls" class="d-none">
                                </div>
                                <p id="selectedFileName" class="text-center mt-3 mb-0" style="font-weight: 500;"></p>
                                <div id="uploadProgressContainer" class="mt-2 px-4" style="display: none;">
                                    <div class="progress" style="height: 10px;">
                                        <div id="uploadProgressBar" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                <div class="form-card-actions justify-content-center mt-3">
                                    <button id="uploadFileBtn" class="btn btn-main btn-primary-main" disabled aria-label="Subir archivo de manifiesto">
                                        <i class="material-icons">file_upload</i>
                                        <span>Subir Archivo</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-2 d-none d-lg-flex justify-content-center">
                            <div class="text-center">
                                <div class="vr" style="height: 150px;"></div>
                                <p class="text-muted fw-bold my-2">Ó</p>
                                <div class="vr" style="height: 150px;"></div>
                            </div>
                        </div>

                        <div class="col-lg-5">
                            <div class="p-3 text-center">
                                <p class="form-label mb-3">Buscar un manifiesto existente</p>
                                <div class="search-input-container mx-auto" style="max-width: 400px;">
                                    <i class="material-icons">search</i>
                                    <input type="text" id="inputBusqueda" class="form-control-modern text-center" placeholder="Buscar por Contenedor o SKU..." aria-label="Buscar manifiesto por Contenedor o SKU">
                                </div>
                                
                                <div class="d-grid mt-4 mx-auto" style="max-width: 400px;">
                                    <button id="btnVerArchivos" class="btn btn-main btn-secondary-main" title="Ver todos los archivos de manifiestos" aria-label="Ver todos los archivos de manifiestos">
                                        <i class="material-icons">folder_open</i>
                                        <span>Ver Todos los Archivos</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <div id="containerResultsSection" style="display:none;" class="mb-4">
                <div class="card shadow-lg" style="border: none; border-radius: 16px; overflow: hidden;">
                    <div class="results-header">
                        <div class="header-info">
                            <h2 class="header-title" id="containerHeader">
                                <i class="material-icons">inventory_2</i>
                                <span>Detalles del Contenedor</span>
                            </h2>
                            <p id="selectedFileToWork" class="header-subtitle"></p>
                            <p id="lastUserUpdate" class="header-meta"></p>
                        </div>
                        <div class="header-actions">

                            <button id="btnDescargarArchivo" class="btn-custom btn-descargar" title="Descargar archivo del manifiesto" aria-label="Descargar archivo del manifiesto">
                                <i class="material-icons">download</i>
                                <span>Descargar</span>
                            </button>
                            <button id="btnCambiarContenedor" class="btn-custom btn-cambiar" title="Cambiar de contenedor" aria-label="Cambiar de contenedor">
                                <i class="material-icons">switch_account</i>
                                <span>Cambiar</span>
                            </button>
                            <button id="btnCerrarContenedor" class="btn-custom btn-cerrar" title="Cerrar o reabrir contenedor" aria-label="Cerrar o reabrir contenedor">
                                <i class="material-icons">lock</i>
                                <span>Cerrar</span>
                            </button>
                        </div>
                    </div>
                    <div id="containerDetails" class="card-body p-3"></div>
                </div>
            </div>

            <div id="scanEntrySection" style="display:none;" class="mb-4">
                <div class="card shadow-sm">
                    <div class="card-header text-center bg-white border-0">
                        <h2 class="h4 mb-0"><i class="material-icons" style="vertical-align:middle;">qr_code_scanner</i> Registro de Piezas</h2>
                    </div>
                    <div class="card-body">
                        <input type="text" id="inputScanCode" class="form-control" placeholder="Escanee o ingrese manualmente el código" disabled>
                        <small class="text-muted d-block mt-1">Se procesará automáticamente al detectar entre 5 y 10 dígitos o, para código europeo, 12 o más.</small>
                    </div>
                    <div class="card-footer text-end bg-white">
                        <button id="btnRegistrarManual" class="btn btn-primary btn-sm" title="Registrar pieza manualmente" aria-label="Registrar pieza manualmente"><i class="material-icons">edit_note</i> Registrar Manual</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="modalDanios" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="border-radius: var(--ios-border-radius);">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title" style="color: var(--rosa-principal); font-weight:700;"><i class="material-icons" style="vertical-align:middle;">warning</i> Registrar Condiciones de la Mcia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="danioCantidad" class="form-label fw-bold">¿Cuántas piezas presentan condiciones (daños)?</label>
                        <input type="number" class="form-control" id="danioCantidad" min="1" step="1" value="1">
                    </div>
                    <div class="mb-3">
                        <label for="danioFoto" class="form-label fw-bold">Foto de la condición</label>
                        <input type="file" class="form-control" id="danioFoto" accept="image/*">
                    </div>
                    <small class="text-muted">Suba una foto clara del artículo.</small>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Cancelar"><i class="material-icons">cancel</i> Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnGuardarDanio" aria-label="Guardar condiciones de la mercancía"><i class="material-icons">check_circle</i> Guardar</button>
                </div>
            </div>
        </div>
    </div>
    <canvas id="hiddenChartCanvas" width="400" height="200" style="display: none;"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>
    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.full.min.js"></script>
        <script src="../libs/vfs_fonts.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

    <script>
        (function() {
            document.addEventListener('DOMContentLoaded', () => {
                document.querySelector('.main-container').removeAttribute('aria-hidden');
                AOS.init();

                /***************************************************
                 * CONFIGURACIÓN DE FIREBASE
                 ***************************************************/
                const firebaseConfig = {
                    apiKey: "AIzaSyA_4H46I7TCVLnFjet8fQPZ006latm-mRE",
                    authDomain: "loginliverpool.firebaseapp.com",
                    projectId: "loginliverpool",
                    storageBucket: "loginliverpool.appspot.com",
                    messagingSenderId: "704223815941",
                    appId: "1:704223815941:web:c871525230fb61caf96f6c",
                    measurementId: "G-QFEPQ4TSPY"
                };
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                const db = firebase.firestore();
                const auth = firebase.auth();
                const storage = firebase.app().storage("gs://loginliverpool.firebasestorage.app");

                /***************************************************
                 * VARIABLES GLOBALES
                 ***************************************************/
                const ADMIN_UID = "OaieQ6cGi7TnW0nbxvlk2oyLaER2";
                let currentUser = null;
                let currentUserStore = null;
                let currentUserRole = null;
                let currentContenedor = null;
                let currentContainerRecords = [];
                let excelDataGlobal = {};
                let currentFileName = "";
                let currentEmployeeNumber = "";
                let debounceTimerBusqueda = null;
                let debounceTimerScan = null;
                let allFilesList = null;
                let globalContainerMap = {};
                let currentDanioSKU = null;
                let permissions = {
                    canScan: false,
                    canUpload: false,
                    canGenerateReport: false,
                    canArchive: false,
                    hasFullAccess: false
                };

                // ...existing code...
                
                // Reemplaza la función calculateProStatistics por esta versión mejorada:
                const calculateProStatistics = (data) => {
                    let tSAP = 0, tSCAN = 0, falt = 0, exc = 0;
                    const contF = {}, contE = {}, secF = {}, secE = {};
                
                    data.forEach(r => {
                        const sap = Number(r.SAP) || 0;
                        // El valor correcto de SCANNER debe ser la suma real de escaneos, no el valor inicial del Excel
                        const scan = Number(r.SCANNER) || 0;
                        const cont = (r.CONTENEDOR || 'SIN NOMBRE').toUpperCase().trim();
                        const sec = (r.SECCION || 'Sin sección').toString().trim();
                
                        tSAP += sap;
                        tSCAN += scan;
                
                        if (scan < sap) {
                            const diff = sap - scan;
                            falt += diff;
                            contF[cont] = (contF[cont] || 0) + diff;
                            secF[sec] = (secF[sec] || 0) + diff;
                        } else if (scan > sap) {
                            const diff = scan - sap;
                            exc += diff;
                            contE[cont] = (contE[cont] || 0) + diff;
                            secE[sec] = (secE[sec] || 0) + diff;
                        }
                    });
                
                    // El avance debe calcularse sobre la suma real de escaneos
                    const av = tSAP ? Math.round((tSCAN / tSAP) * 100) : 0;
                
                    const getTopItems = (obj) => Object.entries(obj)
                        .sort(([, a], [, b]) => b - a);
                
                    return {
                        totalSAP: tSAP,
                        totalSCAN: tSCAN,
                        faltantes: falt,
                        excedentes: exc,
                        avance: av,
                        totalSKUs: data.length,
                        topContenedoresFaltantes: getTopItems(contF),
                        topSeccionesFaltantes: getTopItems(secF),
                        topContenedoresExcedentes: getTopItems(contE),
                        topSeccionesExcedentes: getTopItems(secE),
                    };
                };
                
     

                function formatFecha(d) {
                    if (d instanceof Date && !isNaN(d.getTime())) {
                        const dd = String(d.getDate()).padStart(2, "0");
                        const mm = String(d.getMonth() + 1).padStart(2, "0");
                        const yy = d.getFullYear();
                        return `${dd}/${mm}/${yy}`;
                    }
                    if (typeof d === "string") {
                        let dateObj = new Date(d);
                        if (!isNaN(dateObj.getTime())) {
                            let correctedDate = new Date(dateObj.getTime() + dateObj.getTimezoneOffset() * 60000);
                            return `${String(correctedDate.getDate()).padStart(2, "0")}/${String(correctedDate.getMonth() + 1).padStart(2, "0")}/${correctedDate.getFullYear()}`;
                        }
                        return d;
                    }
                    if (typeof d === "number") {
                        let dateObj = new Date(Math.round((d - 25569) * 86400 * 1000));
                        let correctedDate = new Date(dateObj.getTime() + dateObj.getTimezoneOffset() * 60000);
                        return `${String(correctedDate.getDate()).padStart(2, "0")}/${String(correctedDate.getMonth() + 1).padStart(2, "0")}/${correctedDate.getFullYear()}`;
                    }
                    return "";
                }
async function reconstructManifestDataFromFirebase(manifestoId) {
    try {
        const manifestDoc = await db.collection('manifiestos').doc(manifestoId).get();
        if (!manifestDoc.exists) {
            throw new Error(`El documento del manifiesto con ID ${manifestoId} no existe.`);
        }

        const manifestData = manifestDoc.data();
        const folder = manifestData.store;
        const fileName = manifestData.fileName;

        if (!folder || !fileName) {
            throw new Error(`El documento ${manifestoId} no tiene información de tienda o nombre de archivo.`);
        }

        // Descargamos el archivo Excel original de Storage
        const url = await storage.ref(`Manifiestos/${folder}/${fileName}`).getDownloadURL();
        const buffer = await (await fetch(url)).arrayBuffer();
        const workbook = XLSX.read(buffer, { type: "array", cellDates: true });
        const baseData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

        // Clonamos los datos base para trabajar sobre ellos
        let reconstructedData = JSON.parse(JSON.stringify(baseData));

        // Reseteamos contadores y campos que se calculan
        reconstructedData.forEach(row => {
            row.SCANNER = 0;
            row.DANIO_CANTIDAD = 0;
            row.DANIO_FOTO_URL = "";
            row.LAST_SCANNED_BY = "";
            row.ENTREGADO_A = ""; // Importante: Lo reseteamos para llenarlo con los datos reales
            row.FECHA_ESCANEO = "";
        });
        
        const scansSnapshot = await db.collection('manifiestos').doc(manifestoId).collection('scans').orderBy('scannedAt').get();
        
        const newItems = new Map();
        const deletedSkus = new Set();

        scansSnapshot.docs.forEach(doc => {
            const scan = doc.data();
            const skuUpper = String(scan.sku || "").toUpperCase();

            if (scan.type === 'delete') {
                deletedSkus.add(skuUpper);
                return;
            }

            let record = reconstructedData.find(r => String(r.SKU || "").toUpperCase() === skuUpper);

            if (record) {
                if (deletedSkus.has(skuUpper)) return;

                switch(scan.type) {
                    case 'subtract':
                        record.SCANNER = (Number(record.SCANNER) || 0) - (Number(scan.quantity) || 1);
                        break;
                    case 'damage':
                        record.DANIO_CANTIDAD = (Number(record.DANIO_CANTIDAD) || 0) + (Number(scan.quantity) || 1);
                        if (scan.photoURL) record.DANIO_FOTO_URL = scan.photoURL;
                        break;
                    default: // 'add' o escaneo simple
                        record.SCANNER = (Number(record.SCANNER) || 0) + (Number(scan.quantity) || 1);
                }

                // Asignamos la información del último escaneo
                record.LAST_SCANNED_BY = scan.user || "Desconocido";
                record.ENTREGADO_A = scan.employee || record.ENTREGADO_A; // <--- ¡CORRECCIÓN APLICADA!
                if (scan.scannedAt) record.FECHA_ESCANEO = scan.scannedAt.toDate();

            } else if (scan.type === 'add') {
                if (deletedSkus.has(skuUpper)) return;
                
                const refBaseRow = reconstructedData.length > 0 ? reconstructedData[0] : {};
                let newItem = newItems.get(skuUpper);

                if (!newItem) {
                    newItem = { ...refBaseRow, SKU: scan.sku, SAP: 0, SCANNER: 0, DANIO_CANTIDAD: 0 };
                }
                
                newItem.SCANNER += (Number(scan.quantity) || 1);
                newItem.DESCRIPCION = scan.description || "ARTÍCULO NUEVO";
                newItem.CONTENEDOR = scan.container || refBaseRow.CONTENEDOR || "N/A";
                newItem.LAST_SCANNED_BY = scan.user || "Desconocido";
                newItem.ENTREGADO_A = scan.employee || newItem.ENTREGADO_A; // También para nuevos artículos
                if(scan.scannedAt) newItem.FECHA_ESCANEO = scan.scannedAt.toDate();
                
                newItems.set(skuUpper, newItem);
            }
        });

        reconstructedData = reconstructedData.filter(r => !deletedSkus.has(String(r.SKU || "").toUpperCase()));
        newItems.forEach(item => reconstructedData.push(item));
        
        excelDataGlobal[manifestoId] = { data: reconstructedData, ...manifestData };
        
        return { data: reconstructedData, ...manifestData };

    } catch (error) {
        console.error(`Error al reconstruir datos para el manifiesto ${manifestoId}:`, error);
        throw new Error("No se pudieron reconstruir los datos del manifiesto desde Firebase.");
    }
}
                /***************************************************
                 * REFERENCIAS DEL DOM
                 ***************************************************/
                const logoutBtn = document.getElementById("logout-btn");
                const userInfoEl = document.getElementById("userInfo");
                const employeeNumberInput = document.getElementById("employeeNumberInput");
                const restoInterfaz = document.getElementById("restoInterfaz");
                const uploadAndSearchSection = document.getElementById("uploadAndSearchSection");
                const dropzone = document.getElementById("dropzone");
                const fileInput = document.getElementById("fileInput");
                const selectedFileNameEl = document.getElementById("selectedFileName");
                const uploadFileBtn = document.getElementById("uploadFileBtn");
                const uploadProgressContainer = document.getElementById("uploadProgressContainer");
                const uploadProgressBar = document.getElementById("uploadProgressBar");
                const btnVerArchivos = document.getElementById("btnVerArchivos");
                const inputBusqueda = document.getElementById("inputBusqueda");
                const containerResultsSection = document.getElementById("containerResultsSection");
                const containerDetailsEl = document.getElementById("containerDetails");
                const selectedFileToWorkEl = document.getElementById("selectedFileToWork");
                const lastUserUpdateEl = document.getElementById("lastUserUpdate");
                const scanEntrySection = document.getElementById("scanEntrySection");
                const inputScanCode = document.getElementById("inputScanCode");
                const btnCerrarContenedor = document.getElementById("btnCerrarContenedor");
                const btnRegistrarManual = document.getElementById("btnRegistrarManual");
                const btnCambiarEmpleado = document.getElementById("btnCambiarEmpleado");
                const btnCambiarContenedor = document.getElementById("btnCambiarContenedor");
                const modalDanios = new bootstrap.Modal(document.getElementById("modalDanios"));
                const danioCantidadInput = document.getElementById("danioCantidad");
                const danioFotoInput = document.getElementById("danioFoto");
                const btnGuardarDanio = document.getElementById("btnGuardarDanio");
                const uploadColumn = document.getElementById("upload-column");

                /***************************************************
                 * AUTH / LOGOUT
                 ***************************************************/
                auth.onAuthStateChanged(async (user) => {
                    if (!user) {
                        window.location.href = "../Login/login.html";
                        return;
                    }
                    currentUser = user;
                    try {
                        const docSnap = await db.collection("usuarios").doc(user.uid).get();
                        const isAdmin = user.uid === ADMIN_UID;

                        if (isAdmin || (docSnap.exists && docSnap.data().status === "aprobado")) {
                            const data = docSnap.data() || {};
                            currentUserStore = isAdmin ? "ALL" : (data.store || "");
                            currentUserRole = isAdmin ? "admin" : (data.role || "vendedor");

                            const userName = data.name || (isAdmin ? 'Admin' : 'Usuario');
                            userInfoEl.textContent = `Usuario: ${userName} (Tienda: ${currentUserStore}, Rol: ${currentUserRole})`;

                            switch (currentUserRole) {
                                case 'vendedor':
                                    permissions.canScan = true;
                                    break;
                                case 'auxiliar':
                                    permissions.canScan = true;
                                    permissions.canUpload = true;
                                    permissions.canGenerateReport = true;
                                    break;
                                case 'jefe':
                                    permissions.canScan = true;
                                    permissions.canUpload = true;
                                    permissions.canGenerateReport = true;
                                    permissions.canArchive = true;
                                    break;
                                case 'admin':
                                    permissions.hasFullAccess = true;
                                    break;
                            }
                            if (permissions.hasFullAccess) {
                                permissions = {
                                    canScan: true,
                                    canUpload: true,
                                    canGenerateReport: true,
                                    canArchive: true,
                                    hasFullAccess: true
                                };
                            }

                            if (permissions.canScan || permissions.hasFullAccess) {
                                uploadAndSearchSection.style.display = 'block';
                            } else {
                                uploadAndSearchSection.style.display = 'none';
                            }
                            if (uploadColumn) {
                                if (permissions.canUpload || permissions.hasFullAccess) {
                                    uploadColumn.style.display = 'block';
                                } else {
                                    uploadColumn.style.display = 'none';
                                }
                            }
                        } else {
                            Swal.fire({
                                icon: 'info',
                                title: 'Acceso Denegado',
                                text: 'Tu cuenta no está aprobada. Contacta al administrador.'
                            }).then(() => auth.signOut());
                        }
                    } catch (error) {
                        console.error("Error de autenticación:", error);
                        auth.signOut();
                    }
                });

                logoutBtn.addEventListener("click", () => {
                    auth.signOut().then(() => window.location.href = "../Login/login.html")
                        .catch(e => console.error(e));
                });

 /***************************************************
         * SECCIÓN: SUBIR ARCHIVO MANIFIESTO + BARRA DE PROGRESO (CON VALIDACIÓN)
         ***************************************************/
        dropzone.addEventListener('click', () => fileInput.click());
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.style.borderColor = 'var(--rosa-principal)';
        });
        dropzone.addEventListener('dragleave', () => {
            dropzone.style.borderColor = '#ced4da';
        });
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.style.borderColor = '#ced4da';
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                const file = fileInput.files[0];
                if (file) {
                    selectedFileNameEl.textContent = file.name;
                    uploadFileBtn.disabled = false;
                }
            }
        });

        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (!file) return;
            selectedFileNameEl.textContent = file.name;
            uploadFileBtn.disabled = false;
        });

        uploadFileBtn.addEventListener('click', async () => {
            const file = fileInput.files[0];
            if (!file) return;

            // Deshabilitar botón para evitar dobles clics
            uploadFileBtn.disabled = true;

            const folder = (currentUserStore === "ALL") ? "General" : currentUserStore;
            const storageRef = storage.ref(`Manifiestos/${folder}/${file.name}`);

            try {
                // PRIMERO: Verificamos si ya existe un archivo con ese nombre
                await storageRef.getDownloadURL();

                // Si getDownloadURL() tiene éxito, el archivo ya existe.
                Swal.fire({
                    icon: 'error',
                    title: 'Archivo Duplicado',
                    text: `Ya existe un manifiesto con el nombre "${file.name}". Por favor, renombra el archivo que intentas subir o elimina el existente.`
                });
                uploadFileBtn.disabled = false; // Habilitamos el botón de nuevo
                return; // Detenemos la ejecución

            } catch (error) {
                // Si getDownloadURL() falla con 'storage/object-not-found', significa que el archivo NO existe.
                // ¡Podemos proceder a subirlo!
                if (error.code === 'storage/object-not-found') {
                    uploadProgressContainer.style.display = 'block';
                    const uploadTask = storageRef.put(file);

                    uploadTask.on('state_changed',
                        snapshot => {
                            const percent = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                            uploadProgressBar.style.width = percent + '%';
                            uploadProgressBar.textContent = percent + '%';
                            uploadProgressBar.setAttribute('aria-valuenow', percent);
                        },
                        uploadError => {
                            console.error(uploadError);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error de Subida',
                                text: 'Ocurrió un error al subir el archivo.'
                            });
                            uploadProgressContainer.style.display = 'none';
                            uploadFileBtn.disabled = false;
                        },
                        async () => {
                            // Una vez subido, obtenemos los metadatos y creamos el registro en Firestore
                            try {
                                const reader = new FileReader();
                                reader.readAsArrayBuffer(file);
                                reader.onload = async (e) => {
                                    const data = new Uint8Array(e.target.result);
                                    const workbook = XLSX.read(data, { type: 'array' });
                                    const firstSheetName = workbook.SheetNames[0];
                                    const worksheet = workbook.Sheets[firstSheetName];
                                    const json = XLSX.utils.sheet_to_json(worksheet);
                                    const numeroManifiesto = (json.length > 0 && json[0].MANIFIESTO) ? String(json[0].MANIFIESTO) : "N/A";

                                    // Usamos el nombre del archivo como ID del documento, ya que ahora es único por carpeta.
                                    await db.collection('manifiestos').doc(file.name).set({
                                        fileName: file.name,
                                        store: folder,
                                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                        lastUser: currentUser.email || currentUser.uid,
                                        numeroManifiesto: numeroManifiesto,
                                        closedContainers: {} // Inicializamos el mapa de contenedores cerrados
                                    }, { merge: true });

                                    Swal.fire({
                                        icon: 'success',
                                        title: '¡Éxito!',
                                        text: `El manifiesto "${file.name}" fue subido y procesado correctamente.`
                                    });

                                    // Limpiamos la interfaz de subida
                                    uploadProgressContainer.style.display = 'none';
                                    uploadProgressBar.style.width = '0%';
                                    selectedFileNameEl.textContent = '';
                                    fileInput.value = '';
                                    uploadFileBtn.disabled = true;
                                };
                            } catch (readError) {
                                console.error("Error al leer el excel para metadatos:", readError);
                                Swal.fire('Error al Procesar', 'El archivo se subió, pero no se pudieron leer sus datos internos.', 'error');
                            }
                        }
                    );
                } else {
                    // Otro tipo de error de Storage
                    console.error("Error de Storage:", error);
                    Swal.fire('Error Inesperado', 'No se pudo verificar el archivo en la nube.', 'error');
                    uploadFileBtn.disabled = false;
                }
            }
        });

                /***************************************************
                 * DETECCIÓN DE EMPLEADO (8 dígitos)
                 ***************************************************/
                const debounce = (func, delay = 400) => {
                    let timeoutId;
                    return (...args) => {
                        clearTimeout(timeoutId);
                        timeoutId = setTimeout(() => {
                            func.apply(this, args);
                        }, delay);
                    };
                };

                employeeNumberInput.addEventListener("input", debounce(() => {
                    const restoInterfaz = document.getElementById("restoInterfaz");
                    const inputScanCode = document.getElementById("inputScanCode");
                    const val = employeeNumberInput.value.trim();

                    if (!restoInterfaz || !inputScanCode) {
                        console.error("Error Crítico: No se encontraron 'restoInterfaz' o 'inputScanCode'.");
                        return;
                    }

                    if (/^\d{8}$/.test(val)) {
                        currentEmployeeNumber = val;
                        restoInterfaz.style.display = "block";
                        inputScanCode.disabled = false;
                        inputScanCode.focus();
                    } else {
                        currentEmployeeNumber = "";
                        restoInterfaz.style.display = "none";
                        inputScanCode.disabled = true;
                    }
                }));

                btnCambiarEmpleado.addEventListener("click", () => {
                    Swal.fire({
                        title: "Cambiar Empleado",
                        input: "text",
                        inputLabel: "Ingrese el nuevo número de empleado",
                        inputPlaceholder: "Debe contener 8 dígitos...",
                        inputAttributes: {
                            maxlength: 8,
                            autocapitalize: "off",
                            autocorrect: "off"
                        },
                        showCancelButton: true,
                        confirmButtonText: 'Confirmar',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#43A047',
                        cancelButtonColor: '#6c757d',
                        customClass: {
                            popup: 'animated animate__fadeInDown'
                        },
                        preConfirm: (value) => {
                            if (!/^\d{8}$/.test(value)) {
                                Swal.showValidationMessage("El número debe contener exactamente 8 dígitos numéricos");
                                return false;
                            }
                            return value;
                        }
                    }).then(result => {
                        if (result.isConfirmed) {
                            currentEmployeeNumber = result.value.trim();
                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                icon: 'success',
                                title: 'Número actualizado con éxito',
                                html: `Ahora se usará: <strong>${currentEmployeeNumber}</strong>`,
                                showConfirmButton: false,
                                timer: 2500
                            });
                            restoInterfaz.style.display = "block";
                            inputScanCode.disabled = false;
                            inputScanCode.focus();
                        }
                    });
                });

                /***************************************************
                 * LISTAR / DESCARGAR / ELIMINAR MANIFIESTOS
                 ***************************************************/
                const SUPER_ADMINS = ["OaieQ6cGi7TnW0nbxvlk2oyLaER2", "doxhVo1D3aYQqqkqgRgfJ4qcKcU2"];

                btnVerArchivos.addEventListener("click", listarArchivos);

         async function listarArchivos() {
    Swal.fire({
        title: '<i class="bi bi-stars" style="color: var(--rosa-principal);"></i> Desplegando Centro de Comando...',
        html: `
            <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem; padding: 1rem 0;">
                <div class="epic-loader"></div>
                <p class="text-muted fw-bold mt-2">Sincronizando con la flota de manifiestos...</p>
                <p class="text-muted small">Calculando vectores de progreso. ¡Prepárate!</p>
            </div>
            <style>
                .epic-loader {
                    width: 60px;
                    height: 60px;
                    border-radius: 50%;
                    background: conic-gradient(from 180deg at 50% 50%, #E6007E, #0d6efd, #ffc107, #E6007E);
                    animation: spin 1.2s linear infinite;
                    -webkit-mask: radial-gradient(farthest-side, #0000 calc(100% - 8px), #000 0);
                    mask: radial-gradient(farthest-side, #0000 calc(100% - 8px), #000 0);
                }
                @keyframes spin {
                    to { transform: rotate(1turn); }
                }
            </style>
        `,
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    try {
        let query = db.collection('manifiestos');
        if (currentUserStore !== 'ALL' && !SUPER_ADMINS.includes(currentUser.uid)) {
            query = query.where('store', '==', currentUserStore);
        }

        const manifestosSnapshot = await query.orderBy('createdAt', 'desc').get();

        if (manifestosSnapshot.empty) {
            return Swal.fire("Sin Manifiestos", "No se encontraron archivos para tu tienda.", "info");
        }

        const archivosConDetalles = await Promise.all(
            manifestosSnapshot.docs.map(async (doc) => {
                try {
                    const metadata = doc.data();
                    const reconstructedData = await reconstructManifestDataFromFirebase(doc.id);
                    const stats = calculateProStatistics(reconstructedData.data);

                    return {
                        id: doc.id,
                        name: metadata.fileName,
                        folder: metadata.store,
                        createdAt: metadata.createdAt ? metadata.createdAt.toDate() : new Date(0),
                        progreso: {
                            totalSAP: stats.totalSAP,
                            totalSCAN: stats.totalSCAN,
                            avance: stats.avance,
                            faltantes: stats.faltantes,
                            excedentes: stats.excedentes,
                        },
                    };
                } catch (e) {
                    console.error(`Falló al procesar el manifiesto ${doc.id}:`, e);
                    return null;
                }
            })
        );

        const archivosValidos = archivosConDetalles.filter(a => a !== null);
        const topArchivos = [...archivosValidos].sort((a, b) => b.progreso.totalSCAN - a.progreso.totalSCAN).slice(0, 2);
        const topArchivosSet = new Set(topArchivos.map(f => f.name));

        archivosValidos.sort((a, b) => b.createdAt - a.createdAt);

        const dashboardHTML = `
            <div class="dashboard-pro-container" style="background:linear-gradient(135deg,#fff 80%,#e6007e08 100%);border-radius:24px;box-shadow:0 8px 32px #e6007e11;">
                <header class="dashboard-header" style="padding-bottom:1.5rem;border-bottom:2px solid #e6007e22;">
                    <h2 class="title" style="font-size:2rem;font-weight:800;color:#E6007E;display:flex;align-items:center;gap:0.7rem;">
                        <i class="material-icons" style="font-size:2.5rem;color:#0d6efd;">view_quilt</i>
                        Centro de Manifiestos
                    </h2>
                    <div class="search-filter-controls" style="gap:1.2rem; align-items: center;">
                        <input type="text" id="dashboardSearchInput" class="form-control form-control-sm" placeholder="Buscar por nombre..." aria-label="Buscar manifiesto por nombre" style="max-width:260px;border-radius:12px;border:2px solid #e6007e22;font-size:1.1rem;">
                        <select id="statusFilter" class="form-select form-select-sm" aria-label="Filtrar por estado" style="max-width:180px;border-radius:12px;border:2px solid #e6007e22;font-size:1.1rem;">
                            <option value="Todos">Todos los estados</option>
                            <option value="Sin Iniciar">Sin Iniciar</option>
                            <option value="En Progreso">En Progreso</option>
                            <option value="Avanzado">Avanzado</option>
                            <option value="Completo">Completo</option>
                            <option value="Accion Requerida">Acción Requerida</option>
                        </select>
                        <button id="btnResumenSemanal" class="btn btn-custom" style="background: linear-gradient(45deg, #6a11cb, #2575fc);" title="Generar resumen de una semana">
                            <i class="bi bi-calendar-week-fill"></i>
                            <span>Resumen Semanal</span>
                        </button>
                    </div>
                </header>
                <div id="manifestCardsContainer" class="manifest-cards-container" style="padding-top:2rem;"></div>
            </div>
            <style>
             .dashboard-pro-container{padding:2.5rem 1.5rem}.dashboard-header{background:0 0;border-radius:18px;box-shadow:none}.search-filter-controls input,.search-filter-controls select{box-shadow:0 2px 8px #e6007e11;transition:box-shadow .2s}.search-filter-controls input:focus,.search-filter-controls select:focus{box-shadow:0 4px 16px #e6007e22;border-color:#e6007e}.manifest-cards-container{gap:2rem}.manifest-card-pro{border-radius:18px;box-shadow:0 8px 32px #e6007e11;border:1px solid #e6007e22;transition:transform .18s,box-shadow .18s;margin-bottom:0;position:relative}.manifest-card-pro:hover{transform:translateY(-4px) scale(1.03);box-shadow:0 16px 48px #e6007e22;border-color:#0d6efd}.manifest-card-pro .card-header{background:linear-gradient(90deg,#f8f9fa 80%,#e6007e08 100%);border-bottom:1px solid #e6007e11;font-size:1.1rem;font-weight:600;color:#e6007e;padding:1.2rem 1.5rem}.manifest-card-pro .file-name{font-size:1.15rem;font-weight:700;color:#343a40;letter-spacing:.5px}.manifest-card-pro .file-store{font-size:.95rem;color:#6c757d;margin-top:2px}.manifest-card-pro .card-body{padding:1.5rem;background:#fff}.manifest-card-pro .progress-preview{margin-bottom:1.2rem}.manifest-card-pro .progress-title{font-size:1rem;font-weight:700;color:#6c757d;margin-bottom:.3rem;display:flex;justify-content:space-between}.manifest-card-pro .progress-bar-container{background:#e9ecef;border-radius:50px;height:14px;overflow:hidden}.manifest-card-pro .progress-bar-fill{height:100%;border-radius:50px;background:linear-gradient(90deg,#e6007e 0,#0d6efd 100%);transition:width .5s cubic-bezier(.4,2,.3,1)}.manifest-card-pro .card-stats{display:flex;justify-content:space-around;text-align:center;padding:1rem 0;border-top:1px solid #e6007e11;margin-top:1rem}.manifest-card-pro .stat-value{font-size:1.3rem;font-weight:800;color:#212529}.manifest-card-pro .stat-label{font-size:.8rem;color:#6c757d;text-transform:uppercase}.manifest-card-pro .card-footer{background:linear-gradient(90deg,#f8f9fa 80%,#e6007e08 100%);border-top:1px solid #e6007e11;padding:.7rem 1.2rem;display:flex;gap:.4rem;justify-content:flex-end}.manifest-card-pro .badge-destacado{position:absolute;top:-10px;right:15px;background:linear-gradient(45deg,#ffc107,#f7971e);color:#fff;padding:.4rem .8rem;border-radius:5px;font-weight:700;font-size:.8rem;transform:rotate(10deg);box-shadow:0 4px 10px #e6007e22;z-index:2}.manifest-card-pro .archivable-notice{padding:.4rem;background-color:#dc3545;color:#fff;text-align:center;font-weight:700;font-size:.85rem;border-radius:0 0 8px 8px}.manifest-card-pro .status-tag{padding:3px 10px;border-radius:14px;font-size:.85rem;font-weight:700;color:#fff;background:#6c757d;margin-top:4px;display:inline-block}.manifest-card-pro .status-tag.sin-iniciar{background:#6c757d}.manifest-card-pro .status-tag.en-progreso{background:#0d6efd}.manifest-card-pro .status-tag.avanzado{background:#fd7e14}.manifest-card-pro .status-tag.completo{background:#198754}.manifest-card-pro .status-tag.con-sobrantes{background:#6f42c1}.manifest-card-pro .btn{border-radius:16px;font-weight:600;font-size:.92rem;padding:.35rem .8rem;box-shadow:0 2px 8px #e6007e11;transition:transform .18s,box-shadow .18s;border:none;display:inline-flex;align-items:center;gap:.35rem;min-width:0;height:auto;line-height:1.2}.manifest-card-pro .btn .material-icons{font-size:1.1rem}.manifest-card-pro .btn:hover{transform:scale(1.05);box-shadow:0 8px 24px #e6007e22;border-color:#0d6efd}.manifest-card-pro .btn-primary{background:linear-gradient(90deg,#0d6efd 80%,#1fddff 100%);color:#fff}.manifest-card-pro .btn-warning{background:linear-gradient(90deg,#ffc107 80%,#ffe082 100%);color:#212529}.manifest-card-pro .btn-info{background:linear-gradient(90deg,#17a2b8 80%,#6dd5ed 100%);color:#fff}.manifest-card-pro .btn-danger{background:linear-gradient(90deg,#dc3545 80%,#ffb3b3 100%);color:#fff}@media (max-width:900px){.dashboard-pro-container{padding:1.2rem .5rem}.dashboard-header{flex-direction:column;gap:1rem}.manifest-cards-container{grid-template-columns:1fr;gap:1rem}}@media (max-width:600px){.manifest-card-pro .btn{font-size:.85rem;padding:.25rem .5rem;border-radius:12px}.manifest-card-pro .card-footer{padding:.5rem .6rem;gap:.25rem}}
            </style>
        `;

        await Swal.fire({
            html: dashboardHTML,
            width: '95%',
            customClass: {
                popup: 'dashboard-modal'
            },
            showConfirmButton: false,
            showCloseButton: true,
            didOpen: () => {
                const searchInput = document.getElementById('dashboardSearchInput');
                const statusFilter = document.getElementById('statusFilter');
                
                // ===== ACTIVACIÓN DEL NUEVO BOTÓN =====
                const btnResumenSemanal = document.getElementById('btnResumenSemanal');
                if (btnResumenSemanal) {
                    btnResumenSemanal.addEventListener('click', generarResumenSemanal);
                }
                // ===================================

                const renderizar = () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    const statusFiltro = statusFilter.value;
                    const fiveDaysInMillis = 5 * 24 * 60 * 60 * 1000;

                    const archivosFiltrados = archivosValidos.filter(file => {
                        const isOld = (new Date() - file.createdAt) > fiveDaysInMillis;
                        let searchMatch = file.name.toLowerCase().includes(searchTerm);

                        let estadoArchivo = "Sin Iniciar";
                        if (file.progreso.avance >= 100) estadoArchivo = (file.progreso.totalSCAN > file.progreso.totalSAP) ? "Con Sobrantes" : "Completo";
                        else if (file.progreso.avance >= 50) estadoArchivo = "Avanzado";
                        else if (file.progreso.avance > 0) estadoArchivo = "En Progreso";

                        let statusMatch = true;
                        if (statusFiltro === 'Accion Requerida') statusMatch = isOld;
                        else if (statusFiltro !== 'Todos') statusMatch = estadoArchivo === statusFiltro;

                        return searchMatch && statusMatch;
                    });

                    const container = document.getElementById('manifestCardsContainer');
                    if (archivosFiltrados.length === 0) {
                        container.innerHTML = `<div class="text-center p-5 text-muted w-100"><h4><i class="material-icons">search_off</i> Sin resultados</h4>No se encontraron manifiestos que coincidan con tu búsqueda.</div>`;
                    } else {
                        container.innerHTML = archivosFiltrados.map(file => renderItems(file, topArchivosSet.has(file.name))).join('');
                    }
                };

                searchInput.addEventListener('keyup', renderizar);
                statusFilter.addEventListener('change', renderizar);
                renderizar();
            }
        });

    } catch (err) {
        console.error("Error al listar archivos:", err);
        Swal.fire("Error Inesperado", "No se pudo listar los archivos.", "error");
    }
}
/**
 * --- VERSIÓN FINAL (PULIDA) ---
 * Esta versión incorpora todos los ajustes de diseño y funcionalidad:
 * - Paleta de colores e iconografía de Liverpool.
 * - Tarjetas de sección compactas con contadores de piezas y barras de progreso mejoradas.
 * - Diseño de Ranking de Operadores mejorado.
 * - Funcionalidad de descarga de Excel completamente restaurada.
 */
window.generarResumenSemanal = async function() {
    // Helper para obtener propiedades de un objeto sin importar mayúsculas/minúsculas
    const getProp = (obj, key) => {
        if (!obj) return undefined;
        const lowerKey = String(key).toLowerCase();
        const objKey = Object.keys(obj).find(k => k.toLowerCase() === lowerKey);
        return objKey ? obj[objKey] : undefined;
    };

    // Modal de selección de fechas
    const {
        value: dateRange
    } = await Swal.fire({
        title: '<i class="bi bi-calendar2-range" style="color:#E10098;"></i> Periodo de Análisis',
        html: `
            <p class="text-muted mt-2 mb-4">Selecciona el rango de fechas para generar el reporte de rendimiento.</p>
            <input type="text" id="date-range-picker" class="form-control text-center" placeholder="Seleccionar fechas...">
        `,
        width: 480,
        padding: '2rem',
        confirmButtonText: 'Generar Dashboard <i class="bi bi-arrow-right-circle-fill ms-1"></i>',
        customClass: {
            popup: 'animate__animated animate__fadeInDown border-0 shadow-lg',
            confirmButton: 'btn btn-primary btn-lg',
        },
        didOpen: () => {
            flatpickr.localize(flatpickr.l10ns.es);
            const fp = flatpickr("#date-range-picker", {
                mode: "range",
                dateFormat: "Y-m-d",
                locale: 'es',
                maxDate: "today"
            });
            setTimeout(() => fp.open(), 100);
        },
        preConfirm: () => {
            const range = document.getElementById('date-range-picker').value;
            if (!range || !range.includes(' a ')) {
                Swal.showValidationMessage('Debes seleccionar un rango de fechas válido.');
                return false;
            }
            return range.split(' a ');
        }
    });

    if (!dateRange || dateRange.length < 2) return;

    const [startDateStr, endDateStr] = dateRange;
    Swal.fire({
        title: '<span style="font-weight:700;color:#E10098;">Analizando Datos...</span>',
        html: `<div style="display:flex;flex-direction:column;align-items:center;gap:1.2rem;"><div class="liverpool-loader"></div><div id="loading-message" style="color:#6c757d;">Cargando inteligencia de secciones y procesando manifiestos...<br>Por favor, espera.</div></div><style>.liverpool-loader{width:60px;height:60px;border-radius:50%;background:conic-gradient(from 180deg at 50% 50%,#E10098,#414141,#95C11F,#E10098);animation:spin 1.2s linear infinite;-webkit-mask:radial-gradient(farthest-side,#0000 calc(100% - 8px),#000 0);mask:radial-gradient(farthest-side,#0000 calc(100% - 8px),#000 0);}@keyframes spin{to{transform:rotate(1turn);}}</style>`,
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading(),
    });

    try {
        let seccionesMap = new Map();
        try {
            const seccionesURL = await storage.ref('ExcelManifiestos/Secciones.xlsx').getDownloadURL();
            const seccionesBuffer = await (await fetch(seccionesURL)).arrayBuffer();
            const seccionesWB = XLSX.read(seccionesBuffer, {
                type: 'array'
            });
            const seccionesData = XLSX.utils.sheet_to_json(seccionesWB.Sheets['Jefatura']);
            seccionesData.forEach(row => {
                const seccionKey = String(getProp(row, 'Seccion') || '').trim();
                if (seccionKey) {
                    seccionesMap.set(seccionKey.toUpperCase(), {
                        descripcion: getProp(row, 'Descripcion') || 'Sin Descripción',
                        jefatura: getProp(row, 'Jefatura') || 'Sin Asignar',
                        asistente: getProp(row, 'Asistente de Operaciones') || 'N/A'
                    });
                }
            });
        } catch (error) {
            console.error("Error crítico al cargar 'ExcelManifiestos/Secciones.xlsx':", error);
            Swal.fire('Error de Archivo', "No se pudo cargar el archivo <b>ExcelManifiestos/Secciones.xlsx</b>. Revisa la consola para más detalles.", 'error');
            return;
        }

        const startDate = new Date(startDateStr);
        startDate.setHours(0, 0, 0, 0);
        const endDate = new Date(endDateStr);
        endDate.setHours(23, 59, 59, 999);

        let query = db.collection('manifiestos').where('createdAt', '>=', startDate).where('createdAt', '<=', endDate);
        if (currentUserStore !== 'ALL' && !SUPER_ADMINS.includes(currentUser.uid)) {
            query = query.where('store', '==', currentUserStore);
        }
        const snapshot = await query.get();

        if (snapshot.empty) return Swal.fire('Sin Datos', 'No se encontraron manifiestos en el rango de fechas seleccionado.', 'info');

        let report = {
            totalSAP: 0,
            totalSCAN: 0,
            manifestos: [],
            usuarios: {},
            secciones: {},
            skusSinEscanear: []
        };
        for (const doc of snapshot.docs) {
            try {
                const reconstructed = await reconstructManifestDataFromFirebase(doc.id);
                const manifestData = reconstructed.data;
                const manifestInfo = {
                    id: doc.id,
                    numero: getProp(manifestData[0], 'MANIFIESTO') || 'N/A'
                };
                report.manifestos.push(manifestInfo);
                manifestData.forEach(row => {
                    const seccionKey = String(getProp(row, 'SECCION') || 'Sin Sección').trim();
                    const sap = Number(getProp(row, 'SAP')) || 0;
                    const scan = Number(getProp(row, 'SCANNER')) || 0;
                    const user = getProp(row, 'LAST_SCANNED_BY') || null;

                    if (!report.secciones[seccionKey]) {
                        const seccionInfo = seccionesMap.get(seccionKey.toUpperCase()) || {
                            jefatura: 'Sin Asignar',
                            descripcion: 'Descripción no encontrada',
                            asistente: 'N/A'
                        };
                        report.secciones[seccionKey] = {
                            sap: 0,
                            scan: 0,
                            skus: 0,
                            faltantes: 0,
                            excedentes: 0,
                            ...seccionInfo
                        };
                    }
                    report.totalSAP += sap;
                    report.totalSCAN += scan;
                    report.secciones[seccionKey].sap += sap;
                    report.secciones[seccionKey].scan += scan;
                    report.secciones[seccionKey].skus++;
                    if (scan < sap) report.secciones[seccionKey].faltantes += (sap - scan);
                    if (scan > sap) report.secciones[seccionKey].excedentes += (scan - sap);
                    if (scan === 0 && sap > 0) report.skusSinEscanear.push({
                        sku: getProp(row, 'SKU'),
                        desc: getProp(row, 'DESCRIPCION'),
                        sap,
                        manifiesto: manifestInfo
                    });
                    if (user && scan > 0) {
                        if (!report.usuarios[user]) report.usuarios[user] = {
                            scans: 0,
                            manifests: new Map()
                        };
                        report.usuarios[user].scans += scan;
                        if (!report.usuarios[user].manifests.has(manifestInfo.id)) report.usuarios[user].manifests.set(manifestInfo.id, {
                            scans: 0,
                            numero: manifestInfo.numero
                        });
                        report.usuarios[user].manifests.get(manifestInfo.id).scans += scan;
                    }
                });
            } catch (innerError) {
                console.error(`Error procesando manifiesto ${doc.id}:`, innerError);
            }
        }

        report.jefaturas = {};
        for (const [seccionNombre, seccionData] of Object.entries(report.secciones)) {
            const jefe = seccionData.jefatura;
            if (jefe === 'Sin Asignar') continue;

            if (!report.jefaturas[jefe]) {
                report.jefaturas[jefe] = {
                    sap: 0,
                    scan: 0,
                    faltantes: 0,
                    excedentes: 0,
                    skus: 0,
                    secciones: []
                };
            }
            report.jefaturas[jefe].sap += seccionData.sap;
            report.jefaturas[jefe].scan += seccionData.scan;
            report.jefaturas[jefe].faltantes += seccionData.faltantes;
            report.jefaturas[jefe].excedentes += seccionData.excedentes;
            report.jefaturas[jefe].skus += seccionData.skus;
            report.jefaturas[jefe].secciones.push({
                nombre: seccionNombre,
                sap: seccionData.sap,
                scan: seccionData.scan,
                avance: seccionData.sap > 0 ? (seccionData.scan / seccionData.sap) * 100 : 100
            });
        }

        const avanceGeneral = report.totalSAP > 0 ? (report.totalSCAN / report.totalSAP) * 100 : 0;
        const totalFaltantes = report.totalSAP > report.totalSCAN ? report.totalSAP - report.totalSCAN : 0;
const totalExcedentes = Object.values(report.secciones).reduce((acc, seccion) => acc + seccion.excedentes, 0);        const topScanners = Object.entries(report.usuarios).sort((a, b) => b[1].scans - a[1].scans);
        const jefaturasUnicas = [...new Set(Object.values(report.secciones).map(s => s.jefatura))].filter(j => j !== 'Sin Asignar').sort();

 const descargarResumenExcel = () => {
    // --- ESTILOS PROFESIONALES ---
    const headerStyle = {
        font: { bold: true, color: { rgb: "FFFFFF" }, sz: 11 },
        fill: { fgColor: { rgb: "414141" } }, // Gris oscuro Liverpool
        alignment: { horizontal: "center", vertical: "center" },
        border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } }
    };
    const titleStyle = { font: { sz: 18, bold: true, color: { rgb: "E10098" } } }; // Rosa Liverpool
    const kpiTitleStyle = { font: { sz: 12, bold: true, color: { rgb: "414141" } } };
    const cellStyle = {
        border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } }
    };
    const redTextStyle = { font: { color: { rgb: "E10098" } }, ...cellStyle };
    const greenTextStyle = { font: { color: { rgb: "95C11F" } }, ...cellStyle };
    const orangeTextStyle = { font: { color: { rgb: "f0ad4e" } }, ...cellStyle };

    const wb = XLSX.utils.book_new();

    // --- HOJA 1: RESUMEN EJECUTIVO ---
    const wsResumenData = [
        ["Reporte de Inteligencia Semanal"], [null],
        ["Periodo Analizado:", `${startDate.toLocaleDateString('es-ES')} - ${endDate.toLocaleDateString('es-ES')}`], [null],
        ["Métricas Clave"],
        ["Manifiestos Procesados", report.manifestos.length],
        ["Avance General de Escaneo", { v: avanceGeneral / 100, t: 'n', z: '0.00%' }],
        ["Piezas Totales (SAP)", report.totalSAP],
        ["Piezas Totales Escaneadas", report.totalSCAN],
        ["Piezas Faltantes", { v: totalFaltantes, s: redTextStyle }],
        ["Piezas Excedentes", { v: totalExcedentes, s: orangeTextStyle }],
    ];
    const wsResumen = XLSX.utils.aoa_to_sheet(wsResumenData);
    wsResumen["A1"].s = titleStyle;
    wsResumen["A5"].s = kpiTitleStyle;
    wsResumen["A6"].s = wsResumen["A7"].s = wsResumen["A8"].s = wsResumen["A9"].s = wsResumen["A10"].s = wsResumen["A11"].s = cellStyle;
    wsResumen["B6"].s = wsResumen["B7"].s = wsResumen["B8"].s = wsResumen["B9"].s = cellStyle;
    wsResumen['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 2 } }];
    wsResumen['!cols'] = [{ wch: 30 }, { wch: 20 }];
    XLSX.utils.book_append_sheet(wb, wsResumen, "Resumen Ejecutivo");


    // --- HOJA 2: ANÁLISIS POR SECCIÓN ---
    const wsSeccionesData = [["Sección", "Jefatura", "SKUs Únicos", "Pzs. SAP", "Pzs. Escaneadas", "Faltantes", "Excedentes", "Avance"]];
    const sortedSecciones = Object.entries(report.secciones).sort((a,b) => (b[1].sap - b[1].scan) - (a[1].sap - a[1].scan));
    
    sortedSecciones.forEach(([nombre, data]) => {
        const avance = data.sap > 0 ? data.scan / data.sap : 1;
        const avanceCell = { v: avance, t: 'n', z: '0.00%' };
        
        // Formato condicional de color
        if (avance < 0.5) avanceCell.s = { font: { color: { rgb: "E10098" } }, ...cellStyle };
        else if (avance < 0.9) avanceCell.s = { font: { color: { rgb: "f0ad4e" } }, ...cellStyle };
        else avanceCell.s = { font: { color: { rgb: "95C11F" } }, ...cellStyle };

        wsSeccionesData.push([
            {v: nombre, s: cellStyle},
            {v: data.jefatura, s: cellStyle},
            {v: data.skus, s: cellStyle},
            {v: data.sap, s: cellStyle},
            {v: data.scan, s: cellStyle},
            {v: data.faltantes, s: data.faltantes > 0 ? redTextStyle : cellStyle},
            {v: data.excedentes, s: data.excedentes > 0 ? orangeTextStyle : cellStyle},
            avanceCell
        ]);
    });
    const wsSecciones = XLSX.utils.aoa_to_sheet(wsSeccionesData, { cellStyles: true });
    wsSecciones['!cols'] = [{wch: 18}, {wch: 25}, {wch: 12}, {wch: 12}, {wch: 15}, {wch: 12}, {wch: 12}, {wch: 12}];
    // Aplicar estilo de encabezado a la primera fila
    Object.keys(wsSecciones).forEach(cell => {
        if(cell.match(/^[A-Z]1$/)) {
            wsSecciones[cell].s = headerStyle;
        }
    });
    XLSX.utils.book_append_sheet(wb, wsSecciones, "Análisis por Sección");
    

    // --- HOJA 3: RANKING DE OPERADORES ---
    const wsUsuariosData = [["Ranking", "Operador", "Escaneos Totales", "Manifiestos Trabajados"]];
    topScanners.forEach(([email, data], index) => {
        wsUsuariosData.push([
            {v: index + 1, s: cellStyle},
            {v: email, s: cellStyle},
            {v: data.scans, s: cellStyle},
            {v: data.manifests.size, s: cellStyle}
        ]);
    });
    const wsUsuarios = XLSX.utils.aoa_to_sheet(wsUsuariosData);
    wsUsuarios["A1"].s = wsUsuarios["B1"].s = wsUsuarios["C1"].s = wsUsuarios["D1"].s = headerStyle;
    wsUsuarios['!cols'] = [{wch: 10}, {wch: 35}, {wch: 18}, {wch: 22}];
    XLSX.utils.book_append_sheet(wb, wsUsuarios, "Ranking Operadores");
    

    // --- HOJA 4: EVIDENCIA (NO ESCANEADOS) ---
    const wsEvidenciaData = [["SKU", "Descripción", "Piezas Faltantes (SAP)", "Manifiesto"]];
     report.skusSinEscanear.forEach(item => {
        wsEvidenciaData.push([
            {v: item.sku, s: cellStyle},
            {v: item.desc, s: cellStyle},
            {v: item.sap, s: redTextStyle},
            {v: item.manifiesto.id, s: cellStyle}
        ]);
    });
    const wsEvidencia = XLSX.utils.aoa_to_sheet(wsEvidenciaData);
    wsEvidencia["A1"].s = wsEvidencia["B1"].s = wsEvidencia["C1"].s = wsEvidencia["D1"].s = headerStyle;
    wsEvidencia['!cols'] = [{wch: 18}, {wch: 45}, {wch: 25}, {wch: 40}];
    XLSX.utils.book_append_sheet(wb, wsEvidencia, "Evidencia (No Escaneados)");

    // --- Descarga del archivo ---
    XLSX.writeFile(wb, `Reporte_Inteligencia_Semanal_${startDateStr}_a_${endDateStr}.xlsx`);
};

        const mainHTML = `
            <style>
                :root {
                    --liverpool-pink: #E10098;
                    --liverpool-green: #95C11F;
                    --liverpool-dark: #414141;
                    --liverpool-light-gray: #f4f7fa;
                    --liverpool-border-gray: #dee2e6;
                }
                .swal2-popup.swal2-modal { border-radius: 1.5rem !important; }
                .epic-summary-container{display:flex;min-height:85vh;width:100%;font-family:'Poppins',sans-serif;background:var(--liverpool-light-gray);border-radius:1.5rem;overflow:hidden;}
                .epic-sidebar{width:280px;min-width:280px;background:#ffffff;color:var(--liverpool-dark);padding:2rem 1.5rem;display:flex;flex-direction:column;align-items:flex-start;border-right: 1px solid var(--liverpool-border-gray);}
                .epic-sidebar h3{font-weight:700;font-size:1.5rem;margin-bottom:0.25rem;color:var(--liverpool-pink);}
                .epic-sidebar .date-range {font-size:0.9rem; color:#6c757d; margin-bottom: 2rem;}
                .sidebar-nav{list-style:none;padding:0;margin:0;width:100%;}
                .sidebar-nav li button{width:100%;text-align:left;padding:0.8rem 1rem;background:transparent;border:none;color:#495057;border-radius:10px;font-weight:500;display:flex;align-items:center;gap:0.8rem;transition:all 0.2s ease;margin-bottom:0.5rem;}
                .sidebar-nav li button:hover{background:#e9ecef;color:var(--liverpool-pink);}
                .sidebar-nav li button.active{background:var(--liverpool-pink);color:#fff;font-weight:600;}
                .epic-content{flex-grow:1;padding:2rem 2.5rem;overflow-y:auto;}
                .epic-tab-pane{display:none;animation:fadeIn 0.5s;} .epic-tab-pane.active{display:block;}
                .epic-content h4{font-weight:600;color:var(--liverpool-dark);margin-bottom:1.5rem;border-bottom:1px solid var(--liverpool-border-gray);padding-bottom:0.8rem;display:flex;align-items:center;justify-content:space-between;}
                
                .stat-card-main{background:#fff;border-radius:1rem;padding:1.5rem;text-align:center;border:1px solid var(--liverpool-border-gray); transition:all 0.3s ease;}
                .stat-card-main:hover{transform:translateY(-5px);box-shadow:0 8px 25px rgba(0,0,0,0.08);}
                .stat-card-main .icon{font-size:2rem;margin-bottom:0.5rem;line-height:1;}
                .stat-card-main .value{font-size:2.2rem;font-weight:700;line-height:1.1; color: var(--liverpool-dark);}
                .stat-card-main .label{color:#6c757d;font-weight:500;font-size:0.9rem;}
                .stat-card-main.sap .icon { color: var(--liverpool-dark); }
                .stat-card-main.scan .icon { color: var(--liverpool-green); }
                .stat-card-main.missing .icon { color: var(--liverpool-pink); }
                .stat-card-main.excess .icon { color: #f0ad4e; }
                
                .filter-pills { display: flex; flex-wrap: wrap; gap: 0.5rem; }
                .filter-pills button { background-color: #e9ecef; border: none; border-radius: 2rem; padding: 0.4rem 1rem; font-size: 0.9rem; font-weight: 500; transition: all 0.2s ease; cursor: pointer; }
                .filter-pills button.active { background-color: var(--liverpool-pink); color: white; box-shadow: 0 4px 10px rgba(225, 0, 152, 0.3); }

                .jefatura-card { background-color: #fff; border-radius: 1rem; padding: 1.5rem; border: 1px solid var(--liverpool-border-gray); margin-bottom: 1.5rem; }
                .jefatura-header { display: flex; align-items: center; gap: 1.5rem; padding-bottom:1rem; margin-bottom:1rem; border-bottom: 1px solid #f1f3f5; }
                .jefatura-chart-container { width: 80px; height: 80px; position: relative; flex-shrink: 0; }
                .jefatura-title h5 { font-weight: 700; margin-bottom: 0.1rem; color: var(--liverpool-dark); }
                .jefatura-title .stats-summary { font-size: 0.9rem; color: #6c757d; }
                .jefatura-secciones-list { list-style: none; padding: 0; margin: 0; }
                .jefatura-secciones-list li { display: flex; align-items: center; justify-content: space-between; padding: 0.6rem 0.2rem; font-size: 0.95rem; border-bottom: 1px solid #f8f9fa; }
                .jefatura-secciones-list li:last-child { border-bottom: none; }
                .jefatura-secciones-list .section-name { font-weight: 500; }
                
                .section-card-compact { background: #fff; border: 1px solid var(--liverpool-border-gray); border-radius: 0.75rem; padding: 1rem; text-align: center; transition: all 0.2s ease-in-out; display: flex; flex-direction: column; height: 100%;}
                .section-card-compact:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(0,0,0,0.1); z-index: 10; position:relative; }
                .section-card-compact .section-name { font-weight: 600; font-size: 0.95rem; color: var(--liverpool-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
                .section-card-compact .section-jefe { font-size: 0.8rem; color: #6c757d; margin-bottom: 0.75rem; }
                .section-card-compact .section-counts { font-size: 0.8rem; color: #6c757d; margin-top: 0.5rem; }
                
                .custom-progress { background-color: #e9ecef; border-radius: 2rem; height: 1.25rem; overflow: hidden; }
                .custom-progress-bar { display: flex; align-items: center; justify-content: center; height: 100%; color: white; font-weight: 600; font-size: 0.75rem; transition: width 0.4s ease; }
                .progress-green { background: linear-gradient(45deg, #84ac1c, #95C11F); }
                .progress-yellow { background: linear-gradient(45deg, #e69a05, #f0ad4e); }
                .progress-pink { background: linear-gradient(45deg, #d3008a, #E10098); }

                .leaderboard-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 1rem; background: #fff; margin-bottom: 0.75rem; border: 1px solid var(--liverpool-border-gray); }
                .leaderboard-rank { font-size: 1.2rem; font-weight: 700; color: var(--liverpool-pink); width: 2.5rem; text-align: center; flex-shrink: 0; }
                .leaderboard-info { flex-grow: 1; }
                .leaderboard-name { font-weight: 600; color: var(--liverpool-dark); }
                .leaderboard-details { font-size: 0.85rem; color: #6c757d; }
                .leaderboard-stats { font-size: 1.2rem; font-weight: 700; color: var(--liverpool-dark); text-align: right; }
            </style>
            <div class="epic-summary-container">
                <div class="epic-sidebar">
                    <h3><i class="bi bi-robot me-2"></i>Resumen AI</h3>
                    <p class="date-range">${startDate.toLocaleDateString('es-ES')} - ${endDate.toLocaleDateString('es-ES')}</p>
                    <ul class="sidebar-nav">
                        <li><button class="nav-btn active" data-target="dashboard"><i class="bi bi-grid-1x2-fill"></i>Dashboard</button></li>
                        <li><button class="nav-btn" data-target="jefaturas"><i class="bi bi-person-badge-fill"></i>Por Jefatura</button></li>
                        <li><button class="nav-btn" data-target="secciones"><i class="bi bi-pie-chart-fill"></i>Por Sección</button></li>
                        <li><button class="nav-btn" data-target="usuarios"><i class="bi bi-trophy-fill"></i>Ranking</button></li>
                        <li><button class="nav-btn" data-target="evidencia"><i class="bi bi-exclamation-diamond-fill"></i>Alertas <span class="badge rounded-pill" style="background-color: var(--liverpool-pink);">${report.skusSinEscanear.length}</span></button></li>
                    </ul>
                    <div class="mt-auto w-100"><button id="btnDescargarResumenExcel" class="btn btn-outline-success w-100"><i class="bi bi-file-earmarked-excel-fill me-2"></i>Descargar Excel</button></div>
                </div>
                <div class="epic-content">
                    <div id="dashboard" class="epic-tab-pane active">
                         <h4><i class="bi bi-speedometer2"></i>Resumen General</h4>
                         <div class="row g-4 mb-5">
                            <div class="col-lg-7">
                                <div class="row g-3">
                                    <div class="col-6"><div class="stat-card-main sap"><i class="bi bi-box-seam icon"></i><div class="value">${report.totalSAP.toLocaleString('es-MX')}</div><div class="label">Piezas SAP</div></div></div>
                                    <div class="col-6"><div class="stat-card-main scan"><i class="bi bi-check-circle-fill icon"></i><div class="value">${report.totalSCAN.toLocaleString('es-MX')}</div><div class="label">Escaneadas</div></div></div>
                                    <div class="col-6"><div class="stat-card-main missing"><i class="bi bi-exclamation-triangle-fill icon"></i><div class="value">${totalFaltantes.toLocaleString('es-MX')}</div><div class="label">Faltantes</div></div></div>
                                    <div class="col-6"><div class="stat-card-main excess"><i class="bi bi-plus-circle-dotted icon"></i><div class="value">${totalExcedentes.toLocaleString('es-MX')}</div><div class="label">Excedentes</div></div></div>
                                </div>
                            </div>
                            <div class="col-lg-5 d-flex align-items-center justify-content-center"><canvas id="gaugeChart"></canvas></div>
                        </div>
                         <h4><i class="bi bi-archive-fill me-2"></i>Manifiestos Incluidos</h4>
                         <ul class="list-group list-group-flush">${report.manifestos.map(m => `<li class="list-group-item d-flex justify-content-between align-items-center"><i class="bi bi-file-earmark-text me-2" style="color:var(--liverpool-pink);"></i><div><strong>${m.id}</strong> <br><span class="text-muted small">N° Manif: ${m.numero}</span></div></li>`).join('')}</ul>
                    </div>
                    <div id="jefaturas" class="epic-tab-pane">
                        <h4><i class="bi bi-person-badge-fill me-2"></i>Rendimiento por Jefatura</h4>
                        <div id="jefaturas-grid" style="max-height: 75vh; overflow-y: auto; padding: 0.2rem;"></div>
                    </div>
                    <div id="secciones" class="epic-tab-pane">
                        <h4><i class="bi bi-pie-chart-fill me-2"></i>Rendimiento por Sección</h4>
                        <div id="seccion-jefatura-filter" class="filter-pills mb-4"></div>
                        <div id="secciones-grid-container" class="row row-cols-2 row-cols-md-3 row-cols-xl-4 g-3"></div>
                    </div>
                    <div id="usuarios" class="epic-tab-pane">
                        <h4><i class="bi bi-trophy-fill me-2"></i>Ranking de Operadores</h4>
                        <div style="max-height: 75vh; overflow-y: auto; padding-right:10px;">
                            ${topScanners.length > 0 ? topScanners.map(([email, data], i) => `
                                <div class="leaderboard-item">
                                    <div class="leaderboard-rank">${['🥇','🥈','🥉'][i] || `#${i+1}`}</div>
                                    <div class="leaderboard-info">
                                        <div class="leaderboard-name">${email}</div>
                                        <div class="leaderboard-details">En ${data.manifests.size} manifiesto(s)</div>
                                    </div>
                                    <div class="leaderboard-stats">${data.scans.toLocaleString('es-MX')} <span class="small text-muted">pzs</span></div>
                                </div>`).join('') : '<p class="text-muted text-center mt-4">No hay datos de rendimiento de usuarios.</p>'}
                        </div>
                    </div>
                     <div id="evidencia" class="epic-tab-pane">
                        <h4 style="color: var(--liverpool-pink);"><i class="bi bi-exclamation-diamond-fill me-2"></i>Artículos con Cero Escaneos</h4>
                        <div style="max-height: 75vh; overflow-y: auto; padding-right:10px;"><ul class="list-group list-group-flush">${report.skusSinEscanear.length > 0 ? report.skusSinEscanear.map(item => `<li class="list-group-item d-flex justify-content-between align-items-center"><div><strong style="color:var(--liverpool-dark);">${item.sku}</strong> - ${item.desc}<br><small class="text-muted">Manifiesto: ${item.manifiesto.id}</small></div><span class="badge rounded-pill" style="background-color: var(--liverpool-pink);">${item.sap} pz.</span></li>`).join('') : '<li class="list-group-item text-center text-success fs-5 p-4">¡Felicidades! Todos los artículos fueron escaneados.</li>'}</ul></div>
                    </div>
                </div>
            </div>`;

        Swal.fire({
            html: mainHTML,
            width: '95vw',
            maxWidth: '1600px',
            showCloseButton: true,
            showConfirmButton: false,
            padding: 0,
            customClass: {
                popup: 'p-0 border-0'
            },
            didOpen: () => {
                const navButtons = document.querySelectorAll('.sidebar-nav li button');
                const tabPanes = document.querySelectorAll('.epic-tab-pane');
                document.getElementById('btnDescargarResumenExcel').addEventListener('click', descargarResumenExcel);

                navButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        navButtons.forEach(b => b.classList.remove('active'));
                        tabPanes.forEach(p => p.classList.remove('active'));
                        btn.classList.add('active');
                        document.getElementById(btn.dataset.target).classList.add('active');
                    });
                });

                const renderJefaturaFilter = () => {
                    const container = document.getElementById('seccion-jefatura-filter');
                    if (!container) return;

                    let filtersHTML = '<button class="filter-btn active" data-jefe="Todos">Todos</button>';
                    filtersHTML += jefaturasUnicas.map(jefe => `<button class="filter-btn" data-jefe="${jefe}">${jefe}</button>`).join('');
                    container.innerHTML = filtersHTML;

                    container.querySelectorAll('.filter-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            container.querySelector('.active').classList.remove('active');
                            e.currentTarget.classList.add('active');
                            renderSecciones(e.currentTarget.dataset.jefe);
                        });
                    });
                };

                const renderJefaturas = () => {
                    const grid = document.getElementById('jefaturas-grid');
                    if (!grid) return;
                    const jefesOrdenados = Object.entries(report.jefaturas).sort((a, b) => b[1].sap - a[1].sap);

                    if (jefesOrdenados.length === 0) {
                        grid.innerHTML = '<p class="text-center text-muted col-12 mt-5">No se encontraron datos de jefaturas en este periodo.</p>';
                        return;
                    }

                    grid.innerHTML = jefesOrdenados.map(([nombreJefe, data]) => {
                        const chartId = `chart-jefe-${nombreJefe.replace(/[^a-zA-Z0-9]/g, '')}`;
                        const seccionesHTML = data.secciones.sort((a,b)=>b.avance-a.avance).map(s => `
                            <li>
                                <span class="section-name">${s.nombre}</span>
                                <span class="badge rounded-pill" style="background-color: ${s.avance < 50 ? 'var(--liverpool-pink)' : s.avance < 90 ? '#f0ad4e' : 'var(--liverpool-green)'}; min-width: 50px;">${s.avance.toFixed(0)}%</span>
                            </li>
                        `).join('');

                        return `
                        <div class="jefatura-card">
                            <div class="jefatura-header">
                                <div class="jefatura-chart-container"><canvas id="${chartId}"></canvas></div>
                                <div class="jefatura-title">
                                    <h5>${nombreJefe}</h5>
                                    <span class="stats-summary">${data.scan.toLocaleString('es-MX')} / ${data.sap.toLocaleString('es-MX')} pzs escaneadas</span>
                                </div>
                            </div>
                            <ul class="jefatura-secciones-list">${seccionesHTML}</ul>
                        </div>`;
                    }).join('');

                    setTimeout(() => {
                        jefesOrdenados.forEach(([nombreJefe, data]) => {
                            const doughnutCtx = document.getElementById(`chart-jefe-${nombreJefe.replace(/[^a-zA-Z0-9]/g, '')}`)?.getContext('2d');
                            if (doughnutCtx) {
                                const avance = data.sap > 0 ? (data.scan / data.sap) * 100 : 100;
                                const colorAvance = avance < 50 ? 'var(--liverpool-pink)' : avance < 90 ? '#f0ad4e' : 'var(--liverpool-green)';
                                new Chart(doughnutCtx, {
                                    type: 'doughnut',
                                    data: { datasets: [{ data: [avance, 100 - avance], backgroundColor: [colorAvance, '#f1f3f5'], borderWidth: 0, cutout: '75%' }] },
                                    options: { responsive: true, plugins: { legend: { display: false }, tooltip: { enabled: false }}},
                                    plugins: [{
                                        id: `gaugeText-jefe-${nombreJefe}`,
                                        beforeDraw: chart => {
                                            const { ctx, width, height } = chart; ctx.restore();
                                            ctx.font = `700 ${ (height / 4).toFixed(0) }px Poppins`; ctx.fillStyle = colorAvance; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                                            ctx.fillText(`${avance.toFixed(0)}%`, width / 2, height / 2); ctx.save();
                                        }
                                    }]
                                });
                            }
                        });
                    }, 100);
                };

                const renderSecciones = (filtroJefe = 'Todos') => {
                    const grid = document.getElementById('secciones-grid-container');
                    if (!grid) return;
                    
                    const seccionesFiltradas = Object.entries(report.secciones)
                        .filter(([_, data]) => filtroJefe === 'Todos' || data.jefatura === filtroJefe);
                    
                    if (seccionesFiltradas.length === 0) {
                        grid.innerHTML = '<div class="col-12"><p class="text-center text-muted mt-4">No hay secciones que coincidan con el filtro.</p></div>';
                        return;
                    }
                    
                    grid.innerHTML = seccionesFiltradas.sort((a, b) => b[1].sap - a[1].sap).map(([nombre, data]) => {
                        const avance = data.sap > 0 ? (data.scan / data.sap * 100) : 100;
                        const progressColorClass = avance < 50 ? 'progress-pink' : avance < 90 ? 'progress-yellow' : 'progress-green';
                        
                        return `<div class="col">
                            <div class="section-card-compact">
                                <div class="section-name" title="${data.descripcion}">${nombre}</div>
                                <div class="section-jefe">${data.jefatura}</div>
                                <div class="custom-progress">
                                    <div class="custom-progress-bar ${progressColorClass}" style="width: ${avance}%;">${avance.toFixed(0)}%</div>
                                </div>
                                <div class="section-counts">${data.scan.toLocaleString('es-MX')} / ${data.sap.toLocaleString('es-MX')} pzs</div>
                            </div>
                        </div>`;
                    }).join('');
                };

                renderJefaturaFilter();
                renderJefaturas();
                renderSecciones();

                new Chart(document.getElementById('gaugeChart'), {
                    type: 'doughnut',
                    data: { datasets: [{ data: [avanceGeneral, 100 - avanceGeneral], backgroundColor: ['var(--liverpool-pink)', '#e9ecef'], borderWidth: 0, circumference: 180, rotation: 270 }] },
                    options: { responsive: true, aspectRatio: 2, cutout: '80%', plugins: { legend: { display: false }, tooltip: { enabled: false } } },
                    plugins: [{ id: 'gaugeText-main', beforeDraw: chart => {
                        const { ctx, width, height } = chart; ctx.restore();
                        ctx.font = `800 ${ (height / 6).toFixed(0) }px Poppins`; ctx.fillStyle = 'var(--liverpool-pink)'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                        ctx.fillText(`${avanceGeneral.toFixed(1)}%`, width / 2, height - (height * 0.1)); ctx.save();
                    }}]
                });
            }
        });
    } catch (error) {
        console.error("Error al generar el resumen semanal:", error);
        Swal.fire('Error Inesperado', 'No se pudo completar la operación. Por favor, revisa la consola.', 'error');
    }
}
 function renderItems(file, isDestacado) {
                    const p = file.progreso;
                    const ultimaModificacion = formatFecha(file.createdAt);
                    const diasDesdeSubida = Math.floor((new Date() - file.createdAt) / (1000 * 60 * 60 * 24));

                    let estadoInfo;
                    if (p.avance >= 100) {
                        estadoInfo = (p.totalSCAN > p.totalSAP) ? { texto: 'Con Sobrantes', clase: 'con-sobrantes' } : { texto: 'Completo', clase: 'completo' };
                    } else if (p.avance >= 50) {
                        estadoInfo = { texto: 'Avanzado', clase: 'avanzado' };
                    } else if (p.avance > 0) {
                        estadoInfo = { texto: 'En Progreso', clase: 'en-progreso' };
                    } else {
                        estadoInfo = { texto: 'Sin Iniciar', clase: 'sin-iniciar' };
                    }

                    const isOld = diasDesdeSubida > 5;
                    const actionButtons = [];

                    // Usaremos Bootstrap Icons para mejor calidad y claridad.
                    if (permissions.canScan) {
                        actionButtons.push(`<button class="btn btn-sm btn-primary" onclick="verDashboardArchivo('${file.folder}','${file.name}')" title="Ver análisis detallado" aria-label="Ver análisis detallado para ${file.name}">
                            <i class="bi bi-bar-chart-line-fill fs-5"></i>
                        </button>`);
                    }

                    if (permissions.canGenerateReport) {
                        actionButtons.push(`<button class="btn btn-sm btn-success text-white" onclick="window.downloadFile('${file.folder}','${file.name}')" title="Descargar reporte en Excel" aria-label="Descargar ${file.name} como Excel">
                            <i class="bi bi-file-earmark-excel-fill fs-5"></i>
                        </button>`);
                        
                        actionButtons.push(`<button class="btn btn-sm btn-danger" onclick="window.generatePdfReport('${file.folder}','${file.name}')" title="Generar reporte PDF" aria-label="Generar PDF para ${file.name}">
                            <i class="bi bi-file-earmark-pdf-fill fs-5"></i>
                        </button>`);
                    }

                    if (permissions.canArchive) {
                        actionButtons.push(`<button class="btn btn-sm btn-secondary" onclick="window.archivarManifiesto('${file.name}', '${file.folder}')" title="Archivar este manifiesto" aria-label="Archivar manifiesto ${file.name}">
                            <i class="bi bi-archive-fill fs-5"></i>
                        </button>`);
                    }

                    let statusClass = isOld ? 'is-archivable' : `status-${estadoInfo.clase}`;


                    return `
                        <div class="manifest-card-pro ${statusClass}">
                            ${isDestacado ? `<div class="badge-destacado"><i class="bi bi-fire"></i> Destacado</div>` : ''}
                            ${isOld ? `<div class="archivable-notice">ACCIÓN REQUERIDA (Subido hace ${diasDesdeSubida} días)</div>` : ''}
                            <div class="card-header">
                                <div class="file-name">${file.name}</div>
                                <div class="file-store">Tienda: <strong>${file.folder}</strong> | Subido: ${ultimaModificacion}</div>
                            </div>
                            <div class="card-body">
                                <div class="progress-preview">
                                    <div class="progress-title">
                                        <span>Progreso de Escaneo</span>
                                        <span>${p.avance}%</span>
                                    </div>
                                    <div class="progress-bar-container">
                                        <div class="progress-bar-fill" style="width: ${p.avance}%;"></div>
                                    </div>
                                </div>
                                <div class="card-stats">
                                    <div>
                                        <div class="stat-value">${p.totalSCAN.toLocaleString()} / ${p.totalSAP.toLocaleString()}</div>
                                        <div class="stat-label">Escaneado vs. SAP</div>
                                    </div>
                                    <div>
                                        <span class="status-tag ${estadoInfo.clase}">${estadoInfo.texto}</span>
                                        <div class="stat-label">Estado</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                ${actionButtons}
                            </div>
                        </div>`;
                }

                window.archivarManifiesto = async (fileName, folder) => {
                    const {
                        isConfirmed
                    } = await Swal.fire({
                        title: '¿Archivar Manifiesto?',
                        html: `Esto moverá <strong>${fileName}</strong> a una carpeta de archivados y lo quitará de esta vista. Esta acción es difícil de revertir. ¿Continuar?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, Archivar',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#dc3545'
                    });

                    if (isConfirmed) {
                        Swal.fire({
                            title: 'Archivando...',
                            text: 'Por favor espera.',
                            allowOutsideClick: false,
                            didOpen: () => Swal.showLoading()
                        });

                        try {
                            const originalRef = storage.ref(`Manifiestos/${folder}/${fileName}`);
                            const archivedRef = storage.ref(`Archivados/${folder}/${fileName}`);
                            const url = await originalRef.getDownloadURL();
                            const blob = await (await fetch(url)).blob();

                            await archivedRef.put(blob);
                            await originalRef.delete();
                            await db.collection('manifiestos').doc(fileName).delete();

                            await Swal.fire('¡Archivado!', 'El manifiesto ha sido archivado con éxito.', 'success');

                            listarArchivos();
                        } catch (error) {
                            console.error("Error al archivar:", error);
                            Swal.fire('Error', 'No se pudo completar el archivado del manifiesto.', 'error');
                        }
                    }
                };

                window.verDashboardArchivo = async (folder, fileName) => {
                    try {
                        await reconstructManifestDataFromFirebase(fileName);
                        const datos = excelDataGlobal[fileName].data;

                        const stats = calculateProStatistics(datos);

                        const statColors = {
                            total: { bg: 'linear-gradient(135deg, #E6007E 0%, #fff 100%)', icon: 'apps', color: '#E6007E' },
                            expected: { bg: 'linear-gradient(135deg, #6f42c1 0%, #fff 100%)', icon: 'inventory', color: '#6f42c1' },
                            scanned: { bg: 'linear-gradient(135deg, #198754 0%, #fff 100%)', icon: 'task_alt', color: '#198754' },
                            missing: { bg: 'linear-gradient(135deg, #dc3545 0%, #fff 100%)', icon: 'remove_circle', color: '#dc3545' },
                            excess: { bg: 'linear-gradient(135deg, #ffc107 0%, #fff 100%)', icon: 'add_circle', color: '#ffc107' }
                        };
                        const createProStatCard = (title, value, iconKey, className) => {
                            const colorObj = statColors[className] || statColors.total;
                            return `
                                <div class="stat-card ${className} animate__animated animate__fadeInUp" style="
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center;
                                    gap: 1.2rem; 
                                    box-shadow: 0 8px 24px rgba(0,0,0,0.10); 
                                    border-left: 8px solid ${colorObj.color}; 
                                    background: ${colorObj.bg};
                                    transition: transform 0.3s cubic-bezier(.4,2,.3,1);
                                    text-align: center;
                                ">
                                    <div class="stat-icon d-flex align-items-center justify-content-center" style="
                                        background: ${colorObj.bg};
                                        border-radius: 50%; 
                                        width: 56px; 
                                        height: 56px; 
                                        box-shadow: 0 4px 16px ${colorObj.color}22;
                                        animation: bounceIn 1s;
                                    ">
                                        <i class="material-icons" style="font-size: 2.5rem; color: ${colorObj.color}; filter: drop-shadow(0 2px 4px ${colorObj.color}33);">${colorObj.icon}</i>
                                    </div>
                                    <div class="stat-info" style="flex: 1;">
                                        <div class="stat-value" style="
                                            font-size: 2.5rem; 
                                            font-weight: 800; 
                                            color: #343a40; 
                                            margin-bottom: 4px;
                                            letter-spacing: 1px;
                                            text-shadow: 0 2px 8px ${colorObj.color}11;
                                            animation: pulse 1.2s;
                                        ">${value.toLocaleString('es-MX')}</div>
                                        <div class="stat-title" style="
                                            font-size: 1.05rem; 
                                            color: ${colorObj.color}; 
                                            font-weight: 700;
                                            letter-spacing: 0.5px;
                                        ">${title}</div>
                                    </div>
                                </div>
                                <style>
                                    @keyframes bounceIn {
                                        0% { transform: scale(0.7); opacity: 0; }
                                        60% { transform: scale(1.15); opacity: 1; }
                                        80% { transform: scale(0.95); }
                                        100% { transform: scale(1); }
                                    }
                                    @keyframes pulse {
                                        0% { text-shadow: 0 0 0 #e6007e11; }
                                        50% { text-shadow: 0 4px 16px #e6007e33; }
                                        100% { text-shadow: 0 2px 8px #e6007e11; }
                                    }
                                </style>
                            `;
                        };
                        const createKeyInsightsPanel = (stats) => {
                            // Iconos modernos y con sentido para cada tipo de insight
                            const icons = {
                                missingContainer: { icon: 'bi bi-box-seam', color: '#dc3545', bg: '#fff0f3' },
                                excessContainer: { icon: 'bi bi-boxes', color: '#ffc107', bg: '#fffbe6' },
                                missingSection: { icon: 'bi bi-grid-3x3-gap', color: '#dc3545', bg: '#fff0f3' },
                                excessSection: { icon: 'bi bi-grid-1x2-fill', color: '#ffc107', bg: '#fffbe6' }
                            };
                            // Badge para cantidad, menos saturado y más legible
                            const quantityBadge = (qty, color) => `
                                <span class="quantity-badge" style="
                                    background: ${color}22;
                                    color: ${color};
                                    font-weight:700;
                                    border-radius:12px;
                                    padding:2px 10px;
                                    margin-left:auto;
                                    font-size:1rem;
                                    min-width:60px;
                                    text-align:right;
                                ">${qty.toLocaleString('es-MX')} pz</span>
                            `;
                            // Lista de insights con botón "Ver más" y "Ver menos"
                            function createListItems(items, type, listId) {
                                if (items.length === 0)
                                    return `<li class="insight-empty"><i class="bi bi-emoji-neutral" style="font-size:1.3rem;color:#adb5bd;"></i> Sin datos relevantes.</li>`;
                                const maxToShow = 5;
                                const showMore = items.length > maxToShow;
                                const visibleItems = items.slice(0, maxToShow);
                                const hiddenItems = items.slice(maxToShow);

                                let html = visibleItems.map(([name, quantity], idx) => {
                                    let iconObj;
                                    if (type === 'missingContainer') iconObj = icons.missingContainer;
                                    else if (type === 'excessContainer') iconObj = icons.excessContainer;
                                    else if (type === 'missingSection') iconObj = icons.missingSection;
                                    else iconObj = icons.excessSection;
                                    return `
                                        <li class="insight-list-item animate__animated animate__fadeInUp" style="animation-delay:${idx * 0.08}s;">
                                            <span class="insight-icon" style="background:${iconObj.bg};">
                                                <i class="${iconObj.icon}" style="color:${iconObj.color};font-size:1.4rem;opacity:0.8;"></i>
                                            </span>
                                            <span class="item-name fw-bold" style="color:#343a40;max-width:180px;overflow:hidden;text-overflow:ellipsis;">${name}</span>
                                            ${quantityBadge(quantity, iconObj.color)}
                                        </li>
                                    `;
                                }).join('');
                                if (showMore) {
                                    html += `<li class="insight-list-item show-more-btn" style="justify-content:center;">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="
                                            document.getElementById('${listId}').classList.add('show-all');
                                            this.style.display='none';
                                            document.getElementById('${listId}-ver-menos').style.display='inline-block';
                                        ">Ver más (${hiddenItems.length})</button>
                                        <button id="${listId}-ver-menos" type="button" class="btn btn-sm btn-outline-secondary" style="display:none;" onclick="
                                            document.getElementById('${listId}').classList.remove('show-all');
                                            this.style.display='none';
                                            document.getElementById('${listId}').querySelector('.show-more-btn button').style.display='inline-block';
                                        ">Ver menos</button>
                                    </li>`;
                                    html += hiddenItems.map(([name, quantity], idx) => {
                                        let iconObj;
                                        if (type === 'missingContainer') iconObj = icons.missingContainer;
                                        else if (type === 'excessContainer') iconObj = icons.excessContainer;
                                        else if (type === 'missingSection') iconObj = icons.missingSection;
                                        else iconObj = icons.excessSection;
                                        return `
                                            <li class="insight-list-item extra-item" style="display:none;">
                                                <span class="insight-icon" style="background:${iconObj.bg};">
                                                    <i class="${iconObj.icon}" style="color:${iconObj.color};font-size:1.4rem;opacity:0.8;"></i>
                                                </span>
                                                <span class="item-name fw-bold" style="color:#343a40;max-width:180px;overflow:hidden;text-overflow:ellipsis;">${name}</span>
                                                ${quantityBadge(quantity, iconObj.color)}
                                            </li>
                                        `;
                                    }).join('');
                                }
                                return html;
                            }
                            // IDs únicos para cada lista
                            const idMissingCont = "insight-list-missing-container";
                            const idExcessCont = "insight-list-excess-container";
                            const idMissingSec = "insight-list-missing-section";
                            const idExcessSec = "insight-list-excess-section";
                            return `
                                <div class="key-insights-panel" style="
                                    background: linear-gradient(135deg,#f8f9fa 80%,#e6007e08 100%);
                                    border-radius: 18px;
                                    box-shadow: 0 8px 32px rgba(230,0,126,0.07);
                                    padding: 2rem 1.5rem;
                                    margin-top: 1rem;
                                    font-family: 'Poppins',sans-serif;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                ">
                                    <h4 style="display:flex;align-items:center;gap:12px;font-size:1.5rem;font-weight:800;color:#E6007E;margin-bottom:2rem;justify-content:center;">
                                        <i class="bi bi-lightbulb" style="font-size:2rem;color:#E6007E;opacity:0.7;"></i>
                                        Insights Clave del Manifiesto
                                    </h4>
                                    <div style="width:100%;max-width:700px;display:grid;grid-template-columns:1fr 1fr;gap:2rem;">
                                        <div>
                                            <h6 style="font-size:1.1rem;color:#dc3545;font-weight:700;margin-bottom:0.5rem;display:flex;align-items:center;gap:8px;justify-content:center;">
                                                <i class="bi bi-box-seam" style="font-size:1.3rem;color:#dc3545;opacity:0.7;"></i>
                                                Contenedores con Faltantes
                                            </h6>
                                            <ul id="${idMissingCont}" class="insight-list" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px;">
                                                ${createListItems(stats.topContenedoresFaltantes, 'missingContainer', idMissingCont)}
                                            </ul>
                                        </div>
                                        <div>
                                            <h6 style="font-size:1.1rem;color:#ffc107;font-weight:700;margin-bottom:0.5rem;display:flex;align-items:center;gap:8px;justify-content:center;">
                                                <i class="bi bi-boxes" style="font-size:1.3rem;color:#ffc107;opacity:0.7;"></i>
                                                Contenedores con Excedentes
                                            </h6>
                                            <ul id="${idExcessCont}" class="insight-list" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px;">
                                                ${createListItems(stats.topContenedoresExcedentes, 'excessContainer', idExcessCont)}
                                            </ul>
                                        </div>
                                    </div>
                                    <hr style="margin:2rem 0;border-top:2px dashed #e6007e11;width:80%;">
                                    <div style="width:100%;max-width:700px;display:grid;grid-template-columns:1fr 1fr;gap:2rem;">
                                        <div>
                                            <h6 style="font-size:1.1rem;color:#dc3545;font-weight:700;margin-bottom:0.5rem;display:flex;align-items:center;gap:8px;justify-content:center;">
                                                <i class="bi bi-grid-3x3-gap" style="font-size:1.3rem;color:#dc3545;opacity:0.7;"></i>
                                                Secciones con Faltantes
                                            </h6>
                                            <ul id="${idMissingSec}" class="insight-list" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px;">
                                                ${createListItems(stats.topSeccionesFaltantes, 'missingSection', idMissingSec)}
                                            </ul>
                                        </div>
                                        <div>
                                            <h6 style="font-size:1.1rem;color:#ffc107;font-weight:700;margin-bottom:0.5rem;display:flex;align-items:center;gap:8px;justify-content:center;">
                                                <i class="bi bi-grid-1x2-fill" style="font-size:1.3rem;color:#ffc107;opacity:0.7;"></i>
                                                Secciones con Excedentes
                                            </h6>
                                            <ul id="${idExcessSec}" class="insight-list" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px;">
                                                ${createListItems(stats.topSeccionesExcedentes, 'excessSection', idExcessSec)}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <style>
                                    .key-insights-panel .insight-list-item {
                                        display: flex;
                                        align-items: center;
                                        gap: 14px;
                                        padding: 8px 0;
                                        border-bottom: 1px solid #f1f1f1;
                                        font-size: 1rem;
                                        transition: background 0.2s;
                                        justify-content: flex-start;
                                    }
                                    .key-insights-panel .insight-list-item:last-child {
                                        border-bottom: none;
                                    }
                                    .key-insights-panel .insight-icon {
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        width: 34px;
                                        height: 34px;
                                        border-radius: 50%;
                                        background: #f8f9fa;
                                        box-shadow: 0 2px 8px #e6007e08;
                                    }
                                    .key-insights-panel .quantity-badge {
                                        font-size: 1rem;
                                        font-weight: 700;
                                        letter-spacing: 0.5px;
                                        min-width: 60px;
                                        text-align: right;
                                    }
                                    .key-insights-panel .insight-empty {
                                        color: #6c757d;
                                        font-style: italic;
                                        padding: 10px 0;
                                        text-align: center;
                                    }
                                    .key-insights-panel ul.insight-list {
                                        margin: 0 auto;
                                    }
                                    /* Mostrar todos los elementos extra cuando show-all está activo */
                                    .key-insights-panel ul.show-all .extra-item {
                                        display: flex !important;
                                    }
                                </style>
                            `;
                        };

                        const isComplete = stats.avance >= 100;
                        const statusClass = isComplete ? 'is-success' : 'is-warning';
                        const statusMessage = isComplete ? `<i class="material-icons">celebration</i> ¡Manifiesto completo! Excelente trabajo 🎉` : `<i class="material-icons">warning</i> Aún falta un ${100 - stats.avance}% por completar. ¡Ánimo!`;

                        const canvasId = `grafico_pro_${fileName.replace(/[^a-zA-Z0-9]/g, '_')}`;
                        const dashboardHTML = `
                            <div class="analisis-dashboard-pro" style="max-width:1200px;margin:0 auto;padding:2.5rem 1.5rem;background:linear-gradient(135deg,#fff 80%,#e6007e10 100%);border-radius:32px;box-shadow:0 12px 40px rgba(230,0,126,0.10);">
                                <div class="status-message ${statusClass}" style="justify-content:center;text-align:center;font-size:1.25rem;border-radius:12px;margin-bottom:2rem;box-shadow:0 2px 8px #e6007e11;">
                                    ${statusMessage}
                                </div>
                                <div class="stats-grid stats-grid-responsive" style="margin:0 auto;max-width:950px;gap:2rem;">
                                    ${createProStatCard('SKUs Totales', stats.totalSKUs, 'apps', 'total')}
                                    ${createProStatCard('Piezas Esperadas (SAP)', stats.totalSAP, 'inventory', 'expected')}
                                    ${createProStatCard('Piezas Escaneadas', stats.totalSCAN, 'task_alt', 'scanned')}
                                    ${createProStatCard('Piezas Faltantes', stats.faltantes, 'error', 'missing')}
                                    ${createProStatCard('Piezas Excedentes', stats.excedentes, 'add_shopping_cart', 'excess')}
                                </div>
                                <div class="progress-container" style="margin:2.5rem auto 2.5rem auto;max-width:520px;height:32px;box-shadow:0 2px 8px #e6007e11;">
                                    <div class="progress-fill ${isComplete ? 'bg-success' : 'bg-primary'}" style="width:${stats.avance}%;font-size:1.25rem;justify-content:center;align-items:center;height:100%;border-radius:32px;">
                                        <span style="font-weight:700;">${stats.avance}%</span>
                                    </div>
                                </div>
                                <div class="dashboard-main-layout" style="display:flex;flex-wrap:wrap;justify-content:center;align-items:flex-start;gap:2.5rem;">
                                    <div class="chart-container" style="flex:1 1 350px;max-width:400px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#fff;border-radius:20px;box-shadow:0 4px 24px #e6007e11;padding:2rem 1rem;">
                                        <canvas id="${canvasId}" style="margin:0 auto;display:block;max-width:340px;max-height:340px;"></canvas>
                                        <div style="text-align:center;margin-top:1.2rem;font-size:1.05rem;color:#6c757d;">
                                            <i class="material-icons" style="vertical-align:middle;color:#0d6efd;">pie_chart</i>
                                            <span>Distribución de piezas</span>
                                        </div>
                                    </div>
                                    <div style="flex:2 1 600px;max-width:700px;">
                                        ${createKeyInsightsPanel(stats)}
                                    </div>
                                </div>
                            </div>
                            <style>
                                .analisis-dashboard-pro {
                                    background: linear-gradient(135deg,#fff 80%,#e6007e10 100%);
                                    border-radius: 32px;
                                    box-shadow: 0 12px 40px rgba(230,0,126,0.10);
                                    padding: 2.5rem 1.5rem;
                                }
                                .stats-grid.stats-grid-responsive {
                                    display: grid;
                                    grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
                                    gap: 2rem;
                                    justify-content: center;
                                    margin-bottom: 2rem;
                                }
                                .stat-card {
                                    min-width: 210px;
                                    max-width: 260px;
                                    width: 100%;
                                    padding: 1.2rem 1rem;
                                    margin: 0 auto;
                                    box-sizing: border-box;
                                }
                                .stat-card .stat-value {
                                    font-size: 2.2rem !important;
                                    font-weight: 800;
                                    color: #343a40;
                                    margin-bottom: 4px;
                                    letter-spacing: 1px;
                                    text-shadow: 0 2px 8px #e6007e11;
                                    animation: pulse 1.2s;
                                }
                                .stat-card .stat-title {
                                    font-size: 1rem !important;
                                    color: inherit;
                                    font-weight: 700;
                                    letter-spacing: 0.5px;
                                }
                                .stat-card .stat-icon {
                                    width: 48px !important;
                                    height: 48px !important;
                                    font-size: 2rem !important;
                                }
                                .progress-container {
                                    box-shadow: 0 2px 8px #e6007e11;
                                    height: 32px;
                                    border-radius: 32px;
                                    background: #f8f9fa;
                                    overflow: hidden;
                                }
                                .progress-fill {
                                    height: 100%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: #fff;
                                    font-weight: 700;
                                    font-size: 1.25rem;
                                    transition: width 0.5s cubic-bezier(.4,2,.3,1);
                                    background: linear-gradient(90deg,#e6007e 0%,#0d6efd 100%);
                                }
                                .dashboard-main-layout {
                                    margin-top:2rem;
                                    gap:2.5rem;
                                }
                                .chart-container {
                                    background: #fff;
                                    border-radius: 20px;
                                    box-shadow: 0 4px 24px #e6007e11;
                                    padding: 2rem 1rem;
                                    min-width: 320px;
                                }
                                @media (max-width: 900px) {
                                    .dashboard-main-layout {
                                        flex-direction: column;
                                        gap: 1.5rem;
                                    }
                                    .chart-container, .key-insights-panel {
                                        max-width: 100% !important;
                                    }
                                    .analisis-dashboard-pro {
                                        padding: 1.2rem 0.5rem;
                                    }
                                    .stats-grid.stats-grid-responsive {
                                        grid-template-columns: 1fr 1fr;
                                        gap: 1rem;
                                    }
                                    .stat-card {
                                        min-width: 160px;
                                        max-width: 100%;
                                        padding: 1rem 0.5rem;
                                    }
                                }
                                @media (max-width: 600px) {
                                    .stats-grid.stats-grid-responsive {
                                        grid-template-columns: 1fr;
                                        gap: 0.7rem;
                                    }
                                    .stat-card {
                                        min-width: 120px;
                                        padding: 0.7rem 0.3rem;
                                    }
                                }
                            </style>
                        `;
                    
                        await Swal.fire({
                            title: `<span style="display: flex; align-items: center; gap: 8px; font-size:1.7rem; font-weight:700; color:#E6007E;"><i class="material-icons text-primary" style="font-size:2.2rem; color:#0d6efd;">analytics</i> Análisis PRO: <span style="color:#0d6efd;">${fileName}</span></span>`,
                            html: dashboardHTML,
                            width: '98vw',
                            maxWidth: '1400px',
                            padding: '0',
                            showCloseButton: true,
                            showConfirmButton: false,
                            customClass: {
                                popup: 'dashboard-modal'
                            },
                            didOpen: () => {
                                const chartContainer = document.getElementById(canvasId);
                                if (chartContainer) {
                                    chartContainer.height = 340;
                                    chartContainer.width = 340;
                                    const ctx = chartContainer.getContext('2d');
                                    new Chart(ctx, {
                                        type: 'doughnut',
                                        data: {
                                            labels: ['Correcto', 'Faltante', 'Excedente'],
                                            datasets: [{
                                                data: [stats.totalSCAN - stats.excedentes, stats.faltantes, stats.excedentes],
                                                backgroundColor: [
                                                    'rgba(32,201,151,0.85)', // Correcto
                                                    'rgba(220,53,69,0.85)',  // Faltante
                                                    'rgba(255,193,7,0.85)'   // Excedente
                                                ],
                                                borderColor: '#fff',
                                                borderWidth: 6,
                                                hoverOffset: 16,
                                                shadowOffsetX: 2,
                                                shadowOffsetY: 2,
                                                shadowBlur: 8,
                                                shadowColor: 'rgba(0,0,0,0.10)'
                                            }]
                                        },
                                        options: {
                                            responsive: false,
                                            maintainAspectRatio: false,
                                            cutout: '72%',
                                            plugins: {
                                                legend: {
                                                    position: 'bottom',
                                                    labels: {
                                                        padding: 24,
                                                        usePointStyle: true,
                                                        pointStyle: 'rectRounded',
                                                        font: { size: 15, family: 'Poppins', weight: 'bold' },
                                                        color: '#343a40'
                                                    }
                                                },
                                                tooltip: {
                                                    backgroundColor: '#fff',
                                                    titleColor: '#E6007E',
                                                    bodyColor: '#343a40',
                                                    borderColor: '#E6007E',
                                                    borderWidth: 1,
                                                    callbacks: {
                                                        label: c => ` ${c.label}: ${c.raw.toLocaleString('es-MX')} piezas`
                                                    }
                                                }
                                            }
                                        }
                                    });
                                }
                                // Mejorar accesibilidad y foco visual
                                setTimeout(() => {
                                    const popup = document.querySelector('.swal2-popup.dashboard-modal');
                                    if (popup) {
                                        popup.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    }
                                }, 300);
                            }
                            });

                    } catch (e) {
                        console.error("Error al generar dashboard PRO:", e);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error Inesperado',
                            text: 'No se pudo generar el dashboard del archivo.'
                        });
                    }
                };
window.generatePdfReport = async (folder, name) => {
    Swal.fire({
        title: 'Generando Reporte PDF...',
        html: `Creando un dashboard y resúmenes de análisis. ¡Un momento, por favor!<br>
               <div class="mt-3 spinner-border text-primary" role="status">
                 <span class="visually-hidden">Cargando...</span>
               </div>`,
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });

    try {
        await reconstructManifestDataFromFirebase(name);
        const data = excelDataGlobal[name].data;
        const stats = calculateProStatistics(data);

        const canvas = document.getElementById('hiddenChartCanvas');
        canvas.width = 1000;
        canvas.height = 500;
        const ctx = canvas.getContext('2d');

        if (canvas.chartInstance) {
            canvas.chartInstance.destroy();
        }

        canvas.chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Correcto', 'Faltante', 'Excedente'],
                datasets: [{
                    data: [stats.totalSCAN - stats.excedentes, stats.faltantes, stats.excedentes],
                    backgroundColor: ['#4CAF50', '#dc3545', '#FFC107'],
                    borderColor: '#ffffff',
                    borderWidth: 10,
                    hoverOffset: 20
                }]
            },
            options: {
                responsive: false, maintainAspectRatio: false, cutout: '70%',
                plugins: {
                    legend: { position: 'right', labels: { font: { size: 14, family: 'Roboto', weight: 'normal' }, padding: 20, usePointStyle: true, pointStyle: 'circle' }},
                    tooltip: { callbacks: { label: c => ` ${c.label}: ${c.raw.toLocaleString('es-MX')} piezas` }}
                }
            }
        });

        await new Promise(resolve => setTimeout(resolve, 1000));
        const chartImage = canvas.toDataURL('image/png', 1.0);
        
        // ESTE BLOQUE ES ESENCIAL
        pdfMake.fonts = {
           Roboto: {
             normal: 'Roboto-Regular.ttf',
             bold: 'Roboto-Medium.ttf',
             italics: 'Roboto-Italic.ttf',
             bolditalics: 'Roboto-MediumItalics.ttf'
           }
        };
        
        const formatInsightList = (title, items, type) => {
            const listContent = items.length === 0 ? [{ text: 'No hay datos disponibles.', color: '#6c757d', margin: [0, 5], fontSize: 9 }] :
                items.map(([name, quantity]) => ({
                    columns: [
                        { text: name, width: 'auto', bold: true, fontSize: 9, color: '#343a40' },
                        { text: `${quantity.toLocaleString('es-MX')} pz.`, alignment: 'right', color: type === 'missing' ? '#dc3545' : '#ffc107', fontSize: 9 },
                    ],
                    margin: [0, 3]
                }));
            return [
                { text: title, style: 'subheaderSection', margin: [0, 10, 0, 5] },
                { stack: listContent, margin: [10, 0, 0, 0] }
            ];
        };

        const docDefinition = {
            defaultStyle: { font: 'Roboto', fontSize: 9, lineHeight: 1.3, color: '#343a40' },
            pageMargins: [40, 80, 40, 60],
            header: function(currentPage, pageCount, pageSize) {
                return {
                    columns: [
                        { text: 'LIVERPOOL', style: 'headerMainText' },
                        { text: `REPORTE DE MANIFIESTO - ${name.toUpperCase().replace(/\.XLSX$/,'')}`, style: 'headerSubText' }
                    ],
                    margin: [40, 30, 40, 0],
                    canvas: [{ type: 'line', x1: 0, y1: 0, x2: pageSize.width - 80, y2: 0, lineWidth: 1, lineColor: '#E6007E' }]
                };
            },
            footer: function(currentPage, pageCount, pageSize) {
                return {
                    columns: [
                        { text: 'CONFIDENCIAL | SISTEMA DE MANIFIESTOS', style: 'footerMainText' },
                        { text: `PÁGINA ${currentPage.toString()} de ${pageCount}`, style: 'footerPageNum' }
                    ],
                    margin: [40, 0, 40, 30],
                    canvas: [{ type: 'line', x1: 0, y1: 0, x2: pageSize.width - 80, y2: 0, lineWidth: 1, lineColor: '#E6007E' }]
                };
            },
            content: [
                { columns: [ { width: '45%', stack: [ { text: 'ANÁLISIS EJECUTIVO DEL MANIFIESTO', style: 'mainSectionTitle' }, { text: `Manifiesto: ${data[0]?.MANIFIESTO || 'N/A'}`, style: 'mainSubInfo' }, { text: `Archivo de Origen: ${name}`, style: 'mainSubInfo' }, { text: `Generado por: ${currentUser.email || 'Usuario Desconocido'}`, style: 'mainSubInfo' }, { text: `Fecha del Reporte: ${formatFecha(new Date())}`, style: 'mainSubInfo', margin: [0, 5, 0, 20] }, ] }, { width: '55%', image: chartImage, fit: [350, 350], alignment: 'right', margin: [0, -40, 0, 0] } ] },
                { columns: [ { stack: [{ text: "PIEZAS ESPERADAS", style: "metricLabelStyle" }, { text: stats.totalSAP.toLocaleString("es-MX"), style: "metricValueMainStyle" }], alignment: "center" }, { stack: [{ text: "PIEZAS ESCANEADAS", style: "metricLabelStyle" }, { text: stats.totalSCAN.toLocaleString("es-MX"), style: "metricValueSuccessStyle" }], alignment: "center" }, { stack: [{ text: "SKUs TOTALES", style: "metricLabelStyle" }, { text: stats.totalSKUs.toLocaleString("es-MX"), style: "metricValueMainStyle" }], alignment: "center" }, ], columnGap: 20, margin: [0, 0, 0, 20] },
                { columns: [ { stack: [{ text: "PIEZAS FALTANTES", style: "metricLabelStyle" }, { text: stats.faltantes.toLocaleString("es-MX"), style: "metricValueDangerStyle" }], alignment: "center" }, { stack: [{ text: "PIEZAS EXCEDENTES", style: "metricLabelStyle" }, { text: stats.excedentes.toLocaleString("es-MX"), style: "metricValueWarningStyle" }], alignment: "center" }, { stack: [{ text: "PROGRESO GENERAL", style: "metricLabelStyle" }, { text: `${stats.avance}%`, style: "metricValueAccentStyle" }], alignment: "center" }, ], columnGap: 20, margin: [0, 0, 0, 60] },
                { text: 'ANÁLISIS DE INCIDENCIAS', style: 'mainSectionTitle', pageBreak: 'before' },
                { text: 'Identifica y aborda rápidamente las discrepancias en el inventario para una gestión eficiente.', style: 'sectionDescription', margin: [0, 5, 0, 30] },
                { columns: [ { width: '50%', stack: formatInsightList('Contenedores con Faltantes', stats.topContenedoresFaltantes, 'missing') }, { width: '50%', stack: formatInsightList('Secciones con Faltantes', stats.topSeccionesFaltantes, 'missing') }, ], margin: [0, 0, 0, 30] },
                { columns: [ { width: '50%', stack: formatInsightList('Contenedores con Excedentes', stats.topContenedoresExcedentes, 'excess') }, { width: '50%', stack: formatInsightList('Secciones con Excedentes', stats.topSeccionesExcedentes, 'excess') }, ], margin: [0, 0, 0, 60] },
                { text: 'DETALLE COMPLETO DE ARTÍCULOS', style: 'mainSectionTitle', pageBreak: 'before' },
                { text: 'Listado exhaustivo de todos los SKUs y su estado actual para una auditoría detallada.', style: 'sectionDescription', margin: [0, 5, 0, 30] },
                {
                    table: {
                        headerRows: 1, widths: ['auto', '*', 'auto', 'auto', 'auto', 'auto', 'auto', 'auto'],
                        body: [
                            [{ text: 'SKU', style: 'tableHeaderElegant' }, { text: 'Descripción', style: 'tableHeaderElegant' }, { text: 'SAP', style: 'tableHeaderElegant' }, { text: 'SCAN', style: 'tableHeaderElegant' }, { text: 'DIF.', style: 'tableHeaderElegant' }, { text: 'Contenedor', style: 'tableHeaderElegant' }, { text: 'Sección', style: 'tableHeaderElegant' }, { text: 'Cond.', style: 'tableHeaderElegant' }],
                            ...data.map(item => { const sap = Number(item.SAP) || 0; const scanner = Number(item.SCANNER) || 0; let diffText = ''; let diffColor = '#343a40'; if (scanner === sap) { diffText = 'OK'; diffColor = '#4CAF50'; } else if (scanner < sap) { diffText = `-${sap - scanner}`; diffColor = '#dc3545'; } else { diffText = `+${scanner - sap}`; diffColor = '#FFC107'; } return [ { text: item.SKU || '', fontSize: 8, alignment: 'center' }, { text: item.DESCRIPCION || '', fontSize: 8 }, { text: sap.toLocaleString('es-MX'), alignment: 'center', fontSize: 8 }, { text: scanner.toLocaleString('es-MX'), alignment: 'center', fontSize: 8 }, { text: diffText, alignment: 'center', color: diffColor, bold: true, fontSize: 8 }, { text: item.CONTENEDOR || 'N/A', fontSize: 8, alignment: 'center' }, { text: item.SECCION || 'N/A', fontSize: 8, alignment: 'center' }, { text: (item.DANIO_CANTIDAD > 0 ? `${item.DANIO_CANTIDAD}` : '0'), alignment: 'center', fontSize: 8 }, ]; })
                        ]
                    },
                    alignment: 'center',
                    layout: { hLineWidth: function(i, node) { return (i === 0 || i === 1 || i === node.table.body.length) ? 1 : 0.2; }, vLineWidth: function(i, node) { return 0; }, hLineColor: function(i, node) { return (i === 0 || i === 1 || i === node.table.body.length) ? '#999' : '#eee'; }, vLineColor: function(i, node) { return 0; }, paddingLeft: function(i, node) { return 5; }, paddingRight: function(i, node) { return 5; }, paddingTop: function(i, node) { return 5; }, paddingBottom: function(i, node) { return 5; } },
                }
            ],
            styles: {
                mainSectionTitle: { fontSize: 20, bold: true, color: '#0d6efd', margin: [0, 0, 0, 10], alignment: 'left' }, sectionDescription: { fontSize: 9, color: '#6c757d', margin: [0, 0, 0, 10], alignment: 'left' }, mainSubInfo: { fontSize: 10, color: '#343a40', margin: [0, 3, 0, 0] }, subheaderSection: { fontSize: 11, bold: true, color: '#343a40', margin: [0, 8, 0, 5] }, tableHeaderElegant: { bold: true, fontSize: 8, fillColor: '#f0f0f0', alignment: 'center', color: '#343a40', margin: [0, 2] }, headerMainText: { fontSize: 10, bold: true, color: '#E6007E', alignment: 'left' }, headerSubText: { fontSize: 9, color: '#6c757d', alignment: 'right', bold: true }, footerMainText: { fontSize: 8, color: '#6c757d', alignment: 'left', bold: true }, footerPageNum: { fontSize: 8, color: '#6c757d', alignment: 'right', bold: true }, metricLabelStyle: { fontSize: 10, bold: true, color: '#6c757d', alignment: 'center', margin: [0, 0, 0, 5] }, metricValueMainStyle: { fontSize: 22, bold: true, color: '#0d6efd', alignment: 'center' }, metricValueSuccessStyle: { fontSize: 22, bold: true, color: '#4CAF50', alignment: 'center' }, metricValueDangerStyle: { fontSize: 22, bold: true, color: '#DC3545', alignment: 'center' }, metricValueWarningStyle: { fontSize: 22, bold: true, color: '#FFC107', alignment: 'center' }, metricValueAccentStyle: { fontSize: 22, bold: true, color: '#E6007E', alignment: 'center' }
            },
        };

        pdfMake.createPdf(docDefinition).download(`Reporte_Manifiesto_${name.replace(/\.xlsx$/i, '')}_${new Date().toISOString().slice(0, 10)}.pdf`);
        Swal.close();

    } catch (e) {
        console.error("Error al generar PDF:", e);
        Swal.fire({
            icon: "error",
            title: "Error",
            text: "No se pudo generar el PDF. Revisa la consola para más detalles."
        });
    }
};
                window.downloadFile = async (folder, name) => {
                    Swal.fire({
                        title: 'Generando Reporte Excel Analítico Final...',
                        html: `Creando un dashboard y resúmenes de análisis directamente visibles. ¡Un momento, por favor!<br>
                               <div class="mt-3 spinner-border text-primary" role="status">
                                 <span class="visually-hidden">Cargando...</span>
                               </div>`,
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    try {
                        const dataObjReconstructed = await reconstructManifestDataFromFirebase(name);
                        const data = dataObjReconstructed.data;

                        const stats = calculateProStatistics(data);

                        const formattedExportData = data.map(r => {
                            const sap = Number(r.SAP) || 0;
                            const sc = Number(r.SCANNER) || 0;
                            let diffValue = sc - sap;
                            let diffStatus = "";
                            if (sc === sap) diffStatus = "OK";
                            else if (sc < sap) diffStatus = "FALTANTE";
                            else diffStatus = "EXCEDENTE";

                            return {
                                FECHA: r.FECHA instanceof Date && !isNaN(r.FECHA) ? formatFecha(r.FECHA) : (r.FECHA || ''),
                                SECCION: r.SECCION || "SIN_SECCION",
                                MANIFIESTO: r.MANIFIESTO || "N/A",
                                CONTENEDOR: r.CONTENEDOR || "SIN_CONTENEDOR",
                                SKU: r.SKU || "",
                                EUROPEO: r.EUROPEO || "",
                                DESCRIPCION: r.DESCRIPCION || "",
                                SAP: sap,
                                SCANNER: sc,
                                LAST_SCANNED_BY: r.LAST_SCANNED_BY || "SIN_USUARIO",
                                ENTREGADO_A: r.ENTREGADO_A || "SIN_EMPLEADO",
                                DIFERENCIA_VALOR: diffValue,
                                DIFERENCIA_ESTADO: diffStatus,
                                FechaEscaneo: r.FECHA_ESCANEO instanceof Date && !isNaN(r.FECHA_ESCANEO) ? formatFecha(r.FECHA_ESCANEO) : (r.FECHA_ESCANEO || ''),
                                CONDICIONES_MCIA: r.DANIO_CANTIDAD || 0,
                                FOTO_CONDICIONES: r.DANIO_FOTO_URL || ""
                            };
                        });

                        const containerAnalysis = {};
                        const sectionAnalysis = {};

                        formattedExportData.forEach(row => {
                            const cont = row.CONTENEDOR;
                            const sect = row.SECCION;
                            const sap = row.SAP;
                            const scanner = row.SCANNER;
                            const diffStatus = row.DIFERENCIA_ESTADO;

                            if (!containerAnalysis[cont]) containerAnalysis[cont] = {
                                SAP: 0,
                                SCANNER: 0,
                                FALTANTE: 0,
                                EXCEDENTE: 0,
                                OK: 0
                            };
                            if (!sectionAnalysis[sect]) sectionAnalysis[sect] = {
                                SAP: 0,
                                SCANNER: 0,
                                FALTANTE: 0,
                                EXCEDENTE: 0,
                                OK: 0
                            };

                            containerAnalysis[cont].SAP += sap;
                            containerAnalysis[cont].SCANNER += scanner;
                            sectionAnalysis[sect].SAP += sap;
                            sectionAnalysis[sect].SCANNER += scanner;

                            if (diffStatus === "FALTANTE") {
                                containerAnalysis[cont].FALTANTE += (sap - scanner);
                                sectionAnalysis[sect].FALTANTE += (sap - scanner);
                            } else if (diffStatus === "EXCEDENTE") {
                                containerAnalysis[cont].EXCEDENTE += (scanner - sap);
                                sectionAnalysis[sect].EXCEDENTE += (scanner - sap);
                            } else if (diffStatus === "OK") {
                                containerAnalysis[cont].OK += scanner;
                                sectionAnalysis[sect].OK += scanner;
                            }
                        });

                        const containerAnalysisData = Object.entries(containerAnalysis).map(([key, value]) => ([
                            key, value.SAP, value.SCANNER, value.FALTANTE, value.EXCEDENTE, value.OK, (value.SCANNER - value.SAP)
                        ])).sort((a, b) => String(a[0]).localeCompare(String(b[0])));

                        const sectionAnalysisData = Object.entries(sectionAnalysis).map(([key, value]) => ([
                            key, value.SAP, value.SCANNER, value.FALTANTE, value.EXCEDENTE, value.OK, (value.SCANNER - value.SAP)
                        ])).sort((a, b) => String(a[0]).localeCompare(String(b[0])));


                        const wb = XLSX.utils.book_new();

                        const createStyledCell = (value, style = {}) => {
                            return {
                                v: value,
                                s: { ...style
                                }
                            };
                        };
                        const createMergedCellPlaceholder = () => undefined;
                        const createEmptyCell = () => ({
                            v: "",
                            s: {}
                        });

                        const dashboardTitleStyle = {
                            font: {
                                sz: 18,
                                bold: true,
                                color: {
                                    rgb: "E6007E"
                                }
                            },
                            alignment: {
                                horizontal: "center"
                            }
                        };
                        const dashboardSubtitleStyle = {
                            font: {
                                sz: 12,
                                bold: true
                            },
                            alignment: {
                                horizontal: "center"
                            }
                        };
                        const metricLabelStyle = {
                            font: {
                                bold: true,
                                color: {
                                    rgb: "6C757D"
                                }
                            },
                            alignment: {
                                horizontal: "center"
                            }
                        };
                        const metricValueMainStyle = {
                            font: {
                                sz: 24,
                                bold: true,
                                color: {
                                    rgb: "0D6EFD"
                                }
                            },
                            alignment: {
                                horizontal: "center"
                            }
                        };
                        const metricValueSuccessStyle = {
                            font: {
                                sz: 24,
                                bold: true,
                                color: {
                                    rgb: "4CAF50"
                                }
                            },
                            alignment: {
                                horizontal: "center"
                            }
                        };
                        const metricValueDangerStyle = {
                            font: {
                                sz: 24,
                                bold: true,
                                color: {
                                    rgb: "DC3545"
                                }
                            },
                            alignment: {
                                horizontal: "center"
                            }
                        };
                        const metricValueWarningStyle = {
                            font: {
                                sz: 24,
                                bold: true,
                                color: {
                                    rgb: "FFC107"
                                }
                            },
                            alignment: {
                                horizontal: "center"
                            }
                        };
                        const metricValueAccentStyle = {
                            font: {
                                sz: 24,
                                bold: true,
                                color: {
                                    rgb: "E6007E"
                                }
                            },
                            alignment: {
                                horizontal: "center"
                            }
                        };
                        const dashboardTableHeaderStyle = {
                            font: {
                                bold: true,
                                color: {
                                    rgb: "FFFFFF"
                                }
                            },
                            fill: {
                                fgColor: {
                                    rgb: "343A40"
                                }
                            },
                            alignment: {
                                horizontal: "center"
                            }
                        };


                        let wsGuideData = [];
                        let guideRow = 0;

                        wsGuideData.push([createStyledCell("Guía de Análisis", {
                            font: {
                                sz: 16,
                                bold: true,
                                color: {
                                    rgb: "E6007E"
                                }
                            }
                        }), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("Empodera tus decisiones con análisis de datos avanzado.", {
                            font: {
                                sz: 10,
                                italic: true,
                                color: {
                                    rgb: "6C757D"
                                }
                            }
                        }), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createEmptyCell(), createEmptyCell(), createEmptyCell()]);
                        guideRow++;

                        wsGuideData.push([createStyledCell("¿Por qué usar Tablas Dinámicas?", {
                            font: {
                                sz: 12,
                                bold: true,
                                color: {
                                    rgb: "0D6EFD"
                                }
                            }
                        }), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("Las Tablas Dinámicas (PivotTables) son herramientas poderosas en Excel para resumir, analizar, explorar y presentar datos de forma interactiva y flexible. Te permiten ver patrones, tendencias y hacer comparaciones rápidamente sin cambiar el origen de los datos.", {}), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createEmptyCell(), createEmptyCell(), createEmptyCell()]);
                        guideRow++;

                        wsGuideData.push([createStyledCell("Paso 1: Preparar los Datos Fuente", {
                            font: {
                                sz: 12,
                                bold: true,
                                color: {
                                    rgb: "0D6EFD"
                                }
                            }
                        }), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("Todos los datos detallados de este manifiesto se encuentran en la hoja 'Detalles Completos'. Asegúrate de que todas las columnas tengan encabezados claros.", {}), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createEmptyCell(), createEmptyCell(), createEmptyCell()]);
                        guideRow++;

                        wsGuideData.push([createStyledCell("Paso 2: Crear una Tabla Dinámica", {
                            font: {
                                sz: 12,
                                bold: true,
                                color: {
                                    rgb: "0D6EFD"
                                }
                            }
                        }), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("1. Ve a la hoja 'Detalles Completos'.", {}), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("2. Selecciona cualquier celda dentro de tus datos.", {}), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("3. En el menú superior de Excel, ve a la pestaña 'Insertar' y haz clic en 'Tabla dinámica' (o 'PivotTable').", {}), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("4. En la ventana 'Crear tabla dinámica', asegúrate de que el 'Rango de la tabla/rango' sea el correcto (normalmente Excel lo detecta automáticamente).", {}), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("5. En 'Elige dónde quieres colocar la tabla dinámica', selecciona 'Nueva hoja de cálculo' para un análisis limpio y haz clic en 'Aceptar'.", {}), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createEmptyCell(), createEmptyCell(), createEmptyCell()]);
                        guideRow++;

                        wsGuideData.push([createStyledCell("Paso 3: Configurar tu Análisis Específico", {
                            font: {
                                sz: 12,
                                bold: true,
                                color: {
                                    rgb: "0D6EFD"
                                }
                            }
                        }), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("Se abrirá una nueva hoja con un panel a la derecha ('Campos de tabla dinámica'). Arrastra los campos a las áreas correspondientes:", {}), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createEmptyCell(), createEmptyCell(), createEmptyCell()]);
                        guideRow++;

                        wsGuideData.push([createStyledCell("A. Análisis por CONTENEDOR (Ejemplo)", {
                            font: {
                                sz: 11,
                                bold: true,
                                color: {
                                    rgb: "4CAF50"
                                }
                            }
                        }), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("  • Arrastra 'CONTENEDOR' a FILAS.", {}), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("  • Arrastra 'DIFERENCIA_ESTADO' a COLUMNAS.", {}), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("  • Arrastra 'SAP', 'SCANNER', 'DIFERENCIA_VALOR' a VALORES (asegúrate de que sea 'Suma de').", {}), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createEmptyCell(), createEmptyCell(), createEmptyCell()]);
                        guideRow++;

                        wsGuideData.push([createStyledCell("B. Análisis por SECCIÓN (Ejemplo)", {
                            font: {
                                sz: 11,
                                bold: true,
                                color: {
                                    rgb: "4CAF50"
                                }
                            }
                        }), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("  • Arrastra 'SECCION' a FILAS.", {}), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("  • Arrastra 'DIFERENCIA_ESTADO' a COLUMNAS.", {}), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("  • Arrastra 'SAP', 'SCANNER', 'DIFERENCIA_VALOR' a VALORES (asegúrate de que sea 'Suma de').", {}), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createEmptyCell(), createEmptyCell(), createEmptyCell()]);
                        guideRow++;

                        wsGuideData.push([createStyledCell("Paso 4: Mejorar tu Dashboard Interactivo", {
                            font: {
                                sz: 12,
                                bold: true,
                                color: {
                                    rgb: "0D6EFD"
                                }
                            }
                        }), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("Una vez creada tu Tabla Dinámica, haz clic en ella y ve a la pestaña 'Analizar tabla dinámica' (o 'Opciones' en versiones antiguas):", {}), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("  • 'Gráfico dinámico' (PivotChart): Crea gráficos interactivos a partir de tu tabla.", {}), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("  • 'Insertar segmentación de datos' (Slicer): Añade filtros interactivos para campos como 'CONTENEDOR', 'SECCION', 'DIFERENCIA_ESTADO'.", {}), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createEmptyCell(), createEmptyCell(), createEmptyCell()]);
                        guideRow++;

                        wsGuideData.push([createStyledCell("Consejos Adicionales:", {
                            font: {
                                sz: 12,
                                bold: true,
                                color: {
                                    rgb: "0D6EFD"
                                }
                            }
                        }), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("  • Actualizar datos: Si el manifiesto original cambia, haz clic derecho en la Tabla Dinámica y selecciona 'Actualizar' (Refresh).", {}), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createStyledCell("  • Guardar tu vista: Puedes guardar la hoja con tu Tabla Dinámica configurada para futuras referencias.", {}), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        guideRow++;
                        wsGuideData.push([createEmptyCell(), createEmptyCell(), createEmptyCell()]);
                        guideRow++;


                        const wsGuide = XLSX.utils.aoa_to_sheet(wsGuideData);
                        wsGuide['!cols'] = [{
                            wch: 70
                        }, {
                            wch: 10
                        }, {
                            wch: 10
                        }];

                        let mergesGuide = [];
                        let currentGuideMergeRow = 0;

                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        currentGuideMergeRow++;

                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        currentGuideMergeRow++;

                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        currentGuideMergeRow++;

                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        currentGuideMergeRow++;

                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        currentGuideMergeRow++;

                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        currentGuideMergeRow++;

                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        currentGuideMergeRow++;

                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;
                        mergesGuide.push({
                            s: {
                                r: currentGuideMergeRow,
                                c: 0
                            },
                            e: {
                                r: currentGuideMergeRow,
                                c: 2
                            }
                        });
                        currentGuideMergeRow++;

                        wsGuide['!merges'] = mergesGuide;
                        XLSX.utils.book_append_sheet(wb, wsGuide, "Guía de Análisis");

                        let wsDashboardData = [];

                        wsDashboardData.push([createStyledCell("Dashboard del Manifiesto", dashboardTitleStyle), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        wsDashboardData.push([createStyledCell(`Manifiesto: ${stats.totalSKUs > 0 ? formattedExportData[0].MANIFIESTO : "N/A"}`, dashboardSubtitleStyle), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        wsDashboardData.push([createStyledCell(`Archivo: ${name}`, dashboardSubtitleStyle), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        wsDashboardData.push([createStyledCell(`Generado: ${formatFecha(new Date())}`, dashboardSubtitleStyle), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        wsDashboardData.push([createEmptyCell(), createEmptyCell(), createEmptyCell(), createEmptyCell()]);

                        wsDashboardData.push([createStyledCell("PIEZAS ESPERADAS", metricLabelStyle), createMergedCellPlaceholder(), createStyledCell("PIEZAS ESCANEADAS", metricLabelStyle), createMergedCellPlaceholder()]);
                        wsDashboardData.push([createStyledCell(stats.totalSAP, metricValueMainStyle), createMergedCellPlaceholder(), createStyledCell(stats.totalSCAN, metricValueSuccessStyle), createMergedCellPlaceholder()]);
                        wsDashboardData.push([createEmptyCell(), createEmptyCell(), createEmptyCell(), createEmptyCell()]);

                        wsDashboardData.push([createStyledCell("PIEZAS FALTANTES", metricLabelStyle), createMergedCellPlaceholder(), createStyledCell("PIEZAS EXCEDENTES", metricLabelStyle), createMergedCellPlaceholder()]);
                        wsDashboardData.push([createStyledCell(stats.faltantes, metricValueDangerStyle), createMergedCellPlaceholder(), createStyledCell(stats.excedentes, metricValueWarningStyle), createMergedCellPlaceholder()]);
                        wsDashboardData.push([createEmptyCell(), createEmptyCell(), createEmptyCell(), createEmptyCell()]);

                        wsDashboardData.push([createStyledCell("PROGRESO GENERAL", metricLabelStyle), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        wsDashboardData.push([createStyledCell(`${stats.avance}%`, metricValueAccentStyle), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        wsDashboardData.push([createEmptyCell(), createEmptyCell(), createEmptyCell(), createEmptyCell()]);

                        wsDashboardData.push([createStyledCell("Contenedores con Faltantes/Excedentes", {
                            font: {
                                sz: 12,
                                bold: true,
                                color: {
                                    rgb: "0D6EFD"
                                }
                            }
                        }), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        wsDashboardData.push([createStyledCell("Contenedor", dashboardTableHeaderStyle), createStyledCell("Diferencia (pz)", dashboardTableHeaderStyle), createEmptyCell(), createEmptyCell()]);

                        const allContainerDiffs = [...stats.topContenedoresFaltantes, ...stats.topContenedoresExcedentes]
                            .filter(item => item[1] !== 0)
                            .sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]));

                        allContainerDiffs.forEach(item => {
                            wsDashboardData.push([
                                createStyledCell(item[0], {}),
                                createStyledCell(item[1], {
                                    font: {
                                        color: {
                                            rgb: item[1] < 0 ? "DC3545" : (item[1] > 0 ? "FFC107" : "000000")
                                        }
                                    }
                                }),
                                createEmptyCell(), createEmptyCell()
                            ]);
                        });
                        wsDashboardData.push([createEmptyCell(), createEmptyCell(), createEmptyCell(), createEmptyCell()]);

                        wsDashboardData.push([createStyledCell("Secciones con Faltantes/Excedentes", {
                            font: {
                                sz: 12,
                                bold: true,
                                color: {
                                    rgb: "0D6EFD"
                                }
                            }
                        }), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        wsDashboardData.push([createStyledCell("Sección", dashboardTableHeaderStyle), createStyledCell("Diferencia (pz)", dashboardTableHeaderStyle), createEmptyCell(), createEmptyCell()]);

                        const allSectionDiffs = [...stats.topSeccionesFaltantes, ...stats.topSeccionesExcedentes]
                            .filter(item => item[1] !== 0)
                            .sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]));

                        allSectionDiffs.forEach(item => {
                            wsDashboardData.push([
                                createStyledCell(item[0], {}),
                                createStyledCell(item[1], {
                                    font: {
                                        color: {
                                            rgb: item[1] < 0 ? "DC3545" : (item[1] > 0 ? "FFC107" : "000000")
                                        }
                                    }
                                }),
                                createEmptyCell(), createEmptyCell()
                            ]);
                        });

                        const wsDashboard = XLSX.utils.aoa_to_sheet(wsDashboardData);

                        let mergesDashboard = [];
                        let rowDash = 0;

                        mergesDashboard.push({
                            s: {
                                r: rowDash,
                                c: 0
                            },
                            e: {
                                r: rowDash,
                                c: 3
                            }
                        });
                        rowDash++;
                        mergesDashboard.push({
                            s: {
                                r: rowDash,
                                c: 0
                            },
                            e: {
                                r: rowDash,
                                c: 3
                            }
                        });
                        rowDash++;
                        mergesDashboard.push({
                            s: {
                                r: rowDash,
                                c: 0
                            },
                            e: {
                                r: rowDash,
                                c: 3
                            }
                        });
                        rowDash++;
                        mergesDashboard.push({
                            s: {
                                r: rowDash,
                                c: 0
                            },
                            e: {
                                r: rowDash,
                                c: 3
                            }
                        });
                        rowDash++;
                        rowDash++;

                        mergesDashboard.push({
                            s: {
                                r: rowDash,
                                c: 0
                            },
                            e: {
                                r: rowDash,
                                c: 1
                            }
                        });
                        mergesDashboard.push({
                            s: {
                                r: rowDash,
                                c: 2
                            },
                            e: {
                                r: rowDash,
                                c: 3
                            }
                        });
                        rowDash++;
                        mergesDashboard.push({
                            s: {
                                r: rowDash,
                                c: 0
                            },
                            e: {
                                r: rowDash,
                                c: 1
                            }
                        });
                        mergesDashboard.push({
                            s: {
                                r: rowDash,
                                c: 2
                            },
                            e: {
                                r: rowDash,
                                c: 3
                            }
                        });
                        rowDash++;
                        rowDash++;

                        mergesDashboard.push({
                            s: {
                                r: rowDash,
                                c: 0
                            },
                            e: {
                                r: rowDash,
                                c: 1
                            }
                        });
                        mergesDashboard.push({
                            s: {
                                r: rowDash,
                                c: 2
                            },
                            e: {
                                r: rowDash,
                                c: 3
                            }
                        });
                        rowDash++;
                        mergesDashboard.push({
                            s: {
                                r: rowDash,
                                c: 0
                            },
                            e: {
                                r: rowDash,
                                c: 1
                            }
                        });
                        mergesDashboard.push({
                            s: {
                                r: rowDash,
                                c: 2
                            },
                            e: {
                                r: rowDash,
                                c: 3
                            }
                        });
                        rowDash++;
                        rowDash++;

                        mergesDashboard.push({
                            s: {
                                r: rowDash,
                                c: 0
                            },
                            e: {
                                r: rowDash,
                                c: 3
                            }
                        });
                        rowDash++;
                        mergesDashboard.push({
                            s: {
                                r: rowDash,
                                c: 0
                            },
                            e: {
                                r: rowDash,
                                c: 3
                            }
                        });
                        rowDash++;
                        rowDash++;

                        mergesDashboard.push({
                            s: {
                                r: rowDash,
                                c: 0
                            },
                            e: {
                                r: rowDash,
                                c: 3
                            }
                        });
                        rowDash++;
                        rowDash++;
                        rowDash += allContainerDiffs.length;
                        rowDash++;

                        mergesDashboard.push({
                            s: {
                                r: rowDash,
                                c: 0
                            },
                            e: {
                                r: rowDash,
                                c: 3
                            }
                        });
                        rowDash++;
                        rowDash++;
                        rowDash += allSectionDiffs.length;

                        wsDashboard['!merges'] = mergesDashboard;
                        wsDashboard['!cols'] = [{
                            wch: 25
                        }, {
                            wch: 15
                        }, {
                            wch: 25
                        }, {
                            wch: 15
                        }];

                        XLSX.utils.book_append_sheet(wb, wsDashboard, "Dashboard");


                        const wsDetalles = XLSX.utils.json_to_sheet(formattedExportData, {
                            header: [
                                "FECHA", "SECCION", "MANIFIESTO", "CONTENEDOR", "SKU", "EUROPEO",
                                "DESCRIPCION", "SAP", "SCANNER", "LAST_SCANNED_BY", "ENTREGADO_A",
                                "DIFERENCIA_VALOR", "DIFERENCIA_ESTADO", "FechaEscaneo", "CONDICIONES_MCIA", "FOTO_CONDICIONES"
                            ]
                        });

                        const detailsHeaderStyle = {
                            font: {
                                bold: true,
                                color: {
                                    rgb: "FFFFFF"
                                }
                            },
                            fill: {
                                fgColor: {
                                    rgb: "343A40"
                                }
                            },
                            alignment: {
                                horizontal: "center",
                                vertical: "center"
                            },
                            border: {
                                top: {
                                    style: "thin",
                                    color: {
                                        rgb: "CCCCCC"
                                    }
                                },
                                bottom: {
                                    style: "thin",
                                    color: {
                                        rgb: "CCCCCC"
                                    }
                                },
                                left: {
                                    style: "thin",
                                    color: {
                                        rgb: "CCCCCC"
                                    }
                                },
                                right: {
                                    style: "thin",
                                    color: {
                                        rgb: "CCCCCC"
                                    }
                                }
                            }
                        };
                        const detailsColumnWidths = [{
                            wch: 12
                        }, {
                            wch: 18
                        }, {
                            wch: 18
                        }, {
                            wch: 22
                        }, {
                            wch: 15
                        }, {
                            wch: 25
                        }, {
                            wch: 45
                        }, {
                            wch: 8
                        }, {
                            wch: 8
                        }, {
                            wch: 25
                        }, {
                            wch: 25
                        }, {
                            wch: 15
                        }, {
                            wch: 18
                        }, {
                            wch: 15
                        }, {
                            wch: 15
                        }, {
                            wch: 50
                        }, ];
                        wsDetalles['!cols'] = detailsColumnWidths;

                        for (let C = 0; C < detailsColumnWidths.length; ++C) {
                            const cellRef = XLSX.utils.encode_cell({
                                r: 0,
                                c: C
                            });
                            if (!wsDetalles[cellRef]) {
                                wsDetalles[cellRef] = {
                                    t: 's',
                                    v: ''
                                };
                            }
                            if (!wsDetalles[cellRef].s) {
                                wsDetalles[cellRef].s = {};
                            }
                            Object.assign(wsDetalles[cellRef].s, detailsHeaderStyle);
                        }

                        for (let R = 1; R <= formattedExportData.length; ++R) {
                            const rowData = formattedExportData[R - 1];
                            const diffStatus = rowData.DIFERENCIA_ESTADO;

                            let rowFillColor = {};
                            let textColor = {
                                rgb: "343A40"
                            };

                            if (diffStatus === "FALTANTE") {
                                rowFillColor = {
                                    fgColor: {
                                        rgb: "FFDDDD"
                                    }
                                };
                                textColor = {
                                    rgb: "DC3545"
                                };
                            } else if (diffStatus === "EXCEDENTE") {
                                rowFillColor = {
                                    fgColor: {
                                        rgb: "FFF2CC"
                                    }
                                };
                                textColor = {
                                    rgb: "FFC107"
                                };
                            } else {}

                            for (let C = 0; C < detailsColumnWidths.length; ++C) {
                                const cellRef = XLSX.utils.encode_cell({
                                    r: R,
                                    c: C
                                });
                                if (!wsDetalles[cellRef]) {
                                    wsDetalles[cellRef] = {
                                        t: 's',
                                        v: ''
                                    };
                                }
                                if (!wsDetalles[cellRef].s) {
                                    wsDetalles[cellRef].s = {};
                                }
                                Object.assign(wsDetalles[cellRef].s, {
                                    border: {
                                        top: {
                                            style: "thin",
                                            color: {
                                                rgb: "E0E0E0"
                                            }
                                        },
                                        bottom: {
                                            style: "thin",
                                            color: {
                                                rgb: "E0E0E0"
                                            }
                                        },
                                        left: {
                                            style: "thin",
                                            color: {
                                                rgb: "E0E0E0"
                                            }
                                        },
                                        right: {
                                            style: "thin",
                                            color: {
                                                rgb: "E0E0E0"
                                            }
                                        }
                                    },
                                    fill: rowFillColor,
                                    font: {
                                        color: textColor
                                    }
                                });
                            }
                        }

                        wsDetalles['!autofilter'] = {
                            ref: `A1:P${formattedExportData.length + 1}`
                        };
                        XLSX.utils.book_append_sheet(wb, wsDetalles, "Detalles Completos");

                        let wsAnalisisContenedorData = [];
                        let analisisContenedorRow = 0;
                        const analisisTableHeaders = [
                            "Elemento", "Piezas SAP", "Piezas Escaneadas", "Faltantes", "Excedentes", "OK", "Diferencia Total"
                        ];

                        wsAnalisisContenedorData.push([createStyledCell("Análisis por Contenedor", dashboardTitleStyle), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        analisisContenedorRow++;
                        wsAnalisisContenedorData.push([createStyledCell("Resumen de piezas por contenedor.", {
                            font: {
                                sz: 10,
                                italic: true
                            }
                        }), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        analisisContenedorRow++;
                        wsAnalisisContenedorData.push([createEmptyCell(), createEmptyCell(), createEmptyCell(), createEmptyCell(), createEmptyCell(), createEmptyCell(), createEmptyCell()]);
                        analisisContenedorRow++;

                        wsAnalisisContenedorData.push(analisisTableHeaders.map(header => createStyledCell(header, dashboardTableHeaderStyle)));
                        analisisContenedorRow++;

                        containerAnalysisData.forEach(item => {
                            wsAnalisisContenedorData.push([
                                createStyledCell(item[0], {}),
                                createStyledCell(item[1], {}),
                                createStyledCell(item[2], {}),
                                createStyledCell(item[3], {
                                    font: {
                                        color: {
                                            rgb: "DC3545"
                                        }
                                    }
                                }),
                                createStyledCell(item[4], {
                                    font: {
                                        color: {
                                            rgb: "FFC107"
                                        }
                                    }
                                }),
                                createStyledCell(item[5], {
                                    font: {
                                        color: {
                                            rgb: "4CAF50"
                                        }
                                    }
                                }),
                                createStyledCell(item[6], {
                                    font: {
                                        color: {
                                            rgb: item[6] < 0 ? "DC3545" : (item[6] > 0 ? "008000" : "000000")
                                        }
                                    }
                                })
                            ]);
                            analisisContenedorRow++;
                        });
                        const wsAnalisisContenedor = XLSX.utils.aoa_to_sheet(wsAnalisisContenedorData);
                        wsAnalisisContenedor['!cols'] = [{
                            wch: 25
                        }, {
                            wch: 12
                        }, {
                            wch: 12
                        }, {
                            wch: 10
                        }, {
                            wch: 10
                        }, {
                            wch: 8
                        }, {
                            wch: 15
                        }];
                        wsAnalisisContenedor['!autofilter'] = {
                            ref: `A4:G${analisisContenedorRow}`
                        };

                        const mergesAnalisisContenedor = [{
                            s: {
                                r: 0,
                                c: 0
                            },
                            e: {
                                r: 0,
                                c: 6
                            }
                        }, {
                            s: {
                                r: 1,
                                c: 0
                            },
                            e: {
                                r: 1,
                                c: 6
                            }
                        }];
                        wsAnalisisContenedor['!merges'] = mergesAnalisisContenedor;
                        XLSX.utils.book_append_sheet(wb, wsAnalisisContenedor, "Análisis por Cont.");

                        let wsAnalisisSeccionData = [];
                        let analisisSeccionRow = 0;

                        wsAnalisisSeccionData.push([createStyledCell("Análisis por Sección", dashboardTitleStyle), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        analisisSeccionRow++;
                        wsAnalisisSeccionData.push([createStyledCell("Resumen de piezas por sección.", {
                            font: {
                                sz: 10,
                                italic: true
                            }
                        }), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder(), createMergedCellPlaceholder()]);
                        analisisSeccionRow++;
                        wsAnalisisSeccionData.push([createEmptyCell(), createEmptyCell(), createEmptyCell(), createEmptyCell(), createEmptyCell(), createEmptyCell(), createEmptyCell()]);
                        analisisSeccionRow++;

                        wsAnalisisSeccionData.push(analisisTableHeaders.map(header => createStyledCell(header, dashboardTableHeaderStyle)));
                        analisisSeccionRow++;

                        sectionAnalysisData.forEach(item => {
                            wsAnalisisSeccionData.push([
                                createStyledCell(item[0], {}),
                                createStyledCell(item[1], {}),
                                createStyledCell(item[2], {}),
                                createStyledCell(item[3], {
                                    font: {
                                        color: {
                                            rgb: "DC3545"
                                        }
                                    }
                                }),
                                createStyledCell(item[4], {
                                    font: {
                                        color: {
                                            rgb: "FFC107"
                                        }
                                    }
                                }),
                                createStyledCell(item[5], {
                                    font: {
                                        color: {
                                            rgb: "4CAF50"
                                        }
                                    }
                                }),
                                createStyledCell(item[6], {
                                    font: {
                                        color: {
                                            rgb: item[6] < 0 ? "DC3545" : (item[6] > 0 ? "008000" : "000000")
                                        }
                                    }
                                })
                            ]);
                            analisisSeccionRow++;
                        });
                        const wsAnalisisSeccion = XLSX.utils.aoa_to_sheet(wsAnalisisSeccionData);
                        wsAnalisisSeccion['!cols'] = [{
                            wch: 25
                        }, {
                            wch: 12
                        }, {
                            wch: 12
                        }, {
                            wch: 10
                        }, {
                            wch: 10
                        }, {
                            wch: 8
                        }, {
                            wch: 15
                        }];
                        wsAnalisisSeccion['!autofilter'] = {
                            ref: `A4:G${analisisSeccionRow}`
                        };

                        const mergesAnalisisSeccion = [{
                            s: {
                                r: 0,
                                c: 0
                            },
                            e: {
                                r: 0,
                                c: 6
                            }
                        }, {
                            s: {
                                r: 1,
                                c: 0
                            },
                            e: {
                                r: 1,
                                c: 6
                            }
                        }];
                        wsAnalisisSeccion['!merges'] = mergesAnalisisSeccion;
                        XLSX.utils.book_append_sheet(wb, wsAnalisisSeccion, "Análisis por Secc.");


                        const out = XLSX.write(wb, {
                            bookType: "xlsx",
                            type: "array"
                        });
                        const blob = new Blob([out], {
                            type: "application/octet-stream"
                        });
                        const a = document.createElement("a");
                        a.href = URL.createObjectURL(blob);
                        a.download = `Manifiesto_Dashboard_Analitico_${name.replace(/\.xlsx$/i, '')}_${new Date().toISOString().slice(0, 10)}.xlsx`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        URL.revokeObjectURL(a.href);

                        Swal.fire({
                            icon: "success",
                            title: "Excel Generado",
                            text: "El Dashboard analítico ha sido descargado. ¡Todas las hojas de análisis contienen datos visibles de inmediato!",
                            toast: true,
                            position: "center",
                            timer: 5000
                        });

                    } catch (e) {
                        console.error("Error al generar Excel:", e);
                        Swal.fire({
                            icon: "error",
                            title: "Error",
                            text: "No se pudo generar el Excel. Asegúrate de que los datos de tu manifiesto estén completos y bien formateados. Revisa la consola."
                        });
                    }
                };

                function formatFecha(d) {
                    const dd = String(d.getDate()).padStart(2, "0");
                    const mm = String(d.getMonth() + 1).padStart(2, "0");
                    const yy = d.getFullYear();
                    return `${dd}/${mm}/${yy}`;
                }

                btnCambiarContenedor.addEventListener("click", () => {
                    if (!currentContenedor) {
                        Swal.fire({
                            title: "No hay Contenedor Activo",
                            html: `<div class="no-container-alert">
                                     <i class="material-icons">info_outline</i>
                                     <div>Para cambiar de contenedor, primero debes open uno.</div>
                                   </div>`,
                            icon: 'info',
                            confirmButtonText: "Entendido"
                        });
                        return;
                    }

                    const summaryHTML = getContainerSummaryDetailed(currentContainerRecords);
                    const containerStatus = getContainerStateFromRecords(currentContainerRecords);

                    let statusInfo = {
                        className: 'status-neutral',
                        title: 'Cambio de Contenedor'
                    };
                    if (containerStatus === "INCOMPLETO") {
                        statusInfo = {
                            className: 'status-incompleto',
                            title: 'Contenedor Incompleto'
                        };
                    } else if (containerStatus === "COMPLETO CON MERCANCÍA DE MÁS") {
                        statusInfo = {
                            className: 'status-excedente',
                            title: 'Contenedor con Excedente'
                        };
                    } else if (containerStatus === "COMPLETO") {
                        statusInfo = {
                            className: 'status-completo',
                            title: 'Contenedor Completo'
                        };
                    }

                    Swal.fire({
                        html: `
                            <div class="change-container-modal">
                                <div class="modal-header-status ${statusInfo.className}">
                                    <i class="material-icons">switch_account</i>
                                    <h3>${statusInfo.title}</h3>
                                </div>
                                <div class="modal-body-content">
                                    <div class="container-summary-card">
                                        <h4>
                                            <i class="material-icons">inventory_2</i>
                                            Resumen de: <strong>${currentContenedor}</strong>
                                        </h4>
                                        <div class="summary-content">
                                            ${summaryHTML}
                                        </div>
                                    </div>
                                    <p class="confirmation-prompt">
                                        <i class="material-icons">help_outline</i>
                                        ¿Estás seguro de que deseas cerrar y cambiar de contenedor?
                                    </p>
                                </div>
                            </div>
                        `,
                        showCancelButton: true,
                        confirmButtonText: 'Sí, cambiar',
                        cancelButtonText: 'Cancelar',
                        width: "600px",
                        padding: 0,
                        showLoaderOnConfirm: true,
                        customClass: {
                            confirmButton: 'btn-confirm-custom',
                            cancelButton: 'btn-cancel-custom'
                        }
                    }).then(async (result) => {
                        if (!result.isConfirmed) return;

                        try {
                            await reuploadFileWithScannerChanges(currentFileName);
                        } catch (e) {
                            console.error("Error al guardar cambios antes de cambiar contenedor:", e);
                        }

                        currentContenedor = null;
                        currentContainerRecords = [];
                        selectedFileToWorkEl.textContent = "";

                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'success',
                            title: '¡Listo! Contenedor cerrado.',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            containerResultsSection.style.display = 'none';
                            scanEntrySection.style.display = 'none';
                            uploadAndSearchSection.style.display = 'block';
                            inputBusqueda.value = '';
                            inputBusqueda.focus();
                        });
                    });
                });
btnCerrarContenedor.addEventListener('click', async () => {
            if (!currentContenedor || !currentFileName) {
                return Swal.fire('Error', 'No hay un contenedor activo para esta acción.', 'error');
            }

            const manifestData = excelDataGlobal[currentFileName];
            const isCurrentlyClosed = manifestData.closedContainers?.[currentContenedor];
            const actionText = isCurrentlyClosed ? 'reabrir' : 'cerrar';
            const modalStatusClass = isCurrentlyClosed ? 'status-reopen' : 'status-close';
            const modalTitle = isCurrentlyClosed ? 'Reabrir Contenedor' : 'Cerrar Contenedor';

            const { isConfirmed } = await Swal.fire({
                html: `
                    <div class="confirmation-modal-content">
                        <div class="modal-header-status ${modalStatusClass}">
                            <i class="material-icons">${isCurrentlyClosed ? 'lock_open' : 'lock'}</i>
                            <h3>${modalTitle}</h3>
                        </div>
                        <div class="summary-card">
                            ${getContainerSummaryDetailed(currentContainerRecords)}
                        </div>
                        <p class="main-text">¿Estás seguro de que deseas <strong>${actionText}</strong> el contenedor <strong>${currentContenedor}</strong>?</p>
                        ${isCurrentlyClosed ? '<p>Al reabrir, podrás seguir escaneando artículos.</p>' : '<p>Una vez cerrado, no podrás registrar más piezas en él hasta que lo reabras.</p>'}
                    </div>`,
                showCancelButton: true,
                confirmButtonText: `Sí, ${actionText}`,
                cancelButtonText: 'Cancelar',
                width: "600px",
                padding: 0,
                customClass: {
                    confirmButton: `btn-confirm-custom ${isCurrentlyClosed ? '' : 'btn-danger'}`,
                    cancelButton: 'btn-cancel-custom'
                }
            });

            if (isConfirmed) {
                Swal.fire({ title: 'Actualizando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                const newClosedState = !isCurrentlyClosed;
                
                try {
                    // Actualiza el estado en Firestore
                    const manifestDocRef = db.collection('manifiestos').doc(currentFileName);
                    await manifestDocRef.update({
                        [`closedContainers.${currentContenedor}`]: newClosedState,
                        lastUser: currentUser.email,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Actualiza el estado local
                    manifestData.closedContainers[currentContenedor] = newClosedState;

                    // Actualiza la UI
                    inputScanCode.disabled = newClosedState;
                    btnCerrarContenedor.querySelector('span').textContent = newClosedState ? 'Reabrir' : 'Cerrar';
                    btnCerrarContenedor.querySelector('i.material-icons').textContent = newClosedState ? 'lock_open' : 'lock';
                    
                    // Vuelve a renderizar las tarjetas con el nuevo estado (botones deshabilitados/habilitados)
                    mostrarDetallesContenedor(currentContainerRecords, newClosedState);
                    
                    Swal.fire('¡Éxito!', `El contenedor ha sido ${actionText === 'cerrar' ? 'cerrado' : 'reabierto'}.`, 'success');
                
                } catch (error) {
                    console.error("Error al actualizar el estado del contenedor:", error);
                    Swal.fire('Error', 'No se pudo actualizar el estado del contenedor en la base de datos.', 'error');
                }
            }
        });
                async function actualizarMetadatosManifiesto(fileName) {
                    if (!excelDataGlobal[fileName]) return;

                    const datos = excelDataGlobal[fileName].data;
                    if (!datos || datos.length === 0) return;

                    let totalSAP = 0;
                    let totalSCAN = 0;

                    datos.forEach(r => {
                        totalSAP += Number(r.SAP) || 0;
                        totalSCAN += Number(r.SCANNER) || 0;
                    });

                    const avance = totalSAP > 0 ? Math.round((totalSCAN / totalSAP) * 100) : (totalSCAN > 0 ? 100 : 0);

                    let estado = "Sin Iniciar";
                    if (avance >= 100) {
                        estado = (totalSCAN > totalSAP) ? "Completo con Excedentes" : "Completo";
                    } else if (avance >= 50) {
                        estado = "Avanzado";
                    } else if (avance > 0) {
                        estado = "En Progreso";
                    } else if (totalSAP > 0 && avance === 0) {
                        estado = "Faltantes Detectados";
                    }

                    const metadata = {
                        progreso: {
                            totalSAP,
                            totalSCAN,
                            avance,
                            estado
                        },
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastUser: currentUser.email || currentUser.uid
                    };

                    await db.collection('manifiestos').doc(fileName).set(metadata, {
                        merge: true
                    });
                }

                let containersMapGlobal = {};
                let skuContainerMapGlobal = {};

                const motivationalPhrases = [
                    "Analizando los datos...",
                    "Buscando coincidencias...",
                    "La eficiencia es clave. ¡Ya casi!",
                    "Revisando cada rincón digital...",
                    "El éxito es la suma de pequeños esfuerzos.",
                    "Un momento, estamos en ello...",
                    "Preparando la información para ti...",
                    "Tu próxima gran jugada está a un segundo."
                ];
                let loadingIntervalId = null;

                function showNotFoundAlert(type) {
                    Swal.fire({
                        html: `
                            <div class="epic-not-found-container animate__animated animate__bounceIn">
                                <div class="epic-icon-wrapper">
                                    <i class="bi bi-search"></i>
                                    <span class="question-mark">?</span>
                                </div>
                                <h2 class="epic-title">¡Búsqueda sin Éxito!</h2>
                                <p class="epic-message">
                                    No hemos encontrado ninguna coincidencia para el <strong>${type}</strong> que buscas en los manifiestos activos.
                                </p>
                                <div class="epic-suggestions">
                                    <h4 class="suggestions-title">¿Qué puedes hacer ahora?</h4>
                                    <ul>
                                        <li><i class="bi bi-spellcheck"></i> <strong>Verifica el código:</strong> Un solo dígito puede hacer la diferencia. ¡Revisa que esté perfecto!</li>
                                        <li><i class="bi bi-cloud-arrow-up-fill"></i> <strong>¿Es un manifiesto nuevo?</strong> Si es así, asegúrate de haberlo cargado primero en la sección de subida.</li>
                                        <li><i class="bi bi-question-circle-fill"></i> <strong>Contacta a soporte:</strong> Si estás seguro de que el código es correcto, podría haber un problema mayor.</li>
                                    </ul>
                                </div>
                            </div>
                            <style>
                                .epic-not-found-container {
                                    font-family: 'Poppins', sans-serif;
                                    padding: 1.5rem;
                                    text-align: center;
                                }
                                .epic-icon-wrapper {
                                    position: relative;
                                    width: 100px;
                                    height: 100px;
                                    margin: 0 auto 1.5rem;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    background: linear-gradient(145deg, #f8f9fa, #e9ecef);
                                    border-radius: 50%;
                                    border: 4px solid #fff;
                                    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
                                }
                                .epic-icon-wrapper .bi-search {
                                    font-size: 3.5rem;
                                    color: var(--rosa-principal);
                                    animation: pulse-search 2s infinite ease-in-out;
                                }
                                .epic-icon-wrapper .question-mark {
                                    position: absolute;
                                    top: 0px;
                                    right: 0px;
                                    width: 30px;
                                    height: 30px;
                                    background-color: #dc3545;
                                    color: white;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 1.2rem;
                                    font-weight: 700;
                                    border: 2px solid white;
                                    transform: rotate(10deg);
                                    animation: bounce-qmark 1.5s infinite;
                                }
                                @keyframes pulse-search {
                                    0% { transform: scale(1); }
                                    50% { transform: scale(1.1); }
                                    100% { transform: scale(1); }
                                }
                                @keyframes bounce-qmark {
                                    0%, 20%, 50%, 80%, 100% { transform: translateY(0) rotate(10deg); }
                                    40% { transform: translateY(-10px) rotate(10deg); }
                                    60% { transform: translateY(-5px) rotate(10deg); }
                                }
                                .epic-title {
                                    font-size: 1.8rem;
                                    font-weight: 700;
                                    color: var(--texto-principal);
                                    margin-bottom: 0.5rem;
                                }
                                .epic-message {
                                    font-size: 1rem;
                                    color: #6c757d;
                                    margin-bottom: 2rem;
                                }
                                .epic-suggestions {
                                    text-align: left;
                                    background-color: #f8f9fa;
                                    border-radius: var(--ios-border-radius);
                                    padding: 1.5rem;
                                    border-top: 4px solid var(--rosa-principal);
                                }
                                .suggestions-title {
                                    font-size: 1.1rem;
                                    font-weight: 600;
                                    color: var(--texto-principal);
                                    margin-bottom: 1rem;
                                }
                                .epic-suggestions ul {
                                    list-style: none;
                                    padding: 0;
                                    margin: 0;
                                    display: flex;
                                    flex-direction: column;
                                    gap: 0.75rem;
                                }
                                .epic-suggestions li {
                                    display: flex;
                                    align-items: flex-start;
                                    gap: 0.75rem;
                                    font-size: 0.9rem;
                                    color: #495057;
                                }
                                .epic-suggestions .bi {
                                    font-size: 1.2rem;
                                    color: var(--rosa-principal);
                                    margin-top: 2px;
                                }
                            </style>
                        `,
                        showConfirmButton: true,
                        confirmButtonText: '<i class="bi bi-arrow-repeat"></i> Entendido, reintentar',
                        confirmButtonColor: 'var(--rosa-principal)',
                        customClass: {
                            popup: 'p-0 border-0 shadow-lg',
                            htmlContainer: 'm-0',
                            actions: 'm-0 p-3 border-top',
                            confirmButton: 'btn btn-primary-main'
                        }
                    });
                }

                function createContainerResultCard(containerName, file, isClosed, onclickAction) {
                    return `
                    <div class="result-item-card">
                        <div class="item-info">
                            <div class="item-title">
                                <i class="material-icons text-primary">inventory_2</i>
                                ${containerName}
                                ${isClosed ? `<span class="status-badge is-closed">CERRADO</span>` : ''}
                            </div>
                            <div class="item-meta">
                                <strong>Archivo:</strong> ${file}
                            </div>
                        </div>
                        <button class="btn btn-primary btn-sm btn-choose" onclick="${onclickAction}">
                            <i class="material-icons">touch_app</i> Elegir
                        </button>
                    </div>`;
                }

                async function buscarContenedor(ref) {
                    const searchTerm = ref.trim().toUpperCase();
                    if (!searchTerm) return;

                    let candidates = await checkFileForReference(null, searchTerm, true);
                    if (!candidates || candidates.length === 0) return showNotFoundAlert("contenedor");

                    const foundChoices = [];
                    const uniqueCheck = new Set();

                    candidates.forEach(candidate => {
                        const fileName = candidate.fileName;
                        const uniqueContainersInFile = new Set(candidate.matchedRecords.map(r => String(r.CONTENEDOR || "").trim().toUpperCase()));

                        uniqueContainersInFile.forEach(containerName => {
                            if (containerName.includes(searchTerm)) {
                                const choiceKey = `${containerName}|${fileName}`;
                                if (!uniqueCheck.has(choiceKey)) {
                                    const recordsForThisContainer = excelDataGlobal[fileName].data.filter(rec => String(rec.CONTENEDOR || "").trim().toUpperCase() === containerName);
                                    const totalSKUs = recordsForThisContainer.length;
                                    const totalSAP = recordsForThisContainer.reduce((sum, rec) => sum + (Number(rec.SAP) || 0), 0);

                                    foundChoices.push({
                                        containerName,
                                        fileName,
                                        totalSKUs,
                                        totalSAP
                                    });
                                    uniqueCheck.add(choiceKey);
                                }
                            }
                        });
                    });

                    if (foundChoices.length === 0) return showNotFoundAlert("contenedor");

                    if (foundChoices.length === 1) {
                        Swal.close();
                        const choice = foundChoices[0];
                        realOpenFileManifiesto(choice.fileName, choice.containerName);
                        return;
                    }

                    const choiceHTML = foundChoices.map(choice => {
                        const isClosedData = excelDataGlobal[choice.fileName] && excelDataGlobal[choice.fileName].closedContainers && excelDataGlobal[choice.fileName].closedContainers[choice.containerName];
                        let statusHTML = '';
                        if (isClosedData) {
                            statusHTML = `<span class="status-badge is-closed" title="Cerrado por ${isClosedData}">CERRADO</span>`;
                        }

                        return `
                            <div class="result-item-card">
                                <div class="item-info">
                                    <div class="item-title">
                                        <i class="material-icons text-primary">inventory_2</i>
                                        ${choice.containerName} ${statusHTML}
                                    </div>
                                    <div class="item-meta">
                                        <span><strong>Archivo:</strong> ${choice.fileName}</span><br>
                                        <span><strong>SKUs:</strong> ${choice.totalSKUs} | <strong>Piezas SAP:</strong> ${choice.totalSAP}</span>
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-sm btn-choose" onclick="window.openContainerFromFile('${choice.containerName}', '${choice.fileName}')">
                                    <i class="material-icons">touch_app</i> Elegir
                                </button>
                            </div>`;
                    }).join('');

                    Swal.fire({
                        title: "Múltiples Coincidencias de Contenedor",
                        html: `<p>Se encontró "<strong>${searchTerm}</strong>" en varios lugares. Elige el correcto:</p><div class="results-list-container">${choiceHTML}</div>`,
                        showConfirmButton: false,
                        width: "700px",
                    });
                }

                async function buscarSKUenArchivos(sku) {
                    try {
                        let candidates = await checkFileForReference(null, sku, false);
                        if (!candidates || candidates.length === 0) {
                            return showNotFoundAlert("SKU");
                        }

                        const foundChoices = [];
                        const uniqueCheck = new Set();

                        candidates.forEach(candidate => {
                            const fileName = candidate.fileName;
                            candidate.matchedRecords.forEach(record => {
                                const containerName = String(record.CONTENEDOR || "").trim().toUpperCase();
                                if (!containerName) return;

                                const choiceKey = `${containerName}|${fileName}`;
                                if (!uniqueCheck.has(choiceKey)) {
                                    foundChoices.push({
                                        containerName,
                                        fileName,
                                        record
                                    });
                                    uniqueCheck.add(choiceKey);
                                }
                            });
                        });

                        if (foundChoices.length === 0) {
                            return showNotFoundAlert("SKU en algún contenedor válido");
                        }

                        if (foundChoices.length === 1) {
                            Swal.close();
                            const choice = foundChoices[0];
                            realOpenFileManifiesto(choice.fileName, choice.containerName);
                            return;
                        }

                        const choiceHTML = foundChoices.map(choice => {
                            const sap = choice.record.SAP || 0;
                            const desc = choice.record.DESCRIPCION || '(sin descripción)';
                            const isClosed = excelDataGlobal[choice.fileName]?.closedContainers?.[choice.containerName];
                            return `
                                <div class="result-item-card">
                                    <div class="item-info">
                                        <div class="item-title">
                                            <i class="material-icons text-primary">inventory_2</i>
                                            ${choice.containerName}
                                            ${isClosed ? `<span class="status-badge is-closed">CERRADO</span>` : ''}
                                        </div>
                                        <div class="item-meta">
                                            <span><strong>Archivo:</strong> ${choice.fileName}</span><br>
                                            <span><strong>Descripción:</strong> ${desc} | <strong>SAP:</strong> ${sap} pz.</span>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary btn-sm btn-choose"
                                            onclick="window.openContainerFromFile('${choice.containerName}', '${choice.fileName}')">
                                        <i class="material-icons">touch_app</i> Elegir
                                    </button>
                                </div>`;
                        }).join('');

                        Swal.fire({
                            title: "SKU en Múltiples Ubicaciones",
                            html: `<p>Se encontró el SKU <strong>${sku}</strong> en varios lugares. Por favor, elige el correcto:</p>
                                   <div class="results-list-container">${choiceHTML}</div>`,
                            showConfirmButton: false,
                            width: "700px",
                        });

                    } catch (err) {
                        console.error("Error en buscarSKUenArchivos:", err);
                        Swal.fire({
                            icon: "error",
                            title: "Error Inesperado",
                            text: "Ocurrió un problema al buscar el SKU."
                        });
                    }
                }

                window.openContainerFromFile = (containerName, fileName) => {
                    Swal.close();
                    realOpenFileManifiesto(fileName, containerName);
                };

                window.selectContainerV2 = function(cont) {
                    const info = window.containersMapGlobal[cont];
                    if (info) {
                        Swal.close();
                        openContainerDirect({
                            fileName: info.fileName,
                            matchedRecords: info.records
                        }, 0);
                    }
                };

                const handleSearch = (value) => {
                    let val = value.trim().toUpperCase();
                    if (val.length < 5) return;

                    Swal.fire({
                        html: `
                            <div class="epic-loading-container">
                                <div class="radar-scanner">
                                    <div class="radar-icon-wrapper">
                                        <i class="bi bi-binoculars-fill"></i>
                                    </div>
                                </div>
                                <h2 class="epic-loading-title">Iniciando Protocolo de Búsqueda...</h2>
                                <p id="motivational-phrase" class="epic-loading-phrase"></p>
                                <div class="progress-bar-simulation">
                                    <div class="progress-bar-inner"></div>
                                </div>
                            </div>
                            <style>
                                .epic-loading-container {
                                    font-family: 'Poppins', sans-serif;
                                    padding: 2rem 1rem;
                                    text-align: center;
                                    overflow: hidden;
                                }
                                .radar-scanner {
                                    position: relative;
                                    width: 120px;
                                    height: 120px;
                                    margin: 0 auto 1.5rem;
                                    border-radius: 50%;
                                    background: radial-gradient(circle, rgba(230, 0, 126, 0.05) 0%, rgba(230, 0, 126, 0.15) 60%, transparent 70%);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                }
                                .radar-scanner::before, .radar-scanner::after {
                                    content: '';
                                    position: absolute;
                                    top: 50%;
                                    left: 50%;
                                    width: 100%;
                                    height: 100%;
                                    border-radius: 50%;
                                    transform: translate(-50%, -50%);
                                }
                                .radar-scanner::before {
                                    background: conic-gradient(from 0deg, transparent 0%, var(--rosa-principal) 20%, transparent 25%);
                                    animation: radar-sweep 2.5s linear infinite;
                                }
                                .radar-scanner::after {
                                    border: 2px solid rgba(230, 0, 126, 0.2);
                                    width: calc(100% + 10px);
                                    height: calc(100% + 10px);
                                    animation: radar-pulse 2.5s ease-out infinite;
                                }
                                @keyframes radar-sweep {
                                    from { transform: translate(-50%, -50%) rotate(0deg); }
                                    to { transform: translate(-50%, -50%) rotate(360deg); }
                                }
                                @keyframes radar-pulse {
                                    0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
                                    50% { opacity: 1; }
                                    100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0; }
                                }
                                .radar-icon-wrapper {
                                    width: 80px;
                                    height: 80px;
                                    border-radius: 50%;
                                    background: var(--blanco);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
                                    z-index: 2;
                                    animation: icon-pulse 2s infinite ease-in-out;
                                }
                                .radar-icon-wrapper .bi-binoculars-fill {
                                    font-size: 2.5rem;
                                    color: var(--rosa-principal);
                                }
                                @keyframes icon-pulse {
                                    0% { transform: scale(1); }
                                    50% { transform: scale(1.05); }
                                    100% { transform: scale(1); }
                                }
                                .epic-loading-title {
                                    font-size: 1.5rem;
                                    font-weight: 700;
                                    color: var(--texto-principal);
                                    margin-bottom: 0.5rem;
                                }
                                .epic-loading-phrase {
                                    font-size: 1rem;
                                    color: #6c757d;
                                    height: 24px; /* Prevent layout shift */
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: opacity 0.4s ease-in-out;
                                    opacity: 1;
                                }
                                .epic-loading-phrase.fade-out {
                                    opacity: 0;
                                }
                                .progress-bar-simulation {
                                    width: 80%;
                                    max-width: 300px;
                                    height: 8px;
                                    background-color: #e9ecef;
                                    border-radius: 8px;
                                    margin: 1.5rem auto 0;
                                    overflow: hidden;
                                }
                                .progress-bar-inner {
                                    width: 100%;
                                    height: 100%;
                                    background: linear-gradient(90deg, transparent, var(--rosa-principal), transparent);
                                    background-size: 200% 100%;
                                    animation: progress-sim 2s linear infinite;
                                }
                                @keyframes progress-sim {
                                    0% { background-position: 200% 0; }
                                    100% { background-position: -200% 0; }
                                }
                            </style>
                        `,
                        showConfirmButton: false,
                        allowOutsideClick: false,
                        customClass: {
                            popup: 'p-0 border-0 shadow-lg rounded-3'
                        },
                        didOpen: () => {
                            const phraseElement = document.getElementById('motivational-phrase');
                            if (phraseElement) {
                                let phraseIndex = 0;
                                phraseElement.textContent = motivationalPhrases[phraseIndex];

                                loadingIntervalId = setInterval(() => {
                                    phraseElement.classList.add('fade-out');
                                    
                                    setTimeout(() => {
                                        phraseIndex = (phraseIndex + 1) % motivationalPhrases.length;
                                        phraseElement.textContent = motivationalPhrases[phraseIndex];
                                        phraseElement.classList.remove('fade-out');
                                    }, 400); // Match transition duration

                                }, 2500); // Change phrase every 2.5 seconds
                            }
                        },
                        willClose: () => {
                            clearInterval(loadingIntervalId);
                        }
                    });

                    if (/^[A-Z]/.test(val) || /^[0-9]+[A-Z]+/.test(val)) {
                        buscarContenedor(val);
                    } else {
                        buscarSKUenArchivos(val);
                    }
                    inputBusqueda.value = "";
                };

                inputBusqueda.addEventListener("keyup", (event) => {
                    if (event.key === 'Enter') {
                        clearTimeout(debounceTimerBusqueda);
                        handleSearch(inputBusqueda.value);
                    } else {
                        clearTimeout(debounceTimerBusqueda);
                        debounceTimerBusqueda = setTimeout(() => {
                            handleSearch(inputBusqueda.value);
                        }, 600);
                    }
                });

                inputBusqueda.addEventListener("paste", (event) => {
                    const pastedText = (event.clipboardData || window.clipboardData).getData('text');
                    setTimeout(() => {
                        handleSearch(pastedText);
                    }, 10);
                });

                window.selectContainer = function(cont) {
                    Swal.close();
                    const info = containersMap[cont];
                    openContainerDirect({
                        fileName: info[0].fileName,
                        matchedRecords: info.map(i => i.record)
                    }, 0);
                };

                window.selectSKUContainerV2 = function(cont) {
                    const info = window.skuContainerMapGlobal[cont];
                    if (info) {
                        Swal.close();
                        openContainerDirect({
                            fileName: info.fileName,
                            matchedRecords: info.records
                        }, 0);
                    }
                };

                async function processSingleFile(fileInfo) {
                    const fileName = fileInfo.ref.name;
                    if (excelDataGlobal[fileName]) {
                        return;
                    }

                    try {
                        const url = await storage.ref(`Manifiestos/${fileInfo.folderName}/${fileName}`).getDownloadURL();
                        const arrBuff = await (await fetch(url)).arrayBuffer();
                        const wb = XLSX.read(arrBuff, {
                            type: "array",
                            cellDates: true
                        });
                        const sheet = wb.SheetNames[0];
                        const dataJson = XLSX.utils.sheet_to_json(wb.Sheets[sheet]);

                        const docSnap = await db.collection("manifiestos").doc(fileName).get();

                        let docData = docSnap.exists ? docSnap.data() : {};

                        excelDataGlobal[fileName] = {
                            data: dataJson,
                            lastUser: docData.lastUser || "",
                            lastUserStore: docData.lastUserStore || "",
                            lastUserRole: docData.lastUserRole || "",
                            closedContainers: docData.closedContainers || {},
                            uploadedAt: docData.updatedAt ? docData.updatedAt.toDate() : null
                        };
                    } catch (error) {
                        console.error(`Error procesando el archivo ${fileName}:`, error);
                    }
                }

                async function checkFileForReference(folderName, code) {
                    if (!allFilesList || allFilesList.length === 0) {
                        allFilesList = [];
                        const storeFolder = currentUserStore === "ALL" ? "" : currentUserStore;

                        if (storeFolder) {
                            const storeFiles = await storage.ref(`Manifiestos/${storeFolder}`).listAll();
                            storeFiles.items.forEach(itemRef => allFilesList.push({
                                folderName: storeFolder,
                                ref: itemRef
                            }));
                        } else {
                            const root = await storage.ref("Manifiestos").listAll();
                            for (const folderRef of root.prefixes) {
                                const storeFiles = await folderRef.listAll();
                                storeFiles.items.forEach(itemRef => allFilesList.push({
                                    folderName: folderRef.name,
                                    ref: itemRef
                                }));
                            }
                        }
                    }
                    const filesToProcess = allFilesList.filter(f => !excelDataGlobal[f.ref.name]);

                    if (filesToProcess.length > 0) {
                        const phraseElement = document.getElementById('motivational-phrase');
                        if (phraseElement) {
                            phraseElement.innerText = `Cargando ${filesToProcess.length} archivo(s) nuevos...`;
                        }
                        await Promise.all(filesToProcess.map(fileInfo => processSingleFile(fileInfo)));
                    }

                    const foundCandidates = [];
                    const searchCode = code.toUpperCase();

                    for (const f of allFilesList) {
                        const fileName = f.ref.name;
                        if (!excelDataGlobal[fileName]) continue;

                        const records = excelDataGlobal[fileName].data;
                        const matched = records.filter(r => {
                            const cont = String(r.CONTENEDOR || "").trim().toUpperCase();
                            const sku = String(r.SKU || "").trim().toUpperCase();
                            return cont.includes(searchCode) || sku.includes(searchCode);
                        });

                        if (matched.length > 0) {
                            foundCandidates.push({
                                folderName: f.folderName,
                                fileName,
                                matchedRecords: matched
                            });
                        }
                    }

                    return foundCandidates.length > 0 ? foundCandidates : null;
                }

                function openContainerDirect(candidate, recordIndex = 0) {
                    currentFileName = candidate.fileName;
                    let cont = String(candidate.matchedRecords[recordIndex]?.CONTENEDOR || "").trim().toUpperCase();
                    realOpenFileManifiesto(currentFileName, cont);
                }

                async function realOpenFileManifiesto(fileName, cont) {
                    Swal.fire({
                        title: 'Cargando y reconstruyendo...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });
                    try {
                        if (!excelDataGlobal[fileName]?.data) {
                            let store = currentUserStore;
                            if (currentUserStore === 'ALL') {
                                const manifestDoc = await db.collection('manifiestos').doc(fileName).get();
                                store = manifestDoc.data()?.store;
                            }
                            if (!store) throw new Error(`No se pudo determinar la tienda para el archivo ${fileName}`);
                            const url = await storage.ref(`Manifiestos/${store}/${fileName}`).getDownloadURL();
                            const buffer = await (await fetch(url)).arrayBuffer();
                            const wb = XLSX.read(buffer, {
                                type: "array",
                                cellDates: true
                            });
                            excelDataGlobal[fileName] = {
                                data: XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]])
                            };
                        }

                        const dataObj = excelDataGlobal[fileName];
                        const docSnap = await db.collection("manifiestos").doc(fileName).get();
                        dataObj.closedContainers = docSnap.exists ? (docSnap.data().closedContainers || {}) : {};
                        dataObj.lastUser = docSnap.exists ? (docSnap.data().lastUser || "Desconocido") : "Desconocido";

                        dataObj.data.forEach(row => {
                            row.SCANNER = 0;
                        });

                        const scansSnapshot = await db.collection('manifiestos').doc(fileName).collection('scans').where('container', '==', cont).orderBy('scannedAt').get();
                        const newItems = new Map();
                        const deletedSkus = new Set();
                        scansSnapshot.docs.forEach(doc => {
                            if (doc.data().type === 'delete') deletedSkus.add(doc.data().sku);
                        });

                        scansSnapshot.forEach(doc => {
                            const scan = doc.data();
                            if (deletedSkus.has(scan.sku)) return;
                            let record = dataObj.data.find(r => r.SKU === scan.sku && r.CONTENEDOR === scan.container);
                            if (record) {
                                scan.type === 'subtract' ? record.SCANNER-- : record.SCANNER++;
                                record.LAST_SCANNED_BY = scan.user;
                                if (scan.scannedAt) record.FECHA_ESCANEO = scan.scannedAt.toDate();
                            } else if (scan.type === 'add') {
                                if (newItems.has(scan.sku)) {
                                    newItems.get(scan.sku).SCANNER++;
                                } else {
                                    const ref = dataObj.data[0] || {};
                                    newItems.set(scan.sku, {
                                        FECHA: ref.FECHA,
                                        SECCION: ref.SECCION,
                                        MANIFIESTO: ref.MANIFIESTO,
                                        CONTENEDOR: cont,
                                        DESCRIPCION: "ARTÍCULO NUEVO (RECUPERADO)",
                                        SKU: scan.sku,
                                        SAP: 0,
                                        SCANNER: 1,
                                        LAST_SCANNED_BY: scan.user,
                                        FECHA_ESCANEO: scan.scannedAt?.toDate()
                                    });
                                }
                            }
                        });

                        dataObj.data = dataObj.data.filter(r => !deletedSkus.has(r.SKU));
                        newItems.forEach(item => dataObj.data.push(item));

                        currentContenedor = cont;
                        currentFileName = fileName;
                        currentContainerRecords = dataObj.data.filter(r => String(r.CONTENEDOR || "").trim().toUpperCase() === cont);

                        const uploadAndSearchSection = document.getElementById("uploadAndSearchSection");
                        if (uploadAndSearchSection) uploadAndSearchSection.style.display = "none";

                        const containerResultsSection = document.getElementById("containerResultsSection");
                        if (containerResultsSection) containerResultsSection.style.display = "block";

                        const scanEntrySection = document.getElementById("scanEntrySection");
                        if (scanEntrySection) scanEntrySection.style.display = "block";

                        const isClosed = dataObj.closedContainers?.[cont];

                        const selectedFileToWorkEl = document.getElementById("selectedFileToWork");
                        const lastUserUpdateEl = document.getElementById("lastUserUpdate");
                        const btnCerrarContenedor = document.getElementById("btnCerrarContenedor");
                        const inputScanCode = document.getElementById("inputScanCode");
                        const containerHeaderEl = document.getElementById("containerHeader");


                        if (selectedFileToWorkEl) selectedFileToWorkEl.textContent = fileName;
                        if (lastUserUpdateEl) lastUserUpdateEl.textContent = `Último cambio por: ${dataObj.lastUser}`;

                        if (btnCerrarContenedor) {
                            const btnSpan = btnCerrarContenedor.querySelector('span');
                            if (btnSpan) btnSpan.textContent = isClosed ? 'Reabrir' : 'Cerrar';
                            const btnIcon = btnCerrarContenedor.querySelector('i.material-icons');
                            if (btnIcon) btnIcon.textContent = isClosed ? 'lock_open' : 'lock';
                        }

                        if (inputScanCode) inputScanCode.disabled = !!isClosed;

                        if (containerHeaderEl) {
                            const headerSpan = containerHeaderEl.querySelector('span');
                            if (headerSpan) headerSpan.textContent = `Detalles de ${cont}`;
                        }

            mostrarDetallesContenedor(currentContainerRecords, isClosed); // <-- Pasa la variable isClosed
                        if (inputScanCode) inputScanCode.focus();
                        Swal.close();

                    } catch (error) {
                        console.error("Error openendo manifiesto:", error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de Carga',
                            text: 'No se pudo cargar la información.'
                        });
                    }
                }

                function showScanSuccessToast(sku, newCount) {
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: `+1 ${sku} (Total: ${newCount})`,
                        showConfirmButton: false,
                        timer: 1500,
                        customClass: {
                            popup: 'scan-success-toast'
                        }
                    });
                }

                function showScanErrorToast(title, text) {
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'error',
                        title: title,
                        text: text,
                        showConfirmButton: false,
                        timer: 2500,
                        customClass: {
                            popup: 'scan-error-toast'
                        }
                    });
                }

                function showAddItemConfirmation(code) {
                    return Swal.fire({
                        html: `
                            <div class="modal-header-status status-reopen" style="background-color: #9C27B0;">
                                <i class="material-icons">add_shopping_cart</i>
                                <h3>Artículo No Encontrado</h3>
                            </div>
                            <div class="confirmation-modal-content">
                                <p class="main-text">El artículo <strong>${code}</strong> no existe en este contenedor.</p>
                                <p>¿Deseas añadirlo como un nuevo registro con Cantidad SAP = 0?</p>
                            </div>
                        `,
                        showCancelButton: true,
                        confirmButtonText: 'Sí, Añadir',
                        cancelButtonText: 'Cancelar',
                        width: "550px",
                        padding: 0,
                        customClass: {
                            confirmButton: 'btn-confirm-custom',
                            cancelButton: 'btn-cancel-custom'
                        }
                    });
                }

                function showMultipleMatchesModal(code, matchingRows) {
                    const html = matchingRows.map((row, idx) => `
                        <div class="result-item-card">
                            <div class="item-info">
                                <div class="item-title">
                                    <i class="material-icons text-primary">sell</i>
                                    ${row.SKU || 'SKU no definido'}
                                </div>
                                <div class="item-meta">
                                    <strong>Descripción:</strong> ${row.DESCRIPCION || '(sin descripción)'}
                                </div>
                            </div>
                            <button class="btn btn-primary btn-sm btn-choose" onclick="window.chooseRow(${idx})">
                                <i class="material-icons">touch_app</i> Seleccionar
                            </button>
                        </div>
                    `).join('');

                    Swal.fire({
                        title: "Múltiples Coincidencias",
                        html: `<p>Se encontraron varios registros para el código <strong>${code}</strong>. Por favor, selecciona el correcto:</p>
                               <div class="results-list-container">${html}</div>`,
                        showConfirmButton: false,
                        width: "650px"
                    });
                }


                async function incrementRowAndNotify(row, code) {
                    row.SCANNER = (Number(row.SCANNER) || 0) + 1;
                    row.FECHA_ESCANEO = new Date();
                    row.LAST_SCANNED_BY = currentUser.email || currentUser.uid;

                    showScanSuccessToast(row.SKU || code, row.SCANNER);

                    mostrarDetallesContenedor(currentContainerRecords);

                    await reuploadFileWithScannerChanges(selectedFileToWorkEl.textContent);
                }

async function handleScanCode(code) {
            if (!currentEmployeeNumber) return showScanErrorToast('Falta # de Empleado');
            if (!currentContenedor) return showScanErrorToast('Sin Contenedor');
            const fn = currentFileName;
            const dataObj = excelDataGlobal[fn];
            if (!dataObj || dataObj.closedContainers?.[currentContenedor]) return showScanErrorToast('Contenedor cerrado');

            const codeUpper = code.trim().toUpperCase();
            let targetRow = currentContainerRecords.find(r =>
                String(r.SKU || "").toUpperCase() === codeUpper ||
                String(r.EUROPEO || "").toUpperCase() === codeUpper
            );

            if (targetRow) {
                targetRow.SCANNER = (Number(targetRow.SCANNER) || 0) + 1;
            } else {
                const { isConfirmed } = await showAddItemConfirmation(codeUpper);
                if (!isConfirmed) {
                    inputScanCode.value = "";
                    inputScanCode.focus();
                    return;
                }
                const ref = currentContainerRecords[0] || {};
                targetRow = {
                    FECHA: ref.FECHA || new Date(),
                    SECCION: ref.SECCION || "N/A",
                    MANIFIESTO: ref.MANIFIESTO || "N/A",
                    CONTENEDOR: currentContenedor,
                    DESCRIPCION: "ARTÍCULO NUEVO",
                    SKU: codeUpper,
                    SAP: 0,
                    SCANNER: 1,
                    ENTREGADO_A: currentEmployeeNumber // Se asigna al crear
                };
                dataObj.data.push(targetRow);
                currentContainerRecords.push(targetRow);
                Swal.fire('¡Agregado!', `El artículo ${targetRow.SKU} se añadió al contenedor.`, 'success');
            }

            // Asignamos los datos del usuario y empleado en CADA escaneo
            Object.assign(targetRow, {
                LAST_SCANNED_BY: currentUser.email,
                FECHA_ESCANEO: new Date(),
                ENTREGADO_A: currentEmployeeNumber // <--- ¡AQUÍ ESTÁ LA CORRECCIÓN IMPORTANTE!
            });

            mostrarDetallesContenedor(currentContainerRecords);
            showScanSuccessToast(targetRow.SKU, targetRow.SCANNER);

            inputScanCode.value = "";
            inputScanCode.focus();

            try {
                await db.collection('manifiestos').doc(fn).collection('scans').add({
                    sku: targetRow.SKU,
                    type: 'add',
                    quantity: 1, // Guardamos la cantidad para mayor precisión
                    scannedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    employee: currentEmployeeNumber,
                    user: currentUser.email,
                    container: currentContenedor
                });
                await db.collection('manifiestos').doc(fn).set({
                    lastUser: currentUser.email,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error("Error guardando escaneo en Firestore:", error);
                showScanErrorToast('Error de Red', 'El escaneo no se guardó. Reinténtalo.');
                // Revertimos el cambio local si falla la subida
                targetRow.SCANNER -= 1;
                mostrarDetallesContenedor(currentContainerRecords);
            }
        }

                function scanInputHandler() {
                    let val = inputScanCode.value.trim().toUpperCase();
                    if (val && ((val.length >= 5 && val.length <= 10) || (val.length >= 12))) {
                        handleScanCode(val);
                        inputScanCode.value = "";
                    }
                }

                inputScanCode.addEventListener("keypress", (e) => {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        clearTimeout(debounceTimerScan);
                        scanInputHandler();
                    }
                });

                inputScanCode.addEventListener("paste", (e) => {
                    e.preventDefault();
                    const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                    inputScanCode.value = pastedText;
                    scanInputHandler();
                });

                inputScanCode.addEventListener("keyup", (e) => {
                    if (e.key !== 'Enter') {
                        clearTimeout(debounceTimerScan);
                        debounceTimerScan = setTimeout(() => {
                            scanInputHandler();
                        }, 800);
                    }
                });

                function incrementRow(rowObj, code) {
                    const now = new Date();

                    rowObj.SCANNER = (rowObj.SCANNER || 0) + 1;
                    rowObj.LAST_SCANNED_BY = currentUser.email || currentUser.uid;
                    rowObj.FECHA_ESCANEO = now;

                    const dataObj = excelDataGlobal[currentFileName];
                    dataObj.lastUser = rowObj.LAST_SCANNED_BY;
                    excelDataGlobal[currentFileName] = dataObj;

                    currentContainerRecords = dataObj.data.filter(x =>
                        String(x.CONTENEDOR || "").trim().toUpperCase() === currentContenedor
                    );
                    mostrarDetallesContenedor(currentContainerRecords);

                    Swal.fire({
                        toast: true,
                        position: "top-end",
                        icon: "success",
                        title: `+1 para ${code}`,
                        showConfirmButton: false,
                        timer: 1500,
                        timerProgressBar: true
                    });
                }

    function mostrarDetallesContenedor(registros, isClosed = false) {
        if (!registros) {
            containerDetailsEl.innerHTML = "";
            return;
        }
        registros.sort((a, b) => (a.SAP === 0) - (b.SAP === 0) || String(a.SKU || "").localeCompare(String(b.SKU || "")));

        const cardsHTML = `<div class="details-list-container">
            ${registros.map(r => {
                const sku = String(r.SKU || "").toUpperCase();
                const SAP = Number(r.SAP) || 0;
                const SCANNER = Number(r.SCANNER) || 0;
                const esNuevo = SAP === 0;
                let statusClass = '', diffText = '';
                
                if (SCANNER === SAP) { statusClass = 'is-ok'; diffText = 'OK'; }
                else if (SCANNER < SAP) { statusClass = 'is-missing'; diffText = `FALTA ${SAP - SCANNER}`; }
                else { statusClass = 'is-excess'; diffText = `SOBRA ${SCANNER - SAP}`; }
                
                let cardStatusClass = esNuevo ? 'is-new' : `status-${statusClass.substring(3)}`;
                
                const disabledAttr = isClosed ? 'disabled' : '';

                return `<div class="item-card ${cardStatusClass}" id="row-${sku}">
                    <div class="item-card-main">
                        <div class="sku-container">
                            <i class="bi bi-upc-scan sku-icon"></i>
                            <span class="sku">${sku}</span>
                        </div>
                        <span class="descripcion">${r.DESCRIPCION || "Sin descripción"}</span>
                    </div>
                    <div class="item-card-stats">
                        <div class="stat-item"><div class="label">SAP</div><div class="value">${SAP}</div></div>
                        <div class="stat-item"><div class="label">SCAN</div><div id="scanner-cell-${sku}" class="value">${SCANNER}</div></div>
                        <div class="stat-item"><div class="label">DIF.</div><div id="diff-cell-${sku}"><span class="diff-badge ${statusClass}">${diffText}</span></div></div>
                    </div>
                    <div class="item-card-actions">
                        <button class="btn-action btn-danio" data-sku="${sku}" title="Reportar daño" ${disabledAttr}><i class="bi bi-cone-striped"></i></button>
                        ${r.DANIO_FOTO_URL ? `<button class="btn-action btn-foto" data-url="${r.DANIO_FOTO_URL}" title="Ver foto"><i class="bi bi-image-fill"></i></button>` : ''}
                        ${r.DANIO_FOTO_URL ? `<button class="btn-action btn-eliminar-foto" data-sku="${sku}" data-url="${r.DANIO_FOTO_URL}" title="Eliminar foto de daño" ${disabledAttr}><i class="bi bi-trash2-fill"></i></button>` : ''}
                        <button class="btn-action btn-restar" data-sku="${sku}" title="Restar 1 pieza" ${disabledAttr}><i class="bi bi-dash-circle-fill"></i></button>
                        ${esNuevo ? `<button class="btn-action btn-eliminar" data-sku="${sku}" title="Eliminar artículo añadido" ${disabledAttr}><i class="bi bi-x-octagon-fill"></i></button>` : ''}
                    </div>
                    <div class="item-card-details">
                        <div class="detail-item" title="Sección"><i class="bi bi-folder2-open" style="color: #6f42c1;"></i><span>${r.SECCION || 'N/A'}</span></div>
                        <div class="detail-item" title="Manifiesto"><i class="bi bi-file-earmark-text" style="color: #fd7e14;"></i><span>${r.MANIFIESTO || 'N/A'}</span></div>
                        <div class="detail-item" title="Fecha de Último Escaneo"><i class="bi bi-calendar-check" style="color: #0d6efd;"></i><span>${r.FECHA_ESCANEO ? formatFecha(r.FECHA_ESCANEO) : 'Sin escanear'}</span></div>
                        <div class="detail-item" title="Último escaneo por"><i class="bi bi-person-check-fill" style="color: #198754;"></i><span>${r.LAST_SCANNED_BY || 'N/A'}</span></div>
                        <div class="detail-item" title="Entregado a empleado"><i class="bi bi-person-vcard" style="color: #E6007E;"></i><span>${r.ENTREGADO_A || 'N/A'}</span></div>
                        <div class="detail-item" title="Piezas con condición"><i class="bi bi-tools" style="color: #ffc107;"></i><span>${r.DANIO_CANTIDAD || '0'}</span></div>
                    </div>
                </div>`;
            }).join('')}
        </div>
        <style>
            .sku-container {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                margin-bottom: 0.25rem;
            }
            .sku-icon {
                font-size: 1.5rem;
                color: var(--rosa-principal);
                opacity: 0.7;
            }
            .item-card-main .sku {
                font-size: 1.4rem;
                font-weight: 700;
                color: var(--texto-principal);
                letter-spacing: 0.5px;
            }
            .item-card-main .descripcion {
                font-size: 0.9rem;
                color: #6c757d;
                font-style: italic;
            }
            .details-list-container .btn-action i {
                font-size: 1.2rem;
            }
            .details-list-container .btn-action.btn-eliminar-foto { background-color: #6c757d; }
            .details-list-container .btn-action.btn-restar { background-color: #ff7f50; }
            .details-list-container .btn-action.btn-eliminar { background-color: #dc3545; }
            .item-card-details .bi { font-size: 1.1rem; }
        </style>
        `;

        containerDetailsEl.innerHTML = cardsHTML;

        if (containerDetailsEl.eventHandler) containerDetailsEl.removeEventListener('click', containerDetailsEl.eventHandler);

        const eventHandler = async (event) => {
            const target = event.target.closest('button');
            if (!target) return;
            const sku = target.dataset.sku;
            const fn = currentFileName;

            if (target.classList.contains('btn-restar')) {
                const rowObj = currentContainerRecords.find(r => String(r.SKU || "").toUpperCase() === sku);
                if (!rowObj || (rowObj.SCANNER || 0) <= 0) return;
                rowObj.SCANNER--;
                mostrarDetallesContenedor(currentContainerRecords, isClosed);
                try {
                    await db.collection('manifiestos').doc(fn).collection('scans').add({
                        sku: rowObj.SKU,
                        type: 'subtract',
                        scannedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        employee: currentEmployeeNumber,
                        user: currentUser.email,
                        container: currentContenedor
                    });
                } catch (error) {
                    showScanErrorToast('Error de Red', 'No se pudo guardar la resta.');
                    rowObj.SCANNER++;
                    mostrarDetallesContenedor(currentContainerRecords, isClosed);
                }
            } else if (target.classList.contains('btn-eliminar')) {
                const {
                    isConfirmed
                } = await Swal.fire({
                    title: '¿Estás seguro?',
                    html: `Se eliminará permanentemente el artículo <strong>${sku}</strong>.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Sí, ¡Eliminar!'
                });
                if (isConfirmed) {
                    currentContainerRecords = currentContainerRecords.filter(r => !(String(r.SKU || "").toUpperCase() === sku && r.SAP === 0));
                    mostrarDetallesContenedor(currentContainerRecords, isClosed);

                    try {
                        await db.collection('manifiestos').doc(fn).collection('scans').add({
                            sku: sku,
                            type: 'delete',
                            scannedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            employee: currentEmployeeNumber,
                            user: currentUser.email,
                            container: currentContenedor
                        });
                        Swal.fire('¡Eliminado!', `El artículo ${sku} ha sido marcado para eliminación.`, 'success');
                    } catch (error) {
                        showScanErrorToast('Error de Red', 'No se pudo eliminar. Intenta de nuevo.');
                        realOpenFileManifiesto(fn, currentContenedor);
                    }
                }
            } else if (target.classList.contains('btn-danio')) {
                currentDanioSKU = sku;
                danioCantidadInput.value = "1";
                danioFotoInput.value = "";
                modalDanios.show();
            } else if (target.classList.contains('btn-foto')) {
                window.open(target.dataset.url, "_blank");
            } else if (target.classList.contains('btn-eliminar-foto')) {
                const photoUrl = target.dataset.url;
                const { isConfirmed } = await Swal.fire({
                    title: '¿Eliminar Foto?',
                    text: "Esta acción eliminará la foto de la nube permanentemente. No se puede deshacer.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    confirmButtonText: 'Sí, eliminarla',
                    cancelButtonText: 'Cancelar'
                });

                if (isConfirmed) {
                    Swal.fire({ title: 'Eliminando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    try {
                        const photoRef = storage.refFromURL(photoUrl);
                        await photoRef.delete();

                        const rowObj = currentContainerRecords.find(r => String(r.SKU || "").toUpperCase() === sku);
                        if (rowObj) {
                            rowObj.DANIO_FOTO_URL = "";
                            // También se podría registrar esta acción en Firestore si fuera necesario
                            await db.collection('manifiestos').doc(fn).collection('scans').add({
                                sku: sku,
                                type: 'delete_photo',
                                scannedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                user: currentUser.email,
                                container: currentContenedor
                            });
                        }
                        
                        mostrarDetallesContenedor(currentContainerRecords, isClosed);
                        Swal.fire('¡Eliminada!', 'La foto ha sido eliminada con éxito.', 'success');
                    } catch (error) {
                        console.error("Error al eliminar la foto:", error);
                        Swal.fire('Error', 'No se pudo eliminar la foto. Es posible que ya no exista o haya un problema de red.', 'error');
                    }
                }
            }
        };
        containerDetailsEl.eventHandler = eventHandler;
        containerDetailsEl.addEventListener('click', containerDetailsEl.eventHandler);
    }

    /***********************************************************
     * MODAL DE CONDICIONES DE LA MCIA
     ***********************************************************/
    btnGuardarDanio.addEventListener("click", async () => {
        let cant = parseInt(danioCantidadInput.value) || 0;
        if (!cant || cant < 1) {
            return Swal.fire({
                icon: "info",
                title: "Cantidad inválida",
                html: `<i class="material-icons" style="color:#2196F3;">info</i> Ingrese una cantidad válida.`
            });
        }
        if (!currentDanioSKU) {
            return Swal.fire({
                icon: "info",
                title: "Error interno",
                html: `<i class="material-icons" style="color:#2196F3;">info</i> No se puede guardar condiciones sin SKU.`
            });
        }
        let fn = currentFileName;
        let rowObj = currentContainerRecords.find(r => String(r.SKU || "").toUpperCase() === currentDanioSKU);
        
        if (!rowObj) {
            return Swal.fire({ icon: "info", title: "No encontrado", text: "No se encontró el SKU en el contenedor." });
        }

        Swal.fire({ title: "Procesando...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        let fotoUrl = rowObj.DANIO_FOTO_URL || "";
        const file = danioFotoInput.files[0];
        if (file) {
            const safeSKU = currentDanioSKU.replace(/[^a-zA-Z0-9]/g, '_');
            const ts = Date.now();
            const filePath = `Evidencias/${fn}/${currentContenedor}/${safeSKU}_${ts}.jpg`;
            const ref = storage.ref(filePath);
            const snap = await ref.put(file);
            fotoUrl = await snap.ref.getDownloadURL();
        }

        rowObj.DANIO_CANTIDAD = (rowObj.DANIO_CANTIDAD || 0) + cant;
        rowObj.DANIO_FOTO_URL = fotoUrl;

        try {
            await db.collection('manifiestos').doc(fn).collection('scans').add({
                sku: currentDanioSKU,
                type: 'damage',
                quantity: cant,
                photoURL: fotoUrl,
                scannedAt: firebase.firestore.FieldValue.serverTimestamp(),
                user: currentUser.email,
                container: currentContenedor
            });

            mostrarDetallesContenedor(currentContainerRecords, isClosed);
            Swal.fire({ icon: "success", title: "Condiciones registradas", text: "Se guardó la información." });
            modalDanios.hide();
        } catch (e) {
            console.error(e);
            rowObj.DANIO_CANTIDAD -= cant; // Revertir si falla
            Swal.fire({ icon: "error", title: "Error", text: "No se pudo guardar la información de condiciones." });
        }
    });

                /***********************************************************
                 * DESCARGAR ARCHIVO
                 ***********************************************************/
                document.getElementById("btnDescargarArchivo").addEventListener("click", () => {
                    let fn = selectedFileToWorkEl.textContent;
                    if (!fn || !excelDataGlobal[fn]) {
                        return Swal.fire({
                            icon: "error",
                            title: "Error",
                            html: `<i class="material-icons" style="color:#F44336;">error</i> No hay archivo para descargar.`
                        });
                    }
                    descargarArchivoTotal(fn);
                });

                function descargarArchivoTotal(fileName) {
                    let dataObj = excelDataGlobal[fileName];
                    if (!dataObj || !dataObj.data) {
                        return Swal.fire({
                            icon: "error",
                            title: "Error",
                            html: `<i class="material-icons" style="color:#F44336;">error</i> No hay datos para descargar.`
                        });
                    }
                    let arr = dataObj.data.slice();
                    arr.sort((a, b) => {
                        let ca = String(a.CONTENEDOR || "").trim().toUpperCase();
                        let cb = String(b.CONTENEDOR || "").trim().toUpperCase();
                        if (ca < cb) return -1;
                        if (ca > cb) return 1;
                        return String(a.SKU || "").localeCompare(String(b.SKU || ""));
                    });
                    arr = arr.map(r => {
                        if (r.SCANNER > 0) r.ENTREGADO_A = r.ENTREGADO_A || currentEmployeeNumber;
                        return r;
                    });
                    let exportData = arr.map(r => {
                        let SAP = r.SAP || 0;
                        let SCANNER = r.SCANNER || 0;
                        let diff = (SCANNER === SAP) ? "OK" :
                            (SCANNER < SAP) ? `FALTAN ${SAP - SCANNER} piezas` :
                            `MERCANCIA DE MAS: ${SCANNER - SAP} piezas`;
                        return {
                            FECHA: formatFecha(r.FECHA),
                            SECCION: r.SECCION || "",
                            MANIFIESTO: r.MANIFIESTO || "",
                            CONTENEDOR: r.CONTENEDOR || "",
                            SKU: r.SKU || "",
                            EUROPEO: r.EUROPEO || "",
                            DESCRIPCION: r.DESCRIPCION || "",
                            SAP,
                            SCANNER,
                            LAST_SCANNED_BY: r.LAST_SCANNED_BY || "",
                            ENTREGADO_A: r.ENTREGADO_A || "",
                            DIFERENCIA: diff,
                            "Fecha de Escaneo": r.FECHA_ESCANEO ? formatFecha(r.FECHA_ESCANEO) : "",
                            "CONDICIONES_MCIA": r.DANIO_CANTIDAD || 0,
                            "FOTO_CONDICIONES": r.DANIO_FOTO_URL || ""
                        };
                    });
                    let ws = XLSX.utils.json_to_sheet(exportData, {
                        header: [
                            "FECHA", "SECCION", "MANIFIESTO", "CONTENEDOR", "SKU", "EUROPEO",
                            "DESCRIPCION", "SAP", "SCANNER", "LAST_SCANNED_BY", "ENTREGADO_A",
                            "DIFERENCIA", "Fecha de Escaneo", "CONDICIONES_MCIA", "FOTO_CONDICIONES"
                        ]
                    });
                    let wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                    let wbout = XLSX.write(wb, {
                        bookType: "xlsx",
                        type: "array"
                    });
                    let blob = new Blob([wbout], {
                        type: "application/octet-stream"
                    });
                    let url = URL.createObjectURL(blob);
                    let a = document.createElement("a");
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    Swal.fire({
                        icon: "success",
                        title: "Descargado",
                        html: `<i class="material-icons" style="color:#4CAF50;">check_circle</i> Archivo descargado.`
                    });
                }



                function getContainerAnalysis(records, closedContainers) {
                    let groups = {};
                    records.forEach(r => {
                        let c = String(r.CONTENEDOR || "").trim().toUpperCase() || "SIN CONTENEDOR";
                        if (!groups[c]) groups[c] = [];
                        groups[c].push(r);
                    });
                    let html = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px;">`;
                    for (let c in groups) {
                        let closed = closedContainers && closedContainers[c] ? true : false;
                        html += `<div class="analysis-box" style="padding:10px;border-radius:8px;${closed ? "border:2px solid red;background:rgba(255,0,0,0.1);" : "border:1px solid rgba(255,255,255,0.5);background:rgba(0,0,0,0.1);"}">
                                    <h5 style="margin-bottom:8px;">
                                      <i class="material-icons" style="vertical-align:middle; font-size:1.3rem; ${closed ? "color:red;" : ""}">inventory_2</i>
                                      Contenedor: ${c} ${closed ? '<span style="color:red;font-weight:bold;">(CERRADO)</span>' : ''}
                                    </h5>
                                    ${getContainerSummaryDetailed(groups[c])}
                                  </div>`;
                    }
                    html += "</div>";
                    return html;
                }

                function getContainerSummaryDetailed(recs) {
                    let totalRecords = recs.length;
                    let assignedUsers = new Set();
                    let workers = new Set();
                    let dates = [];
                    let sapSum = 0,
                        scannerSum = 0;
                    let completeCount = 0,
                        totalMissing = 0,
                        totalExtra = 0;
                    recs.forEach(r => {
                        let sap = Number(r.SAP) || 0;
                        let sc = Number(r.SCANNER) || 0;
                        sapSum += sap;
                        scannerSum += sc;
                        if (r.ENTREGADO_A) assignedUsers.add(r.ENTREGADO_A);
                        if (r.LAST_SCANNED_BY) workers.add(r.LAST_SCANNED_BY);
                        if (r.FECHA_ESCANEO) {
                            let d = new Date(r.FECHA_ESCANEO);
                            if (!isNaN(d.getTime())) dates.push(d);
                        }
                        if (sc >= sap) {
                            completeCount++;
                            if (sc > sap) totalExtra += (sc - sap);
                        } else {
                            totalMissing += (sap - sc);
                        }
                    });
                    let status = "INCOMPLETO";
                    if (totalMissing === 0 && totalExtra > 0) {
                        status = "COMPLETO CON MERCANCÍA DE MÁS";
                    } else if (completeCount === totalRecords && totalExtra === 0) {
                        status = "COMPLETO";
                    }
                    let dateInfo = "N/A";
                    if (dates.length > 0) {
                        let minDate = new Date(Math.min(...dates));
                        let maxDate = new Date(Math.max(...dates));
                        dateInfo = `${formatFecha(minDate)} - ${formatFecha(maxDate)}`;
                    }
                    let completionInfo = "N/A";
                    if (status === "INCOMPLETO" || status === "COMPLETO CON MERCANCÍA DE MÁS") {
                        let lastDate = (dates.length > 0) ? new Date(Math.max(...dates)) : new Date();
                        let lastWorker = Array.from(workers).pop() || "N/A";
                        completionInfo = `${lastWorker} el ${formatFecha(lastDate)}`;
                    } else {
                        completionInfo = (workers.size === 1) ? Array.from(workers)[0] : `Varios (${Array.from(workers).join(", ")})`;
                    }
                    return `
                        <div style="font-size:0.95rem; display:flex; flex-direction:column; gap:4px;">
                            <div class="analysis-item">
                                <i class="material-icons" style="color:#666;">apps</i>
                                <strong>SKUs en contenedor:</strong> ${totalRecords}
                            </div>
                            <div class="analysis-item">
                                <i class="material-icons" style="color:#8E44AD;">receipt_long</i>
                                <strong>Piezas Totales (SAP):</strong> ${sapSum}
                            </div>
                            <div class="analysis-item">
                                <i class="material-icons" style="color:#27AE60;">fact_check</i>
                                <strong>Piezas Escaneadas:</strong> ${scannerSum}
                            </div>
                            <div class="analysis-item">
                                <i class="material-icons" style="color:#2980B9;">check_box</i>
                                <strong>SKUs Completos:</strong> ${completeCount} ${totalExtra > 0 ? `(con ${totalExtra} piezas de más)` : ""} 
                            </div>
                            <div class="analysis-item">
                                <i class="material-icons" style="color:${totalMissing > 0 ? "#E74C3C" : "#95A5A6"};">remove_circle</i>
                                <strong>Faltan piezas:</strong> ${totalMissing}
                            </div>
                            <div class="analysis-item">
                                <i class="material-icons" style="color:${totalExtra > 0 ? "#F1C40F" : "#95A5A6"};">add_circle</i>
                                <strong>Excedentes:</strong> ${totalExtra} ${totalExtra > 0 ? "<em style='font-size:0.85rem;color:#555;'>(piezas agregadas de más)</em>" : ""} 
                            </div>
                            <div class="analysis-item">
                                <i class="material-icons" style="color:#16A085;">person</i>
                                <strong>Asignados a:</strong> ${Array.from(assignedUsers).join(", ") || "N/A"}
                            </div>
                            <div class="analysis-item">
                                <i class="material-icons" style="color:#34495E;">engineering</i>
                                <strong>Trabajado por:</strong> ${Array.from(workers).join(", ") || "N/A"}
                            </div>
                            <div class="analysis-item">
                                <i class="material-icons" style="color:#CD6155;">date_range</i>
                                <strong>Fechas de escaneo:</strong> ${dateInfo || "N/A"}
                            </div>
                            <div class="analysis-item">
                                <i class="material-icons" style="color:${status === "COMPLETO" ? "#2ECC71" : "#E74C3C"};">info</i>
                                <strong>Estado:</strong> ${status}
                            </div>
                            <div class="analysis-item">
                                <i class="material-icons" style="color:${status === "COMPLETO" ? "#2ECC71" : "#E74C3C"};">person</i>
                                <strong>${status === "COMPLETO" ? "Completado por:" : "Última actualización:"}</strong> ${completionInfo}
                            </div>
                        </div>
                    `;
                }

                function getContainerStateFromRecords(records) {
                    let totalMissing = 0,
                        totalExtra = 0,
                        completeCount = 0;
                    let totalRecords = records.length;
                    records.forEach(r => {
                        let sap = Number(r.SAP) || 0;
                        let sc = Number(r.SCANNER) || 0;
                        if (sc >= sap) {
                            completeCount++;
                            if (sc > sap) totalExtra += (sc - sap);
                        } else {
                            totalMissing += (sap - sc);
                        }
                    });
                    if (totalMissing === 0 && totalExtra > 0) {
                        return "COMPLETO CON MERCANCÍA DE MÁS";
                    } else if (completeCount === totalRecords && totalExtra === 0) {
                        return "COMPLETO";
                    }
                    return "INCOMPLETO";
                }

                function formatFecha(fecha) {
                    if (fecha instanceof Date && !isNaN(fecha.getTime())) {
                        const dia = fecha.getDate().toString().padStart(2, "0");
                        const mes = (fecha.getMonth() + 1).toString().padStart(2, "0");
                        const anio = fecha.getFullYear();
                        return `${dia}/${mes}/${anio}`;
                    }
                    if (typeof fecha === "string") {
                        let d = new Date(fecha);
                        if (!isNaN(d.getTime())) {
                            let c = new Date(d.getTime() + d.getTimezoneOffset() * 60000);
                            let dd = c.getDate().toString().padStart(2, "0");
                            let mm = (c.getMonth() + 1).toString().padStart(2, "0");
                            let yy = c.getFullYear();
                            return `${dd}/${mm}/${yy}`;
                        }
                        return fecha;
                    }
                    if (typeof fecha === "number") {
                        let d = new Date(Math.round((fecha - 25569) * 86400 * 1000));
                        let c = new Date(d.getTime() + d.getTimezoneOffset() * 60000);
                        let dd = c.getDate().toString().padStart(2, "0");
                        let mm = (c.getMonth() + 1).toString().padStart(2, "0");
                        let yy = c.getFullYear();
                        return `${dd}/${mm}/${yy}`;
                    }
                    return "";
                }

                async function reuploadFileWithScannerChanges(fileName) {
                    let dataObj = excelDataGlobal[fileName];
                    let arr = dataObj.data;
                    let ws = XLSX.utils.json_to_sheet(arr);
                    let wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                    let wbout = XLSX.write(wb, {
                        bookType: "xlsx",
                        type: "array"
                    });
                    let blob = new Blob([wbout], {
                        type: "application/octet-stream"
                    });
                    let storeFolder = (currentUserStore === "ALL") ? "ALL" : currentUserStore;
                    let storageRef = storage.ref(`Manifiestos/${storeFolder}/${fileName}`);
                    await storageRef.put(blob);
                    await db.collection('manifiestos')
                        .doc(fileName)
                        .set({
                            fileName,
                            store: storeFolder,
                            lastUser: dataObj.lastUser,
                            lastUserStore: (dataObj.lastUserStore !== undefined) ? dataObj.lastUserStore : null,
                            lastUserRole: (dataObj.lastUserRole !== undefined) ? dataObj.lastUserRole : null,
                            closedContainers: dataObj.closedContainers || {},
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, {
                            merge: true
                        });
                }
            });
        })();
    </script>
</body>
</html>