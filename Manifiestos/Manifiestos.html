<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manifestar Mercancía - Control en Tiempo Real</title>
  
  <!-- Fuentes, Bootstrap, Bootstrap Icons, SweetAlert2 y AOS -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
  
  <style>
    /* VARIABLES DE COLOR */
    :root {
      --rosa-principal: #E6007E;
      --rosa-secundario: #F8BBD0;
      --negro: #000000;
      --blanco: #ffffff;
      --gris-oscuro: #333333;
      --verde-vivo: #66BB6A;
    }
    /* Clase para badges de ancho fijo */
    .badge-fixed {
      display: inline-block;
      min-width: 2em;
      text-align: center;
    }
    /* ESTILO GENERAL */
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, var(--rosa-principal), var(--negro));
      margin: 0;
      padding: 0;
      color: var(--gris-oscuro);
      min-height: 100vh;
    }
    a { text-decoration: none; }
    /* HEADER */
    header {
      background-color: var(--rosa-principal);
      color: var(--blanco);
      padding: 15px 25px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.3s ease;
    }
    .header-title {
      font-size: 1.8rem;
      font-weight: 600;
    }
    .btn-menu {
      font-size: 1.8rem;
      background: transparent;
      color: var(--blanco);
      border: none;
      cursor: pointer;
    }
    /* Logout */
    #logout-btn {
      font-size: 1rem;
      display: flex;
      align-items: center;
      padding: 0.6rem;
      border-radius: 8px;
      background-color: #c82333;
      border: none;
      color: var(--blanco);
      transition: background-color 0.3s ease;
    }
    #logout-btn:hover { background-color: #a71d2a; }
    /* MENÚ LATERAL */
    .offcanvas {
      background-color: var(--rosa-principal);
      color: var(--blanco);
    }
    .offcanvas-header { padding: 1rem; }
    .offcanvas-body { padding: 0; }
    .offcanvas-title { font-size: 1.3rem; font-weight: 600; }
    .navbar-nav { padding-left: 1rem; }
    .navbar-nav .nav-link {
      color: var(--blanco);
      font-size: 1rem;
      padding: 0.75rem 1.5rem;
      transition: background-color 0.3s ease;
      display: block;
      text-decoration: none;
    }
    .navbar-nav .nav-link:hover {
      background-color: var(--rosa-secundario);
      color: var(--gris-oscuro);
    }
    /* CONTENEDOR PRINCIPAL */
    .main-container {
      max-width: 1000px;
      margin: 3rem auto;
      padding: 2rem 3rem;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      position: relative;
      overflow: hidden;
      animation: containerSlide 0.8s ease-out both;
    }
    @keyframes containerSlide {
      from { opacity: 0; transform: translateY(50px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .main-container h2 {
      font-size: 2.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: var(--rosa-principal);
      text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
    }
    /* DROPZONE */
    #dropzone {
      border: 2px dashed var(--rosa-principal);
      border-radius: 12px;
      background-color: #f1f8ff;
      padding: 2rem;
      text-align: center;
      color: var(--rosa-principal);
      cursor: pointer;
      transition: transform 0.3s ease;
      margin-bottom: 2rem;
    }
    #dropzone:hover { transform: scale(1.02); }
    /* BOTONES */
    .btn, .action-btn {
      border-radius: 8px;
      transition: all 0.2s ease-in-out;
    }
    .btn:hover, .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    /* Sección de Gestión de Archivos para Admins */
    #adminFilesSection {
      margin-top: 1rem;
    }
    /* TABLA MODERNA */
    .table-responsive {
      overflow: hidden;
      width: 100%;
    }
    .table-responsive table {
      width: 100%;
      table-layout: fixed;
      font-size: 0.8rem;
      border-collapse: collapse;
    }
    .table-responsive th,
    .table-responsive td {
      white-space: normal;
      word-wrap: break-word;
      padding: 0.8rem;
      border: 1px solid #ddd;
      text-align: center;
    }
    .table-responsive thead th {
      background-color: var(--rosa-principal);
      color: var(--blanco);
    }
    .table-responsive tbody tr:hover {
      background-color: #fce4ec;
    }
    /* Animaciones */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    /* MODO APILADO EN MÓVILES */
    @media (max-width: 576px) {
      .table-responsive table,
      .table-responsive thead,
      .table-responsive tbody,
      .table-responsive th,
      .table-responsive td,
      .table-responsive tr {
        display: block;
      }
      .table-responsive thead tr { position: absolute; top: -9999px; left: -9999px; }
      .table-responsive tr { border: 1px solid #ccc; margin-bottom: 1rem; }
      .table-responsive td {
        border: none;
        border-bottom: 1px solid #eee;
        position: relative;
        padding-left: 45%;
        text-align: left;
      }
      .table-responsive td:before {
        position: absolute;
        top: 0;
        left: 6px;
        width: 38%;
        padding-right: 10px;
        white-space: nowrap;
        font-weight: bold;
      }
      .table-responsive td:nth-of-type(1):before { content: "Sección"; }
      .table-responsive td:nth-of-type(2):before { content: "Contenedor"; }
      .table-responsive td:nth-of-type(3):before { content: "SKU"; }
      .table-responsive td:nth-of-type(4):before { content: "Descripción"; }
      .table-responsive td:nth-of-type(5):before { content: "SAP"; }
      .table-responsive td:nth-of-type(6):before { content: "SCANNER"; }
      .table-responsive td:nth-of-type(7):before { content: "Diferencia"; }
      .main-container { padding: 1.5rem; }
      .main-container h2 { font-size: 2rem; }
      #logout-btn { padding: 0.4rem 0.8rem; font-size: 0.9rem; }
    }
    .offcanvas.offcanvas-start {
  left: 0 !important;
}

  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="d-flex justify-content-between align-items-center px-4 py-3">
    <div class="d-flex align-items-center">
      <button class="btn-menu me-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuLateral" aria-controls="menuLateral">
        <i class="bi bi-list"></i>
      </button>
      <div class="header-title">Manifestar Mercancía</div>
    </div>
    <button class="btn btn-danger" id="logout-btn" aria-label="Cerrar sesión">
      <i class="bi bi-power"></i>
    </button>
  </header>

<!-- Menú Lateral (Offcanvas) -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="menuLateral" aria-labelledby="menuLateralLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="menuLateralLabel">Menú</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
  </div>
  <div class="offcanvas-body p-0">
    <nav class="nav flex-column">
      <ul class="navbar-nav" style="padding-left: 0; margin-left: 0;">
        <li class="nav-item" data-aos="fade-right" data-aos-delay="100">
          <a class="nav-link d-flex align-items-center" href="../index.html" style="padding-left: 1rem;">
            <i class="bi bi-house-door-fill me-2"></i>
            <span>Inicio</span>
          </a>
        </li>
        <li class="nav-item" data-aos="fade-right" data-aos-delay="200">
          <a class="nav-link d-flex align-items-center" href="../ChecarPrecios/index.html" style="padding-left: 1rem;">
            <i class="bi bi-tags me-2"></i>
            <span>Checar Precios</span>
          </a>
        </li>
        <li class="nav-item" data-aos="fade-right" data-aos-delay="300">
          <a class="nav-link d-flex align-items-center" href="../Rechazos/reportes.html" style="padding-left: 1rem;">
            <i class="bi bi-x-octagon-fill me-2"></i>
            <span>Rechazos</span>
          </a>
        </li>
        <li class="nav-item" data-aos="fade-right" data-aos-delay="400">
          <a class="nav-link d-flex align-items-center" href="../Inventarios/Inventarios.html" style="padding-left: 1rem;">
            <i class="bi bi-archive me-2"></i>
            <span>Inventarios</span>
          </a>
        </li>
        <li class="nav-item" data-aos="fade-right" data-aos-delay="500">
          <a class="nav-link d-flex align-items-center active" href="../Configuraciones/Configuracion.html" style="padding-left: 1rem;">
            <i class="bi bi-sliders me-2"></i>
            <span>Configuración</span>
          </a>
        </li>
        <li class="nav-item" data-aos="fade-right" data-aos-delay="600">
          <a class="nav-link d-flex align-items-center" href="../Manifiestos/Manifiestos.html" style="padding-left: 1rem;">
            <i class="bi bi-file-earmark-check me-2"></i>
            <span>Manifiestos</span>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</div>





  <!-- CONTENEDOR PRINCIPAL -->
  <section class="container main-container" data-aos="fade-up" data-aos-duration="1000">
    <!-- Sección de Carga de Archivos (Solo Admins) -->
    <div id="adminUploadSection" data-aos="zoom-in" style="display: none;">
      <div class="card mb-4">
        <div class="card-header text-center">
          <h2 class="h4" style="color: var(--rosa-principal);">
            <i class="bi bi-upload me-1"></i> Subir Archivo
          </h2>
        </div>
        <div class="card-body text-center">
          <p>Arrastra y suelta o haz clic para seleccionar.</p>
          <div id="dropzone">
            <i class="bi bi-cloud-upload" style="font-size: 2rem;"></i>
            <p>Arrastra aquí</p>
            <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;">
          </div>
          <p id="selectedFileName" class="text-muted"></p>
          <!-- Botón de subir y ver archivos juntos en la misma fila -->
          <div class="d-flex justify-content-center gap-2 mt-3">
            <button id="uploadFileBtn" class="btn btn-primary action-btn" disabled>
              <i class="bi bi-upload me-1"></i> Subir
            </button>
            <button id="btnVerArchivos" class="btn btn-secondary">
              <i class="bi bi-folder2-open"></i> Ver Archivos
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sección para Escanear Referencia (para todos) -->
    <div id="referenceScanSection" data-aos="fade-up" class="mb-4">
      <div class="card shadow-sm">
        <div class="card-header text-center bg-white border-0">
          <h2 class="h4" style="color: var(--rosa-principal);">
            <i class="bi bi-upc-scan me-1"></i> Escanear Referencia
          </h2>
        </div>
        <div class="card-body">
          <div class="row g-3 align-items-center">
            <div class="col-md-9">
              <input type="text" id="inputReferencia" class="form-control" placeholder="Ej: CONT123 o ART456">
            </div>
            <div class="col-md-3">
              <button id="btnBuscarReferencia" class="btn btn-primary btn-sm w-100">
                <i class="bi bi-search me-1"></i> Buscar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sección de Resultados del Contenedor -->
    <div id="containerResultsSection" data-aos="fade-up" style="display: none;" class="mb-4">
      <div class="card shadow-sm">
        <div class="card-header text-center bg-white border-0">
          <h2 class="h4" style="color: var(--rosa-principal);">
            <i class="bi bi-box-seam me-1"></i> Detalles del Contenedor
          </h2>
          <p id="selectedFileToWork" class="fw-bold"></p>
          <button id="btnAnalisisGlobal" class="btn btn-info btn-sm mt-2">Análisis Global</button>
        </div>
        <div id="containerDetails" class="card-body table-responsive">
          <!-- Aquí se mostrarán los registros filtrados -->
        </div>
        <div id="downloadSection" class="p-3" style="display: none; text-align: center;">
          <button id="btnDescargarArchivo" class="btn btn-success btn-sm">
            <i class="bi bi-download me-1"></i> Descargar Archivo Actual
          </button>
        </div>
      </div>
    </div>

    <!-- Sección de Registro de Escaneo (para todos) -->
    <div id="scanEntrySection" data-aos="fade-up" style="display: none;" class="mb-4">
      <div class="card shadow-sm">
        <div class="card-header text-center bg-white border-0">
          <h2 class="h4" style="color: var(--rosa-principal);">
            <i class="bi bi-upc me-1"></i> Registro de Escaneo
          </h2>
        </div>
        <div class="card-body">
          <input type="text" id="inputScanCode" class="form-control" placeholder="Escanee el código aquí" autofocus>
          <small class="text-muted d-block mt-2">
            Presione Enter o, al detectar más de 9 dígitos, se buscará automáticamente.
          </small>
        </div>
      </div>
    </div>
  </section>

  <!-- SCRIPTS: Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA_4H46I7TCVLnFjet8fQPZ006latm-mRE",
      authDomain: "loginliverpool.firebaseapp.com",
      projectId: "loginliverpool",
      storageBucket: "loginliverpool.appspot.com",
      messagingSenderId: "704223815941",
      appId: "1:704223815941:web:c871525230fb61caf96f6c",
      measurementId: "G-QFEPQ4TSPY"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const storage = firebase.app().storage("gs://loginliverpool.firebasestorage.app");
    const db = firebase.firestore();
  </script>

  <!-- Otras librerías -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

  <!-- Script principal -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      AOS.init();
      
      // VARIABLES GLOBALES
      const adminUIDs = ["doxhVo1D3aYQqqkqgRgfJ4qcKcU2", "OaieQ6cGi7TnW0nbxvlk2oyLaER2"];
      let currentUser = null;
      let excelDataGlobal = {};  // Almacenará los datos de cada archivo subido
      let currentContainerRecords = [];
      let currentContenedor = null;
      
      // AUTENTICACIÓN: Sólo los admins ven la sección de carga y gestión
      auth.onAuthStateChanged(user => {
        currentUser = user;
        if (currentUser && adminUIDs.includes(currentUser.uid)) {
          document.getElementById('adminUploadSection').style.display = 'block';
        } else {
          document.getElementById('adminUploadSection').style.display = 'none';
        }
      });
      
      function showToast(icon, title) {
        Swal.fire({
          toast: true,
          position: 'top-end',
          icon: icon,
          title: title,
          showConfirmButton: false,
          timer: 2000,
          timerProgressBar: true,
          didOpen: (toast) => {
            toast.addEventListener('mouseenter', Swal.stopTimer);
            toast.addEventListener('mouseleave', Swal.resumeTimer);
          }
        });
      }
      
      // CERRAR SESIÓN: Solo se asigna el listener si existe el botón
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          auth.signOut().then(() => {
            window.location.href = "../Login/login.html";
          }).catch(error => {
            console.error("Error al cerrar sesión:", error);
          });
        });
      }
      
      // --- FUNCIONES DE ANÁLISIS ---
      function checkContainerCompleteness(records) {
        let missingDetails = [];
        let extraDetails = [];
        const totalCount = records.length;
        let completeCount = 0;
        records.forEach(r => {
          const SAP = r.SAP || 0;
          const SCANNER = r.SCANNER || 0;
          if (SCANNER >= SAP && SAP > 0) {
            completeCount++;
          } else if (SCANNER < SAP) {
            missingDetails.push({ sku: r.SKU, faltan: SAP - SCANNER });
          }
          if (SCANNER > SAP && SAP > 0) {
            extraDetails.push({ sku: r.SKU, deMas: SCANNER - SAP });
          }
        });
        const complete = (completeCount === totalCount);
        let msg = `<p><strong>Contenedor:</strong> ${records[0].CONTENEDOR}</p>`;
        msg += `<table style="width:100%; border-collapse:collapse; margin-bottom:1rem;">
                  <tr>
                    <td style="border:1px solid #ddd; padding:5px; text-align:center;">Completos:</td>
                    <td style="border:1px solid #ddd; padding:5px; text-align:center;" class="badge bg-success badge-fixed">${completeCount}</td>
                  </tr>
                  <tr>
                    <td style="border:1px solid #ddd; padding:5px; text-align:center;">Faltantes:</td>
                    <td style="border:1px solid #ddd; padding:5px; text-align:center;" class="badge bg-danger badge-fixed">${missingDetails.length}</td>
                  </tr>
                  <tr>
                    <td style="border:1px solid #ddd; padding:5px; text-align:center;">Excedentes:</td>
                    <td style="border:1px solid #ddd; padding:5px; text-align:center;" class="badge bg-warning badge-fixed">${extraDetails.length}</td>
                  </tr>
                </table>`;
        if (missingDetails.length > 0) {
          msg += `<p><strong>Detalle de Faltantes:</strong></p>`;
          msg += `<table style="width:100%; border-collapse:collapse; margin-bottom:1rem;">
                    <thead>
                      <tr>
                        <th style="border:1px solid #ddd; padding:5px;">SKU</th>
                        <th style="border:1px solid #ddd; padding:5px;">Faltan</th>
                      </tr>
                    </thead>
                    <tbody>`;
          missingDetails.forEach(item => {
            msg += `<tr>
                      <td style="border:1px solid #ddd; padding:5px; text-align:center;">${item.sku}</td>
                      <td style="border:1px solid #ddd; padding:5px; text-align:center;">${item.faltan} uds</td>
                    </tr>`;
          });
          msg += `</tbody></table>`;
        }
        if (extraDetails.length > 0) {
          msg += `<p><strong>Detalle de Excedentes:</strong></p>`;
          msg += `<table style="width:100%; border-collapse:collapse; margin-bottom:1rem;">
                    <thead>
                      <tr>
                        <th style="border:1px solid #ddd; padding:5px;">SKU</th>
                        <th style="border:1px solid #ddd; padding:5px;">De más</th>
                      </tr>
                    </thead>
                    <tbody>`;
          extraDetails.forEach(item => {
            msg += `<tr>
                      <td style="border:1px solid #ddd; padding:5px; text-align:center;">${item.sku}</td>
                      <td style="border:1px solid #ddd; padding:5px; text-align:center;">${item.deMas} uds</td>
                    </tr>`;
          });
          msg += `</tbody></table>`;
        }
        if (complete) {
          const worker = currentUser ? (currentUser.displayName || currentUser.email) : "Desconocido";
          msg += `<p class="text-success" style="margin:0;"><i class="bi bi-check-circle"></i> Contenedor completado.<br>Trabajado por: <strong>${worker}</strong></p>`;
        }
        msg += `<p>¿Desea continuar con este contenedor?</p>`;
        return { incomplete: (missingDetails.length > 0 || extraDetails.length > 0), msg, complete };
      }
      
      // Función de análisis global de todo el archivo con diseño mejorado, iconos y animaciones
      function checkGlobalCompleteness(records) {
        const grupos = {};
        records.forEach(r => {
          const cont = r.CONTENEDOR || "Sin contenedor";
          if (!grupos[cont]) grupos[cont] = [];
          grupos[cont].push(r);
        });
        let overallComplete = true;
        let msg = `<div style="font-family: 'Poppins', sans-serif;">`;
        for (const cont in grupos) {
          const grupo = grupos[cont];
          let completeCount = 0, missingCount = 0, extraCount = 0;
          const totalCount = grupo.length;
          grupo.forEach(r => {
            const SAP = r.SAP || 0;
            const SCANNER = r.SCANNER || 0;
            if (SCANNER >= SAP && SAP > 0) {
              completeCount++;
            } else {
              if (SCANNER < SAP) missingCount++;
              if (SCANNER > SAP) extraCount++;
            }
          });
          const isComplete = (completeCount === totalCount);
          if (!isComplete) overallComplete = false;
          msg += `<div style="margin-bottom: 1rem; padding: 1rem; border: 2px solid ${isComplete ? '#66BB6A' : '#F44336'}; border-radius: 10px; animation: fadeIn 1s;">`;
          msg += `<h5 style="margin-bottom: 0.5rem; color: ${isComplete ? '#66BB6A' : '#F44336'};">`;
          msg += isComplete ? `<i class="bi bi-check-circle-fill"></i> ` : `<i class="bi bi-exclamation-triangle-fill"></i> `;
          msg += `Contenedor: ${cont}</h5>`;
          msg += `<div style="display: flex; justify-content: space-between;">`;
          msg += `<span style="background: #66BB6A; color: #fff; padding: 0.3rem 0.6rem; border-radius: 5px; animation: pulse 1.5s infinite;">Completos: ${completeCount}</span>`;
          msg += `<span style="background: #F44336; color: #fff; padding: 0.3rem 0.6rem; border-radius: 5px; animation: pulse 1.5s infinite;">Faltantes: ${missingCount}</span>`;
          msg += `<span style="background: #FFEB3B; color: #000; padding: 0.3rem 0.6rem; border-radius: 5px; animation: pulse 1.5s infinite;">Excedentes: ${extraCount}</span>`;
          msg += `</div></div>`;
        }
        msg += `<div style="text-align: center; font-weight: bold; color: ${overallComplete ? '#66BB6A' : '#F44336'}; font-size: 1.1rem; animation: fadeIn 1s;">`;
        msg += overallComplete 
                  ? '<i class="bi bi-check-circle-fill"></i> Todos los contenedores están completos.' 
                  : '<i class="bi bi-exclamation-triangle-fill"></i> Hay contenedores incompletos.';
        msg += `</div></div>`;
        return { msg, complete: overallComplete };
      }
      
      // Función para mostrar detalles del contenedor (vista filtrada)
      function mostrarDetallesContenedor(registros) {
        const containerDetails = document.getElementById('containerDetails');
        containerDetails.innerHTML = "";
        const isMobile = window.innerWidth < 576;
        const headers = isMobile 
          ? ["Sección", "Contenedor", "SKU", "Descripción", "SAP", "SCANNER", "Diferencia"]
          : ["Fecha", "Sección", "Manifiesto", "Contenedor", "SKU", "Europeo", "Descripción", "SAP", "SCANNER", "Diferencia"];
      
        const table = document.createElement('table');
        table.className = 'table table-bordered table-striped table-hover';
        let theadHTML = `<thead><tr>`;
        headers.forEach(h => { theadHTML += `<th>${h}</th>`; });
        theadHTML += `</tr></thead>`;
        table.innerHTML = theadHTML;
      
        const tbody = document.createElement('tbody');
        registros.forEach(reg => {
          const SAPval = reg.SAP || 0;
          const SCANNERval = reg.SCANNER || 0;
          let diffText = "";
          if (SCANNERval < SAPval) {
            diffText = "FALTAN " + (SAPval - SCANNERval) + " uds";
          } else if (SCANNERval > SAPval) {
            diffText = "MERCANCIA DE MAS: " + (SCANNERval - SAPval) + " uds";
          } else {
            diffText = "OK";
          }
          const diffColor = (SCANNERval < SAPval)
            ? "#F44336"
            : (SCANNERval === SAPval) ? "#66BB6A" : "#FFEB3B";
      
          let trHTML = `<tr>`;
          if (!isMobile) {
            trHTML += `<td>${reg.FECHA || ''}</td>`;
            trHTML += `<td>${reg.SECCION || ''}</td>`;
            trHTML += `<td>${reg.MANIFIESTO || ''}</td>`;
            trHTML += `<td>${reg.CONTENEDOR || ''}</td>`;
            trHTML += `<td>${reg.SKU || ''}</td>`;
            trHTML += `<td>${reg.EUROPEO || ''}</td>`;
            trHTML += `<td>${reg.DESCRIPCION || ''}</td>`;
            trHTML += `<td>${SAPval}</td>`;
            trHTML += `<td><input type="text" class="form-control scanner-input" value="${SCANNERval || ''}" data-index="${excelDataGlobal[document.getElementById('selectedFileToWork').textContent].findIndex(r => r.SKU === reg.SKU && r.CONTENEDOR === reg.CONTENEDOR)}" style="max-width:80px;"></td>`;
            trHTML += `<td style="background-color: ${diffColor}; color: ${diffColor === "#FFEB3B" ? "#000000" : "#FFFFFF"}; font-weight: bold;">${diffText}</td>`;
          } else {
            trHTML += `<td>${reg.SECCION || ''}</td>`;
            trHTML += `<td>${reg.CONTENEDOR || ''}</td>`;
            trHTML += `<td>${reg.SKU || ''}</td>`;
            trHTML += `<td>${reg.DESCRIPCION || ''}</td>`;
            trHTML += `<td>${SAPval}</td>`;
            trHTML += `<td><input type="text" class="form-control scanner-input" value="${SCANNERval || ''}" data-index="${excelDataGlobal[document.getElementById('selectedFileToWork').textContent].findIndex(r => r.SKU === reg.SKU && r.CONTENEDOR === reg.CONTENEDOR)}" style="max-width:80px;"></td>`;
            trHTML += `<td style="background-color: ${diffColor}; color: ${diffColor === "#FFEB3B" ? "#000000" : "#FFFFFF"}; font-weight: bold;">${diffText}</td>`;
          }
          trHTML += `</tr>`;
          tbody.innerHTML += trHTML;
        });
        table.appendChild(tbody);
        containerDetails.appendChild(table);
      
        document.querySelectorAll('.scanner-input').forEach(input => {
          input.addEventListener('blur', function() {
            const newVal = parseInt(this.value) || 0;
            const index = this.dataset.index;
            const fileName = document.getElementById('selectedFileToWork').textContent;
            if (index !== undefined && excelDataGlobal[fileName][index] !== undefined) {
              excelDataGlobal[fileName][index].SCANNER = newVal;
              currentContainerRecords = excelDataGlobal[fileName].filter(r => r.CONTENEDOR === excelDataGlobal[fileName][index].CONTENEDOR);
              actualizarArchivoEnStorage(fileName);
              mostrarDetallesContenedor(currentContainerRecords);
              showToast('success', 'SCANNER actualizado.');
            }
          });
        });
      }
      
      // Función para actualizar el archivo en Storage
      function actualizarArchivoEnStorage(fileName) {
        if (!fileName) return;
        const data = excelDataGlobal[fileName];
        const newSheet = XLSX.utils.json_to_sheet(data);
        const range = XLSX.utils.decode_range(newSheet["!ref"]);
        for (let C = range.s.c; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({ r: range.s.r, c: C });
          if (newSheet[cellAddress]) {
            newSheet[cellAddress].s = {
              fill: { fgColor: { rgb: "E6007E" } },
              font: { bold: true, color: { rgb: "FFFFFF" } },
              alignment: { horizontal: "center" },
              border: { top: { style: "thin" }, right: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" } }
            };
          }
        }
        const newWorkbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWorkbook, newSheet, "Sheet1");
        const wbout = XLSX.write(newWorkbook, { bookType: 'xlsx', type: 'array', cellStyles: true });
        const blob = new Blob([wbout], { type: "application/octet-stream" });
        const storageRef = storage.ref().child('excelFiles/' + fileName);
        storageRef.put(blob).then(() => {
          console.log("Archivo actualizado en Storage.");
        }).catch((error) => {
          console.error("Error al actualizar archivo:", error);
          showToast('error', 'No se pudo actualizar el archivo.');
        });
      }
      
      // Función para procesar escaneo acumulativo
      function procesarEscaneo(code) {
        if (!code) return;
        const fileName = document.getElementById('selectedFileToWork').textContent;
        const data = excelDataGlobal[fileName];
        const registro = data.find(row =>
          String(row.SKU).trim() === code || String(row.EUROPEO).trim() === code
        );
        if (!registro) {
          showToast('info', 'Código no encontrado en este archivo.');
          return;
        }
        registro.SCANNER = (registro.SCANNER || 0) + 1;
        actualizarArchivoEnStorage(fileName);
        currentContainerRecords = data.filter(r => r.CONTENEDOR === registro.CONTENEDOR);
        mostrarDetallesContenedor(currentContainerRecords);
      }
      
      // Función para buscar referencia en TODOS los archivos
      function buscarReferenciaEnTodosLosArchivos(referencia) {
        storage.ref('excelFiles').listAll().then(result => {
          let found = false;
          let foundRecords = [];
          let foundFile = "";
          const promises = result.items.map(item => {
            return item.getDownloadURL().then(url => {
              return fetch(url)
                .then(response => response.arrayBuffer())
                .then(data => {
                  const workbook = XLSX.read(data, { type: 'array' });
                  const firstSheetName = workbook.SheetNames[0];
                  const worksheet = workbook.Sheets[firstSheetName];
                  const dataJson = XLSX.utils.sheet_to_json(worksheet);
                  excelDataGlobal[item.name] = dataJson;
                  let registros = dataJson.filter(row => String(row.CONTENEDOR).trim() === referencia);
                  if (registros.length === 0) {
                    const match = dataJson.find(row => 
                      String(row.SKU).trim() === referencia || String(row.EUROPEO).trim() === referencia
                    );
                    if (match) {
                      registros = dataJson.filter(row => String(row.CONTENEDOR).trim() === String(match.CONTENEDOR).trim());
                    }
                  }
                  if (registros.length > 0 && !found) {
                    found = true;
                    foundRecords = registros;
                    foundFile = item.name;
                  }
                });
            });
          });
          Promise.all(promises).then(() => {
            if (found) {
              const nuevoContenedor = foundRecords[0].CONTENEDOR;
              if (currentContenedor && currentContenedor !== nuevoContenedor) {
                const infoActual = checkContainerCompleteness(currentContainerRecords);
                Swal.fire({
                  icon: 'warning',
                  title: 'Cambio de Contenedor',
                  html: `<p>Actualmente trabajas en el contenedor <strong>${currentContenedor}</strong>.</p>
                         ${infoActual.msg}<br>¿Deseas cambiar al contenedor <strong>${nuevoContenedor}</strong>?`,
                  showCancelButton: true,
                  confirmButtonText: 'Sí, cambiar',
                  cancelButtonText: 'No, mantener'
                }).then(res => {
                  if (res.isConfirmed) {
                    currentContenedor = nuevoContenedor;
                    continuarBusqueda(foundRecords, foundFile);
                  }
                });
              } else {
                currentContenedor = nuevoContenedor;
                const info = checkContainerCompleteness(foundRecords);
                if (info.complete) {
                  const worker = currentUser ? (currentUser.displayName || currentUser.email) : "Desconocido";
                  Swal.fire({
                    icon: 'info',
                    title: 'Contenedor Completado',
                    html: `<p>El contenedor <strong>${nuevoContenedor}</strong> ya fue completado.</p>
                           <p>Trabajado por: <strong>${worker}</strong></p>
                           ${info.msg}`,
                    confirmButtonText: 'Continuar'
                  }).then(() => {
                    continuarBusqueda(foundRecords, foundFile);
                  });
                } else {
                  continuarBusqueda(foundRecords, foundFile);
                }
              }
            } else {
              showToast('info', 'No se encontró la referencia en ningún archivo.');
            }
          });
        }).catch(error => {
          console.error("Error al listar archivos:", error);
          showToast('error', 'Error al buscar archivos.');
        });
      }
      
      // Función que continúa la búsqueda mostrando resultados
      function continuarBusqueda(registros, fileName) {
        document.getElementById('selectedFileToWork').textContent = fileName;
        currentContainerRecords = registros;
        mostrarDetallesContenedor(currentContainerRecords);
        document.getElementById('containerResultsSection').style.display = 'block';
        document.getElementById('scanEntrySection').style.display = 'block';
        if (currentUser && adminUIDs.includes(currentUser.uid)) {
          document.getElementById('downloadSection').style.display = 'block';
        } else {
          document.getElementById('downloadSection').style.display = 'none';
        }
      }
      
      // --- EVENTO PARA BOTÓN "ANÁLISIS GLOBAL" ---
      const btnAnalisisGlobal = document.getElementById('btnAnalisisGlobal');
      if (btnAnalisisGlobal) {
        btnAnalisisGlobal.addEventListener('click', () => {
          const fileName = document.getElementById('selectedFileToWork').textContent;
          if (fileName && excelDataGlobal[fileName]) {
            const globalAnalysis = checkGlobalCompleteness(excelDataGlobal[fileName]);
            Swal.fire({
              title: 'Análisis Global',
              html: globalAnalysis.msg,
              icon: globalAnalysis.complete ? 'success' : 'warning',
              confirmButtonText: 'OK'
            });
          } else {
            showToast('error', 'No hay registros para analizar.');
          }
        });
      }
      
      // --- EVENTO PARA BOTÓN "DESCARGAR ARCHIVO" ---
      const btnDescargarArchivo = document.getElementById('btnDescargarArchivo');
      if (btnDescargarArchivo) {
        btnDescargarArchivo.addEventListener('click', () => {
          descargarArchivoTotal();
        });
      }
      
      // Función para descargar el archivo actual
      function descargarArchivoTotal() {
        const fileName = document.getElementById('selectedFileToWork').textContent;
        if (!fileName || !excelDataGlobal[fileName]) {
          showToast('error', 'No hay archivo para descargar.');
          return;
        }
        let exportData = excelDataGlobal[fileName].slice().sort((a, b) => {
          if(a.CONTENEDOR < b.CONTENEDOR) return -1;
          if(a.CONTENEDOR > b.CONTENEDOR) return 1;
          return ('' + a.SKU).localeCompare(b.SKU);
        });
        exportData = exportData.map(row => {
          const SAP = row.SAP || 0;
          const SCANNER = row.SCANNER || 0;
          let diff = "";
          if (SCANNER < SAP) {
            diff = "FALTAN " + (SAP - SCANNER) + " uds";
          } else if (SCANNER > SAP) {
            diff = "MERCANCIA DE MAS: " + (SCANNER - SAP) + " uds";
          } else {
            diff = "OK";
          }
          return {
            FECHA: row.FECHA || "",
            SECCION: row.SECCION || "",
            MANIFIESTO: row.MANIFIESTO || "",
            CONTENEDOR: row.CONTENEDOR || "",
            SKU: row.SKU || "",
            EUROPEO: row.EUROPEO || "",
            DESCRIPCION: row.DESCRIPCION || "",
            SAP: row.SAP || "",
            SCANNER: row.SCANNER || "",
            DIFERENCIA: diff
          };
        });
        const newSheet = XLSX.utils.json_to_sheet(exportData, {
          header: ["FECHA","SECCION","MANIFIESTO","CONTENEDOR","SKU","EUROPEO","DESCRIPCION","SAP","SCANNER","DIFERENCIA"]
        });
        const range = XLSX.utils.decode_range(newSheet["!ref"]);
        for (let C = range.s.c; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({ r: range.s.r, c: C });
          if (newSheet[cellAddress]) {
            newSheet[cellAddress].s = {
              fill: { fgColor: { rgb: "E6007E" } },
              font: { bold: true, color: { rgb: "FFFFFF" }, sz: 12 },
              alignment: { horizontal: "center" },
              border: { top: { style: "thin" }, right: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" } }
            };
          }
        }
        for (let i = range.s.r + 1; i <= range.e.r; i++) {
          const cellAddress = XLSX.utils.encode_cell({ r: i, c: 9 });
          if (newSheet[cellAddress]) {
            const cellValue = newSheet[cellAddress].v;
            if (cellValue === "OK") {
              newSheet[cellAddress].s = {
                fill: { fgColor: { rgb: "66BB6A" } },
                font: { bold: true, color: { rgb: "FFFFFF" }, sz: 12 },
                alignment: { horizontal: "center" },
                border: { top: { style: "thin" }, right: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" } }
              };
            } else if (cellValue.startsWith("MERCANCIA DE MAS")) {
              newSheet[cellAddress].s = {
                fill: { fgColor: { rgb: "FFEB3B" } },
                font: { bold: true, color: { rgb: "000000" }, sz: 12 },
                alignment: { horizontal: "center" },
                border: { top: { style: "thin" }, right: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" } }
              };
            } else if (cellValue.startsWith("FALTAN")) {
              newSheet[cellAddress].s = {
                fill: { fgColor: { rgb: "F44336" } },
                font: { bold: true, color: { rgb: "FFFFFF" }, sz: 12 },
                alignment: { horizontal: "center" },
                border: { top: { style: "thin" }, right: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" } }
              };
            }
          }
        }
        const newWorkbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWorkbook, newSheet, "Sheet1");
        const wbout = XLSX.write(newWorkbook, { bookType: 'xlsx', type: 'array', cellStyles: true });
        const blob = new Blob([wbout], { type: "application/octet-stream" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
      
      // --- EVENTO PARA BOTÓN "BUSCAR REFERENCIA" ---
      const btnBuscarReferencia = document.getElementById('btnBuscarReferencia');
      const inputReferencia = document.getElementById('inputReferencia');
      if (btnBuscarReferencia) {
        btnBuscarReferencia.addEventListener('click', () => {
          const referencia = inputReferencia.value.trim();
          if (!referencia) {
            showToast('error', 'Ingrese una referencia.');
            return;
          }
          buscarReferenciaEnTodosLosArchivos(referencia);
        });
      }
      if (inputReferencia) {
        inputReferencia.addEventListener('keyup', (e) => {
          const referencia = e.target.value.trim();
          if (referencia.length > 9) {
            buscarReferenciaEnTodosLosArchivos(referencia);
          }
        });
      }
      
      // --- EVENTOS PARA SUBIDA DE ARCHIVOS (CLICK y DRAG & DROP) ---
      const dropzone = document.getElementById('dropzone');
      const fileInput = document.getElementById('fileInput');
      const selectedFileName = document.getElementById('selectedFileName');
      const uploadFileBtn = document.getElementById('uploadFileBtn');

      dropzone.addEventListener('click', () => {
        fileInput.click();
      });

      fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
          selectedFileName.textContent = file.name;
          uploadFileBtn.disabled = false;
        }
      });

      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.style.backgroundColor = "#e0e0e0";
      });
      dropzone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropzone.style.backgroundColor = "#f1f8ff";
      });
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.style.backgroundColor = "#f1f8ff";
        const file = e.dataTransfer.files[0];
        if (file) {
          fileInput.files = e.dataTransfer.files;
          selectedFileName.textContent = file.name;
          uploadFileBtn.disabled = false;
        }
      });

      uploadFileBtn.addEventListener('click', () => {
        const file = fileInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const arrayBuffer = e.target.result;
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const dataJson = XLSX.utils.sheet_to_json(worksheet);
            excelDataGlobal[file.name] = dataJson;
            const storageRef = storage.ref().child('excelFiles/' + file.name);
            const blob = new Blob([arrayBuffer], { type: file.type });
            storageRef.put(blob).then(() => {
              showToast('success', 'Archivo subido exitosamente.');
              fileInput.value = "";
              selectedFileName.textContent = "";
              uploadFileBtn.disabled = true;
            }).catch((error) => {
              console.error("Error al subir archivo:", error);
              showToast('error', 'Error al subir archivo.');
            });
          };
          reader.readAsArrayBuffer(file);
        } else {
          showToast('error', 'No hay archivo seleccionado.');
        }
      });
      
      // --- ADMIN: Gestión de Archivos (Listar y Eliminar) ---
      function listarArchivos() {
        storage.ref('excelFiles').listAll().then(result => {
          if (result.items.length === 0) {
            Swal.fire({
              title: 'Archivos Subidos',
              html: '<p>No hay archivos subidos.</p>',
              width: '600px'
            });
            return;
          }
          let html = '<ul class="list-group">';
          result.items.forEach(item => {
            const fileName = item.name;
            html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                      ${fileName}
                      <button class="btn btn-danger btn-sm" onclick="eliminarArchivo('${fileName}')">
                        <i class="bi bi-trash"></i> Eliminar
                      </button>
                    </li>`;
          });
          html += '</ul>';
          Swal.fire({
            title: 'Archivos Subidos',
            html: html,
            width: '600px'
          });
        }).catch(error => {
          console.error("Error al listar archivos:", error);
          showToast('error', 'Error al listar archivos.');
        });
      }
      
      function eliminarArchivo(fileName) {
        Swal.fire({
          title: '¿Está seguro?',
          text: `Se eliminará el archivo: ${fileName}. Esta acción no se puede deshacer.`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Sí, eliminar',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if(result.isConfirmed) {
            storage.ref('excelFiles/' + fileName).delete().then(() => {
              showToast('success', 'Archivo eliminado exitosamente.');
              if(excelDataGlobal[fileName]) {
                delete excelDataGlobal[fileName];
              }
              listarArchivos();
            }).catch(error => {
              console.error("Error al eliminar archivo:", error);
              showToast('error', 'Error al eliminar archivo.');
            });
          }
        });
      }
      
      // Exponer la función eliminarArchivo para que funcione el onclick
      window.eliminarArchivo = eliminarArchivo;
      
      // Asignar el evento al botón de Gestión de Archivos (solo para admins)
      const btnVerArchivos = document.getElementById('btnVerArchivos');
      if (btnVerArchivos) {
        btnVerArchivos.addEventListener('click', () => {
          listarArchivos();
        });
      }
      
    });
  </script>
</body>
</html>
