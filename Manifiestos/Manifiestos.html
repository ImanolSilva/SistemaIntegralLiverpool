<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manifestar Mercancía - Sistema Liverpool</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"> <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <style>
        :root {
            --rosa-principal: #E6007E;
            --negro-fondo: #1a1a1a;
            --blanco: #ffffff;
            --gris-claro: #f8f9fa;
            --gris-medio: #dee2e6;
            --gris-oscuro: #6c757d;
            --texto-principal: #343a40;
            --verde-exito: #43A047;
            --rojo-peligro: #e53935;
            --ios-border-radius: 12px; /* Mantenido para compatibilidad con el contenido */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #E6007E 0%, var(--negro-fondo) 100%);
            color: var(--texto-principal);
        }

        /* --- Estructura Principal y Menú (Estilo del Panel de Admin) --- */
        .app-header{display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,.2);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);padding:1rem 1.5rem;position:sticky;top:0;z-index:1030;border-bottom:1px solid rgba(255,255,255,.1)}
        .header-title{color:var(--blanco);font-weight:700;margin:0; font-size: 1.5rem;}
        .btn-menu,#logout-btn{background:transparent;border:2px solid var(--blanco);color:var(--blanco);border-radius:50px;width:45px;height:45px;display:inline-flex;justify-content:center;align-items:center;font-size:1.2rem;transition:all .3s ease}.btn-menu:hover,#logout-btn:hover{background:var(--blanco);color:var(--rosa-principal);transform:scale(1.1) rotate(10deg)}
        .offcanvas{background-color:var(--rosa-principal)}
        .offcanvas .nav-link{color:var(--blanco);font-size:1.1rem;font-weight:600;padding:1rem 1.5rem;transition:background-color .3s ease,padding-left .3s ease;border-radius:0 50px 50px 0; display: flex; align-items: center;}
        .offcanvas .nav-link.active,.offcanvas .nav-link:hover{background-color:var(--blanco);color:var(--rosa-principal);padding-left:2rem}
        .offcanvas-header{border-bottom:1px solid rgba(255,255,255,.2)}
        .main-container{max-width:1400px;margin:2rem auto;padding:clamp(1.5rem, 5vw, 2.5rem);background:var(--blanco);border-radius:20px;box-shadow:0 15px 40px rgba(0,0,0,.2);animation:fadeIn .8s ease-out}
        @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        
        /* --- Estilos de Componentes (Adaptados y Mantenidos) --- */
        .main-container h2 { font-weight: 700; color: var(--rosa-principal); display: flex; align-items: center; gap: 0.75rem; }
        .card { border-radius: var(--ios-border-radius); border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .form-control:focus, .form-select:focus { border-color: var(--rosa-principal); box-shadow: 0 0 0 3px rgba(230,0,126,0.2); }

        /* Estilos específicos para la página de manifiestos */
        #dropzone {
            border: 2px dashed var(--rosa-principal);
            border-radius: var(--ios-border-radius);
            background-color: #fafafa;
            padding: 2rem;
            text-align: center;
            color: var(--rosa-principal);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #dropzone:hover { transform: scale(1.02); background-color: #f5f5f5; }
        .progress { height: 30px; border-radius: 30px; }
        
        .table-responsive thead th { background-color: var(--texto-principal); color: var(--blanco); white-space: nowrap; }
        .table td, .table th { vertical-align: middle; }
        /* Estilo para cada elemento de la lista de archivos */
.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e0e0e0;
    border-left: 5px solid #0d6efd; /* Un color azul primario */
    background-color: #ffffff;
    padding: 1rem;
    margin-bottom: 0.75rem;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    transition: all 0.3s ease; /* Transición suave para todas las propiedades */
}

/* Efecto al pasar el mouse sobre un elemento de la lista */
.file-item:hover {
    transform: translateY(-3px); /* Se levanta ligeramente */
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-left-color: #E6007E; /* Cambia al color rosa principal */
}

/* Contenedor del ícono principal para darle un fondo */
.file-item-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f0f3ff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    margin-right: 15px;
}

.file-item-icon .material-icons {
    color: #0d6efd;
    font-size: 20px;
}

/* Estilo para la información del archivo (nombre, tienda, fecha) */
.file-info .file-name {
    font-weight: 600;
    color: #333;
    font-size: 1rem;
}

.file-info .file-meta {
    font-size: 0.8rem;
    color: #6c757d;
    display: flex;
    align-items: center;
    gap: 12px; /* Espacio entre los íconos de tienda y fecha */
    margin-top: 4px;
}

.file-meta .material-icons {
    font-size: 1rem; /* Alinea el tamaño de los íconos con el texto */
}

/* Clase base para los botones de acción con animación */
.action-btn {
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease-in-out;
    border: none;
}

.action-btn:hover {
    transform: scale(1.1); /* Agranda el botón al pasar el mouse */
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
}

/* Estilo para los botones de ordenar la lista */
.sort-btn {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
}

/* Estilo para el botón de ordenamiento activo */
.sort-btn.active {
    background-color: #e7f1ff;
    color: #0d6efd;
    font-weight: 600;
}
/* Contenedor principal del dashboard */
.dashboard-container {
    background-color: #f8f9fa; /* Un fondo gris muy claro */
    border-radius: 12px;
    padding: 24px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Mensaje de estado (Progreso o Completo) */
.status-message {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    margin-bottom: 20px;
    border-radius: 8px;
    font-weight: 600;
}
.status-message.is-warning {
    background-color: #fff3cd;
    color: #664d03;
}
.status-message.is-success {
    background-color: #d1e7dd;
    color: #0f5132;
}
.status-message .material-icons {
    vertical-align: middle;
}

/* Contenedor para las tarjetas de estadísticas */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

/* Estilo para cada tarjeta de estadística */
.stat-card {
    background-color: #ffffff;
    padding: 16px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border-left: 4px solid;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
}
.stat-card .stat-title {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 8px;
}
.stat-card .stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: #212529;
}
/* Colores específicos para el borde de cada tarjeta */
.stat-card.total { border-color: #0d6efd; }
.stat-card.expected { border-color: #6f42c1; }
.stat-card.scanned { border-color: #198754; }
.stat-card.missing { border-color: #dc3545; }
.stat-card.excess { border-color: #ffc107; }


/* Barra de progreso */
.progress-container {
    background-color: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    height: 24px;
    margin-bottom: 24px;
}
.progress-fill {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    transition: width 0.5s ease-in-out;
}

/* Contenedor del gráfico */
.chart-container {
    background-color: #ffffff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    margin-bottom: 20px;
}

/* Detalles de faltantes */
.faltantes-section .toggle-btn {
    width: 100%;
    margin-bottom: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
}
.faltantes-details {
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 16px;
    font-size: 0.9rem;
}
.faltantes-details strong {
    color: #dc3545; /* Rojo para resaltar */
}
.faltantes-details ul {
    list-style: none;
    padding-left: 0;
    margin-top: 8px;
}
.faltantes-details li {
    padding: 8px 0;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 1px solid #f1f1f1;
}
.faltantes-details li:last-child {
    border-bottom: none;
}
.faltantes-details .material-icons {
    color: #6c757d;
}
/* Contenedor principal para el modal de cambio de contenedor */
.change-container-modal {
    padding: 0; /* Quitamos el padding para tener control total */
    text-align: left;
}

/* Encabezado del modal que cambia de color según el estado */
.modal-header-status {
    padding: 16px 24px;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    color: white;
    display: flex;
    align-items: center;
    gap: 12px;
}
.modal-header-status .material-icons {
    font-size: 2.5rem;
}
.modal-header-status h3 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
}

/* Colores de estado para el encabezado */
.modal-header-status.status-neutral { background-color: #2196F3; } /* Azul Info */
.modal-header-status.status-incompleto { background-color: #f44336; } /* Rojo */
.modal-header-status.status-excedente { background-color: #FF9800; } /* Naranja */
.modal-header-status.status-completo { background-color: #4CAF50; } /* Verde */

/* Cuerpo del modal */
.modal-body-content {
    padding: 24px;
}

/* Tarjeta para el resumen del contenedor actual */
.container-summary-card {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 16px;
    margin-top: 16px;
}
.container-summary-card h4 {
    color: #343a40;
    margin-top: 0;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.container-summary-card .summary-content {
    font-size: 0.95rem;
    color: #495057;
}

/* Texto de la pregunta de confirmación */
.confirmation-prompt {
    margin-top: 24px;
    font-size: 1.1rem;
    font-weight: 500;
    text-align: center;
    color: #212529;
}
.confirmation-prompt .material-icons {
    vertical-align: bottom;
    color: #E6007E;
}

/* Estilos personalizados para los botones de SweetAlert */
.swal2-actions {
    gap: 12px; /* Espacio entre botones */
}
.swal2-confirm.btn-confirm-custom,
.swal2-cancel.btn-cancel-custom {
    border-radius: 8px !important;
    padding: 12px 24px !important;
    font-size: 1rem !important;
    font-weight: 600 !important;
    display: inline-flex !important;
    align-items: center;
    gap: 8px;
    transition: transform 0.2s ease;
}
.swal2-confirm.btn-confirm-custom:hover,
.swal2-cancel.btn-cancel-custom:hover {
    transform: scale(1.05);
}

.btn-confirm-custom { background-color: #28a745 !important; }
.btn-cancel-custom { background-color: #6c757d !important; }

/* Alerta simple para cuando no hay contenedor */
.no-container-alert {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}
.no-container-alert .material-icons {
    font-size: 3rem;
    color: #17a2b8;
}
/* Contenedor para el campo de búsqueda principal */
.search-input-container {
    position: relative;
    margin-bottom: 20px;
}
.search-input-container .material-icons {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #999;
    font-size: 24px;
}
#inputBusqueda {
    padding: 15px 20px 15px 50px; /* Espacio para el ícono */
    font-size: 1.2rem;
    border: 2px solid #ddd;
    border-radius: 10px;
    transition: all 0.3s ease;
    width: 100%;
}
#inputBusqueda:focus {
    border-color: #E6007E;
    box-shadow: 0 0 10px rgba(230, 0, 126, 0.2);
}

/* Contenedor de la lista de resultados en el modal */
.results-list-container {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 10px;
    margin-top: 16px;
}

/* Tarjeta individual para cada resultado de búsqueda */
.result-item-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
}
.result-item-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-left: 4px solid #E6007E;
    padding-left: 13px;
}
.result-item-card .item-info .item-title {
    font-weight: 600;
    font-size: 1.1rem;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}
.result-item-card .item-info .item-meta {
    font-size: 0.85rem;
    color: #6c757d;
}

/* Badge para el estado del contenedor */
.status-badge {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 700;
    vertical-align: middle;
}
.status-badge.is-closed {
    background-color: #dc3545;
    color: white;
}

/* Botón de 'Elegir' en la tarjeta */
.result-item-card .btn-choose {
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 600;
}

/* Contenedor para el mensaje de 'No encontrado' */
.not-found-container {
    text-align: center;
    padding: 20px;
}
.not-found-container .material-icons {
    font-size: 4rem;
    color: #6c757d;
    margin-bottom: 10px;
}
.not-found-container h4 {
    color: #333;
    font-weight: 600;
}
.not-found-container p {
    color: #6c757d;
}
/* Contenedor para la nueva alerta de carga personalizada */
.custom-loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

/* El ícono de la lupa que se animará */
.swal-icon-searching {
    font-size: 5rem; /* Hacemos el ícono más grande */
    color: #0d6efd; /* Un color azul primario */
    /* Aplicamos la animación */
    animation: search-animation 1.5s ease-in-out infinite;
}

/* El título principal de la alerta */
.swal-loading-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #333;
    margin-top: 20px;
    margin-bottom: 10px;
}

/* El párrafo donde aparecerán las frases motivacionales */
.swal-loading-phrase {
    font-size: 1rem;
    color: #6c757d;
    height: 30px; /* Altura fija para evitar que la alerta "salte" al cambiar el texto */
    display: flex;
    align-items: center;
}
/* Estilo base para el contenido de nuestros modales de confirmación */
.confirmation-modal-content {
    text-align: left;
    padding: 24px;
}

/* Encabezado que cambia de color según la acción */
/* (Reutilizamos el estilo que ya teníamos) */
.modal-header-status {
    padding: 16px 24px;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    color: white;
    display: flex;
    align-items: center;
    gap: 12px;
}
.modal-header-status .material-icons { font-size: 2.5rem; }
.modal-header-status h3 { margin: 0; font-size: 1.5rem; }

/* Colores de estado para el encabezado */
.modal-header-status.status-close { background-color: #f44336; } /* Rojo */
.modal-header-status.status-reopen { background-color: #4CAF50; } /* Verde */

/* Tarjeta para mostrar el resumen del contenedor */
.summary-card {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 16px;
    margin-top: 16px;
    margin-bottom: 20px;
}

/* Mensaje principal del modal */
.confirmation-modal-content p.main-text {
    font-size: 1.1rem;
    color: #333;
    margin-top: 16px;
}
.confirmation-modal-content .closed-by-user {
    color: var(--rosa-principal); /* Usamos tu variable de color rosa */
    font-weight: 600;
}
/* Estilo para el toast de éxito de escaneo */
.scan-success-toast {
    background-color: #28a745 !important; /* Verde éxito */
    color: white !important;
}
.scan-success-toast .swal2-icon-content {
    color: white !important;
}

/* Estilo para el toast de error o advertencia */
.scan-error-toast {
    background-color: #dc3545 !important; /* Rojo error */
    color: white !important;
}
.scan-error-toast .swal2-icon-content {
    color: white !important;
}
/* Contenedor para hacer la tabla responsiva en móviles */
.table-responsive-wrapper {
    overflow-x: auto;
    border-radius: var(--ios-border-radius, 10px);
    border: 1px solid #dee2e6;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
}
/* ======================================================== */
/* ESTILOS DE TARJETA CON MÁS COLOR (DISEÑO VIBRANTE)      */
/* ======================================================== */

/* Contenedor principal de la lista de tarjetas */
.details-list-container {
    display: flex;
    flex-direction: column;
    gap: 1rem; /* Espacio entre cada tarjeta */
}

/* Estilo para cada tarjeta de artículo */
.item-card {
    background-color: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
    /* El borde izquierdo ahora cambia de color según el estado */
    border-left: 6px solid;
    padding: 1rem 1.5rem;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.item-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
}

/* Colores de borde según el estado de la mercancía */
.item-card.status-ok { border-color: #20c997; } /* Verde para OK */
.item-card.status-missing { border-color: #e53935; } /* Rojo para Faltantes */
.item-card.status-excess { border-color: #ffb22d; } /* Naranja para Excedentes */
.item-card.is-new { border-color: var(--rosa-principal); } /* Rosa para nuevos */


/* Sección principal: SKU y Descripción */
.item-card-main {
    flex-grow: 1;
    min-width: 250px;
}
.item-card-main .sku {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--texto-principal);
}
.item-card-main .descripcion {
    font-size: 0.9rem;
    color: #6c757d;
}

/* Sección de estadísticas: SAP, SCANNER y Diferencia */
.item-card-stats {
    display: flex;
    gap: 1.5rem;
    margin: 0 2rem;
    padding: 0.5rem 0;
}
.stat-item { text-align: center; }
.stat-item .label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
}
.stat-item .value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--texto-principal);
}

/* Estilo para el badge de diferencia */
.diff-badge {
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
    color: white;
}
.diff-badge.is-ok { background-color: #20c997; }
.diff-badge.is-missing { background-color: #e53935; }
.diff-badge.is-excess { background-color: #ffb22d; color: #212529; }

/* Sección para los botones de acción */
.item-card-actions {
    display: flex;
    gap: 0.75rem;
    margin-left: auto;
}

/* Botones de acción ahora con colores por defecto */
.details-list-container .btn-action {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    color: white; /* Texto blanco para todos */
    transition: all 0.2s ease;
}
.details-list-container .btn-action:hover {
    transform: scale(1.15); /* Animación más notoria */
    filter: brightness(1.1);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* Colores específicos para cada botón */
.details-list-container .btn-action.btn-danio { background-color: #ffc107; } /* Amarillo */
.details-list-container .btn-action.btn-foto { background-color: #0dcaf0; } /* Cian/Info */
.details-list-container .btn-action.btn-restar { background-color: #6c757d; } /* Gris */
.details-list-container .btn-action.btn-eliminar { background-color: #dc3545; } /* Rojo */

/* Estilo para artículos nuevos (resaltado) */
.item-card.is-new {
    border-left: 5px solid var(--rosa-principal);
}
/* ======================================================== */
/* ESTILOS MEJORADOS PARA BOTONES                           */
/* ======================================================== */

/* --- Estilo Base para TODOS los botones --- */
.btn {
    /* 1. Alineación perfecta de ícono y texto */
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem; /* Espacio entre el ícono y el texto */

    /* 2. Un toque visual más moderno */
    border-radius: 8px;
    font-weight: 600;
    padding: 0.5rem 1rem; /* Ajuste de padding */
    border-width: 2px;
    
    /* 3. Animación para el efecto hover */
    transition: all 0.2s ease-in-out;
}

/* 4. Efecto al pasar el mouse */
.btn:hover {
    transform: translateY(-2px); /* Eleva ligeramente el botón */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); /* Añade una sombra sutil */
}

/* 5. Aseguramos el tamaño y alineación del ícono SIN style en línea */
.btn .material-icons {
    font-size: 1.25rem; /* Tamaño consistente para los íconos */
    /* No se necesita 'vertical-align' gracias a flexbox */
}

/* --- Ajustes para botones pequeños --- */
.btn-sm {
    padding: 0.35rem 0.8rem;
    gap: 0.4rem;
}

.btn-sm .material-icons {
    font-size: 1.1rem;
}

/* --- Pequeños retoques a los colores primarios y secundarios --- */
.btn-primary {
    /* Un azul un poco más vibrante */
    background-color: #0d6efd; 
    border-color: #0d6efd;
}

.btn-secondary {
    /* Un gris un poco más oscuro para mejor contraste */
    background-color: #6c757d;
    border-color: #6c757d;
}
/* ======================================================== */
/* ESTILO PARA EL PANEL DE RESULTADOS Y BOTONES MODERNOS    */
/* ======================================================== */

.results-header {
    background-color: #f8f9fa;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.header-info .header-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--texto-principal);
    margin: 0 0 0.25rem 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}
.header-info .header-subtitle {
    font-weight: 600;
    color: var(--rosa-principal);
    margin: 0;
}
.header-info .header-meta {
    font-size: 0.85rem;
    color: #6c757d;
    margin: 0.25rem 0 0 0;
}

.header-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.btn-custom {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-weight: 600;
    font-size: 0.9rem;
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.25s ease;
    color: white;
}

.btn-custom:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}
/* ======================================================== */
/* == CSS PARA EL NUEVO DISEÑO DE PANEL Y TARJETAS        == */
/* ======================================================== */

/* --- Panel de Resultados Moderno --- */
.results-header {
    background-color: #f8f9fa;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}
.header-info .header-title {
    font-size: 1.5rem; font-weight: 700; color: var(--texto-principal);
    margin: 0 0 0.25rem 0; display: flex; align-items: center; gap: 0.75rem;
}
.header-info .header-subtitle {
    font-weight: 600; color: var(--rosa-principal); margin: 0;
}
.header-info .header-meta {
    font-size: 0.85rem; color: #6c757d; margin: 0.25rem 0 0 0;
}

/* --- Botones Modernos del Panel --- */
.header-actions {
    display: flex; gap: 0.75rem; flex-wrap: wrap;
}
.btn-custom {
    display: inline-flex; align-items: center; justify-content: center;
    gap: 0.5rem; font-weight: 600; font-size: 0.9rem;
    padding: 0.6rem 1.2rem; border: none; border-radius: 50px;
    cursor: pointer; transition: all 0.25s ease; color: white;
}
.btn-custom:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}
.btn-custom.btn-analisis { background: linear-gradient(45deg, #2193b0, #6dd5ed); }
.btn-custom.btn-descargar { background: linear-gradient(45deg, #1d976c, #93f9b9); }
.btn-custom.btn-cambiar { background-color: #6c757d; }
.btn-custom.btn-cerrar { background: linear-gradient(45deg, #c31432, #240b36); }

/* --- Tarjetas de Artículos (Reemplaza la tabla) --- */
.details-list-container {
    display: flex; flex-direction: column; gap: 1rem;
}
.item-card {
    background-color: #ffffff; border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
    border-left: 6px solid #dee2e6; /* Borde neutral por defecto */
    padding: 1rem 1.5rem;
    display: flex; flex-wrap: wrap; align-items: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.item-card:hover {
    transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
}
.item-card.status-ok { border-color: #20c997; } /* Verde para OK */
.item-card.status-missing { border-color: #e53935; } /* Rojo para Faltantes */
.item-card.status-excess { border-color: #ffb22d; } /* Naranja para Excedentes */
.item-card.is-new { border-color: var(--rosa-principal); } /* Rosa para nuevos */
.item-card-main { flex-grow: 1; min-width: 250px; padding-right: 1rem;}
.item-card-main .sku { font-size: 1.25rem; font-weight: 700; color: var(--texto-principal); }
.item-card-main .descripcion { font-size: 0.9rem; color: #6c757d; }
.item-card-stats { display: flex; gap: 1.5rem; margin: 0.5rem 2rem 0.5rem 0; }
.stat-item { text-align: center; }
.stat-item .label { font-size: 0.75rem; font-weight: 600; color: #6c757d; text-transform: uppercase; }
.stat-item .value { font-size: 1.5rem; font-weight: 700; color: var(--texto-principal); }
.diff-badge {
    padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem;
    font-weight: 700; color: white;
}
.diff-badge.is-ok { background-color: #20c997; }
.diff-badge.is-missing { background-color: #e53935; }
.diff-badge.is-excess { background-color: #ffb22d; color: #212529; }
.item-card-actions { display: flex; gap: 0.75rem; margin-left: auto; }
.details-list-container .btn-action {
    width: 42px; height: 42px; border-radius: 50%; display: inline-flex;
    align-items: center; justify-content: center; border: none;
    color: white; transition: all 0.2s ease;
}
.details-list-container .btn-action:hover {
    transform: scale(1.15); filter: brightness(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.details-list-container .btn-action.btn-danio { background-color: #ffc107; }
.details-list-container .btn-action.btn-foto { background-color: #0dcaf0; }
.details-list-container .btn-action.btn-restar { background-color: #6c757d; }
.details-list-container .btn-action.btn-eliminar { background-color: #dc3545; }
.btn-custom.btn-analisis { background: linear-gradient(45deg, #2193b0, #6dd5ed); }
.btn-custom.btn-descargar { background: linear-gradient(45deg, #1d976c, #93f9b9); }
.btn-custom.btn-cambiar { background-color: #6c757d; }
.btn-custom.btn-cerrar { background: linear-gradient(45deg, #c31432, #240b36); }
/* --- Estilos para los detalles extra en las tarjetas --- */
.item-card-details {
    display: flex;
    flex-wrap: wrap; /* Para que se adapte en móviles */
    gap: 1.5rem;   /* Espacio entre cada detalle */
    flex-basis: 100%; /* Ocupa toda la línea */
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid #f1f1f1; /* Línea separadora sutil */
    font-size: 0.8rem;
    color: #6c757d;
}
.detail-item {
    display: flex;
    align-items: center;
    gap: 0.4rem; /* Espacio entre el ícono y el texto */
}
.detail-item .material-icons {
    font-size: 1.1rem; /* Tamaño de los íconos de detalle */
}
/* ======================================================== */
/* == CSS PARA FORMULARIOS Y ZONA DE CARGA MODERNOS       == */
/* ======================================================== */

/* --- Estilo Base para las Tarjetas de Formularios --- */
.form-card {
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    border: 1px solid #e9ecef;
}
.form-card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #e9ecef;
}
.form-card-header h2 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--texto-principal);
}
.form-card-body {
    padding: 1.5rem;
}
.form-card-body .form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: var(--texto-secundario);
}
.form-card-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 1.5rem;
}

/* --- Separador de columnas adaptable --- */
.border-end-md {
    border-right: 1px solid var(--gris-borde);
}
@media (max-width: 767px) {
    .border-end-md {
        border-right: none;
        border-bottom: 1px solid var(--gris-borde);
        padding-bottom: 1.5rem;
        margin-bottom: 1.5rem;
    }
}


/* --- Inputs y Botones Modernos --- */
.form-control-modern {
    width: 100%;
    padding: 0.8rem 1rem;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid #ced4da;
    background-color: #f8f9fa;
    transition: all 0.2s ease;
}
.form-control-modern:focus {
    background-color: #fff;
    border-color: var(--rosa-principal);
    box-shadow: 0 0 0 3px rgba(230, 0, 126, 0.2);
    outline: none;
}
.btn-main {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
}
.btn-main:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.btn-primary-main {
    background-color: var(--rosa-principal);
    color: white;
}
.btn-secondary-main {
    background-color: #495057;
    color: white;
}

/* --- Zona de Carga de Archivos Rediseñada --- */
#dropzone {
    background-color: #f8f9fa;
    border: 2px dashed #ced4da;
    border-radius: 12px;
    padding: 2rem 1rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}
#dropzone:hover {
    border-color: var(--rosa-principal);
    background-color: #fff;
}
#dropzone .material-icons {
    font-size: 3rem;
    color: var(--rosa-principal);
    transition: transform 0.3s ease;
}
#dropzone:hover .material-icons {
    transform: scale(1.1);
}
#dropzone p { margin: 0.5rem 0 0 0; }
#uploadProgressBar {
    background-color: var(--rosa-principal);
}
/* (Reutilizamos los estilos de los botones que ya creamos) */
/* .swal2-confirm.btn-confirm-custom, .swal2-cancel.btn-cancel-custom */
/* Definición de la animación de la lupa */
@keyframes search-animation {
    0% {
        transform: rotate(-15deg) scale(1);
    }
    50% {
        transform: rotate(15deg) scale(1.1);
    }
    100% {
        transform: rotate(-15deg) scale(1);
    }

    
}
/* ======================================================== */
/* == CSS PARA EL NUEVO DASHBOARD DE MANIFIESTOS         == */
/* ======================================================== */

/* --- Contenedor Principal del Modal --- */
.swal2-popup.dashboard-modal {
    width: 90% !important;
    max-width: 1400px !important;
    padding: 0 !important;
}

.dashboard-container {
    padding: 1.5rem 2rem;
    font-family: 'Poppins', sans-serif;
}

/* --- Cabecera del Dashboard (Título y Controles) --- */
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #dee2e6;
}

.dashboard-header .title {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--texto-principal);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin: 0;
}
.dashboard-header .title .material-icons {
    color: var(--rosa-principal);
}

/* --- Controles de Búsqueda y Filtro --- */
.search-filter-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-grow: 1;
    max-width: 600px;
}

.search-input-wrapper {
    position: relative;
    flex-grow: 1;
}

.search-input-wrapper .material-icons {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #999;
}

#dashboardSearchInput {
    width: 100%;
    padding: 0.6rem 1rem 0.6rem 2.5rem;
    border-radius: 50px;
    border: 1px solid #ced4da;
    transition: all 0.2s ease;
}
#dashboardSearchInput:focus {
    border-color: var(--rosa-principal);
    box-shadow: 0 0 0 3px rgba(230, 0, 126, 0.2);
}

/* --- Contenedor de las Tarjetas de Manifiesto --- */
.manifest-cards-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.5rem;
    padding-top: 1.5rem;
    max-height: 65vh;
    overflow-y: auto;
    padding-right: 10px; /* Para que la barra de scroll no se pegue */
}

/* --- Tarjeta Individual de Manifiesto --- */
.manifest-card {
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    border: 1px solid #e9ecef;
    display: flex;
    flex-direction: column;
    transition: all 0.25s ease;
}
.manifest-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

.manifest-card-header {
    padding: 1rem 1.25rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    border-bottom: 1px solid #f1f1f1;
}

.manifest-card-header .file-info .file-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--texto-principal);
    word-break: break-all;
}
.manifest-card-header .file-info .file-store {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 500;
}

.manifest-card-body {
    padding: 1.25rem;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.manifest-card-detail {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    font-size: 0.9rem;
    color: #495057;
}
.manifest-card-detail .material-icons {
    font-size: 1.1rem;
    color: #888;
}

/* --- Alertas en las tarjetas --- */
.manifest-card-alerts {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.5rem;
}
.alert-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.25rem 0.6rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
}
.alert-tag.is-old {
    background-color: #fff3cd;
    color: #664d03;
}
.alert-tag.has-no-number {
    background-color: #f8d7da;
    color: #58151c;
}

.manifest-card-footer {
    padding: 1rem 1.25rem;
    background-color: #f8f9fa;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
}
.manifest-card-footer .btn .material-icons {
    font-size: 1.1rem;
}
.empty-dashboard {
    text-align: center;
    padding: 4rem 2rem;
    color: #6c757d;
}
.empty-dashboard .material-icons {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.swal2-popup.dashboard-modal {
    width: 90% !important;
    max-width: 1400px !important;
    padding: 0 !important;
}

.dashboard-container {
    padding: 1.5rem 2rem;
    font-family: 'Poppins', sans-serif;
}

/* --- Cabecera del Dashboard (Título y Controles) --- */
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #dee2e6;
}

.dashboard-header .title {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--texto-principal);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin: 0;
}
.dashboard-header .title .material-icons {
    color: var(--rosa-principal);
}

/* --- Controles de Búsqueda y Filtro --- */
.search-filter-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-grow: 1;
    max-width: 600px; /* Limita el ancho en pantallas grandes */
}

.search-input-wrapper {
    position: relative;
    flex-grow: 1;
}

.search-input-wrapper .material-icons {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #999;
}

#dashboardSearchInput {
    width: 100%;
    padding: 0.6rem 1rem 0.6rem 2.5rem;
    border-radius: 50px;
    border: 1px solid #ced4da;
    transition: all 0.2s ease;
}
#dashboardSearchInput:focus {
    border-color: var(--rosa-principal);
    box-shadow: 0 0 0 3px rgba(230, 0, 126, 0.2);
}

/* --- Contenedor de las Tarjetas de Manifiesto --- */
.manifest-cards-container {
    display: grid;
    /* Columnas adaptables: mínimo 320px, se ajustan al espacio */
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.5rem;
    padding-top: 1.5rem;
    max-height: 65vh; /* Altura máxima con scroll */
    overflow-y: auto;
    padding-right: 10px; /* Espacio para la barra de scroll */
}

/* --- Tarjeta Individual de Manifiesto --- */
.manifest-card {
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    border: 1px solid #e9ecef;
    display: flex;
    flex-direction: column;
    transition: all 0.25s ease;
}
.manifest-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

.manifest-card-header {
    padding: 1rem 1.25rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    border-bottom: 1px solid #f1f1f1;
}

.manifest-card-header .file-info .file-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--texto-principal);
    word-break: break-all; /* Para nombres de archivo largos */
}
.manifest-card-header .file-info .file-store {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 500;
}

.manifest-card-body {
    padding: 1.25rem;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 0.75rem; /* Espacio entre los detalles */
}

.manifest-card-detail {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    font-size: 0.9rem;
    color: #495057;
}
.manifest-card-detail .material-icons {
    font-size: 1.1rem;
    color: #888;
}

/* --- Alertas dentro de las tarjetas --- */
.manifest-card-alerts {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.5rem; /* Espacio sobre las alertas */
}
.alert-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.25rem 0.6rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
}
/* Alerta para archivo antiguo */
.alert-tag.is-old {
    background-color: #fff3cd; /* Amarillo advertencia */
    color: #664d03;
}
/* Alerta para archivo sin número de manifiesto */
.alert-tag.has-no-number {
    background-color: #f8d7da; /* Rojo peligro */
    color: #58151c;
}

.manifest-card-footer {
    padding: 1rem 1.25rem;
    background-color: #f8f9fa;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
}
.manifest-card-footer .btn .material-icons {
    font-size: 1.1rem;
}

/* Mensaje para cuando no hay archivos */
.empty-dashboard {
    text-align: center;
    padding: 4rem 2rem;
    color: #6c757d;
}
.empty-dashboard .material-icons {
    font-size: 4rem;
    margin-bottom: 1rem;
}
/* ======================================================== */
/* == CSS PARA EL DASHBOARD DE MANIFIESTOS "PRO" v2      == */
/* ======================================================== */

.swal2-popup.dashboard-modal {
    width: 95% !important;
    max-width: 1500px !important;
}
.swal2-html-container {
    padding: 0 !important;
}

.dashboard-pro-container {
    padding: 1.5rem;
    font-family: 'Poppins', sans-serif;
    text-align: left;
}
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #dee2e6;
}
.dashboard-header .title {
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.search-filter-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
}
#dashboardSearchInput { width: 250px; }
#statusFilter { width: 180px; }

.manifest-cards-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.5rem;
    padding-top: 1.5rem;
    max-height: 65vh;
    overflow-y: auto;
    padding-right: 10px;
}

.manifest-card-pro {
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border: 1px solid #e9ecef;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
}

.manifest-card-pro .card-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #f1f1f1;
    background-color: #fafafa;
}
.manifest-card-pro .file-name { font-weight: 600; word-break: break-all; }
.manifest-card-pro .file-store { font-size: 0.85rem; color: #6c757d; }

.manifest-card-pro .card-body { padding: 1.25rem; }

.progress-preview { margin-bottom: 1.25rem; }
.progress-preview .progress-title {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    font-weight: 600;
    color: #6c757d;
    margin-bottom: 0.25rem;
}
.progress-bar-container {
    width: 100%;
    background-color: #e9ecef;
    border-radius: 50px;
    height: 12px;
    overflow: hidden;
}
.progress-bar-fill {
    height: 100%;
    border-radius: 50px;
    background: linear-gradient(90deg, #1fddff, #0d6efd);
    transition: width 0.5s ease;
}

.card-stats {
    display: flex;
    justify-content: space-around;
    text-align: center;
    padding: 1rem 0;
    border-top: 1px solid #f1f1f1;
    margin-top: 1rem;
}
.card-stats .stat-value { font-size: 1.25rem; font-weight: 700; }
.card-stats .stat-label { font-size: 0.7rem; color: #6c757d; text-transform: uppercase; }
.card-stats .is-missing { color: #dc3545; }
.card-stats .is-excess { color: #ffc107; }

.card-footer {
    padding: 0.75rem 1.25rem;
    background-color: #f8f9fa;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-top: auto;
}

.status-tag {
    font-size: 0.75rem;
    font-weight: 700;
    padding: 0.2rem 0.7rem;
    border-radius: 20px;
    color: #fff;
}
.status-tag.sin-iniciar { background-color: #6c757d; }
.status-tag.en-progreso { background-color: #0d6efd; }
.status-tag.avanzado { background-color: #fd7e14; }
.status-tag.completo { background-color: #198754; }
.status-tag.con-sobrantes { background-color: #6f42c1; }

.badge-destacado {
    position: absolute;
    top: -10px;
    right: 15px;
    background: linear-gradient(45deg, #ffc107, #f7971e);
    color: #fff;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    font-weight: 700;
    font-size: 0.8rem;
    transform: rotate(10deg);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.archivable-notice {
    padding: 0.5rem;
    background-color: #dc3545;
    color: white;
    text-align: center;
    font-weight: 600;
    font-size: 0.8rem;
}
    </style>
</head>
<body>
    <header class="app-header">
        <button class="btn-menu" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuLateral"><i class="bi bi-list"></i></button>
        <h1 class="header-title">Manifestar Mercancía</h1>
        <button id="logout-btn" class="btn-menu"><i class="bi bi-power"></i></button>
    </header>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="menuLateral">
        <div class="offcanvas-header"><h5 class="offcanvas-title text-white fw-bold"><i class="bi bi-box-seam-fill me-2"></i> Menú</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button></div>
        <div class="offcanvas-body p-0">
            <nav class="nav flex-column">
                <a class="nav-link" href="../index.html"><i class="bi bi-house-door-fill me-3"></i>Inicio</a>
                <a class="nav-link" href="../ChecarPrecios/index.html"><i class="bi bi-tags-fill me-3"></i>Checar Precios</a>
                <a class="nav-link" href="../Rechazos/reportes.html"><i class="bi bi-x-octagon-fill me-3"></i>Rechazos</a>
                <a class="nav-link" href="../Inventarios/Inventarios.html"><i class="bi bi-archive-fill me-3"></i>Inventarios</a>
                <a class="nav-link" href="../Configuraciones/Configuracion.html"><i class="bi bi-sliders me-3"></i>Configuración</a>
                <a class="nav-link active" href="../Manifiestos/Manifiestos.html"><i class="bi bi-file-earmark-check-fill me-3"></i>Manifiestos</a>
                <li class="nav-item" id="admin-nav-link" style="display: none;"><a class="nav-link" href="../Admin/admin.html"><i class="bi bi-gear-fill me-3"></i>Administrar</a></li>
            </nav>
        </div>
    </div>
<main class="container main-container">
    <div id="userInfo"></div>

    <section id="employeeSection" class="container mb-4">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center bg-white border-0">
                <h2 class="h4 mb-0"><i class="material-icons" style="font-size:1.5rem; vertical-align:middle;">badge</i> Ingrese Número de Empleado (8 dígitos)</h2>
                <button id="btnCambiarEmpleado" class="btn btn-outline-primary btn-sm"><i class="material-icons">edit</i> Cambiar</button>
            </div>
            <div class="card-body">
                <input type="text" id="employeeNumberInput" class="form-control" placeholder="Ej: 12345678" maxlength="8">
                <small class="text-muted">Sin este dato el sistema permanecerá bloqueado.</small>
            </div>
        </div>
    </section>

    <div id="restoInterfaz" style="display: none;">

        <section id="uploadAndSearchSection" data-aos="fade-up" class="form-card mb-4">
            <div class="form-card-header">
                <i class="material-icons">manage_search</i>
                <h2>2. Cargar o Buscar Manifiesto</h2>
            </div>
            <div class="form-card-body">
                <div class="row gx-4 gy-4">
                    <div class="col-md-6 border-end-md">
                        <p class="form-label">Cargar un nuevo archivo:</p>
                        <div id="dropzone">
                            <i class="material-icons">cloud_upload</i>
                            <p class="fw-bold">Arrastra un archivo Excel aquí</p>
                            <p class="text-muted small">o haz clic para seleccionarlo.</p>
                            <input type="file" id="fileInput" accept=".xlsx, .xls" class="d-none">
                        </div>
                        <p id="selectedFileName" class="text-center mt-3 mb-0"></p>
                        <div id="uploadProgressContainer" class="mt-2" style="display: none;">
                            <div class="progress" style="height: 10px;"><div id="uploadProgressBar" class="progress-bar" role="progressbar"></div></div>
                        </div>
                        <div class="form-card-actions">
                            <button id="uploadFileBtn" class="btn-main btn-primary-main" disabled><i class="material-icons">file_upload</i><span>Subir Archivo</span></button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <p class="form-label">Buscar un manifiesto existente:</p>
                        <input type="text" id="inputBusqueda" class="form-control-modern text-center mb-3" placeholder="Buscar por Contenedor o SKU...">
                        <div class="d-grid">
                            <button id="btnVerArchivos" class="btn-main btn-secondary-main"><i class="material-icons">folder_open</i><span>Ver Todos los Archivos</span></button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <div id="containerResultsSection" style="display:none;" class="mb-4">
            <div class="card shadow-lg" style="border: none; border-radius: 16px; overflow: hidden;">
                <div class="results-header">
                    <div class="header-info">
                        <h2 class="header-title" id="containerHeader">
                            <i class="material-icons">inventory_2</i>
                            <span>Detalles del Contenedor</span>
                        </h2>
                        <p id="selectedFileToWork" class="header-subtitle"></p>
                        <p id="lastUserUpdate" class="header-meta"></p>
                    </div>
                    <div class="header-actions">
                        <button id="btnAnalisisGlobal" class="btn-custom btn-analisis">
                            <i class="material-icons">analytics</i>
                            <span>Análisis</span>
                        </button>
                        <button id="btnDescargarArchivo" class="btn-custom btn-descargar">
                            <i class="material-icons">download</i>
                            <span>Descargar</span>
                        </button>
                        <button id="btnCambiarContenedor" class="btn-custom btn-cambiar">
                            <i class="material-icons">switch_account</i>
                            <span>Cambiar</span>
                        </button>
                        <button id="btnCerrarContenedor" class="btn-custom btn-cerrar">
                            <i class="material-icons">lock</i>
                            <span>Cerrar</span>
                        </button>
                    </div>
                </div>
                <div id="containerDetails" class="card-body p-3"></div>
            </div>
        </div>

        <div id="scanEntrySection" style="display:none;" class="mb-4">
            <div class="card shadow-sm">
                <div class="card-header text-center bg-white border-0"><h2 class="h4 mb-0"><i class="material-icons" style="vertical-align:middle;">qr_code_scanner</i> Registro de Piezas</h2></div>
                <div class="card-body">
                    <input type="text" id="inputScanCode" class="form-control" placeholder="Escanee o ingrese manualmente el código" disabled>
                    <small class="text-muted d-block mt-1">Se procesará automáticamente al detectar entre 5 y 10 dígitos o, para código europeo, 12 o más.</small>
                </div>
                <div class="card-footer text-end bg-white">
                    <button id="btnRegistrarManual" class="btn btn-primary btn-sm"><i class="material-icons">edit_note</i> Registrar Manual</button>
                </div>
            </div>
        </div>

    </div>
    </main>
    <div class="modal fade" id="modalDanios" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content" style="border-radius: var(--ios-border-radius);"><div class="modal-header border-bottom-0"><h5 class="modal-title" style="color: var(--rosa-principal); font-weight:700;"><i class="material-icons" style="vertical-align:middle;">warning</i> Registrar Condiciones de la Mcia</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label for="danioCantidad" class="form-label fw-bold">¿Cuántas piezas presentan condiciones (daños)?</label><input type="number" class="form-control" id="danioCantidad" min="1" step="1" value="1"></div><div class="mb-3"><label for="danioFoto" class="form-label fw-bold">Foto de la condición</label><input type="file" class="form-control" id="danioFoto" accept="image/*"><small class="text-muted">Suba una foto clara del artículo.</small></div></div><div class="modal-footer border-top-0"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="material-icons">cancel</i> Cancelar</button><button type="button" class="btn btn-primary" id="btnGuardarDanio"><i class="material-icons">check_circle</i> Guardar</button></div></div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script> <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    </body>

  <script>
    (function(){
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelector('.main-container').removeAttribute('aria-hidden');
        AOS.init();

        /***************************************************
         * CONFIGURACIÓN DE FIREBASE
         ***************************************************/
        const firebaseConfig = {
          apiKey: "AIzaSyA_4H46I7TCVLnFjet8fQPZ006latm-mRE",
          authDomain: "loginliverpool.firebaseapp.com",
          projectId: "loginliverpool",
          storageBucket: "loginliverpool.appspot.com",
          messagingSenderId: "704223815941",
          appId: "1:704223815941:web:c871525230fb61caf96f6c",
          measurementId: "G-QFEPQ4TSPY"
        };
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.app().storage("gs://loginliverpool.firebasestorage.app");

        /***************************************************
         * VARIABLES GLOBALES
         ***************************************************/
        const ADMIN_UID = "OaieQ6cGi7TnW0nbxvlk2oyLaER2";
        let currentUser = null;
        let currentUserStore = null;
        let currentUserRole = null;
        let currentContenedor = null;
        let currentContainerRecords = [];
        let excelDataGlobal = {};
        let currentFileName = "";
        let currentEmployeeNumber = "";
        let debounceTimerBusqueda = null;
        let debounceTimerScan = null;
        let allFilesList = null;
        let globalContainerMap = {};
        let currentDanioSKU = null;

        /***************************************************
         * REFERENCIAS DEL DOM
         ***************************************************/
        const logoutBtn = document.getElementById("logout-btn");
        const userInfoEl = document.getElementById("userInfo");
        const employeeNumberInput = document.getElementById("employeeNumberInput");
        const restoInterfaz = document.getElementById("restoInterfaz");
const uploadAndSearchSection = document.getElementById("uploadAndSearchSection");        
const dropzone = document.getElementById("dropzone");
        const fileInput = document.getElementById("fileInput");
        const selectedFileNameEl = document.getElementById("selectedFileName");
        const uploadFileBtn = document.getElementById("uploadFileBtn");
        const uploadProgressContainer = document.getElementById("uploadProgressContainer");
        const uploadProgressBar = document.getElementById("uploadProgressBar");
        const btnVerArchivos = document.getElementById("btnVerArchivos");
        const inputBusqueda = document.getElementById("inputBusqueda");
        const containerResultsSection = document.getElementById("containerResultsSection");
        const containerDetailsEl = document.getElementById("containerDetails");
        const selectedFileToWorkEl = document.getElementById("selectedFileToWork");
        const lastUserUpdateEl = document.getElementById("lastUserUpdate");
        const btnAnalisisGlobal = document.getElementById("btnAnalisisGlobal");
        const downloadSection = document.getElementById("downloadSection");
        const scanEntrySection = document.getElementById("scanEntrySection");
        const inputScanCode = document.getElementById("inputScanCode");
        const btnCerrarContenedor = document.getElementById("btnCerrarContenedor");
        const btnRegistrarManual = document.getElementById("btnRegistrarManual");
        const btnCambiarEmpleado = document.getElementById("btnCambiarEmpleado");
        const btnCambiarContenedor = document.getElementById("btnCambiarContenedor");
        const modalDanios = new bootstrap.Modal(document.getElementById("modalDanios"));
        const danioCantidadInput = document.getElementById("danioCantidad");
        const danioFotoInput = document.getElementById("danioFoto");
        const btnGuardarDanio = document.getElementById("btnGuardarDanio");

        /***************************************************
         * AUTH / LOGOUT
         ***************************************************/
auth.onAuthStateChanged(async (user) => {
    if (!user) { window.location.href = "../Login/login.html"; return; }
    currentUser = user;
    try {
        const docSnap = await db.collection("usuarios").doc(user.uid).get();
        const isAdmin = user.uid === "OaieQ6cGi7TnW0nbxvlk2oyLaER2";

        if (isAdmin || (docSnap.exists && docSnap.data().status === "aprobado")) {
            const data = docSnap.data() || {};
            currentUserStore = isAdmin ? "ALL" : (data.store || "");
            currentUserRole = isAdmin ? "admin" : (data.role || "vendedor");
            
            // ✅ CORRECCIÓN: Ahora usa la nueva variable para todo el panel
            if (["auxiliar", "jefe", "admin"].includes(currentUserRole)) {
                uploadAndSearchSection.style.display = "block";
            } else {
                uploadAndSearchSection.style.display = "none";
            }
            userInfoEl.textContent = `Usuario: ${data.name || 'Admin'} (Tienda: ${currentUserStore}, Rol: ${currentUserRole})`;
        } else {
            Swal.fire({ icon: 'info', title: 'Acceso Denegado', text: 'Tu cuenta no está aprobada. Contacta al administrador.' }).then(() => auth.signOut());
        }
    } catch (error) {
        console.error("Error de autenticación:", error);
        auth.signOut();
    }
});

        logoutBtn.addEventListener("click", () => {
          auth.signOut().then(() => window.location.href = "../Login/login.html")
            .catch(e => console.error(e));
        });

        /***************************************************
         * SECCIÓN: SUBIR ARCHIVO MANIFIESTO + BARRA DE PROGRESO
         ***************************************************/
        // Al hacer clic en la zona de dropzone, abrir selector de archivo
        dropzone.addEventListener('click', () => fileInput.click());

        // Mostrar nombre de archivo seleccionado y habilitar botón
        fileInput.addEventListener('change', () => {
          const file = fileInput.files[0];
          if (!file) return;
          selectedFileNameEl.textContent = file.name;
          uploadFileBtn.disabled = false;
        });

        // Manejar subida con progreso
 // Manejar subida con progreso
uploadFileBtn.addEventListener('click', () => {
    const file = fileInput.files[0];
    if (!file) return;

    uploadFileBtn.disabled = true;
    uploadProgressContainer.style.display = 'block';

    const folder = (currentUserStore === "ALL") ? "ALL" : currentUserStore;
    const storageRef = storage.ref(`Manifiestos/${folder}/${file.name}`);
    const uploadTask = storageRef.put(file);

    uploadTask.on('state_changed',
        snapshot => {
            const percent = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
            uploadProgressBar.style.width = percent + '%';
            uploadProgressBar.textContent = percent + '%';
        },
        error => {
            console.error(error);
            Swal.fire({ icon:'error', title:'Error', text:'Error al subir el archivo.' });
            uploadProgressContainer.style.display = 'none';
            uploadFileBtn.disabled = false;
        },
        async () => {
            // Al finalizar, obtener URL y guardar metadatos
            try {
                // Leemos el archivo que acabamos de subir para extraer el número de manifiesto
                const reader = new FileReader();
                reader.readAsArrayBuffer(file);
                reader.onload = async (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);
                    
                    // Buscamos un número de manifiesto en la primera fila con datos.
                    const numeroManifiesto = (json.length > 0 && json[0].MANIFIESTO) ? String(json[0].MANIFIESTO) : "N/A";

                    // Ahora guardamos los metadatos completos en Firestore
await db.collection('manifiestos')
    .doc(file.name)
    .set({
        fileName: file.name,
        store: folder,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(), // <-- AÑADIR ESTA LÍNEA
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(), // Esta ya la tenías, se queda igual
        lastUser: currentUser.email || currentUser.uid,
        lastUserStore: currentUserStore,
        lastUserRole: currentUserRole,
        numeroManifiesto: numeroManifiesto
    }, { merge: true });
                        
                    Swal.fire({ icon:'success', title:'Archivo subido y procesado', text: file.name });
                };
            } catch (readError) {
                console.error("Error al leer el excel para metadatos:", readError);
                Swal.fire({ icon:'error', title:'Error al procesar', text:'El archivo se subió, pero no se pudieron leer sus datos internos.' });
            }

            // Resetar barra y campos
            uploadProgressContainer.style.display = 'none';
            uploadProgressBar.style.width = '0%';
            uploadProgressBar.textContent = '';
            selectedFileNameEl.textContent = '';
            fileInput.value = ''; // Limpiar el input de archivo
            uploadFileBtn.disabled = true;
        }
    );
});





        /***************************************************
         * DETECCIÓN DE EMPLEADO (8 dígitos)
         ***************************************************/
/**
 * Función "debounce" para evitar que el código se ejecute en cada pulsación de tecla.
 * Espera a que el usuario deje de escribir para ejecutar la validación.
 * @param {Function} func - La función a ejecutar después del retardo.
 * @param {number} delay - El tiempo de espera en milisegundos.
 * @returns {Function}
 */
const debounce = (func, delay = 400) => {
    let timeoutId;
    return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            func.apply(this, args);
        }, delay);
    };
};

// 1. MEJORA: Usamos 'debounce' en el evento 'input' para una experiencia fluida.
//    La validación solo se ejecuta cuando el usuario deja de escribir.
// Asegúrate de que tu bloque de código sea este:

// REEMPLAZA TU BLOQUE `employeeNumberInput.addEventListener` CON ESTA VERSIÓN FINAL:

employeeNumberInput.addEventListener("input", debounce(() => {
    // Obtenemos los elementos JUSTO cuando el usuario escribe.
    const restoInterfaz = document.getElementById("restoInterfaz");
    const inputScanCode = document.getElementById("inputScanCode");
    const val = employeeNumberInput.value.trim();

    // Verificamos que los elementos realmente existan para evitar errores.
    if (!restoInterfaz || !inputScanCode) {
        console.error("Error Crítico: No se encontraron 'restoInterfaz' o 'inputScanCode'.");
        return;
    }

    if (/^\d{8}$/.test(val)) {
        // ✅ LÍNEA CORREGIDA: Aquí es donde guardamos el número de empleado.
        currentEmployeeNumber = val;

        restoInterfaz.style.display = "block";
        inputScanCode.disabled = false;
        inputScanCode.focus();
    } else {
        // Si el campo se borra o es inválido, bloqueamos todo y limpiamos la variable.
        currentEmployeeNumber = ""; // Limpiamos la variable
        restoInterfaz.style.display = "none";
        inputScanCode.disabled = true;
    }
}));

// 2. MEJORA: Se rediseña el popup para cambiar el número, haciéndolo más atractivo.
btnCambiarEmpleado.addEventListener("click", () => {
    Swal.fire({
        title: "Cambiar Empleado",
        input: "text",
        inputLabel: "Ingrese el nuevo número de empleado",
        inputPlaceholder: "Debe contener 8 dígitos...",
        inputAttributes: {
            maxlength: 8,
            autocapitalize: "off",
            autocorrect: "off"
        },
        showCancelButton: true,
        confirmButtonText: 'Confirmar',
        cancelButtonText: 'Cancelar',
        // MEJORA DE DISEÑO: Colores y estilo consistentes con la app.
        confirmButtonColor: '#43A047', // Verde éxito
        cancelButtonColor: '#6c757d',  // Gris oscuro
        customClass: {
            popup: 'animated animate__fadeInDown' // Animación de entrada
        },
        // MEJORA: Validación más robusta y mensaje de error claro.
        preConfirm: (value) => {
            if (!/^\d{8}$/.test(value)) {
                Swal.showValidationMessage("El número debe contener exactamente 8 dígitos numéricos");
                return false; // Evita que se cierre la alerta
            }
            return value;
        }
    }).then(result => {
        if (result.isConfirmed) {
            currentEmployeeNumber = result.value.trim();
            // MEJORA DE DISEÑO: Notificación de éxito con un toast.
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Número actualizado con éxito',
                html: `Ahora se usará: <strong>${currentEmployeeNumber}</strong>`,
                showConfirmButton: false,
                timer: 2500
            });
            // Aseguramos que la interfaz esté visible después del cambio.
            restoInterfaz.style.display = "block";
            inputScanCode.disabled = false;
            inputScanCode.focus();
        }
    });
});
   /***************************************************
   * LISTAR / DESCARGAR / ELIMINAR MANIFIESTOS
   ***************************************************/
   const SUPER_ADMINS = [
    "OaieQ6cGi7TnW0nbxvlk2oyLaER2",
    "doxhVo1D3aYQqqkqgRgfJ4qcKcU2"
  ];

  btnVerArchivos.addEventListener("click", listarArchivos);

// REEMPLAZA TU FUNCIÓN listarArchivos ACTUAL CON ESTA VERSIÓN COMPLETA
async function listarArchivos() {
    Swal.fire({
        title: 'Cargando Centro de Manifiestos...',
        text: 'Analizando el progreso de cada archivo. Esto puede tardar un momento...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });

    try {
        const entries = [];
        if (SUPER_ADMINS.includes(currentUser.uid)) {
            const root = await storage.ref("Manifiestos").listAll();
            for (const prefix of root.prefixes) {
                const lst = await prefix.listAll();
                lst.items.forEach(i => entries.push({ folder: prefix.name, ref: i }));
            }
        } else {
            const lst = await storage.ref(`Manifiestos/${currentUserStore}`).listAll();
            lst.items.forEach(i => entries.push({ folder: currentUserStore, ref: i }));
        }

        if (!entries.length) {
            return Swal.fire("Sin Manifiestos", "No se encontraron archivos para tu tienda.", "info");
        }

        const archivosConDetalles = await Promise.all(
            entries.map(async (entry) => {
                try {
                    const doc = await db.collection("manifiestos").doc(entry.ref.name).get();
                    const metadata = doc.exists ? doc.data() : {};
                    const url = await entry.ref.getDownloadURL();
                    const buf = await (await fetch(url)).arrayBuffer();
                    const wb = XLSX.read(buf, { type: "array" });
                    const datos = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

                    let totalSAP = 0, totalSCAN = 0;
                    datos.forEach(r => {
                        totalSAP += Number(r.SAP) || 0;
                        totalSCAN += Number(r.SCANNER) || 0;
                    });
                    
                    const avance = totalSAP > 0 ? Math.round((totalSCAN / totalSAP) * 100) : (totalSCAN > 0 ? 100 : 0);
                    
                    return {
                        name: entry.ref.name,
                        folder: entry.folder,
                        createdAt: metadata.createdAt ? metadata.createdAt.toDate() : new Date(0),
                        progreso: { totalSAP, totalSCAN, avance },
                    };
                } catch (e) {
                    console.error(`Falló al procesar ${entry.ref.name}:`, e);
                    return null;
                }
            })
        );
        
        const archivosValidos = archivosConDetalles.filter(a => a !== null);
        
        // NUEVO: Identificar los 2 archivos más trabajados (con más scans)
        const topArchivos = [...archivosValidos].sort((a, b) => b.progreso.totalSCAN - a.progreso.totalSCAN).slice(0, 2);
        const topArchivosSet = new Set(topArchivos.map(f => f.name));

        archivosValidos.sort((a, b) => b.createdAt - a.createdAt);

        const dashboardHTML = `
            <div class="dashboard-pro-container">
                <header class="dashboard-header">
                    <h2 class="title"><i class="material-icons">view_quilt</i> Centro de Manifiestos</h2>
                    <div class="search-filter-controls">
                        <input type="text" id="dashboardSearchInput" class="form-control form-control-sm" placeholder="Buscar por nombre...">
                        <select id="statusFilter" class="form-select form-select-sm">
                            <option value="Todos">Todos los estados</option>
                            <option value="Sin Iniciar">Sin Iniciar</option>
                            <option value="En Progreso">En Progreso</option>
                            <option value="Avanzado">Avanzado</option>
                            <option value="Completo">Completo</option>
                             <option value="Accion Requerida">Acción Requerida</option>
                        </select>
                    </div>
                </header>
                <div id="manifestCardsContainer" class="manifest-cards-container"></div>
            </div>`;

        await Swal.fire({
            html: dashboardHTML,
            width: '95%',
            customClass: { popup: 'dashboard-modal' },
            showConfirmButton: false,
            showCloseButton: true,
            didOpen: () => {
                const searchInput = document.getElementById('dashboardSearchInput');
                const statusFilter = document.getElementById('statusFilter');

                const renderizar = () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    const statusFiltro = statusFilter.value;
                    const fiveDaysInMillis = 5 * 24 * 60 * 60 * 1000;

                    const archivosFiltrados = archivosValidos.filter(file => {
                        const isOld = (new Date() - file.createdAt) > fiveDaysInMillis;
                        const searchMatch = file.name.toLowerCase().includes(searchTerm);
                        
                        let estadoArchivo = "Sin Iniciar";
                        if (file.progreso.avance >= 100) estadoArchivo = (file.progreso.totalSCAN > file.progreso.totalSAP) ? "Con Sobrantes" : "Completo";
                        else if (file.progreso.avance >= 50) estadoArchivo = "Avanzado";
                        else if (file.progreso.avance > 0) estadoArchivo = "En Progreso";

                        let statusMatch = true;
                        if (statusFiltro === 'Accion Requerida') statusMatch = isOld;
                        else if (statusFiltro !== 'Todos') statusMatch = estadoArchivo === statusFiltro;
                        
                        return searchMatch && statusMatch;
                    });
                    
                    const container = document.getElementById('manifestCardsContainer');
                    if (archivosFiltrados.length === 0) {
                        container.innerHTML = `<div class="text-center p-5 text-muted w-100"><h4><i class="material-icons">search_off</i> Sin resultados</h4>No se encontraron manifiestos que coincidan con tu búsqueda.</div>`;
                    } else {
                        container.innerHTML = archivosFiltrados.map(file => renderItems(file, topArchivosSet.has(file.name))).join('');
                    }
                };
                
                searchInput.addEventListener('keyup', renderizar);
                statusFilter.addEventListener('change', renderizar);
                renderizar();
            }
        });

    } catch (err) {
        console.error("Error al listar archivos:", err);
        Swal.fire("Error Inesperado", "No se pudo listar los archivos.", "error");
    }
}

// Función para renderizar CADA TARJETA (reemplaza tu `renderItems` anterior)
function renderItems(file, isDestacado) {
    const p = file.progreso;
    const fechaSubida = formatFecha(file.createdAt);
    const diasDesdeSubida = Math.floor((new Date() - file.createdAt) / (1000 * 60 * 60 * 24));
    
    // Lógica para determinar el estado por avance
    let estadoInfo = { texto: 'Sin Iniciar', clase: 'sin-iniciar' };
    if (p.avance >= 100) {
        estadoInfo = (p.totalSCAN > p.totalSAP) 
            ? { texto: 'Con Sobrantes', clase: 'con-sobrantes' }
            : { texto: 'Completo', clase: 'completo' };
    } else if (p.avance >= 50) {
        estadoInfo = { texto: 'Avanzado', clase: 'avanzado' };
    } else if (p.avance > 0) {
        estadoInfo = { texto: 'En Progreso', clase: 'en-progreso' };
    }

// --- BLOQUE CORRECTO ---
const isOld = diasDesdeSubida > 5;

// 1. Definimos los botones que estarán SIEMPRE presentes.
let actionButtons = `
    <button class="btn btn-sm btn-warning" onclick="downloadFile('${file.folder}','${file.name}')" title="Descargar reporte en Excel">
        <i class="material-icons">assessment</i> Generar Reporte
    </button>
    <button class="btn btn-sm btn-primary" onclick="verDashboardArchivo('${file.folder}','${file.name}')" title="Ver análisis detallado">
        <i class="material-icons">query_stats</i> Analizar
    </button>
`;

// 2. AÑADIMOS el botón de archivar solo si el archivo es antiguo.
if (isOld) {
    actionButtons += `
        <button class="btn btn-sm btn-danger" onclick="archivarManifiesto('${file.name}', '${file.folder}')" title="Archivar este manifiesto">
            <i class="material-icons">archive</i> Archivar
        </button>`;
}
    
    let statusClass = `status-${estadoInfo.clase}`;
    if (isOld) statusClass = 'is-archivable';

    return `
        <div class="manifest-card-pro ${statusClass}">
            ${isDestacado ? `<div class="badge-destacado"><i class="bi bi-fire"></i> Destacado</div>` : ''}
            ${isOld ? `<div class="archivable-notice">REQUIERE ACCIÓN (Subido hace ${diasDesdeSubida} días)</div>` : ''}
            <div class="card-header">
                <div class="file-name">${file.name}</div>
                <div class="file-store">Tienda: <strong>${file.folder}</strong> | Subido: ${fechaSubida}</div>
            </div>
            <div class="card-body">
                <div class="progress-preview">
                    <div class="progress-title">
                        <span>Progreso de Escaneo</span>
                        <span>${p.avance}%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: ${p.avance}%;"></div>
                    </div>
                </div>
                <div class="card-stats">
                    <div>
                        <div class="stat-value">${p.totalSCAN.toLocaleString()} / ${p.totalSAP.toLocaleString()}</div>
                        <div class="stat-label">Escaneado vs. SAP</div>
                    </div>
                    <div>
                        <span class="status-tag ${estadoInfo.clase}">${estadoInfo.texto}</span>
                        <div class="stat-label">Estado</div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                ${actionButtons}
            </div>
        </div>`;
}
/**
 * ✨ NUEVA FUNCIÓN DE ACCIÓN ✨
 * Mueve un manifiesto a la carpeta de archivados en Storage y borra su registro.
 */
window.archivarManifiesto = async (fileName, folder) => {
    const { isConfirmed } = await Swal.fire({
        title: '¿Archivar Manifiesto?',
        html: `Esto moverá <strong>${fileName}</strong> a una carpeta de archivados y lo quitará de esta vista. Esta acción es difícil de revertir. ¿Continuar?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, Archivar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#dc3545'
    });

    if (isConfirmed) {
        Swal.fire({
            title: 'Archivando...',
            text: 'Por favor espera.',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });
        
        try {
            const originalRef = storage.ref(`Manifiestos/${folder}/${fileName}`);
            const archivedRef = storage.ref(`Archivados/${folder}/${fileName}`);
            const url = await originalRef.getDownloadURL();
            const blob = await (await fetch(url)).blob();
            
            await archivedRef.put(blob);
            await originalRef.delete();
            await db.collection('manifiestos').doc(fileName).delete();

            await Swal.fire('¡Archivado!', 'El manifiesto ha sido archivado con éxito.', 'success');
            
            listarArchivos(); // Recargar el dashboard

        } catch (error) {
            console.error("Error al archivar:", error);
            Swal.fire('Error', 'No se pudo completar el archivado del manifiesto.', 'error');
        }
    }
};
/**
 * ✨ NUEVO DASHBOARD DE ANÁLISIS "PRO" ✨
 * Muestra un dashboard avanzado con más detalles, insights y un mejor diseño.
 */
window.verDashboardArchivo = async (folder, fileName) => {
    try {
        // --- 1. Carga y Procesamiento de Datos (Lógica mantenida y mejorada) ---
        if (!excelDataGlobal[fileName]) {
            const url = await storage.ref(`Manifiestos/${folder}/${fileName}`).getDownloadURL();
            const buf = await (await fetch(url)).arrayBuffer();
            const wb = XLSX.read(buf, { type: "array" });
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            excelDataGlobal[fileName] = { data };
        }

        const datos = excelDataGlobal[fileName].data;

        // Función de cálculo mejorada para devolver también los top 5 de diferencias
        const calculateProStatistics = (data) => {
            let tSAP = 0, tSCAN = 0, falt = 0, exc = 0;
            const contF = {}, contE = {}, secF = {}, secE = {};

            data.forEach(r => {
                const sap = Number(r.SAP) || 0;
                const sc = Number(r.SCANNER) || 0;
                const cont = (r.CONTENEDOR || 'SIN NOMBRE').toUpperCase().trim();
                const sec = (r.SECCION || 'Sin sección').toString().trim();
                
                tSAP += sap;
                tSCAN += sc;

                if (sc < sap) {
                    const diff = sap - sc;
                    falt += diff;
                    contF[cont] = (contF[cont] || 0) + diff;
                    secF[sec] = (secF[sec] || 0) + diff;
                } else if (sc > sap) {
                    const diff = sc - sap;
                    exc += diff;
                    contE[cont] = (contE[cont] || 0) + diff;
                    secE[sec] = (secE[sec] || 0) + diff;
                }
            });
            
            const av = tSAP ? Math.round((tSCAN / tSAP) * 100) : 0;
            
            // Función auxiliar para obtener el top 5
            const getTopItems = (obj) => Object.entries(obj)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5);

            return {
                totalSAP: tSAP, totalSCAN: tSCAN, faltantes: falt, excedentes: exc, avance: av,
                totalSKUs: data.length,
                topContenedoresFaltantes: getTopItems(contF),
                topSeccionesFaltantes: getTopItems(secF),
                topContenedoresExcedentes: getTopItems(contE),
                topSeccionesExcedentes: getTopItems(secE),
            };
        };
        
        const stats = calculateProStatistics(datos);

        // --- 2. Generación del HTML con el nuevo diseño ---

        // Helper para crear tarjetas de estadísticas
        const createProStatCard = (title, value, icon, className) => `
            <div class="stat-card ${className}">
                <div class="stat-icon"><i class="material-icons">${icon}</i></div>
                <div class="stat-info">
                    <div class="stat-value">${value.toLocaleString('es-MX')}</div>
                    <div class="stat-title">${title}</div>
                </div>
            </div>`;

        // Helper para crear el panel de "Insights Clave"
        const createKeyInsightsPanel = (stats) => {
            const createListItems = (items, type) => {
                if (items.length === 0) return '<li>No hay datos.</li>';
                const badgeClass = type === 'missing' ? 'is-missing' : 'is-excess';
                return items.map(([name, quantity]) => `
                    <li>
                        <i class="material-icons">${name.startsWith('SIN') ? 'help_outline' : 'inventory_2'}</i>
                        <span class="item-name">${name}</span>
                        <span class="quantity-badge ${badgeClass}">${quantity.toLocaleString('es-MX')} pz.</span>
                    </li>`).join('');
            };

            return `
                <div class="key-insights-panel">
                    <h4><i class="material-icons">lightbulb</i> Insights Clave</h4>
                    <h6>Top 5 Contenedores con Faltantes</h6>
                    <ul class="insight-list">${createListItems(stats.topContenedoresFaltantes, 'missing')}</ul>
                    <hr>
                    <h6>Top 5 Contenedores con Excedentes</h6>
                    <ul class="insight-list">${createListItems(stats.topContenedoresExcedentes, 'excess')}</ul>
                </div>`;
        };
        
        const isComplete = stats.avance >= 100;
        const statusClass = isComplete ? 'is-success' : 'is-warning';
        const statusMessage = isComplete
            ? `<i class="material-icons">celebration</i> ¡Manifiesto completo! Excelente trabajo 🎉`
            : `<i class="material-icons">warning</i> Aún falta un ${100 - stats.avance}% por completar. ¡Ánimo!`;

        const canvasId = `grafico_pro_${fileName.replace(/[^a-zA-Z0-9]/g, '_')}`;
        const dashboardHTML = `
          <div class="analisis-dashboard-pro">
            <div class="status-message ${statusClass}">${statusMessage}</div>
            
            <div class="stats-grid">
              ${createProStatCard('SKUs Totales', stats.totalSKUs, 'apps', 'total')}
              ${createProStatCard('Piezas Esperadas (SAP)', stats.totalSAP, 'inventory', 'expected')}
              ${createProStatCard('Piezas Escaneadas', stats.totalSCAN, 'task_alt', 'scanned')}
              ${createProStatCard('Piezas Faltantes', stats.faltantes, 'error', 'missing')}
              ${createProStatCard('Piezas Excedentes', stats.excedentes, 'add_shopping_cart', 'excess')}
            </div>

            <div class="progress-container">
              <div class="progress-fill ${isComplete ? 'bg-success' : 'bg-primary'}" style="width:${stats.avance}%;">${stats.avance}%</div>
            </div>

            <div class="dashboard-main-layout">
                <div class="chart-container">
                    <canvas id="${canvasId}"></canvas>
                </div>
                ${createKeyInsightsPanel(stats)}
            </div>
          </div>`;

        // --- 3. Renderizado del Modal de SweetAlert ---
        await Swal.fire({
            title: `<span style="display: flex; align-items: center; gap: 8px;">
                        <i class="material-icons text-primary">analytics</i> Análisis PRO: ${fileName}
                    </span>`,
            html: dashboardHTML,
            width: '90%',
            padding: '0',
            showCloseButton: true,
            showConfirmButton: false,
            didOpen: () => {
                const ctx = document.getElementById(canvasId).getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Correcto', 'Faltante', 'Excedente'],
                        datasets: [{
                            data: [stats.totalSCAN - stats.excedentes, stats.faltantes, stats.excedentes],
                            backgroundColor: ['#198754', '#dc3545', '#ffc107'],
                            borderColor: '#f8f9fa',
                            borderWidth: 4,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true, pointStyle: 'rectRounded' } },
                            tooltip: { callbacks: { label: c => ` ${c.label}: ${c.raw.toLocaleString('es-MX')} piezas` } }
                        }
                    }
                });
            }
        });

    } catch (e) {
        console.error("Error al generar dashboard PRO:", e);
        Swal.fire({ icon: 'error', title: 'Error Inesperado', text: 'No se pudo generar el dashboard del archivo.' });
    }
};
  // Descargar un manifiesto (con columna DIFERENCIA)
  window.downloadFile = async (folder, name) => {
    try {
      // 1) Cargar o reutilizar datos en memoria
      if (!excelDataGlobal[name]) {
        const url = await storage.ref(`Manifiestos/${folder}/${name}`).getDownloadURL();
        const buf = await (await fetch(url)).arrayBuffer();
        const wb = XLSX.read(buf, { type: "array", cellDates: true });
        const js = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        excelDataGlobal[name] = { data: js };
      }
      const data = excelDataGlobal[name].data;

      // 2) Preparar exportación
      const exportData = data.map(r => {
        const sap = Number(r.SAP) || 0;
        const sc = Number(r.SCANNER) || 0;
        let diff = "";
        if (sc === sap) diff = "OK";
        else if (sc < sap) diff = `FALTAN ${sap - sc} piezas`;
        else diff = `+${sc - sap} piezas`;

        return {
          FECHA: formatFecha(new Date(r.FECHA)),
          SECCION: r.SECCION || "",
          MANIFIESTO: r.MANIFIESTO || "",
          CONTENEDOR: r.CONTENEDOR || "",
          SKU: r.SKU || "",
          EUROPEO: r.EUROPEO || "",
          DESCRIPCION: r.DESCRIPCION || "",
          SAP: sap,
          SCANNER: sc,
          LAST_SCANNED_BY: r.LAST_SCANNED_BY || "",
          ENTREGADO_A: r.ENTREGADO_A || "",
          DIFERENCIA: diff,
          FechaEscaneo: formatFecha(new Date(r.FECHA_ESCANEO)),
          CONDICIONES_MCIA: r.DANIO_CANTIDAD || 0,
          FOTO_CONDICIONES: r.DANIO_FOTO_URL || ""
        };
      });

      // 3) Generar y descargar XLSX
      const ws = XLSX.utils.json_to_sheet(exportData, {
        header: [
          "FECHA","SECCION","MANIFIESTO","CONTENEDOR","SKU","EUROPEO",
          "DESCRIPCION","SAP","SCANNER","LAST_SCANNED_BY","ENTREGADO_A",
          "DIFERENCIA","FechaEscaneo","CONDICIONES_MCIA","FOTO_CONDICIONES"
        ]
      });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
      const out = XLSX.write(wb, { bookType: "xlsx", type: "array" });
      const blob = new Blob([out], { type: "application/octet-stream" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);

      Swal.fire({
        icon: "success",
        title: "Descargado",
        toast: true,
        position: "center",
        timer: 1200
      });

    } catch (e) {
      console.error(e);
      Swal.fire({ icon: "error", title: "Error", text: "No se pudo descargar." });
    }
  };

  // Eliminar un manifiesto
  window.eliminarArchivo = async (folder, name) => {
    const { isConfirmed } = await Swal.fire({
      title: "Eliminar manifiesto",
      html: `¿Eliminar <strong>${name}</strong>?`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Sí, eliminar",
      cancelButtonText: "Cancelar"
    });
    if (!isConfirmed) return;

    try {
      await storage.ref(`Manifiestos/${folder}/${name}`).delete();
      await db.collection("manifiestos").doc(name).delete().catch(()=>{});
      delete excelDataGlobal[name];
      Swal.fire({
        icon: "success",
        title: "Eliminado",
        toast: true,
        position: "center",
        timer: 1200
      });
      listarArchivos();
    } catch {
      Swal.fire({ icon: "error", title: "Error", text: "No se pudo eliminar." });
    }
  };

  // Helper: formatea Date a dd/mm/yyyy
  function formatFecha(d) {
    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }
btnCambiarContenedor.addEventListener("click", () => {
    // --- ¡MEJORA! ---
    // Alerta mejorada para cuando no hay un contenedor activo.
    if (!currentContenedor) {
        Swal.fire({
            title: "No hay Contenedor Activo",
            html: `<div class="no-container-alert">
                     <i class="material-icons">info_outline</i>
                     <div>Para cambiar de contenedor, primero debes abrir uno.</div>
                   </div>`,
            icon: 'info',
            confirmButtonText: "Entendido"
        });
        return;
    }

    const summaryHTML = getContainerSummaryDetailed(currentContainerRecords);
    const containerStatus = getContainerStateFromRecords(currentContainerRecords);

    // --- ¡MEJORA! ---
    // Mapeamos el estado a una clase de CSS y un título para el modal.
    let statusInfo = { className: 'status-neutral', title: 'Cambio de Contenedor' };
    if (containerStatus === "INCOMPLETO") {
        statusInfo = { className: 'status-incompleto', title: 'Contenedor Incompleto' };
    } else if (containerStatus === "COMPLETO CON MERCANCÍA DE MÁS") {
        statusInfo = { className: 'status-excedente', title: 'Contenedor con Excedente' };
    } else if (containerStatus === "COMPLETO") {
        statusInfo = { className: 'status-completo', title: 'Contenedor Completo' };
    }

    // --- ¡MEJORA! ---
    // Modal de confirmación completamente rediseñado con clases CSS.
    Swal.fire({
        html: `
            <div class="change-container-modal">
                <div class="modal-header-status ${statusInfo.className}">
                    <i class="material-icons">switch_account</i>
                    <h3>${statusInfo.title}</h3>
                </div>
                <div class="modal-body-content">
                    <div class="container-summary-card">
                        <h4>
                            <i class="material-icons">inventory_2</i>
                            Resumen de: <strong>${currentContenedor}</strong>
                        </h4>
                        <div class="summary-content">
                            ${summaryHTML}
                        </div>
                    </div>
                    <p class="confirmation-prompt">
                        <i class="material-icons">help_outline</i>
                        ¿Estás seguro de que deseas cerrar y cambiar de contenedor?
                    </p>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Sí, cambiar',
        cancelButtonText: 'Cancelar',
        width: "600px",
        padding: 0, // Importante para que nuestro diseño se ajuste bien
        showLoaderOnConfirm: true,
        customClass: {
            confirmButton: 'btn-confirm-custom',
            cancelButton: 'btn-cancel-custom'
        }
    }).then(async (result) => {
        if (!result.isConfirmed) return;

        // La lógica de guardado y reseteo se mantiene igual. ¡Ya estaba perfecta!
        try {
            await reuploadFileWithScannerChanges(currentFileName);
        } catch (e) {
            console.error("Error al guardar cambios antes de cambiar contenedor:", e);
            // Podríamos mostrar un error aquí si falla el guardado
        }

        currentContenedor = null;
        currentContainerRecords = [];
        selectedFileToWorkEl.textContent = "";

        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'success',
            title: '¡Listo! Contenedor cerrado.',
            timer: 1500,
            showConfirmButton: false
        }).then(() => {
    // 1. Ocultamos las secciones que ya no son necesarias (la de resultados y la de escaneo)
    containerResultsSection.style.display = 'none';
    scanEntrySection.style.display = 'none';
    
    // 2. Mostramos la sección principal de carga y búsqueda
    uploadAndSearchSection.style.display = 'block';

    // 3. Colocamos el foco en el campo de búsqueda para una mejor experiencia de usuario
    inputBusqueda.value = ''; // Limpiamos el campo por si acaso
    inputBusqueda.focus();
});
    });
});

/****************************************************************************
 * INICIO DE LA SECCIÓN DE BÚSQUEDA MEJORADA
 ****************************************************************************/

// =========================================================================
// PASO 1: Declarar variables en un ámbito superior
// =========================================================================
let containersMapGlobal = {};
let skuContainerMapGlobal = {}; // Esta la usaremos después

// --- ¡NUEVO! ---
// Array con las frases que irán cambiando
const motivationalPhrases = [
    "Analizando los datos...",
    "Buscando coincidencias...",
    "La eficiencia es clave. ¡Ya casi!",
    "Revisando cada rincón digital...",
    "El éxito es la suma de pequeños esfuerzos.",
    "Un momento, estamos en ello...",
    "Preparando la información para ti...",
    "Tu próxima gran jugada está a un segundo."
];
// Variable para guardar el ID del intervalo y poder limpiarlo después
let loadingIntervalId = null;
// =========================================================================
// PASO 2: Definir funciones de ayuda
// =========================================================================

// Función para mostrar una alerta de "No encontrado" más visual.
function showNotFoundAlert(type) {
    Swal.fire({
        html: `<div class="not-found-container">
                 <i class="material-icons">search_off</i>
                 <h4>No se encontraron resultados</h4>
                 <p>No pudimos encontrar el ${type} que buscas. Por favor, verifica el código y vuelve a intentarlo.</p>
               </div>`,
        showConfirmButton: false,
        timer: 3000
    });
}

// Función que crea el HTML para cada tarjeta de resultado.
function createContainerResultCard(containerName, file, isClosed, onclickAction) {
    return `
    <div class="result-item-card">
        <div class="item-info">
            <div class="item-title">
                <i class="material-icons text-primary">inventory_2</i>
                ${containerName}
                ${isClosed ? `<span class="status-badge is-closed">CERRADO</span>` : ''}
            </div>
            <div class="item-meta">
                <strong>Archivo:</strong> ${file}
            </div>
        </div>
        <button class="btn btn-primary btn-sm btn-choose" onclick="${onclickAction}">
            <i class="material-icons">touch_app</i> Elegir
        </button>
    </div>`;
}
/**
 * BUSCADOR DE CONTENEDORES (MEJORADO CON MÁS DETALLES)
 * Encuentra todas las coincidencias y permite elegir, mostrando un resumen.
 */
async function buscarContenedor(ref) {
    const searchTerm = ref.trim().toUpperCase();
    if (!searchTerm) return;

    let candidates = await checkFileForReference(null, searchTerm, true);
    if (!candidates || candidates.length === 0) return showNotFoundAlert("contenedor");

    const foundChoices = [];
    const uniqueCheck = new Set();
    
    candidates.forEach(candidate => {
        const fileName = candidate.fileName;
        const uniqueContainersInFile = new Set(candidate.matchedRecords.map(r => String(r.CONTENEDOR || "").trim().toUpperCase()));
        
        uniqueContainersInFile.forEach(containerName => {
            if (containerName.includes(searchTerm)) {
                const choiceKey = `${containerName}|${fileName}`;
                if (!uniqueCheck.has(choiceKey)) {
                    // Calculamos un resumen para este contenedor específico
                    const recordsForThisContainer = excelDataGlobal[fileName].data.filter(rec => String(rec.CONTENEDOR || "").trim().toUpperCase() === containerName);
                    const totalSKUs = recordsForThisContainer.length;
                    const totalSAP = recordsForThisContainer.reduce((sum, rec) => sum + (Number(rec.SAP) || 0), 0);

                    foundChoices.push({
                        containerName,
                        fileName,
                        totalSKUs,
                        totalSAP
                    });
                    uniqueCheck.add(choiceKey);
                }
            }
        });
    });

    if (foundChoices.length === 0) return showNotFoundAlert("contenedor");

    if (foundChoices.length === 1) {
        Swal.close();
        const choice = foundChoices[0];
        realOpenFileManifiesto(choice.fileName, choice.containerName);
        return;
    }

    const choiceHTML = foundChoices.map(choice => {
        const isClosedData = excelDataGlobal[choice.fileName]?.closedContainers?.[choice.containerName];
        let statusHTML = '';
        if (isClosedData) {
            statusHTML = `<span class="status-badge is-closed" title="Cerrado por ${isClosedData}">CERRADO</span>`;
        }

        return `
            <div class="result-item-card">
                <div class="item-info">
                    <div class="item-title">
                        <i class="material-icons text-primary">inventory_2</i>
                        ${choice.containerName} ${statusHTML}
                    </div>
                    <div class="item-meta">
                        <span><strong>Archivo:</strong> ${choice.fileName}</span><br>
                        <span><strong>SKUs:</strong> ${choice.totalSKUs} | <strong>Piezas SAP:</strong> ${choice.totalSAP}</span>
                    </div>
                </div>
                <button class="btn btn-primary btn-sm btn-choose" onclick="window.openContainerFromFile('${choice.containerName}', '${choice.fileName}')">
                    <i class="material-icons">touch_app</i> Elegir
                </button>
            </div>`;
    }).join('');

    Swal.fire({
        title: "Múltiples Coincidencias de Contenedor",
        html: `<p>Se encontró "<strong>${searchTerm}</strong>" en varios lugares. Elige el correcto:</p><div class="results-list-container">${choiceHTML}</div>`,
        showConfirmButton: false,
        width: "700px",
    });
}

/**
 * BUSCADOR DE SKU (CORREGIDO)
 * Encuentra todas las ubicaciones de un SKU y permite elegir.
 */
async function buscarSKUenArchivos(sku) {
    let candidates = await checkFileForReference(null, sku, false);
    if (!candidates || candidates.length === 0) return showNotFoundAlert("SKU");

    const foundChoices = [];
    const uniqueCheck = new Set();
    candidates.forEach(candidate => {
        const fileName = candidate.fileName;
        candidate.matchedRecords.forEach(record => {
            const containerName = String(record.CONTENEDOR || "").trim().toUpperCase();
            if (!containerName) return;
            const choiceKey = `${containerName}|${fileName}`;
            if (!uniqueCheck.has(choiceKey)) {
                foundChoices.push({ containerName, fileName, record });
                uniqueCheck.add(choiceKey);
            }
        });
    });

    if (foundChoices.length === 0) return showNotFoundAlert("SKU en algún contenedor");
    
    if (foundChoices.length === 1) {
        Swal.close();
        const choice = foundChoices[0];
        realOpenFileManifiesto(choice.fileName, choice.containerName);
        return;
    }

    const choiceHTML = foundChoices.map(choice => {
        const sap = choice.record.SAP || 0;
        const desc = choice.record.DESCRIPCION || '(sin descripción)';
        const isClosed = excelDataGlobal[choice.fileName]?.closedContainers?.[choice.containerName];
        return `
            <div class="result-item-card">
                <div class="item-info">
                    <div class="item-title">
                        <i class="material-icons text-primary">inventory_2</i> ${choice.containerName}
                        ${isClosed ? `<span class="status-badge is-closed">CERRADO</span>` : ''}
                    </div>
                    <div class="item-meta">
                        <span><strong>Archivo:</strong> ${choice.fileName}</span><br>
                        <span><strong>Descripción:</strong> ${desc} | <strong>SAP:</strong> ${sap} pz.</span>
                    </div>
                </div>
                <button class="btn btn-primary btn-sm btn-choose" onclick="window.openContainerFromFile('${choice.containerName}', '${choice.fileName}')">
                    <i class="material-icons">touch_app</i> Elegir
                </button>
            </div>`;
    }).join('');

    Swal.fire({
        title: "SKU en Múltiples Ubicaciones",
        html: `<p>Se encontró el SKU <strong>${sku}</strong> en varios lugares. Elige el correcto:</p><div class="results-list-container">${choiceHTML}</div>`,
        showConfirmButton: false, width: "700px",
    });
}

/**
 * Función auxiliar para abrir el manifiesto desde los botones de elección.
 */
window.openContainerFromFile = (containerName, fileName) => {
    Swal.close();
    realOpenFileManifiesto(fileName, containerName);
};

// =========================================================================
// PASO 4: Función llamada por los nuevos botones 'Elegir'
// =========================================================================
// Esta función reemplaza a tu antiguo `selectContainer`
window.selectContainerV2 = function(cont) {
    const info = window.containersMapGlobal[cont];
    if (info) {
        Swal.close();
        openContainerDirect({
            fileName: info.fileName,
            matchedRecords: info.records
        }, 0);
    }
};

// =========================================================================
// PASO 5: Reemplazar los `addEventListener` con el manejador unificado
// =========================================================================
// =========================================================================
// MANEJADOR DE BÚSQUEDA (VERSIÓN CORREGIDA)
// =========================================================================
const handleSearch = (value) => {
    let val = value.trim().toUpperCase();
    if (val.length < 5) return;

    // Se asegura que el HTML de la alerta de carga contenga el <p id="motivational-phrase">
    Swal.fire({
        html: `
            <div class="custom-loading-container">
                <i class="material-icons swal-icon-searching">search</i>
                <h3 class="swal-loading-title">Buscando</h3>
                <p id="motivational-phrase" class="swal-loading-phrase"></p>
            </div>
        `,
        showConfirmButton: false,
        allowOutsideClick: false,
        didOpen: () => {
            const phraseElement = document.getElementById('motivational-phrase');
            // Esta validación previene el error si el elemento no se encontrara
            if (phraseElement) {
                let phraseIndex = 0;
                phraseElement.innerText = motivationalPhrases[phraseIndex];

                loadingIntervalId = setInterval(() => {
                    phraseIndex = (phraseIndex + 1) % motivationalPhrases.length;
                    phraseElement.innerText = motivationalPhrases[phraseIndex];
                }, 2000);
            }
        },
        willClose: () => {
            clearInterval(loadingIntervalId);
        }
    });

    // Esta parte no cambia, sigue decidiendo a qué función de búsqueda llamar
    if (/^[A-Z]/.test(val) || /^[0-9]+[A-Z]+/.test(val)) {
        buscarContenedor(val);
    } else {
        buscarSKUenArchivos(val);
    }
    inputBusqueda.value = "";
};

// Asignamos los listeners que inician todo el proceso
inputBusqueda.addEventListener("keyup", (event) => {
    if (event.key === 'Enter') {
        clearTimeout(debounceTimerBusqueda);
        handleSearch(inputBusqueda.value);
    } else {
        clearTimeout(debounceTimerBusqueda);
        debounceTimerBusqueda = setTimeout(() => {
            handleSearch(inputBusqueda.value);
        }, 600);
    }
});

inputBusqueda.addEventListener("paste", (event) => {
    const pastedText = (event.clipboardData || window.clipboardData).getData('text');
    setTimeout(() => {
        handleSearch(pastedText);
    }, 10);
});

// Se llama al pulsar “Elegir”
window.selectContainer = function(cont) {
  Swal.close();
  const info = containersMap[cont];
  openContainerDirect({
    fileName: info[0].fileName,
    matchedRecords: info.map(i => i.record)
  }, 0);
};
// =========================================================================
// BUSCADOR DE SKU (VERSIÓN CORREGIDA PARA MÚLTIPLES COINCIDENCIAS)
// =========================================================================
async function buscarSKUenArchivos(sku) {
    try {
        // 1. Obtenemos TODOS los posibles archivos y registros que contienen el SKU.
        let candidates = await checkFileForReference(null, sku, false);
        if (!candidates || candidates.length === 0) {
            return showNotFoundAlert("SKU");
        }

        // 2. Creamos una lista de opciones únicas (Contenedor + Archivo).
        const foundChoices = [];
        const uniqueCheck = new Set();

        candidates.forEach(candidate => {
            const fileName = candidate.fileName;
            candidate.matchedRecords.forEach(record => {
                const containerName = String(record.CONTENEDOR || "").trim().toUpperCase();
                // Ignoramos registros que no estén asignados a un contenedor
                if (!containerName) return;

                const choiceKey = `${containerName}|${fileName}`; // Clave única de la opción
                if (!uniqueCheck.has(choiceKey)) {
                    foundChoices.push({
                        containerName,
                        fileName,
                        record // Guardamos el registro para mostrar info extra (SAP, Descripción).
                    });
                    uniqueCheck.add(choiceKey);
                }
            });
        });

        // 3. Decidimos qué hacer según el número de coincidencias.

        // CASO A: No se encontró el SKU en ningún contenedor con nombre.
        if (foundChoices.length === 0) {
            return showNotFoundAlert("SKU en algún contenedor válido");
        }

        // CASO B: Se encontró en UNA SOLA ubicación. La abrimos directamente.
        if (foundChoices.length === 1) {
            Swal.close();
            const choice = foundChoices[0];
            realOpenFileManifiesto(choice.fileName, choice.containerName);
            return;
        }

        // CASO C: Se encontró en MÚLTIPLES ubicaciones. Mostramos las opciones.
        const choiceHTML = foundChoices.map(choice => {
            const sap = choice.record.SAP || 0;
            const desc = choice.record.DESCRIPCION || '(sin descripción)';
            const isClosed = excelDataGlobal[choice.fileName]?.closedContainers?.[choice.containerName];

            // Reutilizamos el estilo de tarjetas que ya tienes.
            return `
                <div class="result-item-card">
                    <div class="item-info">
                        <div class="item-title">
                            <i class="material-icons text-primary">inventory_2</i>
                            ${choice.containerName}
                            ${isClosed ? `<span class="status-badge is-closed">CERRADO</span>` : ''}
                        </div>
                        <div class="item-meta">
                            <span><strong>Archivo:</strong> ${choice.fileName}</span><br>
                            <span><strong>Descripción:</strong> ${desc} | <strong>SAP:</strong> ${sap} pz.</span>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-sm btn-choose"
                            onclick="window.openContainerFromFile('${choice.containerName}', '${choice.fileName}')">
                        <i class="material-icons">touch_app</i> Elegir
                    </button>
                </div>`;
        }).join('');

        Swal.fire({
            title: "SKU en Múltiples Ubicaciones",
            html: `<p>Se encontró el SKU <strong>${sku}</strong> en varios lugares. Por favor, elige el correcto:</p>
                   <div class="results-list-container">${choiceHTML}</div>`,
            showConfirmButton: false,
            width: "700px",
        });

    } catch (err) {
        console.error("Error en buscarSKUenArchivos:", err);
        Swal.fire({ icon: "error", title: "Error Inesperado", text: "Ocurrió un problema al buscar el SKU." });
    }
}

// =========================================================================
// Función llamada por los botones 'Elegir' de la búsqueda de SKU
// =========================================================================
window.selectSKUContainerV2 = function(cont) {
    // Lee la información desde la variable global que llenamos antes
    const info = window.skuContainerMapGlobal[cont];
    if (info) {
        Swal.close();
        // Llama a la misma función que ya tienes para abrir el contenedor
        openContainerDirect({
            fileName: info.fileName,
            matchedRecords: info.records
        }, 0);
    }
};
// ========================================================
// INICIA EL BLOQUE PARA REEMPLAZAR
// ========================================================

// FUNCIÓN AUXILIAR PARA PROCESAR UN SOLO ARCHIVO (CON LA CORRECCIÓN)
async function processSingleFile(fileInfo) {
    const fileName = fileInfo.ref.name;
    // Si el archivo ya está en caché, no hacemos nada y lo devolvemos.
    if (excelDataGlobal[fileName]) {
        return; 
    }

    try {
        const url = await storage.ref(`Manifiestos/${fileInfo.folderName}/${fileName}`).getDownloadURL();
        const arrBuff = await (await fetch(url)).arrayBuffer();
        const wb = XLSX.read(arrBuff, { type: "array", cellDates: true });
        const sheet = wb.SheetNames[0];
        const dataJson = XLSX.utils.sheet_to_json(wb.Sheets[sheet]);
        
        // Obtenemos metadatos de Firestore
        const docSnap = await db.collection("manifiestos").doc(fileName).get();
        
        // --- ¡LA CORRECCIÓN DEFINITIVA ESTÁ AQUÍ! ---
        // Usamos 'docSnap.exists' (sin paréntesis) para que sea compatible con tu versión de Firebase.
        let docData = docSnap.exists ? docSnap.data() : {};

        // Guardamos todo en nuestra caché global
        excelDataGlobal[fileName] = {
            data: dataJson,
            lastUser: docData.lastUser || "",
            lastUserStore: docData.lastUserStore || "",
            lastUserRole: docData.lastUserRole || "",
            closedContainers: docData.closedContainers || {},
            uploadedAt: docData.updatedAt ? docData.updatedAt.toDate() : null
        };
    } catch (error) {
        // Mostramos un error más detallado en la consola para futura depuración
        console.error(`Error procesando el archivo ${fileName}:`, error);
    }
}


// VERSIÓN OPTIMIZADA DE checkFileForReference
async function checkFileForReference(folderName, code) {
    // Lógica para obtener la lista de archivos (mejorada)
    if (!allFilesList || allFilesList.length === 0) {
        allFilesList = [];
        const storeFolder = currentUserStore === "ALL" ? "" : currentUserStore;
        
        if (storeFolder) { // Si es una tienda específica
            const storeFiles = await storage.ref(`Manifiestos/${storeFolder}`).listAll();
            storeFiles.items.forEach(itemRef => allFilesList.push({ folderName: storeFolder, ref: itemRef }));
        } else { // Si es Super Admin (ALL)
            const root = await storage.ref("Manifiestos").listAll();
            for (const folderRef of root.prefixes) {
                const storeFiles = await folderRef.listAll();
                storeFiles.items.forEach(itemRef => allFilesList.push({ folderName: folderRef.name, ref: itemRef }));
            }
        }
    }
    const filesToProcess = allFilesList.filter(f => !excelDataGlobal[f.ref.name]);

    // Procesamos todos los archivos necesarios en paralelo.
    if (filesToProcess.length > 0) {
        const phraseElement = document.getElementById('motivational-phrase');
        if (phraseElement) {
             phraseElement.innerText = `Cargando ${filesToProcess.length} archivo(s) nuevos...`;
        }
        await Promise.all(filesToProcess.map(fileInfo => processSingleFile(fileInfo)));
    }
    
    // Lógica de filtrado (la misma que antes, pero ahora sobre datos ya cargados)
    const foundCandidates = [];
    const searchCode = code.toUpperCase();

    for (const f of allFilesList) {
        const fileName = f.ref.name;
        if (!excelDataGlobal[fileName]) continue; // Si falló la carga, lo saltamos

        const records = excelDataGlobal[fileName].data;
        const matched = records.filter(r => {
            const cont = String(r.CONTENEDOR || "").trim().toUpperCase();
            const sku = String(r.SKU || "").trim().toUpperCase();
            return cont.includes(searchCode) || sku.includes(searchCode);
        });

        if (matched.length > 0) {
            foundCandidates.push({
                folderName: f.folderName,
                fileName,
                matchedRecords: matched
            });
        }
    }

    return foundCandidates.length > 0 ? foundCandidates : null;
}

// ========================================================
// FIN DEL BLOQUE PARA REEMPLAZAR
// ========================================================
        function openContainerDirect(candidate, recordIndex = 0) {
          currentFileName = candidate.fileName;
          let cont = String(candidate.matchedRecords[recordIndex]?.CONTENEDOR || "").trim().toUpperCase();
          realOpenFileManifiesto(currentFileName, cont);
        }

        function realOpenFileManifiesto(fileName, cont) {
          if (!excelDataGlobal[fileName]) {
            Swal.fire({
              icon: "error",
              title: "Error",
              html: `<i class="material-icons" style="color:#F44336;">error</i> No se encontró el archivo ${fileName}`
            });
            return;
          }
          adminUploadSection.style.display = "none";
          searchContainerSection.style.display = "none";
          currentContenedor = cont;
          let dataObj = excelDataGlobal[fileName];
          let arr = dataObj.data;
          let matched = arr.filter(r => String(r.CONTENEDOR || "").trim().toUpperCase() === cont);
          if (matched.length === 0) {
            Swal.fire({
              icon: "info",
              title: "Sin registros",
              html: `<i class="material-icons" style="color:#2196F3;">info</i> No se encontraron registros para el contenedor ${cont}`
            });
            return;
          }
          currentContainerRecords = matched;
          if (selectedFileToWorkEl) selectedFileToWorkEl.textContent = fileName;
          currentFileName = fileName;
          let closedBy = dataObj.closedContainers && dataObj.closedContainers[cont] ? dataObj.closedContainers[cont] : "";
          if (closedBy) {
            lastUserUpdateEl.textContent = `Contenedor ${cont} cerrado por: ${closedBy}`;
            inputScanCode.disabled = true;
            btnCerrarContenedor.innerHTML = `<i class="material-icons" style="vertical-align:middle;">lock_open</i> Abrir Contenedor`;
          } else {
            let lastU = dataObj.lastUser || "Desconocido";
            let store = dataObj.lastUserStore || "?";
            let role = dataObj.lastUserRole || "?";
            lastUserUpdateEl.textContent = `Último cambio por: ${lastU} (Tienda: ${store}, Rol: ${role})`;
            inputScanCode.disabled = (currentEmployeeNumber === "");
            btnCerrarContenedor.innerHTML = `<i class="material-icons" style="vertical-align:middle;">lock</i> Cerrar Contenedor`;
          }
          containerResultsSection.style.display = "block";
          scanEntrySection.style.display = "block";

// Mostrar sección de descarga también a vendedores
if (
    currentUser &&
    (
        currentUser.uid === ADMIN_UID ||
        ["admin", "jefe", "auxiliar", "vendedor"].includes(currentUserRole)
    )
) {
    downloadSection.style.display = "block";
} else {
    downloadSection.style.display = "none";
}

          document.getElementById("containerHeader").innerHTML = `<i class="material-icons" style="vertical-align:middle;">inventory_2</i> Detalles del Contenedor (${cont})`;
          mostrarDetallesContenedor(currentContainerRecords);
          inputScanCode.focus();
        }
// =========================================================================
// SECCIÓN: CERRAR / REABRIR CONTENEDOR (MEJORADA)
// =========================================================================

// --- PASO 1: Funciones de ayuda para crear los modales ---

/** Muestra el modal de confirmación para REABRIR un contenedor. */
function showReopenConfirmationModal(containerName, closedBy) {
    return Swal.fire({
        html: `
            <div class="modal-header-status status-reopen">
                <i class="material-icons">lock_open</i>
                <h3>Reabrir Contenedor</h3>
            </div>
            <div class="confirmation-modal-content">
                <p class="main-text">
                    El contenedor <strong>${containerName}</strong> fue cerrado por <strong class="closed-by-user">${closedBy}</strong>.
                </p>
                <p class="text-muted small">Al reabrirlo, podrás registrar mercancía faltante. Se volverá a cerrar automáticamente si cambias de contenedor.</p>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Sí, Reabrir',
        cancelButtonText: 'Cancelar',
        width: "550px",
        padding: 0,
        customClass: {
            confirmButton: 'btn-confirm-custom', // Reutilizamos clases de botones
            cancelButton: 'btn-cancel-custom'
        }
    });
}

/** Muestra el modal de confirmación para CERRAR un contenedor. */
function showCloseConfirmationModal(containerName, summaryHTML) {
    return Swal.fire({
        html: `
            <div class="modal-header-status status-close">
                <i class="material-icons">lock</i>
                <h3>Cerrar Contenedor</h3>
            </div>
            <div class="confirmation-modal-content">
                <p class="main-text">¿Estás seguro de que deseas cerrar el contenedor <strong>${containerName}</strong>?</p>
                <div class="summary-card">${summaryHTML}</div>
                <p class="text-muted small">Una vez cerrado, no podrás escanear más productos en él a menos que lo reabras.</p>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Sí, Cerrar',
        cancelButtonText: 'Cancelar',
        width: "600px",
        padding: 0,
        customClass: {
            confirmButton: 'btn-confirm-custom',
            cancelButton: 'btn-cancel-custom'
        }
    });
}

/** Muestra el resumen final DESPUÉS de cerrar un contenedor. */
function showFinalSummaryModal(containerName, summaryHTML, closedBy) {
    Swal.fire({
        html: `
            <div class="modal-header-status status-close">
                <i class="material-icons">check_circle</i>
                <h3>Contenedor Cerrado</h3>
            </div>
            <div class="confirmation-modal-content">
                <p class="main-text">
                    El contenedor <strong>${containerName}</strong> ha sido cerrado con éxito por <strong class="closed-by-user">${closedBy}</strong>.
                </p>
                <p>Este es el resumen final:</p>
                <div class="summary-card">${summaryHTML}</div>
            </div>
        `,
        confirmButtonText: "Entendido",
        width: "600px",
        padding: 0
    });
}


// --- PASO 2: El Event Listener principal, ahora mucho más limpio ---

btnCerrarContenedor.addEventListener("click", async () => {
    const fn = selectedFileToWorkEl.textContent;
    // Validaciones iniciales (mejoradas con nuestras alertas estándar)
    if (!fn || !excelDataGlobal[fn] || !currentContenedor) {
        return showNotFoundAlert("contenedor abierto para realizar esta acción");
    }

    const dataObj = excelDataGlobal[fn];
    const isClosed = dataObj.closedContainers && dataObj.closedContainers[currentContenedor];

    if (isClosed) {
        // --- Flujo para REABRIR ---
        const closedBy = dataObj.closedContainers[currentContenedor];
        const { isConfirmed } = await showReopenConfirmationModal(currentContenedor, closedBy);

        if (isConfirmed) {
            delete dataObj.closedContainers[currentContenedor];
            excelDataGlobal[fn] = dataObj;
            await reuploadFileWithScannerChanges(fn);
            
            Swal.fire({ icon: "success", title: "¡Reabierto!", text: `El contenedor ${currentContenedor} está listo para escanear de nuevo.`, timer: 2000, showConfirmButton: false });

            inputScanCode.disabled = false;
            btnCerrarContenedor.innerHTML = `<i class="material-icons">lock</i> Cerrar Contenedor`;
        }
    } else {
        // --- Flujo para CERRAR ---
        const summary = getContainerSummaryDetailed(currentContainerRecords);
        const { isConfirmed } = await showCloseConfirmationModal(currentContenedor, summary);

        if (isConfirmed) {
            if (!dataObj.closedContainers) dataObj.closedContainers = {};
            const userIdentifier = currentUser.email || currentUser.uid;
            dataObj.closedContainers[currentContenedor] = userIdentifier;
            excelDataGlobal[fn] = dataObj;
            
            await reuploadFileWithScannerChanges(fn);

            inputScanCode.disabled = true;
            btnCerrarContenedor.innerHTML = `<i class="material-icons">lock_open</i> Reabrir Contenedor`;
            
            // --- ¡Alerta única y mejorada! ---
            // Mostramos el resumen final en lugar de dos alertas separadas.
            showFinalSummaryModal(currentContenedor, summary, userIdentifier);
        }
    }
});
// =========================================================================
// SECCIÓN: REGISTRO DE PIEZAS (SCAN) - MEJORADA
// =========================================================================

// --- PASO 1: Funciones de ayuda para la interfaz de usuario ---

/** Muestra un toast de éxito rápido tras un escaneo correcto. */
function showScanSuccessToast(sku, newCount) {
    Swal.fire({
        toast: true,
        position: 'top-end',
        icon: 'success',
        title: `+1 ${sku} (Total: ${newCount})`,
        showConfirmButton: false,
        timer: 1500, // Desaparece en 1.5 segundos
        customClass: { popup: 'scan-success-toast' }
    });
}

/** Muestra un toast de error no bloqueante. */
function showScanErrorToast(title, text) {
    Swal.fire({
        toast: true,
        position: 'top-end',
        icon: 'error',
        title: title,
        text: text,
        showConfirmButton: false,
        timer: 2500,
        customClass: { popup: 'scan-error-toast' }
    });
}

/** Muestra el modal para confirmar si se añade un nuevo artículo. */
function showAddItemConfirmation(code) {
    return Swal.fire({
        html: `
            <div class="modal-header-status status-reopen" style="background-color: #9C27B0;">
                <i class="material-icons">add_shopping_cart</i>
                <h3>Artículo No Encontrado</h3>
            </div>
            <div class="confirmation-modal-content">
                <p class="main-text">El artículo <strong>${code}</strong> no existe en este contenedor.</p>
                <p>¿Deseas añadirlo como un nuevo registro con Cantidad SAP = 0?</p>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Sí, Añadir',
        cancelButtonText: 'Cancelar',
        width: "550px",
        padding: 0,
        customClass: {
            confirmButton: 'btn-confirm-custom',
            cancelButton: 'btn-cancel-custom'
        }
    });
}

/** Muestra el modal para elegir entre múltiples coincidencias. */
function showMultipleMatchesModal(code, matchingRows) {
    // Reutilizamos nuestras tarjetas de resultados
    const html = matchingRows.map((row, idx) => `
        <div class="result-item-card">
            <div class="item-info">
                <div class="item-title">
                    <i class="material-icons text-primary">sell</i>
                    ${row.SKU || 'SKU no definido'}
                </div>
                <div class="item-meta">
                    <strong>Descripción:</strong> ${row.DESCRIPCION || '(sin descripción)'}
                </div>
            </div>
            <button class="btn btn-primary btn-sm btn-choose" onclick="window.chooseRow(${idx})">
                <i class="material-icons">touch_app</i> Seleccionar
            </button>
        </div>
    `).join('');

    Swal.fire({
        title: "Múltiples Coincidencias",
        html: `<p>Se encontraron varios registros para el código <strong>${code}</strong>. Por favor, selecciona el correcto:</p>
               <div class="results-list-container">${html}</div>`,
        showConfirmButton: false,
        width: "650px"
    });
}


// --- PASO 2: La lógica principal de manejo de escaneo ---

/** Incrementa el contador de un artículo y notifica al usuario. */
async function incrementRowAndNotify(row, code) {
    // Tu lógica original para incrementar la fila (se mantiene)
    row.SCANNER = (Number(row.SCANNER) || 0) + 1;
    row.FECHA_ESCANEO = new Date();
    row.LAST_SCANNED_BY = currentUser.email || currentUser.uid;
    // ... cualquier otra lógica que tuvieras en incrementRow ...

    // Mostramos el toast de éxito
    showScanSuccessToast(row.SKU || code, row.SCANNER);

    // Actualizamos la vista de detalles del contenedor
    mostrarDetallesContenedor(currentContainerRecords);
    
    // Guardamos los cambios en el archivo
    await reuploadFileWithScannerChanges(selectedFileToWorkEl.textContent);
}
// ========================================================
// MANEJADOR DE ESCANEO CON FLUJO DE FOCO AUTOMÁTICO
// ========================================================
async function handleScanCode(code) {
    if (!currentEmployeeNumber) return showScanErrorToast('Falta # de Empleado');
    if (!currentContenedor) return showScanErrorToast('Sin Contenedor');
    const fn = currentFileName;
    const dataObj = excelDataGlobal[fn];
    if (!dataObj || dataObj.closedContainers?.[currentContenedor]) return showScanErrorToast('Contenedor cerrado');

    const codeUpper = code.trim().toUpperCase();
    let targetRow = currentContainerRecords.find(r => 
        String(r.SKU || "").toUpperCase() === codeUpper || 
        String(r.EUROPEO || "").toUpperCase() === codeUpper
    );

    if (targetRow) {
        targetRow.SCANNER = (Number(targetRow.SCANNER) || 0) + 1;
    } else {
        const { isConfirmed } = await showAddItemConfirmation(codeUpper);
        if (!isConfirmed) { 
            inputScanCode.value = "";
            inputScanCode.focus(); // Se asegura de devolver el foco si se cancela
            return; 
        }
        const ref = currentContainerRecords[0] || {};
        targetRow = { 
            FECHA: ref.FECHA || new Date(), SECCION: ref.SECCION || "N/A", MANIFIESTO: ref.MANIFIESTO || "N/A", 
            CONTENEDOR: currentContenedor, DESCRIPCION: "ARTÍCULO NUEVO", SKU: codeUpper, SAP: 0, SCANNER: 1, 
            ENTREGADO_A: currentEmployeeNumber 
        };
        dataObj.data.push(targetRow);
        currentContainerRecords.push(targetRow);
        Swal.fire('¡Agregado!', `El artículo ${targetRow.SKU} se añadió al contenedor.`, 'success');
    }
    
    Object.assign(targetRow, { LAST_SCANNED_BY: currentUser.email, FECHA_ESCANEO: new Date() });
    
    mostrarDetallesContenedor(currentContainerRecords);
    showScanSuccessToast(targetRow.SKU, targetRow.SCANNER);
    
    // Limpiamos el campo para el siguiente escaneo
    inputScanCode.value = "";
    
    // ✨ MEJORA DE FLUJO: Devolvemos el foco al campo de escaneo automáticamente.
    inputScanCode.focus();
    
    try {
        await db.collection('manifiestos').doc(fn).collection('scans').add({
            sku: targetRow.SKU, type: 'add', scannedAt: firebase.firestore.FieldValue.serverTimestamp(),
            employee: currentEmployeeNumber, user: currentUser.email, container: currentContenedor
        });
db.collection('manifiestos').doc(fn).set({ lastUser: currentUser.email, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });    } catch (error) {
        showScanErrorToast('Error de Red', 'El escaneo no se guardó. Reinténtalo.');
        targetRow.SCANNER -= 1;
        mostrarDetallesContenedor(currentContainerRecords);
    }
}
async function realOpenFileManifiesto(fileName, cont) {
    Swal.fire({ title: 'Cargando y reconstruyendo...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
    try {
        // ... (Toda la lógica de carga y reconstrucción se mantiene igual)
        if (!excelDataGlobal[fileName]?.data) {
            let store = currentUserStore;
            if (currentUserStore === 'ALL') {
                const manifestDoc = await db.collection('manifiestos').doc(fileName).get();
                store = manifestDoc.data()?.store;
            }
            if (!store) throw new Error(`No se pudo determinar la tienda para el archivo ${fileName}`);
            const url = await storage.ref(`Manifiestos/${store}/${fileName}`).getDownloadURL();
            const buffer = await (await fetch(url)).arrayBuffer();
            const wb = XLSX.read(buffer, { type: "array", cellDates: true });
            excelDataGlobal[fileName] = { data: XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]) };
        }
        
        const dataObj = excelDataGlobal[fileName];
        const docSnap = await db.collection("manifiestos").doc(fileName).get();
        dataObj.closedContainers = docSnap.exists ? (docSnap.data().closedContainers || {}) : {};
        dataObj.lastUser = docSnap.exists ? (docSnap.data().lastUser || "Desconocido") : "Desconocido";
        
        dataObj.data.forEach(row => { row.SCANNER = 0; });

        const scansSnapshot = await db.collection('manifiestos').doc(fileName).collection('scans').where('container', '==', cont).orderBy('scannedAt').get();
        const newItems = new Map();
        const deletedSkus = new Set();
        scansSnapshot.docs.forEach(doc => { if (doc.data().type === 'delete') deletedSkus.add(doc.data().sku); });

        scansSnapshot.forEach(doc => {
            const scan = doc.data();
            if (deletedSkus.has(scan.sku)) return;
            let record = dataObj.data.find(r => r.SKU === scan.sku && r.CONTENEDOR === scan.container);
            if (record) {
                scan.type === 'subtract' ? record.SCANNER-- : record.SCANNER++;
                record.LAST_SCANNED_BY = scan.user;
                if(scan.scannedAt) record.FECHA_ESCANEO = scan.scannedAt.toDate();
            } else if (scan.type === 'add') {
                if (newItems.has(scan.sku)) { newItems.get(scan.sku).SCANNER++; }
                else {
                    const ref = dataObj.data[0] || {};
                    newItems.set(scan.sku, { FECHA: ref.FECHA, SECCION: ref.SECCION, MANIFIESTO: ref.MANIFIESTO, CONTENEDOR: cont, DESCRIPCION: "ARTÍCULO NUEVO (RECUPERADO)", SKU: scan.sku, SAP: 0, SCANNER: 1, LAST_SCANNED_BY: scan.user, FECHA_ESCANEO: scan.scannedAt?.toDate() });
                }
            }
        });
        
        dataObj.data = dataObj.data.filter(r => !deletedSkus.has(r.SKU));
        newItems.forEach(item => dataObj.data.push(item));

        currentContenedor = cont;
        currentFileName = fileName;
        currentContainerRecords = dataObj.data.filter(r => String(r.CONTENEDOR || "").trim().toUpperCase() === cont);

        // ✅ CORRECCIÓN: Oculta el panel unificado de Carga/Búsqueda.
        uploadAndSearchSection.style.display = "none";
        
        containerResultsSection.style.display = "block";
        scanEntrySection.style.display = "block";
        
        const isClosed = dataObj.closedContainers?.[cont];
        selectedFileToWorkEl.textContent = fileName;
        lastUserUpdateEl.textContent = `Último cambio por: ${dataObj.lastUser}`;
        btnCerrarContenedor.querySelector('span').textContent = isClosed ? 'Reabrir' : 'Cerrar';
        inputScanCode.disabled = !!isClosed;
        document.getElementById("containerHeader").querySelector('span').textContent = `Detalles de ${cont}`;
        
        mostrarDetallesContenedor(currentContainerRecords);
        inputScanCode.focus();
        Swal.close();

    } catch (error) {
        console.error("Error abriendo manifiesto:", error);
        Swal.fire({ icon: 'error', title: 'Error de Carga', text: 'No se pudo cargar la información.' });
    }
}
// --- PASO 3: Los nuevos event listeners, unificados y eficientes ---

function scanInputHandler() {
    let val = inputScanCode.value.trim().toUpperCase();
    // Validamos la longitud del código escaneado
    if (val && ((val.length >= 5 && val.length <= 10) || (val.length >= 12))) {
        handleScanCode(val);
        inputScanCode.value = "";
    }
}

// Un scanner de códigos de barras normalmente simula un 'Enter' al final.
// Por eso, este es nuestro listener principal.
inputScanCode.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
        e.preventDefault(); // Evita que el 'Enter' envíe un formulario si lo hubiera
        clearTimeout(debounceTimerScan); // Limpiamos cualquier timer pendiente
        scanInputHandler();
    }
});

// El listener de 'paste' es útil si se copia y pega el código manualmente.
inputScanCode.addEventListener("paste", (e) => {
    e.preventDefault();
    const pastedText = (e.clipboardData || window.clipboardData).getData('text');
    inputScanCode.value = pastedText;
    scanInputHandler();
});

// Mantenemos un debounce para el 'keyup' como un respaldo, pero con menos tiempo.
inputScanCode.addEventListener("keyup", (e) => {
    if (e.key !== 'Enter') {
        clearTimeout(debounceTimerScan);
        debounceTimerScan = setTimeout(() => {
            scanInputHandler();
        }, 800); // 800ms es un tiempo más razonable para una pausa al teclear.
    }
});

        // **MODIFICACIÓN**: En vez de reescribir el XLSX en cada escaneo,
        // solo actualizamos la interfaz y dejamos el reupload para el cierre.
/***********************************************************
 * incrementRow (ahora asigna FECHA_ESCANEO correctamente)
 ***********************************************************/
 function incrementRow(rowObj, code) {
  const now = new Date();

  // Incrementar contador y asignar metadatos
  rowObj.SCANNER         = (rowObj.SCANNER || 0) + 1;
  rowObj.LAST_SCANNED_BY = currentUser.email || currentUser.uid;
  rowObj.FECHA_ESCANEO   = now;                     // ← asignación de fecha de escaneo

  if (!rowObj.ENTREGADO_A) {
    rowObj.ENTREGADO_A = currentEmployeeNumber;
  }

  // Actualizar último usuario en memoria
  const dataObj = excelDataGlobal[currentFileName];
  dataObj.lastUser = rowObj.LAST_SCANNED_BY;
  excelDataGlobal[currentFileName] = dataObj;

  // Refrescar UI
  currentContainerRecords = dataObj.data.filter(x =>
    String(x.CONTENEDOR || "").trim().toUpperCase() === currentContenedor
  );
  mostrarDetallesContenedor(currentContainerRecords);

  // Toast de confirmación
  Swal.fire({
    toast: true,
    position: "top-end",
    icon: "success",
    title: `+1 para ${code}`,
    showConfirmButton: false,
    timer: 1500,
    timerProgressBar: true
  });
}
function mostrarDetallesContenedor(registros) {
    if (!registros) { containerDetailsEl.innerHTML = ""; return; }
    registros.sort((a, b) => (a.SAP === 0) - (b.SAP === 0) || String(a.SKU || "").localeCompare(String(b.SKU || "")));

    const cardsHTML = `<div class="details-list-container">
        ${registros.map(r => {
            const sku = String(r.SKU || "").toUpperCase();
            const SAP = Number(r.SAP) || 0;
            const SCANNER = Number(r.SCANNER) || 0;
            const esNuevo = SAP === 0;
            let statusClass = '', diffText = '';
            if (SCANNER === SAP) { statusClass = 'is-ok'; diffText = 'OK'; }
            else if (SCANNER < SAP) { statusClass = 'is-missing'; diffText = `FALTA ${SAP - SCANNER}`; }
            else { statusClass = 'is-excess'; diffText = `SOBRA ${SCANNER - SAP}`; }
            let cardStatusClass = esNuevo ? 'is-new' : `status-${statusClass.substring(3)}`;
            return `<div class="item-card ${cardStatusClass}" id="row-${sku}">
                        <div class="item-card-main"><span class="sku">${sku}</span><span class="descripcion">${r.DESCRIPCION || "Sin descripción"}</span></div>
                        <div class="item-card-stats">
                            <div class="stat-item"><div class="label">SAP</div><div class="value">${SAP}</div></div>
                            <div class="stat-item"><div class="label">SCAN</div><div id="scanner-cell-${sku}" class="value">${SCANNER}</div></div>
                            <div class="stat-item"><div class="label">DIF.</div><div id="diff-cell-${sku}"><span class="diff-badge ${statusClass}">${diffText}</span></div></div>
                        </div>
                        <div class="item-card-actions">
                            <button class="btn-action btn-danio" data-sku="${sku}" title="Reportar daño"><i class="material-icons">warning</i></button>
                            ${r.DANIO_FOTO_URL ? `<button class="btn-action btn-foto" data-url="${r.DANIO_FOTO_URL}" title="Ver foto"><i class="material-icons">image</i></button>` : ''}
                            <button class="btn-action btn-restar" data-sku="${sku}" title="Restar 1 pieza"><i class="material-icons">remove</i></button>
                            ${esNuevo ? `<button class="btn-action btn-eliminar" data-sku="${sku}" title="Eliminar artículo añadido"><i class="material-icons">delete_forever</i></button>` : ''}
                        </div>
                        <div class="item-card-details">
                            <div class="detail-item" title="Sección"><i class="material-icons">folder_open</i><span>${r.SECCION || 'N/A'}</span></div>
                            <div class="detail-item" title="Manifiesto"><i class="material-icons">article</i><span>${r.MANIFIESTO || 'N/A'}</span></div>
                            <div class="detail-item" title="Fecha de Último Escaneo"><i class="material-icons">update</i><span>${r.FECHA_ESCANEO ? formatFecha(r.FECHA_ESCANEO) : 'Sin escanear'}</span></div>
                        </div>
                    </div>`;
        }).join('')}
    </div>`;

    containerDetailsEl.innerHTML = cardsHTML;

    if (containerDetailsEl.eventHandler) containerDetailsEl.removeEventListener('click', containerDetailsEl.eventHandler);

    const eventHandler = async (event) => {
        const target = event.target.closest('button');
        if (!target) return;
        const sku = target.dataset.sku;
        const fn = currentFileName;

        if (target.classList.contains('btn-restar')) {
            const rowObj = currentContainerRecords.find(r => String(r.SKU || "").toUpperCase() === sku);
            if (!rowObj || (rowObj.SCANNER || 0) <= 0) return;
            rowObj.SCANNER--;
            mostrarDetallesContenedor(currentContainerRecords);
            try {
                await db.collection('manifiestos').doc(fn).collection('scans').add({ sku: rowObj.SKU, type: 'subtract', scannedAt: firebase.firestore.FieldValue.serverTimestamp(), employee: currentEmployeeNumber, user: currentUser.email, container: currentContenedor });
            } catch (error) {
                showScanErrorToast('Error de Red', 'No se pudo guardar la resta.');
                rowObj.SCANNER++;
                mostrarDetallesContenedor(currentContainerRecords);
            }
        } 
        else if (target.classList.contains('btn-eliminar')) {
            const { isConfirmed } = await Swal.fire({ title: '¿Estás seguro?', html: `Se eliminará permanentemente el artículo <strong>${sku}</strong>.`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Sí, ¡Eliminar!' });
            if (isConfirmed) {
                // Actualiza la UI inmediatamente
                currentContainerRecords = currentContainerRecords.filter(r => !(String(r.SKU || "").toUpperCase() === sku && r.SAP === 0));
                mostrarDetallesContenedor(currentContainerRecords);
                
                try {
                    // ✅ SOLUCIÓN: En lugar de resubir el archivo, creamos un "recibo de eliminación".
                    await db.collection('manifiestos').doc(fn).collection('scans').add({
                        sku: sku,
                        type: 'delete', // Este es el nuevo tipo de transacción
                        scannedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        employee: currentEmployeeNumber,
                        user: currentUser.email,
                        container: currentContenedor
                    });
                    Swal.fire('¡Eliminado!', `El artículo ${sku} ha sido marcado para eliminación.`, 'success');
                } catch (error) {
                    showScanErrorToast('Error de Red', 'No se pudo eliminar. Intenta de nuevo.');
                    // Si falla, volvemos a cargar todo para asegurar consistencia
                    realOpenFileManifiesto(fn, currentContenedor);
                }
            }
        }
        else if (target.classList.contains('btn-danio')) {
             currentDanioSKU = sku;
             danioCantidadInput.value = "1";
             danioFotoInput.value = "";
             modalDanios.show();
        }
        else if (target.classList.contains('btn-foto')) {
            window.open(target.dataset.url, "_blank");
        }
    };
    containerDetailsEl.eventHandler = eventHandler;
    containerDetailsEl.addEventListener('click', containerDetailsEl.eventHandler);


    // Evento para abrir modal de daños
    containerDetailsEl.querySelectorAll(".btnDanio").forEach(btn => {
        btn.addEventListener("click", () => {
            currentDanioSKU = btn.dataset.sku || "";
            danioCantidadInput.value = "1";
            danioFotoInput.value = "";
            modalDanios.show();
        });
    });

    // Evento para abrir foto de daño
    containerDetailsEl.querySelectorAll(".btnFoto").forEach(btn => {
        btn.addEventListener("click", () => window.open(btn.dataset.url, "_blank"));
    });

    // --- ¡MEJORA DE ACTUALIZACIÓN INTELIGENTE! ---FV
    // Evento para restar una pieza
    containerDetailsEl.querySelectorAll(".removeOneBtn").forEach(btn => {
        btn.addEventListener("click", () => {
            const sku = btn.dataset.sku;
            const fn = selectedFileToWorkEl.textContent;
            const dataObj = excelDataGlobal[fn];
            const rowObj = dataObj.data.find(x => String(x.SKU || "").trim().toUpperCase() === sku && String(x.CONTENEDOR || "").trim().toUpperCase() === currentContenedor);
            
            if (!rowObj || (rowObj.SCANNER || 0) === 0) return;

            // 1. Actualizar datos en memoria
            rowObj.SCANNER -= 1;
            // ... (el resto de tu lógica de actualización de datos se mantiene)

            // 2. Persistir en segundo plano (igual que antes)
            reuploadFileWithScannerChanges(fn).catch(e => console.error(e));

            // 3. ¡Actualizar solo la UI necesaria, sin redibujar todo!
            const scannerCell = document.getElementById(`scanner-cell-${sku}`);
            const diffCell = document.getElementById(`diff-cell-${sku}`);
            const rowElement = document.getElementById(`row-${sku}`);

            if (scannerCell && diffCell && rowElement) {
                scannerCell.textContent = rowObj.SCANNER;

                // Re-calculamos la diferencia y actualizamos su celda
                const SAP = rowObj.SAP || 0;
                let diffClass = '', diffText = '';
                if (rowObj.SCANNER === SAP) { diffClass = 'is-ok'; diffText = 'OK'; }
                else if (rowObj.SCANNER < SAP) { diffClass = 'is-missing'; diffText = `FALTAN ${SAP - rowObj.SCANNER}`; }
                else { diffClass = 'is-excess'; diffText = `EXCESO: ${rowObj.SCANNER - SAP}`; }
                diffCell.innerHTML = `<div class="diff-status ${diffClass}">${diffText}</div>`;
                
                // Animación para feedback visual
                rowElement.classList.add('row-updated');
                setTimeout(() => rowElement.classList.remove('row-updated'), 1000);
            }

            // 4. Toast rápido (igual que antes)
            Swal.fire({
                toast: true, position: 'top-end', icon: 'info',
                title: `-1 ${sku}`, showConfirmButton: false, timer: 1200
            });
        });
    });
}
        /***********************************************************
         * MODAL DE CONDICIONES DE LA MCIA
         ***********************************************************/
        btnGuardarDanio.addEventListener("click", async () => {
          let cant = parseInt(danioCantidadInput.value) || 0;
          if (!cant || cant < 1) {
            return Swal.fire({
              icon: "info",
              title: "Cantidad inválida",
              html: `<i class="material-icons" style="color:#2196F3;">info</i> Ingrese una cantidad válida.`
            });
          }
          if (!currentDanioSKU) {
            return Swal.fire({
              icon: "info",
              title: "Error interno",
              html: `<i class="material-icons" style="color:#2196F3;">info</i> No se puede guardar condiciones sin SKU.`
            });
          }
          let fn = selectedFileToWorkEl.textContent;
          let dataObj = excelDataGlobal[fn];
          let arr = dataObj.data;
          let rowObj = arr.find(r => {
            let s = String(r.SKU || "").trim().toUpperCase();
            return s === currentDanioSKU && String(r.CONTENEDOR || "").toUpperCase() === currentContenedor;
          });
          if (!rowObj) {
            return Swal.fire({
              icon: "info",
              title: "No encontrado",
              html: `<i class="material-icons" style="color:#2196F3;">info</i> No se encontró el SKU en el contenedor.`
            });
          }
          rowObj.DANIO_CANTIDAD = cant;
          let file = danioFotoInput.files[0];
          if (file) {
            Swal.fire({ title: "Subiendo foto...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            let safeSKU = currentDanioSKU.replace(/[^a-zA-Z0-9]/g, '_');
            let ts = Date.now();
            let filePath = `Evidencias/${fn}/${currentContenedor}/${safeSKU}_${ts}.jpg`;
            let ref = storage.ref(filePath);
            let snap = await ref.put(file);
            rowObj.DANIO_FOTO_URL = await snap.ref.getDownloadURL();
          }
          rowObj.LAST_SCANNED_BY = currentUser.email || currentUser.uid;
          dataObj.lastUser = rowObj.LAST_SCANNED_BY;
          excelDataGlobal[fn] = dataObj;
          try {
            await reuploadFileWithScannerChanges(fn);
            currentContainerRecords = arr.filter(z =>
              String(z.CONTENEDOR || "").toUpperCase() === currentContenedor
            );
            mostrarDetallesContenedor(currentContainerRecords);
            Swal.fire({
              icon: "success",
              title: "Condiciones registradas",
              html: `<i class="material-icons" style="color:#4CAF50;">check_circle</i> Se guardó la información.`
            });
            modalDanios.hide();
          } catch (e) {
            console.error(e);
            Swal.fire({
              icon: "error",
              title: "Error",
              html: `<i class="material-icons" style="color:#F44336;">error</i> No se pudo subir la info de condiciones.`
            });
          }
        });

        /***********************************************************
         * DESCARGAR ARCHIVO
         ***********************************************************/
        document.getElementById("btnDescargarArchivo").addEventListener("click", () => {
          let fn = selectedFileToWorkEl.textContent;
          if (!fn || !excelDataGlobal[fn]) {
            return Swal.fire({
              icon: "error",
              title: "Error",
              html: `<i class="material-icons" style="color:#F44336;">error</i> No hay archivo para descargar.`
            });
          }
          descargarArchivoTotal(fn);
        });
        function descargarArchivoTotal(fileName) {
          let dataObj = excelDataGlobal[fileName];
          if (!dataObj || !dataObj.data) {
            return Swal.fire({
              icon: "error",
              title: "Error",
              html: `<i class="material-icons" style="color:#F44336;">error</i> No hay datos para descargar.`
            });
          }
          let arr = dataObj.data.slice();
          arr.sort((a, b) => {
            let ca = String(a.CONTENEDOR || "").trim().toUpperCase();
            let cb = String(b.CONTENEDOR || "").trim().toUpperCase();
            if (ca < cb) return -1;
            if (ca > cb) return 1;
            return String(a.SKU||"").localeCompare(String(b.SKU||""));
          });
          arr = arr.map(r => {
            if (r.SCANNER > 0) r.ENTREGADO_A = r.ENTREGADO_A || currentEmployeeNumber;
            return r;
          });
          let exportData = arr.map(r => {
            let SAP = r.SAP || 0;
            let SCANNER = r.SCANNER || 0;
            let diff = (SCANNER === SAP) ? "OK"
                     : (SCANNER < SAP) ? `FALTAN ${SAP - SCANNER} piezas`
                     : `MERCANCIA DE MAS: ${SCANNER - SAP} piezas`;
            return {
              FECHA: formatFecha(r.FECHA),
              SECCION: r.SECCION || "",
              MANIFIESTO: r.MANIFIESTO || "",
              CONTENEDOR: r.CONTENEDOR || "",
              SKU: r.SKU || "",
              EUROPEO: r.EUROPEO || "",
              DESCRIPCION: r.DESCRIPCION || "",
              SAP,
              SCANNER,
              LAST_SCANNED_BY: r.LAST_SCANNED_BY || "",
              ENTREGADO_A: r.ENTREGADO_A || "",
              DIFERENCIA: diff,
              "Fecha de Escaneo": r.FECHA_ESCANEO ? formatFecha(r.FECHA_ESCANEO) : "",
              "CONDICIONES_MCIA": r.DANIO_CANTIDAD || 0,
              "FOTO_CONDICIONES": r.DANIO_FOTO_URL || ""
            };
          });
          let ws = XLSX.utils.json_to_sheet(exportData, {
            header: [
              "FECHA","SECCION","MANIFIESTO","CONTENEDOR","SKU","EUROPEO",
              "DESCRIPCION","SAP","SCANNER","LAST_SCANNED_BY","ENTREGADO_A",
              "DIFERENCIA","Fecha de Escaneo","CONDICIONES_MCIA","FOTO_CONDICIONES"
            ]
          });
          let wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
          let wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
          let blob = new Blob([wbout], { type: "application/octet-stream" });
          let url = URL.createObjectURL(blob);
          let a = document.createElement("a");
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          Swal.fire({
            icon: "success",
            title: "Descargado",
            html: `<i class="material-icons" style="color:#4CAF50;">check_circle</i> Archivo descargado.`
          });
        }

        /***********************************************************
         * ANÁLISIS GLOBAL
         ***********************************************************/
        btnAnalisisGlobal.addEventListener("click", () => {
          let fn = selectedFileToWorkEl.textContent;
          if (!fn || !excelDataGlobal[fn]) {
            return Swal.fire({
              icon: "error",
              title: "Error",
              html: `<i class="material-icons" style="color:#F44336;">error</i> No hay registros para analizar.`
            });
          }
          let data = excelDataGlobal[fn].data;
          let closed = excelDataGlobal[fn].closedContainers || {};
          let secciones = Array.from(new Set(data.map(r => String(r.SECCION || "").trim().toUpperCase()))).filter(s => s);
          let selectHTML = '<label class="form-label"><strong>Filtrar por Sección:</strong></label><select class="form-select" id="selectSeccion"><option value="">(Todas)</option>';
          secciones.forEach(sec => {
            selectHTML += `<option value="${sec}">${sec}</option>`;
          });
          selectHTML += '</select>';
          let inputContHTML = '<input type="text" id="analysisSearchContInput" class="form-control mt-2" placeholder="Buscar Contenedor...">';
          let containerHTML = `<div class="global-analysis-content" id="analysisContainer">${getContainerAnalysis(data, closed)}</div>`;
          Swal.fire({
            title: `<i class="material-icons" style="vertical-align:middle;">analytics</i> Análisis Global`,
            html: `<div>${selectHTML}${inputContHTML}</div>${containerHTML}`,
            icon: "info",
            confirmButtonText: "Cerrar",
            width: "600px",
            customClass: { popup: "swal2-popup global-analysis" }
          });
          setTimeout(() => {
            let sel = document.getElementById("selectSeccion");
            let cont = document.getElementById("analysisContainer");
            let inputCont = document.getElementById("analysisSearchContInput");
            sel.addEventListener("change", () => {
              let val = sel.value.trim().toUpperCase();
              let filtered = (val === "" ? data : data.filter(r => String(r.SECCION || "").trim().toUpperCase() === val));
              cont.innerHTML = getContainerAnalysis(filtered, closed);
            });
            inputCont.addEventListener("input", () => {
              let text = inputCont.value.trim().toUpperCase();
              let groups = {};
              data.forEach(r => {
                let c = String(r.CONTENEDOR || "").trim().toUpperCase() || "SIN CONTENEDOR";
                if (!groups[c]) groups[c] = [];
                groups[c].push(r);
              });
              let html = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px;">`;
              for (let c in groups) {
                if (c.includes(text) || text === "") {
                  let closedFlag = closed && closed[c] ? true : false;
                  html += `<div class="analysis-box" style="padding:10px;border-radius:8px;${closedFlag ? "border:2px solid red;background:rgba(255,0,0,0.1);" : "border:1px solid rgba(255,255,255,0.5);background:rgba(0,0,0,0.1);"}">
                              <h5 style="margin-bottom:8px;">
                                <i class="material-icons" style="vertical-align:middle; font-size:1.3rem; ${closedFlag ? "color:red;" : ""}">inventory_2</i>
                                Contenedor: ${c} ${closedFlag ? '<span style="color:red;font-weight:bold;">(CERRADO)</span>' : ''}
                              </h5>
                              ${getContainerSummaryDetailed(groups[c])}
                            </div>`;
                }
              }
              html += `</div>`;
              cont.innerHTML = html;
            });
          }, 100);
        });
        function getContainerAnalysis(records, closedContainers) {
          let groups = {};
          records.forEach(r => {
            let c = String(r.CONTENEDOR || "").trim().toUpperCase() || "SIN CONTENEDOR";
            if (!groups[c]) groups[c] = [];
            groups[c].push(r);
          });
          let html = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px;">`;
          for (let c in groups) {
            let closed = closedContainers && closedContainers[c] ? true : false;
            html += `<div class="analysis-box" style="padding:10px;border-radius:8px;${closed ? "border:2px solid red;background:rgba(255,0,0,0.1);" : "border:1px solid rgba(255,255,255,0.5);background:rgba(0,0,0,0.1);"}">
                        <h5 style="margin-bottom:8px;">
                          <i class="material-icons" style="vertical-align:middle; font-size:1.3rem; ${closed ? "color:red;" : ""}">inventory_2</i>
                          Contenedor: ${c} ${closed ? '<span style="color:red;font-weight:bold;">(CERRADO)</span>' : ''}
                        </h5>
                        ${getContainerSummaryDetailed(groups[c])}
                      </div>`;
          }
          html += "</div>";
          return html;
        }
        function getContainerSummaryDetailed(recs) {
          let totalRecords = recs.length;
          let assignedUsers = new Set();
          let workers = new Set();
          let dates = [];
          let sapSum = 0, scannerSum = 0;
          let completeCount = 0, totalMissing = 0, totalExtra = 0;
          recs.forEach(r => {
            let sap = Number(r.SAP) || 0;
            let sc = Number(r.SCANNER) || 0;
            sapSum += sap;
            scannerSum += sc;
            if (r.ENTREGADO_A) assignedUsers.add(r.ENTREGADO_A);
            if (r.LAST_SCANNED_BY) workers.add(r.LAST_SCANNED_BY);
            if (r.FECHA_ESCANEO) {
              let d = new Date(r.FECHA_ESCANEO);
              if (!isNaN(d.getTime())) dates.push(d);
            }
            if (sc >= sap) {
              completeCount++;
              if (sc > sap) totalExtra += (sc - sap);
            } else {
              totalMissing += (sap - sc);
            }
          });
          let status = "INCOMPLETO";
          if (totalMissing === 0 && totalExtra > 0) {
            status = "COMPLETO CON MERCANCÍA DE MÁS";
          } else if (completeCount === totalRecords && totalExtra === 0) {
            status = "COMPLETO";
          }
          let dateInfo = "N/A";
          if (dates.length > 0) {
            let minDate = new Date(Math.min(...dates));
            let maxDate = new Date(Math.max(...dates));
            dateInfo = `${formatFecha(minDate)} - ${formatFecha(maxDate)}`;
          }
          let completionInfo = "N/A";
          if (status === "INCOMPLETO" || status === "COMPLETO CON MERCANCÍA DE MÁS") {
            let lastDate = (dates.length > 0) ? new Date(Math.max(...dates)) : new Date();
            let lastWorker = Array.from(workers).pop() || "N/A";
            completionInfo = `${lastWorker} el ${formatFecha(lastDate)}`;
          } else {
            completionInfo = (workers.size === 1) ? Array.from(workers)[0] : `Varios (${Array.from(workers).join(", ")})`;
          }
          return `
            <div style="font-size:0.95rem; display:flex; flex-direction:column; gap:4px;">
              <div class="analysis-item">
                <i class="material-icons" style="color:#666;">apps</i>
                <strong>SKUs en contenedor:</strong> ${totalRecords}
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:#8E44AD;">receipt_long</i>
                <strong>Piezas Totales (SAP):</strong> ${sapSum}
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:#27AE60;">fact_check</i>
                <strong>Piezas Escaneadas:</strong> ${scannerSum}
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:#2980B9;">check_box</i>
                <strong>SKUs Completos:</strong> ${completeCount} ${totalExtra > 0 ? `(con ${totalExtra} piezas de más)` : ""} 
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:${totalMissing > 0 ? "#E74C3C" : "#95A5A6"};">remove_circle</i>
                <strong>Faltan piezas:</strong> ${totalMissing}
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:${totalExtra > 0 ? "#F1C40F" : "#95A5A6"};">add_circle</i>
                <strong>Excedentes:</strong> ${totalExtra} ${totalExtra > 0 ? "<em style='font-size:0.85rem;color:#555;'>(piezas agregadas de más)</em>" : ""} 
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:#16A085;">person</i>
                <strong>Asignados a:</strong> ${Array.from(assignedUsers).join(", ") || "N/A"}
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:#34495E;">engineering</i>
                <strong>Trabajado por:</strong> ${Array.from(workers).join(", ") || "N/A"}
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:#CD6155;">date_range</i>
                <strong>Fechas de escaneo:</strong> ${dateInfo || "N/A"}
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:${status === "COMPLETO" ? "#2ECC71" : "#E74C3C"};">info</i>
                <strong>Estado:</strong> ${status}
              </div>
              <div class="analysis-item">
                <i class="material-icons" style="color:${status === "COMPLETO" ? "#2ECC71" : "#E74C3C"};">person</i>
                <strong>${status === "COMPLETO" ? "Completado por:" : "Última actualización:"}</strong> ${completionInfo}
              </div>
            </div>
          `;
        }
        function getContainerStateFromRecords(records) {
          let totalMissing = 0, totalExtra = 0, completeCount = 0;
          let totalRecords = records.length;
          records.forEach(r => {
            let sap = Number(r.SAP) || 0;
            let sc = Number(r.SCANNER) || 0;
            if (sc >= sap) {
              completeCount++;
              if (sc > sap) totalExtra += (sc - sap);
            } else {
              totalMissing += (sap - sc);
            }
          });
          if (totalMissing === 0 && totalExtra > 0) {
            return "COMPLETO CON MERCANCÍA DE MÁS";
          } else if (completeCount === totalRecords && totalExtra === 0) {
            return "COMPLETO";
          }
          return "INCOMPLETO";
        }
        function formatFecha(fecha) {
  // Si es instancia de Date, usamos el día local sin correction de zona
  if (fecha instanceof Date && !isNaN(fecha.getTime())) {
    const dia  = fecha.getDate().toString().padStart(2, "0");
    const mes  = (fecha.getMonth() + 1).toString().padStart(2, "0");
    const anio = fecha.getFullYear();
    return `${dia}/${mes}/${anio}`;
  }
          if (typeof fecha === "string") {
            let d = new Date(fecha);
            if (!isNaN(d.getTime())) {
              let c = new Date(d.getTime() + d.getTimezoneOffset() * 60000);
              let dd = c.getDate().toString().padStart(2, "0");
              let mm = (c.getMonth() + 1).toString().padStart(2, "0");
              let yy = c.getFullYear();
              return `${dd}/${mm}/${yy}`;
            }
            return fecha;
          }
          if (typeof fecha === "number") {
            let d = new Date(Math.round((fecha - 25569) * 86400 * 1000));
            let c = new Date(d.getTime() + d.getTimezoneOffset() * 60000);
            let dd = c.getDate().toString().padStart(2, "0");
            let mm = (c.getMonth() + 1).toString().padStart(2, "0");
            let yy = c.getFullYear();
            return `${dd}/${mm}/${yy}`;
          }
          return "";
        }
        async function reuploadFileWithScannerChanges(fileName) {
          let dataObj = excelDataGlobal[fileName];
          let arr = dataObj.data;
          let ws = XLSX.utils.json_to_sheet(arr);
          let wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
          let wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
          let blob = new Blob([wbout], { type: "application/octet-stream" });
          let storeFolder = (currentUserStore === "ALL") ? "ALL" : currentUserStore;
          let storageRef = storage.ref(`Manifiestos/${storeFolder}/${fileName}`);
          await storageRef.put(blob);
          await db.collection('manifiestos')
  .doc(fileName)
  .set(
    {
      fileName,
      store: storeFolder,
      lastUser: dataObj.lastUser,
      lastUserStore: (dataObj.lastUserStore !== undefined) ? dataObj.lastUserStore : null,
      lastUserRole:  (dataObj.lastUserRole   !== undefined) ? dataObj.lastUserRole   : null,
      closedContainers: dataObj.closedContainers || {},
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    },
    { merge: true }
  );

        }
      });
    })();
  </script>
</body>
</html>